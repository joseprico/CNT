<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="https://clubnatacioterrassa.cat/wp-content/uploads/CNT_Escut_Blau.png.webp" type="image/webp">
	<title>Visualizador de Estadísticas - CN Terrassa</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
	<style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
body { 
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 50%, #0891b2 100%);
    color: white;
    min-height: 100vh;
    padding: 20px;
    transition: background 0.5s ease;
}

/* Tema CADET (Gris suau) */
body.theme-cadet { 
    background: linear-gradient(135deg, #1e293b 0%, #334155 50%, #475569 100%);
}

/* Tema JUVENIL (Azul suau) */
body.theme-juvenil { 
    background: linear-gradient(135deg, #1e3a5a 0%, #1e4a7a 50%, #0891b2 100%);
}
        .container { max-width: 1400px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { font-size: 32px; margin-bottom: 10px; }
        /* Ajustes específicos para gráficos en móvil */
@media (max-width: 768px) {
    /* Gráfico de Heatmap de Titularidades */
    #titularityHeatmapChart {
        min-height: 400px !important;
        max-height: 600px !important;
    }
   #totalTimeChart {
        min-height: 500px !important;
        max-height: 700px !important;
    } 
    /* Gráfico de Consistencia */
    #consistencyChart {
        min-height: 400px !important;
        max-height: 600px !important;
    }
    
    /* Contenedores de canvas para gráficos horizontales */
    .card canvas[id$="Chart"] {
        min-height: 300px !important;
    }
}
        @media (max-width: 768px) {
            body { padding: 10px; }
            .header h1 { font-size: 24px; }
            .header p { font-size: 14px; }
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 12px;
            flex-wrap: wrap;
        }
        .tab {
            flex: 1;
            min-width: 120px;
            padding: 12px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        @media (max-width: 768px) {
            .tabs { gap: 8px; padding: 8px; }
            .tab { 
                padding: 10px 8px; 
                font-size: 13px;
                min-width: 100px;
            }
        }
        .tab.active { background: #06b6d4; }
        .tab:hover { background: rgba(255,255,255,0.2); }
        .card {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .scoreboard {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            padding: 20px;
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .team-score { text-align: center; }
        .team-name { font-size: 24px; font-weight: bold; color: #67e8f9; margin-bottom: 10px; }
        .score { font-size: 64px; font-weight: 900; color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .separator { font-size: 48px; font-weight: bold; color: #67e8f9; }
        
        @media (max-width: 768px) {
            .scoreboard { gap: 15px; padding: 15px; }
            .team-name { font-size: 18px; }
            .score { font-size: 48px; }
            .separator { font-size: 36px; }
        }
        .section-title { font-size: 22px; font-weight: bold; margin-bottom: 15px; color: #22d3ee; }
        .periods-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .period-card {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .period-label { font-size: 14px; color: #bae6fd; margin-bottom: 8px; }
        .period-score { font-size: 32px; font-weight: bold; color: #fde047; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }
        .player-stat {
            background: rgba(0,0,0,0.2);
            padding: 12px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        @media (max-width: 768px) {
            .player-stat {
                padding: 10px;
                flex-direction: column;
                align-items: flex-start;
            }
            .player-info { margin-bottom: 8px; }
        }
.stats-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}
/* Pastilles responsive */
@media (max-width: 768px) {
    #pastilles-grid {
        grid-template-columns: 1fr !important;
    }
}
/* Limitar alçada dels gràfics circulars de porters */
#goalkeeperSavePercentageChart {
    max-height: 300px !important;
    width: 100% !important;
}

@media (max-width: 768px) {
    #goalkeeperSavePercentageChart {
        max-height: 250px !important;
    }
}
@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
}
.stats-table th,
.stats-table td {
    padding: 10px;
    text-align: left;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}
/* Visualització Piscina */
.pool-container {
    background: linear-gradient(180deg, rgba(6, 182, 212, 0.3) 0%, rgba(8, 145, 178, 0.3) 100%);
    border: 3px solid #0891b2;
    border-radius: 20px;
    padding: 30px 20px;
    position: relative;
    max-width: 600px;
    margin: 0 auto;
}

.pool-goal {
    background: rgba(239, 68, 68, 0.3);
    border: 2px solid #ef4444;
    border-radius: 10px;
    padding: 10px;
    text-align: center;
    margin-bottom: 25px;
}

.pool-players {
    display: grid;
    gap: 15px;
}

.pool-goalkeeper {
    display: flex;
    justify-content: center;
    margin-bottom: 20px;
}

.pool-field-players {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    justify-items: center;
}

.pool-player {
    background: rgba(255, 255, 255, 0.1);
    border: 2px solid #22d3ee;
    border-radius: 12px;
    padding: 12px;
    text-align: center;
    min-width: 100px;
    transition: all 0.3s;
}

.pool-player:hover {
    transform: scale(1.05);
    background: rgba(255, 255, 255, 0.2);
}

.pool-player-num {
    background: #06b6d4;
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    font-weight: bold;
    margin: 0 auto 8px;
}

.pool-player-name {
    font-size: 12px;
    font-weight: bold;
    color: white;
    margin-bottom: 4px;
}

.pool-player-stat {
    font-size: 10px;
    color: #bae6fd;
}

.pool-midfield {
    border-top: 2px dashed rgba(255, 255, 255, 0.3);
    padding-top: 15px;
    margin-top: 15px;
    text-align: center;
    color: #bae6fd;
    font-size: 10px;
}
.stats-table th {
    background: rgba(6, 182, 212, 0.3);
    font-weight: bold;
    color: white;
}

.stats-table td {
    color: white;
}

.stats-table tbody tr:hover {
    background: rgba(255, 255, 255, 0.05);
}

        .player-info { display: flex; align-items: center; gap: 10px; }
        .player-num {
            background: #06b6d4;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .player-num.rival { background: #ef4444; }
        .player-name { font-weight: 600; }
        .player-stats { display: flex; gap: 15px; font-size: 18px; font-weight: bold; }
        .stat-item { display: flex; flex-direction: column; align-items: center; }
        .stat-label { font-size: 10px; color: #bae6fd; }
        .stat-value { color: #fde047; }
        .lineup-section { margin-bottom: 20px; }
        .lineup-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
        }
        .lineup-player {
            background: rgba(34, 197, 94, 0.3);
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            font-size: 12px;
            border: 2px solid #22c55e;
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .info-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 10px;
            }
        }
        .info-item {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 8px;
        }
        .info-label { font-size: 12px; color: #bae6fd; margin-bottom: 5px; }
        .info-value { font-size: 18px; font-weight: bold; }
        .observations {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 8px;
            white-space: pre-wrap;
            line-height: 1.6;
        }
        .btn {
            padding: 12px 24px;
            background: #06b6d4;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn:hover { background: #0891b2; }
        .no-data {
            text-align: center;
            padding: 60px 20px;
            font-size: 18px;
            color: #bae6fd;
        }
        .hidden { display: none; }
        .top-scorers {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .top-scorer-item {
            background: rgba(0,0,0,0.3);
            padding: 12px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .rank {
            background: #fbbf24;
            color: #000;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .rank.gold { background: #fbbf24; }
        .rank.silver { background: #d1d5db; }
        .rank.bronze { background: #d97706; }
        .matches-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }
        .match-item {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
            gap: 15px;
            flex-wrap: wrap;
        }
        .match-item:hover { background: rgba(0,0,0,0.3); }
        .match-info { flex: 1; min-width: 200px; }
        
        @media (max-width: 768px) {
            .match-item {
                padding: 12px;
                flex-direction: column;
                align-items: flex-start;
            }
            .match-info { width: 100%; }
            .match-score { margin: 10px 0 0 0 !important; }
        }
        .match-date { font-size: 12px; color: #bae6fd; margin-bottom: 5px; }
        .match-teams { font-size: 16px; font-weight: bold; }
        .match-score { font-size: 24px; font-weight: bold; color: #fde047; margin: 0 15px; }
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 14px;
        }
        .comparison-table th,
        .comparison-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .comparison-table th {
            background: rgba(0,0,0,0.3);
            color: #22d3ee;
            font-weight: bold;
        }
        .comparison-table tr:hover {
            background: rgba(255,255,255,0.05);
        }
        
        @media (max-width: 768px) {
            .comparison-table {
                font-size: 11px;
            }
            .comparison-table th,
            .comparison-table td {
                padding: 8px 4px;
            }
        }
        .win { color: #22c55e; font-weight: bold; }
        .loss { color: #ef4444; font-weight: bold; }
        .draw { color: #fbbf24; font-weight: bold; }
        .titular-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        @media (max-width: 768px) {
            .titular-stats {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            canvas {
                max-height: 250px !important;
            }
        }
        .titular-item {
            background: rgba(0,0,0,0.2);
            padding: 12px;
            border-radius: 8px;
        }
        .titular-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        .titular-quarters {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }
		.match-header {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 30px;
    padding: 20px;
    background: rgba(0,0,0,0.2);
    border-radius: 12px;
}

.team-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
}
.goal-zone-heatmap {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 4px;
    max-width: 300px;
    margin: 0 auto;
    background: rgba(0, 0, 0, 0.2);
    padding: 10px;
    border-radius: 8px;
}
.player-row-clickable {
    cursor: pointer;
}

.player-row-clickable:hover {
    background: rgba(34, 211, 238, 0.2) !important;
}
.goal-zone-cell {
    aspect-ratio: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    border: 2px solid rgba(255, 255, 255, 0.2);
    font-size: 16px;
    font-weight: bold;
    transition: transform 0.2s;
}

.goal-zone-cell:hover {
    transform: scale(1.05);
    border-color: #22d3ee;
}

.zone-label {
    font-size: 9px;
    color: rgba(255, 255, 255, 0.6);
    margin-bottom: 2px;
}

.zone-count {
    font-size: 18px;
    color: white;
}

.individual-zone-card {
    background: rgba(0, 0, 0, 0.2);
    padding: 12px;
    border-radius: 8px;
}

.individual-zone-card .player-name {
    font-size: 12px;
    font-weight: bold;
    color: #22d3ee;
    margin-bottom: 8px;
    text-align: center;
}

.individual-zone-card .goal-zone-heatmap {
    max-width: 180px;
}

.individual-zone-card .zone-count {
    font-size: 14px;
}
.team-section h2 {
    margin: 0;
    font-size: 20px;
    font-weight: bold;
}

.score {
    font-size: 48px;
    font-weight: bold;
    color: #fde047;
}

.vs {
    font-size: 24px;
    font-weight: bold;
    color: rgba(255,255,255,0.6);
}
        .quarter-badge {
            background: rgba(6, 182, 212, 0.3);
            border: 2px solid #06b6d4;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
        }
        .total-badge {
            background: #fbbf24;
            color: #000;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #22d3ee;
        }
        .filter-bar {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        @media (max-width: 768px) {
            .filter-bar {
                padding: 12px;
                gap: 10px;
            }
            .filter-item { width: 100%; }
            .filter-input { width: 100%; }
        }
        .filter-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .filter-label {
            font-size: 12px;
            color: #bae6fd;
        }
        .filter-input {
    padding: 8px 12px;
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.3);
    border-radius: 6px;
    color: white;
    font-size: 14px;
}
/* Estilos para pestanya Individual */
.player-header {
    text-align: center;
    padding: 20px;
    background: rgba(0,0,0,0.3);
    border-radius: 12px;
    margin-bottom: 20px;
}

.player-header h3 {
    font-size: 28px;
    color: #22d3ee;
    margin-bottom: 10px;
}

.player-header .player-number-big {
    display: inline-block;
    background: #06b6d4;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    line-height: 60px;
    font-size: 32px;
    font-weight: bold;
    margin-bottom: 10px;
}

#comparePlayersCheckboxes label {
    background: rgba(255,255,255,0.1);
    padding: 10px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 8px;
}

#comparePlayersCheckboxes label:hover {
    background: rgba(255,255,255,0.2);
}

#comparePlayersCheckboxes input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.zone-heatmap-container {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 5px;
    max-width: 400px;
    margin: 0 auto;
}

.zone-cell {
    aspect-ratio: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    font-weight: bold;
    color: white;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
}

.zone-cell .zone-label {
    font-size: 10px;
    margin-bottom: 5px;
    opacity: 0.8;
}

.zone-cell .zone-count {
    font-size: 24px;
}
.timeline {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.timeline-item {
    background: rgba(0,0,0,0.3);
    padding: 12px;
    border-radius: 8px;
    border-left: 4px solid;
    display: flex;
    align-items: center;
    gap: 12px;
}
.timeline-item.water-change {
    border-left-color: #06b6d4;
}

.timeline-item.goal {
    border-left-color: #22c55e;
}

.timeline-item.exclusion {
    border-left-color: #f97316;
}

.timeline-item.penalty-missed {
    border-left-color: #ef4444;
}

.timeline-icon {
    font-size: 24px;
    flex-shrink: 0;
}

.timeline-content {
    flex: 1;
}

.timeline-player {
    font-weight: bold;
    color: #22d3ee;
}

.timeline-detail {
    font-size: 12px;
    color: #bae6fd;
    margin-top: 2px;
}

.timeline-quarter {
    background: rgba(6, 182, 212, 0.3);
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 11px;
    color: #67e8f9;
    font-weight: bold;
    border: 1px solid #22d3ee;
    flex-shrink: 0;
}

.timeline-rival {
    color: #fca5a5;
}

.no-timeline {
    text-align: center;
    padding: 40px 20px;
    color: #bae6fd;
    font-size: 14px;
}
.filter-input:focus {
    outline: none;
    border-color: #22d3ee;
}
.player-number-big {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 36px;
    font-weight: bold;
    color: white;
    margin: 0 auto 15px;
    box-shadow: 0 4px 12px rgba(6, 182, 212, 0.4);
}
.filter-input option {
    background: #1e3a8a;
    color: white;
}
        .stats-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        @media (max-width: 768px) {
            .stats-breakdown {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 8px;
            }
        }
        .breakdown-item {
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }
        .breakdown-label {
            font-size: 11px;
            color: #bae6fd;
            margin-bottom: 5px;
        }
        .breakdown-value {
            font-size: 20px;
            font-weight: bold;
            color: #fde047;
        }
		@media print {
    /* Ocultar elements que no vols imprimir */
    .btn, .filter-bar, .tabs {
        display: none !important;
    }
    
    /* Ajustar mides per impressió */
    body {
        background: white;
    }
    
    .card {
        page-break-inside: avoid;
        box-shadow: none;
        border: 1px solid #ddd;
    }
}
/* Estils addicionals per la pestanya ACTAWP */
.stat-item {
    background: rgba(255,255,255,0.05);
    padding: 15px;
    border-radius: 8px;
    text-align: center;
}

.stat-label {
    font-size: 12px;
    color: #bae6fd;
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.stat-value {
    font-size: 32px;
    font-weight: bold;
    color: #22d3ee;
}

.comparison-table {
    width: 100%;
    border-collapse: collapse;
}

.comparison-table th {
    background: rgba(0,0,0,0.3);
    padding: 12px;
    text-align: left;
    font-weight: bold;
    color: #22d3ee;
    border-bottom: 2px solid rgba(34, 211, 238, 0.3);
}

.comparison-table td {
    padding: 10px 12px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

.comparison-table tr:hover {
    background: rgba(255,255,255,0.05);
}
.hidden {
    display: none !important;
}

.tab-content {
    display: none;
}

.tab-content:not(.hidden) {
    display: block;
}
/* Estils per la classificació */
.ranking-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}

.ranking-table thead {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.ranking-table th {
    padding: 12px 8px;
    text-align: center;
    color: white;
    font-weight: 600;
    font-size: 12px;
    text-transform: uppercase;
}

.ranking-table tbody tr {
    border-bottom: 1px solid rgba(255,255,255,0.1);
    transition: all 0.2s ease;
}

.ranking-table tbody tr:hover {
    background-color: rgba(34, 211, 238, 0.1);
}

.ranking-table tbody tr.highlight-team {
    background-color: rgba(251, 191, 36, 0.2);
    font-weight: bold;
    border-left: 3px solid #fbbf24;
}

.ranking-table td {
    padding: 12px 8px;
    text-align: center;
    color: #bae6fd;
}

.team-cell {
    text-align: left !important;
    display: flex;
    align-items: center;
    gap: 10px;
    padding-left: 15px !important;
}

.team-logo {
    width: 30px;
    height: 30px;
    object-fit: contain;
    background: white;
    border-radius: 4px;
    padding: 2px;
}

.position-badge {
    display: inline-block;
    width: 26px;
    height: 26px;
    line-height: 26px;
    border-radius: 50%;
    font-weight: bold;
    color: white;
}

.position-badge.gold { background: linear-gradient(135deg, #FFD700, #FFA500); }
.position-badge.silver { background: linear-gradient(135deg, #C0C0C0, #A8A8A8); }
.position-badge.bronze { background: linear-gradient(135deg, #CD7F32, #B8733A); }

.stat-wins { color: #4ade80; font-weight: 600; }
.stat-draws { color: #fbbf24; font-weight: 600; }
.stat-losses { color: #ef4444; font-weight: 600; }
.stat-points { color: #fbbf24; font-weight: bold; font-size: 16px; }
/* Estils per els logos dels equips */
.match-team-logo {
    width: 28px;
    height: 28px;
    object-fit: contain;
    background: white;
    border-radius: 4px;
    padding: 2px;
    margin-right: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}

.match-team-container {
    display: flex;
    align-items: center;
    gap: 8px;
}

.match-team-name {
    flex: 1;
}
    </style>
 <script async src="https://www.googletagmanager.com/gtag/js?id=G-H8JDTNNK0Z"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-H8JDTNNK0Z');
</script>
</head>
<body>
<div id="teamSelectionModal" style="
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.95);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
">
    <div style="
        background: linear-gradient(135deg, #1e3a8a 0%, #0891b2 100%);
        border-radius: 16px;
        padding: 40px;
        max-width: 500px;
        width: 90%;
        text-align: center;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    ">
        <h1 style="
            font-size: 32px;
            font-weight: bold;
            color: white;
            margin-bottom: 10px;
        ">🏊 CN Terrassa</h1>
        <p style="
            font-size: 16px;
            color: #bae6fd;
            margin-bottom: 30px;
        ">Selecciona l'equip que vols veure:</p>
        
        <div style="
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        ">
         <button onclick="selectTeam('cadet')" style="
    padding: 30px 20px;
    background: linear-gradient(135deg, #64748b, #475569);
    border: 3px solid #fb923c;
    border-radius: 12px;
    color: white;
    font-size: 20px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 4px 20px rgba(251, 146, 60, 0.3);
" onmouseover="this.style.background='linear-gradient(135deg, #475569, #334155)'; this.style.transform='translateY(-3px) scale(1.05)'; this.style.boxShadow='0 8px 30px rgba(251, 146, 60, 0.5)'" 
   onmouseout="this.style.background='linear-gradient(135deg, #64748b, #475569)'; this.style.transform='none'; this.style.boxShadow='0 4px 20px rgba(251, 146, 60, 0.3)'">
    <div style="font-size: 48px; margin-bottom: 10px;">🏊‍♂️</div>
    CADET
    <div style="font-size: 12px; color: #fed7aa; margin-top: 8px; font-weight: 600;">Temporada 25-26</div>
</button>
            
            <button onclick="selectTeam('juvenil')" style="
    padding: 30px 20px;
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    border: 3px solid #60a5fa;
    border-radius: 12px;
    color: white;
    font-size: 20px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 4px 20px rgba(59, 130, 246, 0.5);
" onmouseover="this.style.background='linear-gradient(135deg, #2563eb, #1d4ed8)'; this.style.transform='translateY(-3px) scale(1.05)'; this.style.boxShadow='0 8px 30px rgba(59, 130, 246, 0.7)'" 
   onmouseout="this.style.background='linear-gradient(135deg, #3b82f6, #2563eb)'; this.style.transform='none'; this.style.boxShadow='0 4px 20px rgba(59, 130, 246, 0.5)'">
    <div style="font-size: 48px; margin-bottom: 10px;">🏊‍♂️</div>
    JUVENIL
    <div style="font-size: 12px; color: #dbeafe; margin-top: 8px; font-weight: 600;">Temporada 25-26</div>
</button>
        </div>
        
        <p style="font-size: 11px; color: #94a3b8; margin-top: 20px;">
            Pots canviar d'equip més tard des del menú
        </p>
    </div>
</div>
    <div class="container">
    <div class="header" style="position: relative;">
    <div style="position: absolute; top: 0; right: 0; font-size: 12px; color: rgba(255,255,255,0.6); font-style: italic;">
        by Josep Rico
    </div>
    <div style="display: flex; align-items: center; justify-content: center; gap: 15px; flex-wrap: wrap; margin-bottom: 10px;">
        <img src="https://clubnatacioterrassa.cat/wp-content/uploads/CNT_Escut_Blau.png.webp" 
             alt="CN Terrassa" 
             style="width: 60px; height: 60px; object-fit: contain;">
        <div style="text-align: center;">
            <h1 id="mainTitle" style="margin: 0;">📊 Estadístiques CN Terrassa</h1>
            <p id="mainSubtitle" style="margin: 5px 0 0 0;">Selecciona un equip...</p>
        </div>
    </div>
    <p id="coachName" style="font-size: 16px; color: #fde047; margin-top: 8px; font-weight: 600;"></p>
    <button onclick="changeTeam()" class="btn" style="background: #8b5cf6; padding: 8px 16px; font-size: 14px; margin-top: 10px;">
        🔄 Canviar Equip
    </button>
</div>
	
        <!-- TABS SIEMPRE VISIBLES -->
        <div class="tabs">
    <button class="tab active" onclick="showTab('list')">🏠 Inici</button>
    <button class="tab" onclick="showTab('comparison')">📊 Estadístiques</button>
    <button class="tab" onclick="showTab('titular')">👥 Titularitat</button>
    <button class="tab" onclick="showTab('tiempo')">⏱️ Temps de Joc</button>
    <button class="tab" onclick="showTab('individual')">👤 Individual</button>
    <button class="tab" onclick="showTab('actawpTab')">🌐 FCN ACTAWP</button> 
</div>
        </div>

        <!-- TAB: LISTA DE PARTIDOS -->
        <div id="listTab">
            <div id="loadingMatches" class="loading">
                Cargando partidos...
            </div>

            <div id="matchesView" class="hidden">
			          <!-- 📅 ÚLTIMA ACTUALITZACIÓ ACTAWP -->
    <div style="margin-bottom: 15px; padding: 12px 16px; background: rgba(34, 211, 238, 0.08); border-radius: 8px; border-left: 3px solid #22d3ee; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
        <div style="display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 18px;">📡</span>
            <div>
                <div style="color: #bae6fd; font-size: 11px; font-weight: 600; opacity: 0.8;">DADES FCN ACTAWP</div>
                <div style="color: #93c5fd; font-size: 13px; margin-top: 2px;">
                    Última actualització: <span id="lastUpdateTimeHome" style="font-weight: bold; color: #22d3ee;">Carregant...</span>
                </div>
            </div>
        </div>
        <span id="recentUpdateBadgeHome" style="display: none; background: #10b981; color: white; padding: 5px 12px; border-radius: 12px; font-size: 11px; font-weight: bold;">
            🟢 Actualitzat
        </span>
    </div>
                <!-- ⭐ PASTILLES: Pròxim Partit + Classificació -->
    <div id="pastilles-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
        
        <!-- Pastilla 1: Pròxim Partit -->
        <div class="card" style="background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); color: white; padding: 20px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3 style="margin: 0; font-size: 14px; opacity: 0.9; font-weight: 600;">⚡ PRÒXIM PARTIT</h3>
        <button class="btn" onclick="showTab('actawpTab')" style="background: rgba(255,255,255,0.2); padding: 4px 10px; font-size: 11px; color: white;">
            Veure tot →
        </button>
    </div>
    <div id="next-match-pill" style="text-align: center;">
        <div style="color: #bfdbfe; font-size: 12px;">Carregant...</div>
    </div>
</div>
        
        <!-- Pastilla 2: Classificació Mini -->
        <div class="card" style="padding: 15px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3 style="margin: 0; font-size: 14px; font-weight: 600;">🏆 Classificació</h3>
                <button class="btn" onclick="showTab('actawpTab')" style="background: #3b82f6; padding: 4px 10px; font-size: 11px;">
                    Veure tot →
                </button>
            </div>
            <div id="ranking-pill" style="font-size: 12px;">
                <div style="color: #64748b; text-align: center; padding: 10px;">Carregant...</div>
            </div>
        </div>
        
    </div>
		<!-- Últims Resultats (compacte) -->
<div id="last-results-mini" style="margin-bottom: 20px; padding: 12px; background: rgba(148, 163, 184, 0.05); border-radius: 8px; border-left: 3px solid #22d3ee;">
    <div style="color: #64748b; text-align: center; font-size: 12px;">Carregant últims resultats...</div>
</div>

<!-- ⭐ ESPERIT D'EQUIP -->
<div id="team-spirit" style="margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); border-radius: 8px; color: white; text-align: center;">
    <div style="font-size: 12px; opacity: 0.9; margin-bottom: 8px; font-weight: 600;">💪 ESPERIT D'EQUIP</div>
    <div id="team-spirit-content" style="font-size: 14px;">
        <div style="color: rgba(255,255,255,0.8); font-size: 12px;">Carregant...</div>
    </div>
</div>

<div class="card">
    <div class="filter-bar">
                        <div class="filter-item">
                            <label class="filter-label">Buscar rival</label>
                            <input type="text" class="filter-input" id="filterRival" placeholder="Nombre del rival..." onkeyup="filterMatches()">
                        </div>
                        <div class="filter-item">
                            <label class="filter-label">Resultado</label>
                            <select class="filter-input" id="filterResult" onchange="filterMatches()">
                                <option value="">Todos</option>
                                <option value="win">Victorias</option>
                                <option value="loss">Derrotas</option>
                                <option value="draw">Empates</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label class="filter-label">Ordenar por</label>
                            <select class="filter-input" id="sortBy" onchange="filterMatches()">
                                <option value="date-desc">Fecha (más reciente)</option>
                                <option value="date-asc">Fecha (más antiguo)</option>
                                <option value="score-desc">Más goles</option>
                            </select>
                        </div>
                    </div>
                </div>
<div style="margin-bottom: 20px;">
        <button class="btn" onclick="window.print()" style="background: #8b5cf6; padding: 12px 20px;">
            🖨️ Imprimir / Exportar PDF
        </button>
    </div>
                <div class="card">
                    <h2 class="section-title">Partidos Disponibles</h2>
                    <div class="matches-list" id="availableMatches"></div>
                </div>
            </div>
	</div>
	
<!-- TAB: TIEMPO DE JUEGO -->
<div id="tiempoTab" class="hidden">
 <!--
 <div style="margin-bottom: 20px;">
        <button class="btn" onclick="generateTimePDF()" style="background: #8b5cf6; padding: 12px 20px;">
            📄 Generar PDF Temps de Joc
        </button>
    </div>
	-->
	
    <!-- Filtro por jugador -->
    <div class="card">
        <div class="filter-bar">
            <div class="filter-item">
                <label class="filter-label">Filtrar por jugador</label>
                <select class="filter-input" id="filterPlayerTime" onchange="filterByPlayerTime()">
                    <option value="">Todos los jugadores</option>
                </select>
            </div>
            <button class="btn" onclick="clearPlayerTimeFilter()" style="margin-top: 20px;">Limpiar filtro</button>
        </div>
    </div>

    <!-- Estadísticas individuales del jugador seleccionado -->
    <div id="playerTimeStatsCard" class="card hidden">
        <h2 class="section-title">⏱️ Estadísticas de Tiempo - <span id="selectedPlayerTimeName"></span></h2>
        <div class="info-grid" id="playerTimeSummaryGrid"></div>
        
        <h3 class="section-title" style="margin-top: 20px;">📈 Evolución del Tiempo por Partido</h3>
        <canvas id="playerTimeEvolutionChart" style="max-height: 300px;"></canvas>
        
        <h3 class="section-title" style="margin-top: 20px;">🔥 Tiempo por Cuarto (Todos los Partidos)</h3>
        <canvas id="playerTimeByQuarterChart" style="max-height: 250px;"></canvas>
        
        <h3 class="section-title" style="margin-top: 20px;">⚡ Eficiencia por Minuto</h3>
        <div class="stats-breakdown" id="playerEfficiencyBreakdown"></div>
        
        <h3 class="section-title" style="margin-top: 20px;">📊 Rendimiento: Titular vs Suplente</h3>
        <div class="info-grid" id="playerTitularVsSuplenteGrid"></div>
    </div>

    <!-- Separador -->
    <div style="margin: 40px 0 30px 0; text-align: center;">
        <div style="height: 3px; background: linear-gradient(to right, transparent, #22d3ee, transparent); margin-bottom: 15px;"></div>
        <h2 style="font-size: 28px; font-weight: bold; color: #22d3ee; text-transform: uppercase; letter-spacing: 2px;">
            📊 Estadísticas del Equipo
        </h2>
        <div style="height: 3px; background: linear-gradient(to right, transparent, #22d3ee, transparent); margin-top: 15px;"></div>
    </div>
<!-- PISCINA: 7 Jugadors més utilitzats -->
    <div class="card">
        <h2 class="section-title">🏊‍♂️ Els 7 Jugadors Més Utilitzats</h2>
        <p style="font-size: 12px; color: #bae6fd; margin-bottom: 15px;">
            Alineació basada en el temps total jugat en tots els partits
        </p>
        <div id="globalTimePoolContainer"></div>
    </div>
    <!-- 1. Tiempo Total por Jugador -->
    <div class="card">
        <h2 class="section-title">📊 Tiempo Total Jugado por Jugador</h2>
        <p id="timeChartSubtitle" style="font-size: 12px; color: #bae6fd; margin-bottom: 15px;">
            Cargando...
        </p>
        <canvas id="totalTimeChart" style="max-height: 400px;"></canvas>
    </div>

    <!-- 2. Heatmap de Tiempo por Cuarto -->
    <div class="card">
        <h2 class="section-title">🔥 Heatmap: Tiempo por Cuarto</h2>
        <div style="overflow-x: auto;">
            <table class="comparison-table" id="timeHeatmapTable"></table>
        </div>
    </div>

  
    <!-- 4. Distribución de Minutos (Pastel) -->
    <div class="card">
        <h2 class="section-title">🥧 Distribución de Minutos del Equipo</h2>
        <canvas id="minutesDistributionChart" style="max-height: 350px;"></canvas>
    </div>

    <!-- 5. Plus/Minus por Jugador -->
    <div class="card">
        <h2 class="section-title">📈 Plus/Minus cuando está en el Agua</h2>
        <p style="font-size: 12px; color: #bae6fd; margin-bottom: 15px;">
            Diferencia de goles (a favor - en contra) cuando el jugador está jugando
        </p>
        <canvas id="plusMinusChart" style="max-height: 400px;"></canvas>
    </div>

    <!-- 6. Balance de Carga -->
    <div class="card">
        <h2 class="section-title">⚖️ Balance de Carga del Equipo</h2>
        <div class="info-grid" id="loadBalanceGrid"></div>
        <canvas id="loadBalanceChart" style="max-height: 250px; margin-top: 20px;"></canvas>
    </div>

    <!-- 7. Análisis por Cuarto -->
    <div class="card">
        <h2 class="section-title">📊 Análisis de Rotación por Cuarto</h2>
        <div style="overflow-x: auto;">
            <table class="comparison-table" id="quarterAnalysisTable"></table>
        </div>
    </div>

    <!-- 8. Rendimiento vs Tiempo (Dispersión) -->
    <div class="card">
        <h2 class="section-title">🎯 Rendimiento del Equipo vs Tiempo Jugado</h2>
        <p style="font-size: 12px; color: #bae6fd; margin-bottom: 15px;">
            ¿El equipo rinde mejor cuando ciertos jugadores juegan más?
        </p>
        <canvas id="performanceVsTimeChart" style="max-height: 400px;"></canvas>
    </div>

   <!-- 9. Análisis de Fatiga -->
    <!-- <div class="card">
        <h2 class="section-title">😓 Análisis de Fatiga</h2>
        <p style="font-size: 12px; color: #bae6fd; margin-bottom: 15px;">
            Comparación de rendimiento: Primer cuarto vs Último cuarto
        </p>
        <div style="overflow-x: auto;">
            <table class="comparison-table" id="fatigueAnalysisTable"></table>
        </div>
    </div> -->

    <!-- 10. Promedio de Rotación -->
    <div class="card">
        <h2 class="section-title">🔄 Estadísticas de Rotación</h2>
        <div class="info-grid" id="rotationStatsGrid"></div>
    </div>
</div>
<!-- TAB: INDIVIDUAL -->
<div style="margin-bottom: 20px;">
        <button class="btn" onclick="window.print()" style="background: #8b5cf6; padding: 12px 20px;">
            🖨️ Imprimir / Exportar PDF
        </button>
    </div>
<div id="individualTab" class="hidden">
    <!-- Selector de jugador -->
    <div class="card">
        <h2 class="section-title">👤 Selecciona un Jugador</h2>
        <select class="filter-input" id="playerSelector" onchange="showPlayerStats()" style="font-size: 16px; padding: 12px;">
            <option value="">-- Selecciona un jugador --</option>
        </select>
    </div>

    <!-- Contingut de les estadístiques (es mostra quan se selecciona un jugador) -->
    <div id="playerStatsContent" class="hidden">
        
        <!-- 1. Resum Global -->
        <div class="card">
            <h2 class="section-title">📊 Resum Global</h2>
            <div class="player-header" id="playerHeader"></div>
            <div class="stats-grid" id="playerSummaryGrid"></div>
        </div>

        <!-- 2. Gràfic d'Evolució Temporal -->
        <div class="card">
            <h2 class="section-title">📈 Evolució al Llarg de la Temporada</h2>
            <canvas id="playerEvolutionChart"></canvas>
        </div>

        <!-- 3. Mapa de Zones de Gol -->
        <div class="card">
            <h2 class="section-title">🎯 Mapa de Calor - Zones de Gol</h2>
            <div id="playerGoalZonesHeatmap"></div>
        </div>

        <!-- 4. Comparativa amb la Mitjana de l'Equip -->
        <div class="card">
            <h2 class="section-title">⚖️ Comparativa: Jugador vs Mitjana Equip</h2>
            <canvas id="playerVsTeamChart"></canvas>
        </div>

        <!-- 5. Comparativa Multi-Jugador -->
        <div class="card">
            <h2 class="section-title">👥 Comparar amb Altres Jugadors</h2>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px; font-weight: bold;">Selecciona jugadors per comparar (fins a 4):</label>
                <div id="comparePlayersCheckboxes" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;"></div>
            </div>
            <button class="btn" onclick="compareSelectedPlayers()" style="background: #8b5cf6; margin-bottom: 20px;">
                🔄 Comparar Jugadors
            </button>
            <div id="multiPlayerComparisonContent" class="hidden">
                <canvas id="multiPlayerComparisonChart"></canvas>
            </div>
        </div>

        <!-- 6. Estadístiques per Tipus de Partit -->
        <div class="card">
            <h2 class="section-title">🏠 Rendiment: Casa vs Fora</h2>
            <canvas id="homeAwayChart"></canvas>
        </div>

        <!-- 7. Eficiència per Quarter -->
        <div class="card">
            <h2 class="section-title">⏱️ Rendiment per Quarter</h2>
            <canvas id="quarterPerformanceChart"></canvas>
        </div>

        <!-- 8. Històric Detallat de Partits -->
        <div class="card">
            <h2 class="section-title">📋 Històric de Tots els Partits</h2>
            <div style="overflow-x: auto;">
                <table class="comparison-table" id="playerMatchHistoryTable"></table>
            </div>
        </div>

    </div>
	<!-- Secció especial per PORTERS -->
<div id="goalkeeperStatsContent" class="hidden">
    
    <!-- 1. Resum Específic de Porter -->
    <div class="card">
        <h2 class="section-title">🧤 Estadístiques de Porter</h2>
        <div class="stats-grid" id="goalkeeperSummaryGrid"></div>
    </div>

    !-- 2. Gràfic de % Parades -->
<div class="card">
    <h2 class="section-title">📊 Percentatge de Parades</h2>
    <div style="max-width: 400px; max-height: 400px; margin: 0 auto;">
        <canvas id="goalkeeperSavePercentageChart"></canvas>
    </div>
</div>

    <!-- 3. Parades per Tipus -->
    <div class="card">
        <h2 class="section-title">🤾 Parades per Tipus</h2>
        <canvas id="goalkeeperSaveTypeChart"></canvas>
    </div>

    <!-- 4. Mapa de Calor - Zones de Parades -->
    <div class="card">
        <h2 class="section-title">🎯 Mapa de Zones - On Para Més</h2>
        <div id="goalkeeperZonesHeatmap"></div>
        <p style="font-size: 12px; color: #bae6fd; margin-top: 15px; text-align: center;">
            * Zones des de la perspectiva del porter (esquerra del porter = dreta de l'atacant)
        </p>
    </div>

    <!-- 5. Parades per Rival -->
    <div class="card">
        <h2 class="section-title">🏆 Rendiment per Rival</h2>
        <div style="overflow-x: auto;">
            <table class="comparison-table" id="goalkeeperByRivalTable"></table>
        </div>
    </div>

    <!-- 6. Evolució Temporal del % Parades -->
    <div class="card">
        <h2 class="section-title">📈 Evolució del Percentatge de Parades</h2>
        <canvas id="goalkeeperEvolutionChart"></canvas>
    </div>

    <!-- 7. Comparativa amb altres Porters -->
    <div class="card">
        <h2 class="section-title">⚖️ Comparativa amb Altres Porters</h2>
        <canvas id="goalkeeperComparisonChart"></canvas>
    </div>

    <!-- 8. Penalties -->
    <div class="card">
        <h2 class="section-title">🎯 Estadístiques de Penalties</h2>
        <div class="stats-grid" id="goalkeeperPenaltiesGrid"></div>
    </div>

</div>
	
</div>
<!-- TAB: WEB FEDERACIÓ -->
<div id="federacionTab" class="hidden">
    <div class="card">
        <h2 class="section-title">📅 Calendari i Resultats de la Federació</h2>
        <p style="color: #bae6fd; margin-bottom: 30px;">
            Clica als botons per veure el calendari i resultats oficials de cada equip a la web de la Federació Catalana de Natació.
        </p>
        
        <!-- Cadet -->
        <div style="margin-bottom: 30px; padding: 20px; background: rgba(34, 211, 238, 0.1); border-radius: 12px; border: 2px solid rgba(34, 211, 238, 0.3);">
            <h3 style="color: #22d3ee; font-size: 22px; margin-bottom: 15px;">
                🏊 Cadet - Didac Cobacho
            </h3>
            <p style="color: #bae6fd; margin-bottom: 15px; font-size: 14px;">
                Consulta el calendari, resultats, classificació i estadístiques de l'equip Cadet.
            </p>
            <a href="https://actawp.natacio.cat/ca/team/15621224" target="_blank" rel="noopener noreferrer">
                <button class="btn" style="background: #06b6d4; padding: 15px 30px; font-size: 16px; width: 100%; max-width: 400px;">
                    🌐 Obrir Web Cadet
                </button>
            </a>
        </div>

        <!-- Juvenil -->
        <div style="padding: 20px; background: rgba(34, 211, 238, 0.1); border-radius: 12px; border: 2px solid rgba(34, 211, 238, 0.3);">
            <h3 style="color: #22d3ee; font-size: 22px; margin-bottom: 15px;">
                🏊 Juvenil - Jordi Busquets
            </h3>
            <p style="color: #bae6fd; margin-bottom: 15px; font-size: 14px;">
                Consulta el calendari, resultats, classificació i estadístiques de l'equip Juvenil.
            </p>
            <a href="https://actawp.natacio.cat/es/team/15621223" target="_blank" rel="noopener noreferrer">
                <button class="btn" style="background: #06b6d4; padding: 15px 30px; font-size: 16px; width: 100%; max-width: 400px;">
                    🌐 Obrir Web Juvenil
                </button>
            </a>
        </div>
    </div>
</div>
  
<!-- 2. AFEGIR AQUEST DIV DESPRÉS DE LES ALTRES TABS -->
<div id="actawpTab" class="hidden">
    <div class="card">
        <h2 class="section-title">📊 Dades Oficials ACTAWP</h2>
        <p style="color: #bae6fd; margin-bottom: 10px;">
    Estadístiques i calendari oficial de la Federació Catalana de Natació
</p>
<p style="color: #93c5fd; font-size: 14px; margin-bottom: 20px; font-style: italic;">
    🔄 Dades extretes directament de la Federació Catalana de Natació • Actualitzades automàticament
</p>
       <div style="display: flex; align-items: center; gap: 15px; margin-top: 10px; flex-wrap: wrap;">
    <p style="color: #93c5fd; font-size: 13px; margin: 0;">
        📅 Última actualització: <span id="lastUpdateTime" style="font-weight: bold; color: #22d3ee;">Carregant...</span>
    </p>
    <span id="recentUpdateBadge" style="display: none; background: #ef4444; color: white; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: bold; animation: pulse 2s infinite;">
        🔴 Actualitzat recentment
    </span>
</div> 
        <div id="actawpLoading" style="text-align: center; padding: 40px;">
            <div style="font-size: 48px;">⏳</div>
            <p>Carregant dades d'ACTAWP...</p>
        </div>
        
        <div id="actawpContent" style="display: none;">
            
            
            <!-- PRÒXIMS PARTITS -->
            <div class="card" style="background: rgba(0,0,0,0.3); margin-top: 20px;">
                <h3 class="section-title">📅 Pròxims Partits</h3>
                <div id="actawp-upcoming-matches">
                    <p style="color: #bae6fd;">No hi ha pròxims partits programats</p>
                </div>
            </div>
            
            <!-- ÚLTIMS RESULTATS -->
            <div class="card" style="background: rgba(0,0,0,0.3); margin-top: 20px;">
                <h3 class="section-title">🏆 Últims Resultats</h3>
                <div id="actawp-last-results">
                    <p style="color: #bae6fd;">No hi ha resultats recents</p>
                </div>
            </div>
           <!-- AFEGIR DESPRÉS DELS "ÚLTIMS RESULTATS" -->

<!-- CLASSIFICACIÓ FASE 2 -->
<div class="card" style="background: rgba(0,0,0,0.3); margin-top: 20px;">
    <h3 class="section-title">🏆 Classificació Fase 2</h3>
    <p style="color: #bae6fd; margin-bottom: 15px; font-size: 14px;">
        Classificació oficial de la segona fase de la lliga
    </p>
    <div id="actawp-ranking-container">
        <p style="text-align: center; color: #bae6fd;">Carregant classificació...</p>
    </div>
</div>
<!-- ESTADÍSTIQUES DE L'EQUIP -->
            <div class="card" style="background: rgba(0,0,0,0.3);">
                <h3 class="section-title">📈 Estadístiques</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-label">Punts</div>
                        <div class="stat-value" id="actawp-points">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Partits Jugats</div>
                        <div class="stat-value" id="actawp-matches-played">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Victories</div>
                        <div class="stat-value" style="color: #4ade80;" id="actawp-wins">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Empats</div>
                        <div class="stat-value" style="color: #fbbf24;" id="actawp-draws">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Derrotes</div>
                        <div class="stat-value" style="color: #ef4444;" id="actawp-losses">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Gols a Favor</div>
                        <div class="stat-value" style="color: #22d3ee;" id="actawp-goals-for">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Gols en Contra</div>
                        <div class="stat-value" style="color: #fb923c;" id="actawp-goals-against">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Diferència</div>
                        <div class="stat-value" id="actawp-goal-diff">-</div>
                    </div>
                </div>
            </div>
            <!-- COMPARATIVA AMB LES NOSTRES DADES -->
            <div class="card" style="background: rgba(0,0,0,0.3); margin-top: 20px;">
                <h3 class="section-title">🔍 Comparativa de Jugadors</h3>
                <p style="color: #bae6fd; margin-bottom: 15px; font-size: 14px;">
                    Comparació entre les estadístiques locals i les oficials d'ACTAWP
                </p>
                <div id="actawp-comparison-table"></div>
            </div>
        </div>
    </div>
<div class="card" style="background: rgba(0,0,0,0.3); margin-top: 30px;">
    <h3 class="section-title">🌐 Enllaços Directes ACTAWP</h3>
    
    <!-- Cadet -->
    <div style="margin-bottom: 30px; padding: 20px; background: rgba(34, 211, 238, 0.1); border-radius: 12px; border: 2px solid rgba(34, 211, 238, 0.3);">
        <h3 style="color: #22d3ee; font-size: 22px; margin-bottom: 15px;">
            🏊 Cadet - Didac Cobacho
        </h3>
        <p style="color: #bae6fd; margin-bottom: 15px; font-size: 14px;">
            Consulta el calendari, resultats, classificació i estadístiques de l'equip Cadet.
        </p>
        <a href="https://actawp.natacio.cat/ca/team/15621224" target="_blank" rel="noopener noreferrer">
            <button class="btn" style="background: #06b6d4; padding: 15px 30px; font-size: 16px; width: 100%; max-width: 400px;">
                🌐 Obrir Web Cadet
            </button>
        </a>
    </div>
    
    <!-- Juvenil -->
    <div style="padding: 20px; background: rgba(34, 211, 238, 0.1); border-radius: 12px; border: 2px solid rgba(34, 211, 238, 0.3);">
        <h3 style="color: #22d3ee; font-size: 22px; margin-bottom: 15px;">
            🏊 Juvenil - Jordi Busquets
        </h3>
        <p style="color: #bae6fd; margin-bottom: 15px; font-size: 14px;">
            Consulta el calendari, resultats, classificació i estadístiques de l'equip Juvenil.
        </p>
        <a href="https://actawp.natacio.cat/es/team/15621223" target="_blank" rel="noopener noreferrer">
            <button class="btn" style="background: #06b6d4; padding: 15px 30px; font-size: 16px; width: 100%; max-width: 400px;">
                🌐 Obrir Web Juvenil
            </button>
        </a>
    </div>
</div>
</div>     

		   <!-- Vista de partido individual -->
            <div id="singleMatchView" class="hidden">
                <div class="card">
                    <button class="btn" onclick="backToList()" style="margin-bottom: 20px;">← Volver a la lista</button>
  <!--  <button class="btn" onclick="generateMatchPDF(currentMatch)" style="background: #8b5cf6; padding: 12px 20px; margin-bottom: 15px;">
            📄 Generar PDF d'aquest Partit
        </button>-->
		
		<div id="listTab" class="hidden">
    <div id="matchesView" class="hidden">
        <!-- contingut -->
    </div>
</div>
    <div class="card">
        <div class="match-header">
            <div class="team-section">
                <h2>CN Terrassa</h2>
                <div class="score" id="scoreCNT">0</div>
            </div>
            <div class="vs">VS</div>
            <div class="team-section">
                <h2 id="teamRival">RIVAL</h2>
                <div class="score" id="scoreRival">0</div>
            </div>
        </div>
    </div>

    <div class="card">
        <h2 class="section-title">ℹ️ Información del Partido</h2>
        <div id="matchInfo"></div>
    </div>

    <div class="card">
        <h2 class="section-title">⚽ Desglose de Goles CN Terrassa</h2>
        <div class="stats-breakdown" id="goalsScoredBreakdown"></div>
    </div>

    <div class="card">
        <h2 class="section-title">🥅 Desglose de Goles Recibidos</h2>
        <div class="stats-breakdown" id="goalsReceivedBreakdown"></div>
    </div>

    <div class="card">
        <h2 class="section-title">🟥 Desglose de Exclusiones</h2>
        <div class="stats-breakdown" id="exclusionsBreakdown"></div>
    </div>
	
                    
    <div class="card">
    <h2 class="section-title">📊 Estadísticas Completas del Partido</h2>
    <div style="overflow-x: auto;">
        <table class="comparison-table" id="singleMatchStatsTable"></table>
    </div>
    <div style="margin-top: 20px; padding: 15px; background: rgba(34, 211, 238, 0.1); border-radius: 8px; border-left: 4px solid #22d3ee;">
    <h3 style="color: #22d3ee; margin-bottom: 10px; font-size: 14px;">⭐ Criteris de Valoració MVP</h3>
    <div style="font-size: 12px; color: #bae6fd; line-height: 1.8;">
        <strong style="color: #22c55e;">Accions Positives:</strong><br>
        • Gol normal/contraatac/H+/boya: +2 | Gol penalty: +1<br>
        • Assistència: +1 | Robatori: +1 | Blocatge: +1 | Parada: +1 | Parada penal: +2 | Falta rebuda: +1<br><br>
        <strong style="color: #ef4444;">Accions Negatives:</strong><br>
        • Exclusió (normal o penalty): -1 | Penalty fallat: -2 | Pèrdua: -0.5 | Tir fallat: -0.5 | Infraccions 2m: -0.5 | Contrafalta: -0.75 | Gol rebut (porters): -0.5
    </div>
</div>
</div>

                
                <div class="card">
                    <h2 class="section-title">📈 Evolución del Marcador por Cuartos</h2>
                    <canvas id="scoreEvolutionChart" style="max-height: 300px;"></canvas>
                </div>
    <div class="card">
                    <h2 class="section-title">Alineaciones por Cuarto</h2>
                    <div id="lineupsContainer"></div>
                </div>
               
                <div class="card">
                    <h2 class="section-title">⚖️ Balance Ofensivo vs Defensivo</h2>
                    <canvas id="offenseDefenseChart" style="max-height: 300px;"></canvas>
                </div>

                <div class="card">
                    <h2 class="section-title">👥 Eficiencia por Jugador (Goles vs Exclusiones)</h2>
                    <canvas id="playerEfficiencyChart" style="max-height: 350px;"></canvas>
                </div>

                 <div class="card">
                    <h2 class="section-title">Estadístiques CN Terrassa</h2>
                    <div class="stats-grid" id="statsCNT"></div>
                </div>

                <div class="card">
                    <h2 class="section-title">Estadístiques Rival</h2>
                    <div class="stats-grid" id="statsRival"></div>
                </div>
<div class="card">
    <h2 class="section-title">⏱️ Temps de Joc per Jugador</h2>
    <div id="playingTimesContainer"></div>
</div>
<div class="card">
    <h2 class="section-title">🧤 Parades dels Porters</h2>
    <canvas id="goalkeeperSavesChart" style="max-height: 300px;"></canvas>
</div>
            

                <div class="card">
                    <h2 class="section-title">Observaciones</h2>
                    <div class="observations" id="observations">No hay observaciones</div>
                </div>
				<div class="card">
    <h2 class="section-title">🎯 Zones de Porteria CN Terrassa</h2>
    <div id="matchGoalZonesContainer"></div>
</div>  
<div class="card" id="swimRacesCard" style="display: none;">
    <h2 class="section-title">🏊 Curses Inicials</h2>
    <div id="matchSwimRacesContainer"></div>
</div>
<div class="card">
    <h2 class="section-title">📋 Cronología del Partido</h2>
    <div id="matchTimeline"></div>
</div>
            </div>
        </div>

      <!-- TAB: COMPARACIÓN -->
<div id="comparisonTab" class="hidden">
    <div id="comparisonView">
	<!--<div style="margin-bottom: 20px;">
            <button class="btn" onclick="generateGeneralPDF()" style="background: #8b5cf6; padding: 12px 20px;">
                📄 Generar PDF General
            </button>
        </div>-->
       <!-- <div style="margin-bottom: 20px;">
            <button class="btn" onclick="window.print()" style="background: #8b5cf6; padding: 12px 20px;">
                🖨️ Imprimir / Exportar PDF
            </button>
        </div>-->
        
		 <div class="card">
            <h2 class="section-title">Resumen de Resultados</h2>
            <div class="info-grid" id="summaryGrid"></div>
        </div>
		<!-- NUEVO: Evolución de Resultados -->
        <div class="card">
            <h2 class="section-title">📈 Evolución de Resultados</h2>
            <canvas id="resultsEvolutionChart" style="max-height: 300px;"></canvas>
        </div>

        <!-- NUEVO: Diferencia de Goles por Cuarto -->
        <div class="card">
            <h2 class="section-title">⚡ Diferencia de Goles por Cuarto</h2>
            <p style="font-size: 12px; color: #bae6fd; margin-bottom: 15px;">
                Promedio de diferencia (Goles a favor - Goles en contra) en cada cuarto
            </p>
            <canvas id="quarterDifferenceChart" style="max-height: 250px;"></canvas>
        </div>

        <!-- NUEVO: Mejores y Peores Partidos -->
        <div class="card">
            <h2 class="section-title">🏆 Mejores y Peores Partidos</h2>
            <div class="info-grid" id="bestWorstGrid"></div>
        </div>

        <!-- NUEVO: Historial contra Rivales -->
        <div class="card">
            <h2 class="section-title">🎯 Historial contra Rivales</h2>
            <div style="overflow-x: auto;">
                <table class="comparison-table" id="rivalsHistoryTable"></table>
            </div>
        </div>
        <div class="card">
            <h2 class="section-title">Desglose de Goles (Total)</h2>
            <div class="stats-breakdown" id="totalGoalsBreakdown"></div>
        </div>

        <div class="card">
            <h2 class="section-title">Desglose de Goles Recibidos (Total)</h2>
            <div class="stats-breakdown" id="totalGoalsReceivedBreakdown"></div>
        </div>

        <div class="card">
            <h2 class="section-title">Desglose de Exclusiones (Total)</h2>
            <div class="stats-breakdown" id="totalExclusionsBreakdown"></div>
        </div>

        <div class="card">
            <h2 class="section-title">🥧 Distribución de Goles por Jugador</h2>
            <canvas id="goalsDistributionChart" style="max-height: 300px;"></canvas>
        </div>

        <div class="card">
    <h2 class="section-title">📊 Comparación de Estadísticas</h2>
    <div style="overflow-x: auto;">
        <table class="comparison-table" id="comparisonTable"></table>
    </div>
    <div style="margin-top: 20px; padding: 15px; background: rgba(34, 211, 238, 0.1); border-radius: 8px; border-left: 4px solid #22d3ee;">
    <h3 style="color: #22d3ee; margin-bottom: 10px; font-size: 14px;">⭐ Criteris de Valoració MVP</h3>
    <div style="font-size: 12px; color: #bae6fd; line-height: 1.8;">
        <strong style="color: #22c55e;">Accions Positives:</strong><br>
        • Gol normal/contraatac/H+/boya: +2 | Gol penalty: +1<br>
        • Assistència: +1 | Robatori: +1 | Blocatge: +1 | Parada: +1 | Parada penal: +2 | Falta rebuda: +1<br><br>
        <strong style="color: #ef4444;">Accions Negatives:</strong><br>
        • Exclusió (normal o penalty): -1 | Penalty fallat: -2 | Pèrdua: -0.5 | Tir fallat: -0.5 |Infraccions 2m(-0.5)| Gol rebut (porters): -0.5
    </div>
</div>
</div>

        <div class="card">
            <h2 class="section-title">Top Goleadores (Todos los Partidos)</h2>
            <div class="top-scorers" id="allTimeScorers"></div>
        </div>
		<div id="swimRacesStatsContainer"></div>
    </div>
    </div>
	
</div>

        <!-- TAB: TITULARIDAD -->
<!-- TAB: TITULARIDAD -->
<div id="titularTab" class="hidden">
<!--<div style="margin-bottom: 20px;">
        <button class="btn" onclick="generateTitularityPDF()" style="background: #8b5cf6; padding: 12px 20px;">
            📄 Generar PDF Titularitats
        </button>
    </div>-->
<!--	<div style="margin-bottom: 20px;">
        <button class="btn" onclick="window.print()" style="background: #8b5cf6; padding: 12px 20px;">
            🖨️ Imprimir / Exportar PDF
        </button>
    </div>-->
	
    <div class="card">
        <h2 class="section-title">⏰ Equipo tipo titular</h2>
        <p style="font-size: 12px; color: #bae6fd; margin-bottom: 15px;">
            ¿Que jugadores han sido más veces titulares?
        </p>
        <div id="quarterPatternsGrid" class="stats-grid"></div>
    </div>
    <div class="card">
        <h2 class="section-title">🔥 Heatmap de Titularidades</h2>
        <canvas id="titularityHeatmapChart" style="max-height: 400px;"></canvas>
    </div>
    
    <!-- Consistencia de Titularidad -->
    <div class="card">
        <h2 class="section-title">📊 Consistencia de Titularidad</h2>
        <p style="font-size: 12px; color: #bae6fd; margin-bottom: 15px;">
            Porcentaje de cuartos en los que cada jugador fue titular
        </p>
        <canvas id="consistencyChart" style="max-height: 350px;"></canvas>
    </div>
    
    <!-- Rendimiento según Titularidad -->
    <div class="card">
        <h2 class="section-title">⚡ Rendimiento: Titular vs Suplente</h2>
        <p style="font-size: 12px; color: #bae6fd; margin-bottom: 15px;">
            Media de goles y exclusiones cuando son titulares vs suplentes
        </p>
        <div style="overflow-x: auto;">
            <table class="comparison-table" id="performanceTable"></table>
        </div>
    </div>
    
    <div class="card">
        <div id="titularView"></div>
    </div>
    
   
</div>

    <script>
        let allMatches = [];
        let filteredMatches = [];
        let currentMatch = null;
		let matchesWithTime = []; 
        window.addEventListener('DOMContentLoaded', async () => {
            await loadAllMatches();
        });

  async function loadAllMatches(team = 'juvenil') {
    try {
        console.log('🎯 Iniciando carga de partidos para:', team);
        
        // ✅ URL base segons l'equip
        const baseUrls = {
            cadet: 'https://joseprico.github.io/cnt_cadet_25-26/',
            juvenil: 'https://joseprico.github.io/CNT_juvenil_25_26/'
        };
        
        const baseUrl = baseUrls[team];
        console.log('🌐 Base URL:', baseUrl);
        
        // ⭐ CARREGAR DES D'INDEX.JSON (sense token, sense rate limit)
        console.log('📥 Cargando lista de archivos desde index.json...');
        const indexResponse = await fetch(`${baseUrl}index.json?t=${Date.now()}`); // Cache buster
        
        if (!indexResponse.ok) {
            throw new Error(`Error cargando index.json: ${indexResponse.status}`);
        }
        
        const indexData = await indexResponse.json();
        const jsonFiles = indexData.files || [];
        
        console.log('✅ Archivos encontrados en index.json:', jsonFiles.length);
        console.log('📄 Lista de archivos:', jsonFiles);
        console.log('📅 Última actualización:', indexData.last_updated);

        if (jsonFiles.length === 0) {
            throw new Error('No se encontraron archivos en index.json. Verifica que el GitHub Action se haya ejecutado correctamente.');
        }

        // Carregar cada fitxer JSON
        const promises = jsonFiles.map(async fileName => {
            console.log('📥 Cargando archivo:', fileName);
            const fileUrl = `${baseUrl}${fileName}`;
            
            try {
                const res = await fetch(fileUrl);
                
                if (!res.ok) {
                    console.warn(`⚠️ Error cargando ${fileName}: ${res.status}`);
                    return null;
                }
                
                const matchData = await res.json();
                normalizeAllPlayers(matchData);

                // Normalitzar estadístiques
                (matchData.jugadors || []).forEach(p => {
                    p.estadistiques = p.estadistiques || {};
                    p.estadistiques.paradeTypes = {
                        corner: 0, rebuig: 0, atrapa: 0, penal: 0,
                        ...(p.estadistiques.paradeTypes || {})
                    };
                });
                
                if (!matchData.data || !matchData.rivalTeam) {
                    console.warn('⚠️ Archivo con estructura incorrecta:', fileName);
                }
                
                return matchData;
            } catch (error) {
                console.error(`❌ Error procesando ${fileName}:`, error);
                return null;
            }
        });

        const results = await Promise.all(promises);
        allMatches = results.filter(m => m !== null); // Filtrar nulls

        // Filtrar partits vàlids
        allMatches = allMatches.filter(m => {
            if (!m || !m.data || m.scoreCNT === undefined || m.scoreRival === undefined) {
                console.warn('⚠️ Partido sin estructura básica');
                return false;
            }
            
            if (!m.rivalTeam || m.rivalTeam.toLowerCase() === 'rival' || m.rivalTeam.trim() === '') {
                console.warn('⚠️ Partido sin nombre de rival válido:', m.rivalTeam);
                return false;
            }
            
            if (!m.jugadors || m.jugadors.length === 0) {
                console.warn('⚠️ Partido sin jugadores');
                return false;
            }
            
            if (!m.periodScores) {
                console.warn('⚠️ Partido sin marcadores por periodo');
                return false;
            }
            
            return true;
        });

        console.log('✅ Partidos válidos cargados:', allMatches.length);
        
        // Ordenar per data (més recent primer)
        allMatches.sort((a, b) => {
            const dateA = new Date(a.data).getTime();
            const dateB = new Date(b.data).getTime();
            return dateB - dateA;
        });
        
        filteredMatches = [...allMatches];

        document.getElementById('loadingMatches').classList.add('hidden');
        document.getElementById('matchesView').classList.remove('hidden');
        
        displayMatchesList();
        displayComparison();
        displayTitularStats();
        initializePlayerSelector();
        document.getElementById('mainSubtitle').innerHTML = `Temporada 25/26 • ${allMatches.length} partits`;
        
        // Carregar dades ACTAWP
        await loadActawpData(team);
        
        setTimeout(() => {
            showTab('list');
        }, 200);
        
    } catch (error) {
        console.error('❌ Error detallado:', error);
        document.getElementById('loadingMatches').innerHTML = `
            <div class="no-data">
                <p style="color: #ef4444; font-weight: bold;">❌ Error al cargar los partidos</p>
                <p style="font-size: 14px; margin-top: 10px; color: #fbbf24;">${error.message}</p>
                <p style="font-size: 12px; margin-top: 10px; color: #bae6fd;">
                    Posibles causas:<br>
                    • El archivo index.json no existe en el repositorio<br>
                    • El GitHub Action no se ha ejecutado todavía<br>
                    • GitHub Pages tarda unos segundos en actualizar
                </p>
                <button class="btn" onclick="loadAllMatches('${team}')" style="margin-top: 15px;">
                    🔄 Reintentar
                </button>
            </div>
        `;
    }
}
  function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }
function getQuarterRealStartTime(match, quarter) {
    // Prioritzar quarterRealStartTimes si existeix (nou sistema amb botó)
    if (match.quarterRealStartTimes && match.quarterRealStartTimes[quarter]) {
        return match.quarterRealStartTimes[quarter];
    }
    
    // Fallback: usar quarterStartTimes (sistema antic)
    return match.quarterStartTimes && match.quarterStartTimes[quarter] 
        ? match.quarterStartTimes[quarter] 
        : null;
}
function getQuarterRealStartTime(match, quarter) {
    // Buscar la primera acción REAL del cuarto (gol, exclusión, cambio de agua)
    const actions = match.chronologicalActions || [];
    const quarterActions = actions.filter(a => a.quarter === quarter);
    
    if (quarterActions.length > 0) {
        // Ordenar por timestamp y devolver el primero
        quarterActions.sort((a, b) => a.timestamp - b.timestamp);
        return quarterActions[0].timestamp;
    }
    
    // Si no hay acciones, usar quarterStartTimes como fallback
    return match.quarterStartTimes[quarter];
}
function getQuarterEndTime(match, quarter, quarterStartTime, quarterDuration) {
    if (match.quarterRealEndTimes && match.quarterRealEndTimes[quarter]) {
        return match.quarterRealEndTimes[quarter];
    }
    
    const quarterOrder = ['q1', 'q2', 'q3', 'q4'];
    const currentIndex = quarterOrder.indexOf(quarter);
    
    if (currentIndex < 3) {
        const nextQuarter = quarterOrder[currentIndex + 1];
        if (match.quarterStartTimes[nextQuarter]) {
            return match.quarterStartTimes[nextQuarter];
        }
    }
    
    return quarterStartTime + (quarterDuration * 1000);
}
  function displayMatchesList() {
    const container = document.getElementById('availableMatches');
    
    if (filteredMatches.length === 0) {
        container.innerHTML = '<div class="no-data">No hay partidos que coincidan con los filtros</div>';
        return;
    }

    container.innerHTML = filteredMatches.map((match, idx) => {  // ✅ Usar idx del map
        const date = new Date(match.data);
        const result = match.scoreCNT > match.scoreRival ? 'win' : 
                      match.scoreCNT < match.scoreRival ? 'loss' : 'draw';
        const resultText = result === 'win' ? '✅ Victoria' : 
                          result === 'loss' ? '❌ Derrota' : '🤝 Empate';
        const locationIcon = (match.matchLocation === 'home' || !match.matchLocation) ? '🏠' : '✈️';
        const locationText = (match.matchLocation === 'home' || !match.matchLocation) ? 'Casa' : 'Fuera';
        
        return `
            <div class="match-item" onclick="viewMatch(${idx})">  
                <div class="match-info">
                    <div class="match-date">${date.toLocaleDateString('es-ES', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'})}</div>
                    <div class="match-teams">CN Terrassa vs ${match.rivalTeam || 'Rival'} ${locationIcon}</div>
                    <div class="${result}">${resultText} • ${locationText}</div>
                </div>
                <div class="match-score">${match.scoreCNT} - ${match.scoreRival}</div>
            </div>
        `;
    }).join('');
}

        function filterMatches() {
            const rivalFilter = document.getElementById('filterRival').value.toLowerCase();
            const resultFilter = document.getElementById('filterResult').value;
            const sortBy = document.getElementById('sortBy').value;

            filteredMatches = allMatches.filter(match => {
                const rivalMatch = !rivalFilter || (match.rivalTeam || '').toLowerCase().includes(rivalFilter);
                
                let resultMatch = true;
                if (resultFilter) {
                    const result = match.scoreCNT > match.scoreRival ? 'win' : 
                                  match.scoreCNT < match.scoreRival ? 'loss' : 'draw';
                    resultMatch = result === resultFilter;
                }

                return rivalMatch && resultMatch;
            });

            if (sortBy === 'date-desc') {
                filteredMatches.sort((a, b) => new Date(b.data) - new Date(a.data));
            } else if (sortBy === 'date-asc') {
                filteredMatches.sort((a, b) => new Date(a.data) - new Date(b.data));
            } else if (sortBy === 'score-desc') {
                filteredMatches.sort((a, b) => b.scoreCNT - a.scoreCNT);
            }

            displayMatchesList();
        }

      function viewMatch(idx) {
    currentMatch = filteredMatches[idx];  // ✅ USAR filteredMatches en lugar de allMatches
    document.getElementById('matchesView').classList.add('hidden');
    document.getElementById('singleMatchView').classList.remove('hidden');
    displayMatchData();
}

  function backToList() {
    document.getElementById('singleMatchView').classList.add('hidden');
    document.getElementById('matchesView').classList.remove('hidden');
    const pdfButton = document.getElementById('pdfMatchButton');
    if (pdfButton) {
        pdfButton.style.display = 'none';
    }
}

function showTab(tabName) {
    if (tabName !== 'list') {
        stopCountdownTimer();
    }
	// Eliminar active de tots els tabs
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    if (event && event.target) {
        event.target.classList.add('active');
    }
    
    // Ocultar TOTS els tabs
    document.getElementById('listTab').classList.add('hidden');
    document.getElementById('comparisonTab').classList.add('hidden');
    document.getElementById('titularTab').classList.add('hidden');
    document.getElementById('tiempoTab').classList.add('hidden');
    document.getElementById('individualTab').classList.add('hidden');
    document.getElementById('federacionTab').classList.add('hidden');
    document.getElementById('actawpTab').classList.add('hidden');
    
    // Ocultar també les vistes internes del listTab
    document.getElementById('matchesView').classList.add('hidden');
    document.getElementById('singleMatchView').classList.add('hidden');
    
    // Mostrar el tab seleccionat
    if (tabName === 'list') {
        document.getElementById('listTab').classList.remove('hidden');
        document.getElementById('matchesView').classList.remove('hidden');
        
        // ⭐ CARREGAR LES PASTILLES
        setTimeout(() => {
            loadFrontPagePills();
        }, 100);
        
    } else if (tabName === 'comparison') {
        document.getElementById('comparisonTab').classList.remove('hidden');
    } else if (tabName === 'titular') {
        document.getElementById('titularTab').classList.remove('hidden');
        setTimeout(() => {
            renderTitularityHeatmapChart();
        }, 100);
    } else if (tabName === 'tiempo') {
        document.getElementById('tiempoTab').classList.remove('hidden');
        setTimeout(() => {
            displayTimeStats();
        }, 100);
    } else if (tabName === 'individual') {
        document.getElementById('individualTab').classList.remove('hidden');
        setTimeout(() => {
            initializePlayerSelector();
        }, 100);
    } else if (tabName === 'federacion') {
        document.getElementById('federacionTab').classList.remove('hidden');
    } else if (tabName === 'actawpTab') {
        document.getElementById('actawpTab').classList.remove('hidden');
        setTimeout(() => {
            if (actawpData) {
                displayActawpData();
            }
        }, 100);
    }
}

 function displayMatchData() {
    document.getElementById('scoreCNT').textContent = currentMatch.scoreCNT || 0;
    document.getElementById('scoreRival').textContent = currentMatch.scoreRival || 0;
    document.getElementById('teamRival').textContent = currentMatch.rivalTeam || 'RIVAL';
// Actualitzar també el scoreboard de dalt si existeix
if (document.getElementById('scoreboardCNT')) {
    document.getElementById('scoreboardCNT').textContent = currentMatch.scoreCNT || 0;
    document.getElementById('scoreboardRival').textContent = currentMatch.scoreRival || 0;
    document.getElementById('scoreboardRivalName').textContent = currentMatch.rivalTeam || 'RIVAL';
}
    const date = new Date(currentMatch.data);
    const locationIcon = (currentMatch.matchLocation === 'home' || !currentMatch.matchLocation) ? '🏠' : '✈️';
    const locationText = (currentMatch.matchLocation === 'home' || !currentMatch.matchLocation) ? 'Casa' : 'Fuera';
    const totalExcCNT = currentMatch.jugadors.reduce((sum, j) => sum + j.estadistiques.exclusions, 0);
    const totalExcRival = currentMatch.rivalStats.reduce((sum, j) => sum + j.exclusions, 0);

    // Parades dels porters
    const totalParadesCNT = currentMatch.jugadors.reduce((sum, j) => {
        return sum + (j.estadistiques.parades || 0);
    }, 0);
    
    // Calcular totalGoals abans d'utilitzar-lo
    const totalGoals = currentMatch.jugadors.reduce((sum, j) => sum + j.estadistiques.gols, 0);
    
    // Noves accions
    const totalAssistenciesCNT = currentMatch.jugadors.reduce((sum, j) => {
        return sum + (j.estadistiques.assistencies || 0);
    }, 0);

    const totalRobatorisCNT = currentMatch.jugadors.reduce((sum, j) => {
        return sum + (j.estadistiques.robatoris || 0);
    }, 0);

    const totalPerduesCNT = currentMatch.jugadors.reduce((sum, j) => {
        return sum + (j.estadistiques.perdues || 0);
    }, 0);

    const totalXutsFallatsCNT = currentMatch.jugadors.reduce((sum, j) => {
        return sum + (j.estadistiques.xutsFallats || 0);
    }, 0);
    
    const totalBlocksCNT = currentMatch.jugadors.reduce((sum, j) => {
        return sum + (j.estadistiques.blocks || 0);
    }, 0);

    const totalFaltesRebudesCNT = currentMatch.jugadors.reduce((sum, j) => {
        return sum + (j.estadistiques.faltesRebudes || 0);
    }, 0);
    const totalInfraccions2mCNT = currentMatch.jugadors.reduce((sum, j) => {
    return sum + (j.estadistiques.infraccions2m || 0);
}, 0);

    // Eficiència de tir
    const totalXutsCNT = totalGoals + totalXutsFallatsCNT;
    const eficienciaTirCNT = totalXutsCNT > 0 ? ((totalGoals / totalXutsCNT) * 100).toFixed(1) : '0.0';
    
    // Conversión H+ del CNT (goles H+ CNT / exclusiones normales rival)
    let totalHPlusCNT = 0;
    let totalExclusionsNoPenaltyRival = 0;

    currentMatch.jugadors.forEach(j => {
        if (j.estadistiques.goalTypes && j.estadistiques.goalTypes['h+']) {
            totalHPlusCNT += j.estadistiques.goalTypes['h+'];
        }
    });

    currentMatch.rivalStats.forEach(j => {
        if (j.exclusionTypes) {
            totalExclusionsNoPenaltyRival += (j.exclusionTypes.normal || 0);
        }
    });

    const conversionRateCNT = totalExclusionsNoPenaltyRival > 0 ? 
        ((totalHPlusCNT / totalExclusionsNoPenaltyRival) * 100).toFixed(1) : '0.0';

    // Conversión H+ del Rival (goles H+ rival / exclusiones normales CNT)
    let totalHPlusRival = 0;
    let totalExclusionsNoPenaltyCNT = 0;

    currentMatch.rivalStats.forEach(j => {
        if (j.goalTypes && j.goalTypes['h+']) {
            totalHPlusRival += j.goalTypes['h+'];
        }
    });

    currentMatch.jugadors.forEach(j => {
        if (j.estadistiques.exclusionTypes) {
            totalExclusionsNoPenaltyCNT += (j.estadistiques.exclusionTypes.normal || 0);
        }
    });

    const conversionRateRival = totalExclusionsNoPenaltyCNT > 0 ? 
        ((totalHPlusRival / totalExclusionsNoPenaltyCNT) * 100).toFixed(1) : '0.0';

    document.getElementById('matchInfo').innerHTML = `
        <div class="info-grid">
            <div class="info-item">
                <div class="info-label">📅 Fecha</div>
                <div class="info-value">${date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' })}</div>
            </div>
            <div class="info-item">
                <div class="info-label">${locationIcon} Ubicación</div>
                <div class="info-value">${locationText}</div>
            </div>
            <div class="info-item">
                <div class="info-label">🟥 Exclusiones CNT</div>
                <div class="info-value">${totalExcCNT}</div>
            </div>
            <div class="info-item">
                <div class="info-label">🟥 Exclusiones Rival</div>
                <div class="info-value">${totalExcRival}</div>
            </div>
            ${totalParadesCNT > 0 ? `
            <div class="info-item">
                <div class="info-label">🧤 Parades CNT</div>
                <div class="info-value" style="color: #c084fc;">${totalParadesCNT}</div>
            </div>
            ` : ''}
            <div class="info-item">
                <div class="info-label">🎯 Eficiència Tir CNT</div>
                <div class="info-value" style="color: ${eficienciaTirCNT >= 50 ? '#22c55e' : eficienciaTirCNT >= 30 ? '#fbbf24' : '#ef4444'};">${eficienciaTirCNT}%</div>
            </div>
            <div class="info-item">
                <div class="info-label">📊 Conversió H+ CNT</div>
                <div class="info-value">${conversionRateCNT}%</div>
            </div>
            <div class="info-item">
                <div class="info-label">📊 Conversió H+ Rival</div>
                <div class="info-value">${conversionRateRival}%</div>
            </div>
            ${totalAssistenciesCNT > 0 ? `
            <div class="info-item">
                <div class="info-label">🎯 Assistències CNT</div>
                <div class="info-value" style="color: #86efac;">${totalAssistenciesCNT}</div>
            </div>
            ` : ''}
            ${totalRobatorisCNT > 0 ? `
            <div class="info-item">
                <div class="info-label">🛡️ Robatoris CNT</div>
                <div class="info-value" style="color: #7dd3fc;">${totalRobatorisCNT}</div>
            </div>
            ` : ''}
            ${totalPerduesCNT > 0 ? `
            <div class="info-item">
                <div class="info-label">❌ Pèrdues CNT</div>
                <div class="info-value" style="color: #fca5a5;">${totalPerduesCNT}</div>
            </div>
            ` : ''}
            ${totalXutsFallatsCNT > 0 ? `
            <div class="info-item">
                <div class="info-label">🎯❌ Xuts Fallats CNT</div>
                <div class="info-value" style="color: #fb923c;">${totalXutsFallatsCNT}</div>
            </div>
            ` : ''}
            ${totalBlocksCNT > 0 ? `
            <div class="info-item">
                <div class="info-label">✋ Blocks CNT</div>
                <div class="info-value" style="color: #a78bfa;">${totalBlocksCNT}</div>
            </div>
            ` : ''}
            ${totalFaltesRebudesCNT > 0 ? `
            <div class="info-item">
                <div class="info-label">⚠️ Faltes Rebudes</div>
                <div class="info-value" style="color: #fbbf24;">${totalFaltesRebudesCNT}</div>
            </div>
            ` : ''}
			${totalInfraccions2mCNT > 0 ? `
<div class="info-item">
    <div class="info-label">📏 Infraccions 2m CNT</div>
    <div class="info-value" style="color: #fb923c;">${totalInfraccions2mCNT}</div>
</div>
` : ''}
        </div>
    `;

    // Stats CNT
    document.getElementById('statsCNT').innerHTML = currentMatch.jugadors
    .filter(j => j.estadistiques.gols > 0 || j.estadistiques.exclusions > 0 || 
             (j.estadistiques.parades || 0) > 0 || (j.estadistiques.assistencies || 0) > 0 || 
             (j.estadistiques.infraccions2m || 0) > 0 ||  // ✅ AFEGEIX AQUESTA LÍNIA
			 (j.estadistiques.contrafaltes || 0) > 0 ||
             (j.estadistiques.robatoris || 0) > 0 || (j.estadistiques.perdues || 0) > 0 || 
             (j.estadistiques.xutsFallats || 0) > 0 || (j.estadistiques.blocks || 0) > 0 ||
             (j.estadistiques.faltesRebudes || 0) > 0)
        .map(j => {
            const goalTypes = j.estadistiques.goalTypes || {};
            const exclusionTypes = j.estadistiques.exclusionTypes || {};
            const penaltyMissed = j.estadistiques.penaltyMissed || 0;
            const parades = j.estadistiques.parades || 0;
            const paradeTypes = j.estadistiques.paradeTypes || {};
            const assistencies = j.estadistiques.assistencies || 0;
			const infraccions2m = j.estadistiques.infraccions2m || 0;
            const robatoris = j.estadistiques.robatoris || 0;
            const perdues = j.estadistiques.perdues || 0;
            const xutsFallats = j.estadistiques.xutsFallats || 0;
            const blocks = j.estadistiques.blocks || 0;
			const contrafaltes = j.estadistiques.contrafaltes || 0;
            const faltesRebudes = j.estadistiques.faltesRebudes || 0;
            
            const isGoalkeeper = j.numero === 1 || j.numero === 13;
            
            let goalTypesText = '';
            if (goalTypes['h+']) goalTypesText += `H+:${goalTypes['h+']} `;
            if (goalTypes.penalty) goalTypesText += `P:${goalTypes.penalty} `;
            if (goalTypes.contra) goalTypesText += `C:${goalTypes.contra} `;
            if (goalTypes.boya) goalTypesText += `B:${goalTypes.boya} `;
            if (goalTypes.normal) goalTypesText += `N:${goalTypes.normal}`;
            
            let exclusionTypesText = '';
            if (exclusionTypes.normal) exclusionTypesText += `EX:${exclusionTypes.normal} `;
            if (exclusionTypes.penalty) exclusionTypesText += `P:${exclusionTypes.penalty}`;
            
            let paradeTypesText = '';
            if (paradeTypes.corner) paradeTypesText += `Corner:${paradeTypes.corner} `;
            if (paradeTypes.rebuig) paradeTypesText += `Rebuig:${paradeTypes.rebuig} `;
            if (paradeTypes.atrapa) paradeTypesText += `Atrapa:${paradeTypes.atrapa}`;
			if (paradeTypes.penal) paradeTypesText += `Penal:${paradeTypes.penal} `;
            
            return `
            <div class="player-stat">
                <div class="player-info">
                    <div class="player-num">${j.numero}</div>
                    <div class="player-name">${j.nom}</div>
                </div>
                <div class="player-stats">
                    ${j.estadistiques.gols > 0 ? `
                    <div class="stat-item">
                        <div class="stat-label">Gols</div>
                        <div class="stat-value">${j.estadistiques.gols}</div>
                    </div>
                    ` : ''}
                    ${goalTypesText ? `
                    <div class="stat-item" style="grid-column: span 2;">
                        <div class="stat-label">Tipus</div>
                        <div class="stat-value" style="font-size: 11px;">${goalTypesText}</div>
                    </div>
                    ` : ''}
                    ${j.estadistiques.exclusions > 0 ? `
                    <div class="stat-item">
                        <div class="stat-label">Exc</div>
                        <div class="stat-value">${j.estadistiques.exclusions}</div>
                    </div>
                    ` : ''}
                    ${exclusionTypesText ? `
                    <div class="stat-item">
                        <div class="stat-label">Tipus</div>
                        <div class="stat-value" style="font-size: 11px;">${exclusionTypesText}</div>
                    </div>
                    ` : ''}
                    ${parades > 0 ? `
                    <div class="stat-item">
                        <div class="stat-label">🧤 Parades</div>
                        <div class="stat-value" style="color: #c084fc;">${parades}</div>
                    </div>
                    ` : ''}
                    ${paradeTypesText ? `
                    <div class="stat-item" style="grid-column: span 2;">
                        <div class="stat-label">Tipus</div>
                        <div class="stat-value" style="font-size: 11px;">${paradeTypesText}</div>
                    </div>
                    ` : ''}
                    ${assistencies > 0 ? `
                    <div class="stat-item">
                        <div class="stat-label">🎯 Asist</div>
                        <div class="stat-value" style="color: #86efac;">${assistencies}</div>
                    </div>
                    ` : ''}
					${infraccions2m > 0 ? `
<div class="stat-item">
    <div class="stat-label">📏 2m</div>
    <div class="stat-value" style="color: #fb923c;">${infraccions2m}</div>
</div>
` : ''}
                    ${contrafaltes > 0 ? `
<div class="stat-item">
    <div class="stat-label">⚠️ C.F</div>
    <div class="stat-value" style="color: #fbbf24;">${contrafaltes}</div>
</div>
` : ''}
					${robatoris > 0 ? `
                    <div class="stat-item">
                        <div class="stat-label">🛡️ Rob</div>
                        <div class="stat-value" style="color: #7dd3fc;">${robatoris}</div>
                    </div>
                    ` : ''}
                    ${perdues > 0 ? `
                    <div class="stat-item">
                        <div class="stat-label">❌ Pèrd</div>
                        <div class="stat-value" style="color: #fca5a5;">${perdues}</div>
                    </div>
                    ` : ''}
                    ${xutsFallats > 0 ? `
                    <div class="stat-item">
                        <div class="stat-label">🎯❌ X.F</div>
                        <div class="stat-value" style="color: #fb923c;">${xutsFallats}</div>
                    </div>
                    ` : ''}
                    ${blocks > 0 ? `
                    <div class="stat-item">
                        <div class="stat-label">✋ Block</div>
                        <div class="stat-value" style="color: #a78bfa;">${blocks}</div>
                    </div>
                    ` : ''}
                    ${faltesRebudes > 0 ? `
                    <div class="stat-item">
                        <div class="stat-label">⚠️ F.Reb</div>
                        <div class="stat-value" style="color: #fbbf24;">${faltesRebudes}</div>
                    </div>
                    ` : ''}
                    ${(j.estadistiques.gols > 0 || xutsFallats > 0) ? `
                    <div class="stat-item">
                        <div class="stat-label">Efic%</div>
                        <div class="stat-value" style="color: ${(() => {
                            const totalXuts = j.estadistiques.gols + xutsFallats;
                            const efic = totalXuts > 0 ? (j.estadistiques.gols / totalXuts * 100) : 0;
                            return efic >= 50 ? '#22c55e' : efic >= 30 ? '#fbbf24' : '#ef4444';
                        })()};">
                            ${(() => {
                                const totalXuts = j.estadistiques.gols + xutsFallats;
                                const efic = totalXuts > 0 ? (j.estadistiques.gols / totalXuts * 100).toFixed(0) : 0;
                                return efic + '%';
                            })()}
                        </div>
                    </div>
                    ` : ''}
                    ${penaltyMissed > 0 ? `
                    <div class="stat-item">
                        <div class="stat-label">Pen.F</div>
                        <div class="stat-value" style="color: #ef4444;">${penaltyMissed}</div>
                    </div>
                    ` : ''}
                </div>
            </div>
        `;
    }).join('');

    // Stats Rival
    const rivalPlayers = currentMatch.rivalStats.filter(p => p.name || p.gols > 0 || p.exclusions > 0);
    document.getElementById('statsRival').innerHTML = rivalPlayers.length === 0 ? '<p>No hay estadísticas del rival</p>' :
        rivalPlayers.map(j => {
            const penaltyMissed = j.penaltyMissed || 0;
            return `
            <div class="player-stat">
                <div class="player-info">
                    <div class="player-num rival">${j.num}</div>
                    <div class="player-name">${j.name || 'Jugador ' + j.num}</div>
                </div>
                <div class="player-stats">
                    <div class="stat-item">
                        <div class="stat-label">Gols</div>
                        <div class="stat-value">${j.gols}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Exc</div>
                        <div class="stat-value">${j.exclusions}</div>
                    </div>
                    ${penaltyMissed > 0 ? `
                    <div class="stat-item">
                        <div class="stat-label">Pen.F</div>
                        <div class="stat-value" style="color: #ef4444;">${penaltyMissed}</div>
                    </div>
                    ` : ''}
                </div>
            </div>
        `}).join('');

    // Alineaciones
    const quarters = ['q1', 'q2', 'q3', 'q4'];
    const labels = ['1º Cuarto', '2º Cuarto', '3º Cuarto', '4º Cuarto'];
    document.getElementById('lineupsContainer').innerHTML = quarters.map((q, i) => {
        const lineup = currentMatch.lineups[q] || [];
        if (lineup.length === 0) return '';

        const players = lineup.map(num => {
            const player = currentMatch.jugadors.find(j => j.numero === num);
            return player ? `${player.numero}. ${player.nom.split(' ')[0]}` : num;
        }).join(', ');

        const score = currentMatch.periodScores[q];
        return `
            <div class="period-row">
                <div class="period-label">${labels[i]}</div>
                <div style="font-size: 12px; color: rgba(255,255,255,0.8);">${players}</div>
                <div class="period-score">${score.cnt} - ${score.rival}</div>
            </div>
        `;
    }).join('');

    // Desglose de tipos de goles
    const goalLabels = {
        'h+': 'Superioridad (H+)',
        'penalty': 'Penalty',
        'contra': 'Contraataque',
        'boya': 'Boya',
        'normal': 'Normal'
    };

    const cntGoalStats = {
        'h+': 0,
        'penalty': 0,
        'contra': 0,
        'boya': 0,
        'normal': 0
    };

    currentMatch.jugadors.forEach(j => {
        if (j.estadistiques.goalTypes) {
            Object.keys(cntGoalStats).forEach(type => {
                cntGoalStats[type] += j.estadistiques.goalTypes[type] || 0;
            });
        }
    });

    document.getElementById('goalsScoredBreakdown').innerHTML = Object.keys(cntGoalStats)
        .filter(type => cntGoalStats[type] > 0)
        .map(type => `
            <div class="breakdown-item">
                <div class="breakdown-label">${goalLabels[type]}</div>
                <div class="breakdown-value">${cntGoalStats[type]}</div>
            </div>
        `).join('') || '<p class="no-data" style="padding: 20px;">No hay datos de tipos de goles</p>';

    const rivalGoalStats = {
        'h+': 0,
        'penalty': 0,
        'contra': 0,
        'boya': 0,
        'normal': 0
    };

    currentMatch.rivalStats.forEach(j => {
        if (j.goalTypes) {
            Object.keys(rivalGoalStats).forEach(type => {
                rivalGoalStats[type] += j.goalTypes[type] || 0;
            });
        }
    });

    document.getElementById('goalsReceivedBreakdown').innerHTML = Object.keys(rivalGoalStats)
        .filter(type => rivalGoalStats[type] > 0)
        .map(type => `
            <div class="breakdown-item">
                <div class="breakdown-label">${goalLabels[type]}</div>
                <div class="breakdown-value">${rivalGoalStats[type]}</div>
            </div>
        `).join('') || '<p class="no-data" style="padding: 20px;">No hay datos de tipos de goles</p>';

    // Desglose de exclusiones
    const excStats = {
        cnt: { normal: 0, penalty: 0 },
        rival: { normal: 0, penalty: 0 }
    };

    currentMatch.jugadors.forEach(j => {
        if (j.estadistiques.exclusionTypes) {
            excStats.cnt.normal += j.estadistiques.exclusionTypes.normal || 0;
            excStats.cnt.penalty += j.estadistiques.exclusionTypes.penalty || 0;
        }
    });

    currentMatch.rivalStats.forEach(j => {
        if (j.exclusionTypes) {
            excStats.rival.normal += j.exclusionTypes.normal || 0;
            excStats.rival.penalty += j.exclusionTypes.penalty || 0;
        }
    });

    document.getElementById('exclusionsBreakdown').innerHTML = `
        <div class="breakdown-item">
            <div class="breakdown-label">CNT - Normales</div>
            <div class="breakdown-value">${excStats.cnt.normal}</div>
        </div>
        <div class="breakdown-item">
            <div class="breakdown-label">CNT - Penalty</div>
            <div class="breakdown-value">${excStats.cnt.penalty}</div>
        </div>
        <div class="breakdown-item">
            <div class="breakdown-label">Rival - Normales</div>
            <div class="breakdown-value">${excStats.rival.normal}</div>
        </div>
        <div class="breakdown-item">
            <div class="breakdown-label">Rival - Penalty</div>
            <div class="breakdown-value">${excStats.rival.penalty}</div>
        </div>
    `;
	


    document.getElementById('observations').textContent = currentMatch.observacions || 'No hay observaciones';

    
// ============ MVP DEL PARTIT ============
const playersWithValue = currentMatch.jugadors.map(j => {
    const valor = calculatePlayerValue({
        gols: j.estadistiques.gols,
        goalTypes: j.estadistiques.goalTypes,
        assistencies: j.estadistiques.assistencies,
        infraccions2m: j.estadistiques.infraccions2m || 0,  // ✅ AFEGEIX AQUESTA LÍNIA
		contrafaltes: j.estadistiques.contrafaltes || 0,
        robatoris: j.estadistiques.robatoris,
        blocatges: j.estadistiques.blocks || 0,
        parades: j.estadistiques.parades,
        faltesRebudes: j.estadistiques.faltesRebudes || 0,
        exclusions: j.estadistiques.exclusions,
        exclusionTypes: j.estadistiques.exclusionTypes || { normal: 0, penalty: 0 },
        penaltyMissed: j.estadistiques.penaltyMissed,
        perdues: j.estadistiques.perdues,
        xutsFallats: j.estadistiques.xutsFallats,
        golsRebuts: 0
    });
    return { ...j, valor };
}).sort((a, b) => b.valor - a.valor);

const mvp = playersWithValue[0];
const top3 = playersWithValue.slice(0, 3);

document.getElementById('matchInfo').insertAdjacentHTML('afterend', `
    <div class="card" style="margin-top: 20px;">
        <h2 class="section-title">🏆 MVP del Partit</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
            ${top3.map((player, index) => {
                const medals = ['🥇', '🥈', '🥉'];
                const colors = ['#fbbf24', '#d1d5db', '#d97706'];
                const borderColors = ['#f59e0b', '#9ca3af', '#ea580c'];
                const bgColors = [
                    'linear-gradient(135deg, rgba(251, 191, 36, 0.3), rgba(245, 158, 11, 0.1))',
                    'linear-gradient(135deg, rgba(209, 213, 219, 0.3), rgba(156, 163, 175, 0.1))',
                    'linear-gradient(135deg, rgba(217, 119, 6, 0.3), rgba(234, 88, 12, 0.1))'
                ];
                
                return `
                    <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; border: 3px solid ${borderColors[index]}; position: relative;">
                        <div style="position: absolute; top: 10px; right: 10px; font-size: 36px;">
                            ${medals[index]}
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                            <div class="player-num" style="width: 40px; height: 40px; font-size: 18px;">${player.numero}</div>
                            <div>
                                <div style="font-weight: bold; font-size: 16px; color: ${colors[index]};">${player.nom}</div>
                                <div style="font-size: 12px; color: #bae6fd;">Valoració: ${player.valor.toFixed(1)}</div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 8px;">
                            ${player.estadistiques.gols > 0 ? `
                                <div style="background: rgba(253, 224, 71, 0.2); padding: 6px; border-radius: 4px; text-align: center;">
                                    <div style="color: #bae6fd;">Gols</div>
                                    <div style="color: #fde047; font-weight: bold;">${player.estadistiques.gols}</div>
                                </div>
                            ` : ''}
                            ${(player.estadistiques.assistencies || 0) > 0 ? `
                                <div style="background: rgba(6, 182, 212, 0.2); padding: 6px; border-radius: 4px; text-align: center;">
                                    <div style="color: #bae6fd;">Assists</div>
                                    <div style="color: #06b6d4; font-weight: bold;">${player.estadistiques.assistencies}</div>
                                </div>
                            ` : ''}
                            ${(player.estadistiques.robatoris || 0) > 0 ? `
                                <div style="background: rgba(59, 130, 246, 0.2); padding: 6px; border-radius: 4px; text-align: center;">
                                    <div style="color: #bae6fd;">Robatoris</div>
                                    <div style="color: #3b82f6; font-weight: bold;">${player.estadistiques.robatoris}</div>
                                </div>
                            ` : ''}
                            ${(player.estadistiques.parades || 0) > 0 ? `
                                <div style="background: rgba(139, 92, 246, 0.2); padding: 6px; border-radius: 4px; text-align: center;">
                                    <div style="color: #bae6fd;">Parades</div>
                                    <div style="color: #8b5cf6; font-weight: bold;">${player.estadistiques.parades}</div>
                                </div>
                            ` : ''}
                            ${(player.estadistiques.faltesRebudes || 0) > 0 ? `
                                <div style="background: rgba(251, 191, 36, 0.2); padding: 6px; border-radius: 4px; text-align: center;">
                                    <div style="color: #bae6fd;">Faltes R.</div>
                                    <div style="color: #fbbf24; font-weight: bold;">${player.estadistiques.faltesRebudes}</div>
                                </div>
                            ` : ''}
							${(player.estadistiques.infraccions2m || 0) > 0 ? `
    <div style="background: rgba(251, 146, 60, 0.2); padding: 6px; border-radius: 4px; text-align: center;">
        <div style="color: #bae6fd;">2m</div>
        <div style="color: #fb923c; font-weight: bold;">${player.estadistiques.infraccions2m}</div>
    </div>
` : ''}
                            ${(player.estadistiques.contrafaltes || 0) > 0 ? `
    <div style="background: rgba(251, 191, 36, 0.2); padding: 6px; border-radius: 4px; text-align: center;">
        <div style="color: #bae6fd;">C.F</div>
        <div style="color: #fbbf24; font-weight: bold;">${player.estadistiques.contrafaltes}</div>
    </div>
` : ''}
							${player.estadistiques.exclusions > 0 ? `
                                <div style="background: rgba(239, 68, 68, 0.2); padding: 6px; border-radius: 4px; text-align: center;">
                                    <div style="color: #bae6fd;">Exc</div>
                                    <div style="color: #ef4444; font-weight: bold;">${player.estadistiques.exclusions}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('')}
        </div>
    </div>
`);


	// Generar gráficas
    renderScoreEvolutionChart();
    renderOffenseDefenseChart();
    renderPlayerEfficiencyChart();
    renderMatchTimeline();
    renderSingleMatchStatsTable();
    renderPlayingTimes();
    renderMatchGoalZones();
    
    // ✅ AFEGIR AQUÍ les zones de gols rebuts pels porters
    
    // Zones de Porteria dels Porters (només per aquest partit)
    const matchGoalkeeperZones = {
        1: { num: 1, name: 'MAX VALLS', totalGolsRebuts: 0, zones: {} },
        13: { num: 13, name: 'ERIC MORA', totalGolsRebuts: 0, zones: {} }
    };
    
    // Inicialitzar zones
    [1, 13].forEach(gkNum => {
        matchGoalkeeperZones[gkNum].zones = {
            'top-left': 0, 'top-center': 0, 'top-right': 0,
            'mid-left': 0, 'mid-center': 0, 'mid-right': 0,
            'bottom-left': 0, 'bottom-center': 0, 'bottom-right': 0,
            'unknown': 0
        };
    });
    
    // Calcular zones dels gols rebuts en aquest partit
    currentMatch.jugadors.forEach(j => {
        if ((j.numero === 1 || j.numero === 13) && j.estadistiques.golsRebutsZones) {
            Object.keys(j.estadistiques.golsRebutsZones).forEach(zone => {
                const count = j.estadistiques.golsRebutsZones[zone] || 0;
                matchGoalkeeperZones[j.numero].zones[zone] += count;
                matchGoalkeeperZones[j.numero].totalGolsRebuts += count;
            });
        }
    });
    
    // Només mostrar si hi ha dades
    const hasGoalkeeperData = matchGoalkeeperZones[1].totalGolsRebuts > 0 || 
                              matchGoalkeeperZones[13].totalGolsRebuts > 0;
    
    if (hasGoalkeeperData) {
        const matchGkZonesHTML = `
            <div class="card" id="goalkeeperZonesCard">
                <h2 class="section-title">🧤 Zones de Gols Rebuts pels Porters</h2>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    ${[1, 13].map(gkNum => {
                        const gk = matchGoalkeeperZones[gkNum];
                        if (gk.totalGolsRebuts === 0) return '';
                        
                        const zoneOrder = [
                            'top-left', 'top-center', 'top-right',
                            'mid-left', 'mid-center', 'mid-right',
                            'bottom-left', 'bottom-center', 'bottom-right'
                        ];
                        
                        const zoneLabels = {
                            'top-left': '⬆️E',
                            'top-center': '⬆️C',
                            'top-right': '⬆️D',
                            'mid-left': '➡️E',
                            'mid-center': '🎯',
                            'mid-right': '⬅️D',
                            'bottom-left': '⬇️E',
                            'bottom-center': '⬇️B',
                            'bottom-right': '⬇️D'
                        };
                        
                        const maxCount = Math.max(...zoneOrder.map(z => gk.zones[z] || 0));
                        
                        // Trobar zona més feble
                        const weakestZone = zoneOrder.reduce((max, zone) => 
                            (gk.zones[zone] || 0) > (gk.zones[max] || 0) ? zone : max
                        , zoneOrder[0]);
                        
                        const weakestZoneLabel = {
                            'top-left': 'Dalt Esquerra',
                            'top-center': 'Dalt Centre',
                            'top-right': 'Dalt Dreta',
                            'mid-left': 'Centre Esquerra',
                            'mid-center': 'Centre',
                            'mid-right': 'Centre Dreta',
                            'bottom-left': 'Baix Esquerra',
                            'bottom-center': 'Baix Centre',
                            'bottom-right': 'Baix Dreta'
                        }[weakestZone];
                        
                        return `
                            <div style="background: rgba(0, 0, 0, 0.2); padding: 12px; border-radius: 8px;">
                                <div style="text-align: center; margin-bottom: 10px;">
                                    <div style="font-size: 12px; font-weight: bold; color: #22d3ee;">
                                        ${gk.num}. ${gk.name.split(' ')[0]}
                                    </div>
                                    <div style="font-size: 10px; color: #bae6fd; margin-top: 2px;">
                                        ${gk.totalGolsRebuts} gols rebuts
                                    </div>
                                </div>
                                
                                <div class="goal-zone-heatmap" style="max-width: 200px; margin: 0 auto;">
                                    ${zoneOrder.map(zone => {
                                        const count = gk.zones[zone] || 0;
                                        const percentage = gk.totalGolsRebuts > 0 ? 
                                            ((count / gk.totalGolsRebuts) * 100).toFixed(1) : 0;
                                        const intensity = maxCount > 0 ? count / maxCount : 0;
                                        const bgColor = getHeatmapColor(intensity);
                                        
                                        return `
                                            <div class="goal-zone-cell" style="background: ${bgColor};">
                                                <div class="zone-label">${zoneLabels[zone]}</div>
                                                <div class="zone-count">${count}</div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                                
                                ${gk.zones[weakestZone] > 0 ? `
                                    <div style="text-align: center; margin-top: 10px; font-size: 10px; color: #fca5a5;">
                                        ⚠️ Zona més vulnerable: ${weakestZoneLabel} (${gk.zones[weakestZone]})
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
        
        // ✅ Inserir DESPRÉS del segon card de zones (el que té id matchGoalZonesContainer)
        // Buscar tots els cards amb zones
        const allCards = document.querySelectorAll('.card');
        let matchZonesCard = null;
        
        allCards.forEach(card => {
            if (card.querySelector('#matchGoalZonesContainer')) {
                matchZonesCard = card;
            }
        });
        
        if (matchZonesCard) {
            // Esborrar si ja existeix
            const existingGKCard = document.getElementById('goalkeeperZonesCard');
            if (existingGKCard) {
                existingGKCard.remove();
            }
            
            matchZonesCard.insertAdjacentHTML('afterend', matchGkZonesHTML);
        }
    }
    
    const pdfButton = document.getElementById('pdfMatchButton');
    if (pdfButton) {
        pdfButton.style.display = 'inline-block';
    }
}  // ← Tancament de displayMatchData()
       
function sortSingleMatchTable(column) {
    if (singleMatchSortColumn === column) {
        singleMatchSortOrder = singleMatchSortOrder === 'desc' ? 'asc' : 'desc';
    } else {
        singleMatchSortColumn = column;
        singleMatchSortOrder = 'desc';
    }
    renderSingleMatchStatsTable();
}
 function renderSingleMatchStatsTable() {
    const table = document.getElementById('singleMatchStatsTable');
    if (!table || !currentMatch) return;

    const players = currentMatch.jugadors.map(j => {
        const stats = j.estadistiques;
        const goles = stats.gols;
        const xutsTotal = goles + (stats.xutsFallats || 0);
        const eficiencia = xutsTotal > 0 ? ((goles / xutsTotal) * 100).toFixed(1) : '0.0';
        
        // ✅ SUMAR blocks i blocatges
        const totalBlocks = (stats.blocks || 0) + (stats.blocatges || 0);
        
        const valor = calculatePlayerValue({
    gols: stats.gols,
    goalTypes: stats.goalTypes,
    assistencies: stats.assistencies,
    infraccions2m: stats.infraccions2m || 0,  // ✅ AFEGEIX
	contrafaltes: stats.contrafaltes || 0,
    robatoris: stats.robatoris,
    blocatges: totalBlocks,
    parades: stats.parades,
    faltesRebudes: stats.faltesRebudes || 0,
    exclusions: stats.exclusions,
    exclusionTypes: stats.exclusionTypes || { normal: 0, penalty: 0 },
    penaltyMissed: stats.penaltyMissed,
    perdues: stats.perdues,
    xutsFallats: stats.xutsFallats
});

        return {
            num: j.numero,
            nom: j.nom,
            gols: goles,
            hPlus: stats.goalTypes?.['h+'] || 0,
            penalty: stats.goalTypes?.penalty || 0,
            contra: stats.goalTypes?.contra || 0,
            boya: stats.goalTypes?.boya || 0,
            normal: stats.goalTypes?.normal || 0,
            exclusions: stats.exclusions,
            parades: stats.parades || 0,
            assistencies: stats.assistencies || 0,
			infraccions2m: stats.infraccions2m || 0,
            robatoris: stats.robatoris || 0,
            blocks: totalBlocks,  // ✅ AFEGIR AQUESTA LÍNIA
            infraccions2m: stats.infraccions2m || 0,
			perdues: stats.perdues || 0,
			contrafaltes: stats.contrafaltes || 0,
            faltesRebudes: stats.faltesRebudes || 0,
            xutsFallats: stats.xutsFallats || 0,
            penaltyMissed: stats.penaltyMissed || 0,
            eficiencia: eficiencia,
            valor: valor.toFixed(1)
        };
    });

   // Aplicar ordenació segons la columna seleccionada
   players.sort((a, b) => {
       let valA, valB;
       
       switch(singleMatchSortColumn) {
           case 'num':
               valA = a.num;
               valB = b.num;
               break;
           case 'nom':
               return singleMatchSortOrder === 'desc' 
                   ? b.nom.localeCompare(a.nom)
                   : a.nom.localeCompare(b.nom);
           case 'gols':
               valA = a.gols;
               valB = b.gols;
               break;
           case 'hPlus':
               valA = a.hPlus;
               valB = b.hPlus;
               break;
           case 'penalty':
               valA = a.penalty;
               valB = b.penalty;
               break;
           case 'contra':
               valA = a.contra;
               valB = b.contra;
               break;
           case 'boya':
               valA = a.boya;
               valB = b.boya;
               break;
           case 'normal':
               valA = a.normal;
               valB = b.normal;
               break;
           case 'exclusions':
               valA = a.exclusions;
               valB = b.exclusions;
               break;
           case 'parades':
               valA = a.parades;
               valB = b.parades;
               break;
           case 'assistencies':
               valA = a.assistencies;
               valB = b.assistencies;
               break;
           case 'robatoris':
               valA = a.robatoris;
               valB = b.robatoris;
               break;
           case 'blocks':
               valA = a.blocks;
               valB = b.blocks;
               break;
           case 'infraccions2m':
               valA = a.infraccions2m;
               valB = b.infraccions2m;
               break;
			case 'contrafaltes':
    valA = a.contrafaltes;
    valB = b.contrafaltes;
    break;   
           case 'perdues':
               valA = a.perdues;
               valB = b.perdues;
               break;
           case 'faltesRebudes':
               valA = a.faltesRebudes;
               valB = b.faltesRebudes;
               break;
           case 'xutsFallats':
               valA = a.xutsFallats;
               valB = b.xutsFallats;
               break;
           case 'penaltyMissed':
               valA = a.penaltyMissed;
               valB = b.penaltyMissed;
               break;
           case 'eficiencia':
               valA = parseFloat(a.eficiencia);
               valB = parseFloat(b.eficiencia);
               break;
           case 'valor':
               valA = parseFloat(a.valor);
               valB = parseFloat(b.valor);
               break;
           default:
               return 0;
       }
       
       return singleMatchSortOrder === 'desc' ? valB - valA : valA - valB;
   });
   const getSortIndicator = (column) => {
       if (singleMatchSortColumn !== column) return '';
       return singleMatchSortOrder === 'desc' ? ' ▼' : ' ▲';
   };
    table.innerHTML = `
     <thead>
    <tr>
        <th rowspan="2" onclick="sortSingleMatchTable('num')" style="cursor: pointer; vertical-align: middle;">Nº${getSortIndicator('num')}</th>
        <th rowspan="2" onclick="sortSingleMatchTable('nom')" style="cursor: pointer; vertical-align: middle;">Jugador${getSortIndicator('nom')}</th>
        <th rowspan="2" onclick="sortSingleMatchTable('gols')" style="cursor: pointer; vertical-align: middle;">Gols${getSortIndicator('gols')}</th>
        <th colspan="5" style="background: rgba(34, 211, 238, 0.2); text-align: center;" title="Tipus de Gols">🎯 TIPUS GOLS</th>
        <th colspan="6" style="background: rgba(34, 197, 94, 0.2); text-align: center;" title="Accions Positives">✅ POSITIVES</th>
        <th colspan="6" style="background: rgba(239, 68, 68, 0.2); text-align: center;" title="Accions Negatives">❌ NEGATIVES</th>
        <th rowspan="2" onclick="sortSingleMatchTable('eficiencia')" style="cursor: pointer; vertical-align: middle;">Efic%${getSortIndicator('eficiencia')}</th>
        <th rowspan="2" onclick="sortSingleMatchTable('valor')" style="cursor: pointer; vertical-align: middle;">⭐ Valor${getSortIndicator('valor')}</th>
    </tr>
    <tr style="font-size: 11px;">
        <!-- Tipus de Gols (5 columnes) -->
        <th onclick="sortSingleMatchTable('hPlus')" style="cursor: pointer;">H+${getSortIndicator('hPlus')}</th>
        <th onclick="sortSingleMatchTable('penalty')" style="cursor: pointer;">Pen${getSortIndicator('penalty')}</th>
        <th onclick="sortSingleMatchTable('contra')" style="cursor: pointer;">Con${getSortIndicator('contra')}</th>
        <th onclick="sortSingleMatchTable('boya')" style="cursor: pointer;">Boy${getSortIndicator('boya')}</th>
        <th onclick="sortSingleMatchTable('normal')" style="cursor: pointer;">Nor${getSortIndicator('normal')}</th>
        
        <!-- Positives (6 columnes) -->
        <th onclick="sortSingleMatchTable('parades')" style="cursor: pointer;">🧤 Par${getSortIndicator('parades')}</th>
        <th onclick="sortSingleMatchTable('assistencies')" style="cursor: pointer;">🎯 Ast${getSortIndicator('assistencies')}</th>
        <th onclick="sortSingleMatchTable('robatoris')" style="cursor: pointer;">🛡️ Rob${getSortIndicator('robatoris')}</th>
        <th onclick="sortSingleMatchTable('blocks')" style="cursor: pointer;">🚫 Blk${getSortIndicator('blocks')}</th>
        <th onclick="sortSingleMatchTable('faltesRebudes')" style="cursor: pointer;">⚠️ FR${getSortIndicator('faltesRebudes')}</th>
        <th onclick="sortSingleMatchTable('exclusions')" style="cursor: pointer;">Exc${getSortIndicator('exclusions')}</th>
        
        <!-- Negatives (6 columnes) -->
        <th onclick="sortSingleMatchTable('infraccions2m')" style="cursor: pointer;">📏 2m${getSortIndicator('infraccions2m')}</th>
        <th onclick="sortSingleMatchTable('contrafaltes')" style="cursor: pointer;">⚠️ CF${getSortIndicator('contrafaltes')}</th>
        <th onclick="sortSingleMatchTable('perdues')" style="cursor: pointer;">❌ Pèr${getSortIndicator('perdues')}</th>
        <th onclick="sortSingleMatchTable('xutsFallats')" style="cursor: pointer;">🚫 Xut${getSortIndicator('xutsFallats')}</th>
        <th onclick="sortSingleMatchTable('penaltyMissed')" style="cursor: pointer;">PenF${getSortIndicator('penaltyMissed')}</th>
    </tr>
</thead>
        <tbody>
            ${players.map((p, index) => {
                // Colors per al podi
                const rankColor = index === 0 ? 'background: rgba(255, 215, 0, 0.2);' :
                                 index === 1 ? 'background: rgba(192, 192, 192, 0.2);' :
                                 index === 2 ? 'background: rgba(205, 127, 50, 0.2);' : '';
                
                 return `
                    <tr style="${rankColor}">
                        <td>${p.num}</td>
                        <td><strong>${p.nom.split(' ')[0]}</strong></td>
                        <td>${p.gols}</td>
                        <!-- Tipus Gols (5) -->
                        <td>${p.hPlus}</td>
                        <td>${p.penalty}</td>
                        <td>${p.contra}</td>
                        <td>${p.boya}</td>
                        <td>${p.normal}</td>
                        <!-- Positives (6) -->
                        <td>${p.parades}</td>
                        <td>${p.assistencies}</td>
                        <td>${p.robatoris}</td>
                        <td>${p.blocks}</td>
                        <td>${p.faltesRebudes}</td>
                        <td>${p.exclusions}</td>
                        <!-- Negatives (6) -->
                        <td>${p.infraccions2m}</td>
                        <td>${p.contrafaltes}</td>
                        <td>${p.perdues}</td>
                        <td>${p.xutsFallats}</td>
                        <td>${p.penaltyMissed}</td>
                        <!-- Efic i Valor -->
                        <td>${p.eficiencia}%</td>
                        <td><strong>${p.valor}</strong></td>
                    </tr>
                `;
            }).join('')}
        </tbody>
    `;
}
 function renderScoreEvolutionChart() {
            const ctx = document.getElementById('scoreEvolutionChart');
            if (!ctx) return;
            
            if (window.scoreEvolutionChartInstance) {
                window.scoreEvolutionChartInstance.destroy();
            }
            
            const periods = ['Inicio', '1Q', '2Q', '3Q', '4Q'];
            const cntScores = [0];
            const rivalScores = [0];
            
            ['q1', 'q2', 'q3', 'q4'].forEach(q => {
                const lastCnt = cntScores[cntScores.length - 1];
                const lastRival = rivalScores[rivalScores.length - 1];
                cntScores.push(lastCnt + currentMatch.periodScores[q].cnt);
                rivalScores.push(lastRival + currentMatch.periodScores[q].rival);
            });
            
            window.scoreEvolutionChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: periods,
                    datasets: [
                        {
                            label: 'CN Terrassa',
                            data: cntScores,
                            borderColor: '#22d3ee',
                            backgroundColor: 'rgba(34, 211, 238, 0.1)',
                            tension: 0.3,
                            fill: true,
                            pointRadius: 5,
                            pointHoverRadius: 7
                        },
                        {
                            label: currentMatch.rivalTeam || 'Rival',
                            data: rivalScores,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.3,
                            fill: true,
                            pointRadius: 5,
                            pointHoverRadius: 7
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { 
                            display: true,
                            labels: { color: 'white', font: { size: 14 } }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            ticks: { color: 'white', stepSize: 1 },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        x: { 
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
        }

        function renderOffenseDefenseChart() {
            const ctx = document.getElementById('offenseDefenseChart');
            if (!ctx) return;
            
            if (window.offenseDefenseChartInstance) {
                window.offenseDefenseChartInstance.destroy();
            }
            
            const cntGoalStats = { 'h+': 0, 'penalty': 0, 'contra': 0, 'boya': 0, 'normal': 0 };
            const rivalGoalStats = { 'h+': 0, 'penalty': 0, 'contra': 0, 'boya': 0, 'normal': 0 };
            
            currentMatch.jugadors.forEach(j => {
                if (j.estadistiques.goalTypes) {
                    Object.keys(cntGoalStats).forEach(type => {
                        cntGoalStats[type] += j.estadistiques.goalTypes[type] || 0;
                    });
                }
            });
            
            currentMatch.rivalStats.forEach(j => {
                if (j.goalTypes) {
                    Object.keys(rivalGoalStats).forEach(type => {
                        rivalGoalStats[type] += j.goalTypes[type] || 0;
                    });
                }
            });
            
            const labels = ['H+', 'Penalty', 'Contra', 'Boya', 'Normal'];
            const cntData = [cntGoalStats['h+'], cntGoalStats.penalty, cntGoalStats.contra, cntGoalStats.boya, cntGoalStats.normal];
            const rivalData = [rivalGoalStats['h+'], rivalGoalStats.penalty, rivalGoalStats.contra, rivalGoalStats.boya, rivalGoalStats.normal];
            
            window.offenseDefenseChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Goles a Favor',
                            data: cntData,
                            backgroundColor: '#22c55e'
                        },
                        {
                            label: 'Goles en Contra',
                            data: rivalData,
                            backgroundColor: '#ef4444'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { 
                            display: true,
                            labels: { color: 'white', font: { size: 14 } }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            ticks: { color: 'white', stepSize: 1 },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        x: { 
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
        }

        function renderPlayerEfficiencyChart() {
            const ctx = document.getElementById('playerEfficiencyChart');
            if (!ctx) return;
            
            if (window.playerEfficiencyChartInstance) {
                window.playerEfficiencyChartInstance.destroy();
            }
            
            const playersWithStats = currentMatch.jugadors
                .filter(j => j.estadistiques.gols > 0 || j.estadistiques.exclusions > 0)
                .sort((a, b) => b.estadistiques.gols - a.estadistiques.gols);
            
            const labels = playersWithStats.map(j => `${j.numero}. ${j.nom.split(' ')[0]}`);
            const goalsData = playersWithStats.map(j => j.estadistiques.gols);
            const exclusionsData = playersWithStats.map(j => j.estadistiques.exclusions);
            
            window.playerEfficiencyChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Goles',
                            data: goalsData,
                            backgroundColor: '#fde047'
                        },
                        {
                            label: 'Exclusiones',
                            data: exclusionsData,
                            backgroundColor: '#f97316'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    indexAxis: 'y',
                    plugins: {
                        legend: { 
                            display: true,
                            labels: { color: 'white', font: { size: 14 } }
                        }
                    },
                    scales: {
                        x: { 
                            beginAtZero: true,
                            ticks: { color: 'white', stepSize: 1 },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        y: { 
                            ticks: { color: 'white', font: { size: 11 } },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
        }

function displayComparison() {
    if (allMatches.length === 0) return;
    
    
    const wins = allMatches.filter(m => m.scoreCNT > m.scoreRival).length;
    const losses = allMatches.filter(m => m.scoreCNT < m.scoreRival).length;
    const draws = allMatches.filter(m => m.scoreCNT === m.scoreRival).length;
    const totalGoals = allMatches.reduce((sum, m) => sum + m.scoreCNT, 0);
    const totalGoalsAgainst = allMatches.reduce((sum, m) => sum + m.scoreRival, 0);
    const avgGoals = (totalGoals / allMatches.length).toFixed(1);
    const avgGoalsAgainst = (totalGoalsAgainst / allMatches.length).toFixed(1);

    // Filtrar només partits amb dades de xuts fallats
    const matchesWithShotData = allMatches.filter(m => {
        const hasXutsFallats = m.jugadors.some(j => (j.estadistiques.xutsFallats || 0) > 0);
        return hasXutsFallats;
    });

    const totalXutsFallats = matchesWithShotData.reduce((sum, m) => {
        return sum + m.jugadors.reduce((s, j) => s + (j.estadistiques.xutsFallats || 0), 0);
    }, 0);

    const totalGoalsWithShotData = matchesWithShotData.reduce((sum, m) => sum + m.scoreCNT, 0);
    const totalXutsGlobal = totalGoalsWithShotData + totalXutsFallats;
    const eficienciaGlobal = totalXutsGlobal > 0 ? ((totalGoalsWithShotData / totalXutsGlobal) * 100).toFixed(1) : '0.0';
    const numMatchesWithShotData = matchesWithShotData.length;
    
    let totalPenMissedCNT = 0;
    let totalPenMissedRival = 0;
    let totalHPlusCNT = 0;
    let totalExclusionsNoPenaltyRival = 0;
    let totalHPlusRival = 0;
    let totalExclusionsNoPenaltyCNT = 0;

    const globalGoalStats = {
        'h+': 0,
        'penalty': 0,
        'contra': 0,
        'boya': 0,
        'normal': 0
    };

    const globalExcStats = {
        cnt: { normal: 0, penalty: 0 },
        rival: { normal: 0, penalty: 0 }
    };

    allMatches.forEach(match => {
        match.jugadors.forEach(j => {
            totalPenMissedCNT += (j.estadistiques.penaltyMissed || 0);
            if (j.estadistiques.goalTypes) {
                Object.keys(globalGoalStats).forEach(type => {
                    globalGoalStats[type] += j.estadistiques.goalTypes[type] || 0;
                });
                if (j.estadistiques.goalTypes['h+']) {
                    totalHPlusCNT += j.estadistiques.goalTypes['h+'];
                }
            }
            if (j.estadistiques.exclusionTypes) {
                globalExcStats.cnt.normal += j.estadistiques.exclusionTypes.normal || 0;
                globalExcStats.cnt.penalty += j.estadistiques.exclusionTypes.penalty || 0;
                totalExclusionsNoPenaltyCNT += j.estadistiques.exclusionTypes.normal || 0;
            }
        });
        
        match.rivalStats.forEach(j => {
            totalPenMissedRival += (j.penaltyMissed || 0);
            if (j.goalTypes && j.goalTypes['h+']) {
                totalHPlusRival += j.goalTypes['h+'];
            }
            if (j.exclusionTypes) {
                totalExclusionsNoPenaltyRival += (j.exclusionTypes.normal || 0);
                globalExcStats.rival.normal += j.exclusionTypes.normal || 0;
                globalExcStats.rival.penalty += j.exclusionTypes.penalty || 0;
            }
        });
    });

    const conversionRateCNT = totalExclusionsNoPenaltyRival > 0 ? 
        ((totalHPlusCNT / totalExclusionsNoPenaltyRival) * 100).toFixed(1) : '0.0';

    const conversionRateRival = totalExclusionsNoPenaltyCNT > 0 ? 
        ((totalHPlusRival / totalExclusionsNoPenaltyCNT) * 100).toFixed(1) : '0.0';

    // NUEVO: Rendimiento Casa vs Fuera
    const homeMatches = allMatches.filter(m => m.matchLocation === 'home' || !m.matchLocation);
    const awayMatches = allMatches.filter(m => m.matchLocation === 'away');

    const homeWins = homeMatches.filter(m => m.scoreCNT > m.scoreRival).length;
    const homeLosses = homeMatches.filter(m => m.scoreCNT < m.scoreRival).length;
    const homeDraws = homeMatches.filter(m => m.scoreCNT === m.scoreRival).length;

    const awayWins = awayMatches.filter(m => m.scoreCNT > m.scoreRival).length;
    const awayLosses = awayMatches.filter(m => m.scoreCNT < m.scoreRival).length;
    const awayDraws = awayMatches.filter(m => m.scoreCNT === m.scoreRival).length;

    const homeGoalsFor = homeMatches.reduce((sum, m) => sum + m.scoreCNT, 0);
    const homeGoalsAgainst = homeMatches.reduce((sum, m) => sum + m.scoreRival, 0);
    const awayGoalsFor = awayMatches.reduce((sum, m) => sum + m.scoreCNT, 0);
    const awayGoalsAgainst = awayMatches.reduce((sum, m) => sum + m.scoreRival, 0);

    document.getElementById('summaryGrid').innerHTML = `
        <div class="info-item">
            <div class="info-label">Partidos Jugados</div>
            <div class="info-value">${allMatches.length}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Victorias</div>
            <div class="info-value win">${wins}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Derrotas</div>
            <div class="info-value loss">${losses}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Empates</div>
            <div class="info-value draw">${draws}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Goles a Favor</div>
            <div class="info-value">${totalGoals}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Goles en Contra</div>
            <div class="info-value">${totalGoalsAgainst}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Media Goles/Partido</div>
            <div class="info-value">${avgGoals}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Media Goles en Contra</div>
            <div class="info-value">${avgGoalsAgainst}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Penaltis Fallados CNT</div>
            <div class="info-value" style="color: ${totalPenMissedCNT === 0 ? '#22c55e' : '#ef4444'}">${totalPenMissedCNT}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Penaltis Fallados Rival</div>
            <div class="info-value" style="color: ${totalPenMissedRival === 0 ? '#22c55e' : '#ef4444'}">${totalPenMissedRival}</div>
        </div>
        <div class="info-item">
            <div class="info-label">🏠 Partidos en Casa</div>
            <div class="info-value">${homeMatches.length}</div>
            <div style="font-size: 10px; color: #bae6fd; margin-top: 4px;">
                ${homeWins}V - ${homeLosses}D - ${homeDraws}E
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">🎯 Eficiència Global de Tir</div>
            <div class="info-value" style="color: ${totalXutsGlobal > 0 ? (eficienciaGlobal >= 50 ? '#22c55e' : eficienciaGlobal >= 30 ? '#fbbf24' : '#ef4444') : '#bae6fd'};">
                ${totalXutsGlobal > 0 ? `${totalGoals}/${totalXutsGlobal}` : 'No hi ha dades'}<br>
                ${totalXutsGlobal > 0 ? `<span style="font-size: 14px;">(${eficienciaGlobal}%)</span>` : ''}
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">✈️ Partidos Fuera</div>
            <div class="info-value">${awayMatches.length}</div>
            <div style="font-size: 10px; color: #bae6fd; margin-top: 4px;">
                ${awayWins}V - ${awayLosses}D - ${awayDraws}E
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">🏠 Media Goles Casa</div>
            <div class="info-value" style="color: #fde047;">
                ${homeMatches.length > 0 ? (homeGoalsFor / homeMatches.length).toFixed(1) : '-'}
            </div>
            <div style="font-size: 10px; color: #bae6fd; margin-top: 4px;">
                GC: ${homeMatches.length > 0 ? (homeGoalsAgainst / homeMatches.length).toFixed(1) : '-'}
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">✈️ Media Goles Fuera</div>
            <div class="info-value" style="color: #fde047;">
                ${awayMatches.length > 0 ? (awayGoalsFor / awayMatches.length).toFixed(1) : '-'}
            </div>
            <div style="font-size: 10px; color: #bae6fd; margin-top: 4px;">
                GC: ${awayMatches.length > 0 ? (awayGoalsAgainst / awayMatches.length).toFixed(1) : '-'}
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">Conversión H+ CNT (Total)</div>
            <div class="info-value" style="color: ${conversionRateCNT >= 50 ? '#22c55e' : conversionRateCNT >= 30 ? '#fbbf24' : '#ef4444'}">
                ${totalHPlusCNT}/${totalExclusionsNoPenaltyRival}<br>
                <span style="font-size: 14px;">(${conversionRateCNT}%)</span>
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">Conversión H+ Rival (Total)</div>
            <div class="info-value" style="color: ${conversionRateRival >= 50 ? '#ef4444' : conversionRateRival >= 30 ? '#fbbf24' : '#22c55e'}">
                ${totalHPlusRival}/${totalExclusionsNoPenaltyCNT}<br>
                <span style="font-size: 14px;">(${conversionRateRival}%)</span>
            </div>
        </div>
    `;

    const goalLabels = {
        'h+': 'Superioridad (H+)',
        'penalty': 'Penaltis',
        'contra': 'Contraataques',
        'boya': 'Boya',
        'normal': 'Normales'
    };

    document.getElementById('totalGoalsBreakdown').innerHTML = Object.keys(globalGoalStats)
        .filter(type => globalGoalStats[type] > 0)
        .map(type => `
            <div class="breakdown-item">
                <div class="breakdown-label">${goalLabels[type]}</div>
                <div class="breakdown-value">${globalGoalStats[type]}</div>
                <div style="font-size: 11px; color: #bae6fd; margin-top: 4px;">
                    ${((globalGoalStats[type] / totalGoals) * 100).toFixed(1)}%
                </div>
            </div>
        `).join('') || '<p class="no-data" style="padding: 20px;">No hay datos de tipos de goles</p>';

    const globalRivalGoalStats = {
        'h+': 0,
        'penalty': 0,
        'contra': 0,
        'boya': 0,
        'normal': 0
    };
    
    allMatches.forEach(match => {
        match.rivalStats.forEach(j => {
            if (j.goalTypes) {
                Object.keys(globalRivalGoalStats).forEach(type => {
                    globalRivalGoalStats[type] += j.goalTypes[type] || 0;
                });
            }
        });
    });

    document.getElementById('totalGoalsReceivedBreakdown').innerHTML = Object.keys(globalRivalGoalStats)
        .filter(type => globalRivalGoalStats[type] > 0)
        .map(type => `
            <div class="breakdown-item">
                <div class="breakdown-label">${goalLabels[type]}</div>
                <div class="breakdown-value">${globalRivalGoalStats[type]}</div>
                <div style="font-size: 11px; color: #bae6fd; margin-top: 4px;">
                    ${((globalRivalGoalStats[type] / totalGoalsAgainst) * 100).toFixed(1)}%
                </div>
            </div>
        `).join('') || '<p class="no-data" style="padding: 20px;">No hay datos de tipos de goles</p>';

    document.getElementById('totalExclusionsBreakdown').innerHTML = `
        <div class="breakdown-item">
            <div class="breakdown-label">CNT - Normales</div>
            <div class="breakdown-value">${globalExcStats.cnt.normal}</div>
        </div>
        <div class="breakdown-item">
            <div class="breakdown-label">CNT - Penaltis</div>
            <div class="breakdown-value">${globalExcStats.cnt.penalty}</div>
        </div>
        <div class="breakdown-item">
            <div class="breakdown-label">Rival - Normales</div>
            <div class="breakdown-value">${globalExcStats.rival.normal}</div>
        </div>
        <div class="breakdown-item">
            <div class="breakdown-label">Rival - Penaltis</div>
            <div class="breakdown-value">${globalExcStats.rival.penalty}</div>
        </div>
    `;

    const playerStats = {};
    const playerMatchAppearances = {};
    
    allMatches.forEach((match, matchIndex) => {
        match.jugadors.forEach(j => {
            const playerName = j.nom.trim();
            
            if (!playerStats[playerName]) {
                playerStats[playerName] = { 
                    num: j.numero,
                    name: playerName, 
                    gols: 0, 
                    exclusions: 0,
                    penaltyMissed: 0,
                    partidos: 0,
                    goalTypes: { 'h+': 0, penalty: 0, contra: 0, boya: 0, normal: 0 },
                    parades: 0,
                    paradeTypes: { corner: 0, rebuig: 0, atrapa: 0, penal: 0 },
                    assistencies: 0,
					infraccions2m: 0,
					contrafaltes: 0,
                    robatoris: 0,
                    perdues: 0,
                    xutsFallats: 0,
                    blocks: 0,
                    faltesRebudes: 0,
                    exclusionTypes: { normal: 0, penalty: 0 }
                };
                playerMatchAppearances[playerName] = new Set();
            }
            
            playerStats[playerName].num = j.numero;
            playerMatchAppearances[playerName].add(matchIndex);
            
            playerStats[playerName].gols += j.estadistiques.gols;
            playerStats[playerName].exclusions += j.estadistiques.exclusions;
            playerStats[playerName].penaltyMissed += (j.estadistiques.penaltyMissed || 0);
            playerStats[playerName].parades += (j.estadistiques.parades || 0);
            playerStats[playerName].assistencies += (j.estadistiques.assistencies || 0);
			playerStats[playerName].infraccions2m += (j.estadistiques.infraccions2m || 0);
			playerStats[playerName].contrafaltes += (j.estadistiques.contrafaltes || 0);
            playerStats[playerName].robatoris += (j.estadistiques.robatoris || 0);
            playerStats[playerName].perdues += (j.estadistiques.perdues || 0);
            playerStats[playerName].xutsFallats += (j.estadistiques.xutsFallats || 0);
            playerStats[playerName].blocks += (j.estadistiques.blocks || 0);
            playerStats[playerName].faltesRebudes += (j.estadistiques.faltesRebudes || 0);
            playerStats[playerName].blocatges += (j.estadistiques.blocatges || 0);
            
            if (j.estadistiques.goalTypes) {
                Object.keys(playerStats[playerName].goalTypes).forEach(type => {
                    playerStats[playerName].goalTypes[type] += j.estadistiques.goalTypes[type] || 0;
                });
            }
            
            if (j.estadistiques.exclusionTypes) {
                if (playerStats[playerName].exclusionTypes) {
                    Object.keys(playerStats[playerName].exclusionTypes).forEach(type => {
                        playerStats[playerName].exclusionTypes[type] += (j.estadistiques.exclusionTypes[type] || 0);
                    });
                }
            } else {
                if (!playerStats[playerName].exclusionTypes) {
                    playerStats[playerName].exclusionTypes = { normal: 0, penalty: 0 };
                }
            }
            
            if (j.estadistiques.paradeTypes) {
                Object.keys(playerStats[playerName].paradeTypes).forEach(type => {
                    playerStats[playerName].paradeTypes[type] += j.estadistiques.paradeTypes[type] || 0;
                });
            }
        });
    });
    
    Object.keys(playerStats).forEach(name => {
        playerStats[name].partidos = playerMatchAppearances[name].size;
    });

    const players = Object.values(playerStats).map(p => {
    const valor = calculatePlayerValue({
        gols: p.gols,
        goalTypes: p.goalTypes,
        assistencies: p.assistencies,
        infraccions2m: p.infraccions2m || 0,  // ✅ AFEGEIX AQUESTA LÍNIA
		contrafaltes: p.contrafaltes || 0,
        robatoris: p.robatoris,
        blocatges: p.blocks || 0,
        parades: p.parades,
        faltesRebudes: p.faltesRebudes || 0,
        exclusions: p.exclusions,
        exclusionTypes: p.exclusionTypes || { normal: 0, penalty: 0 },
        penaltyMissed: p.penaltyMissed,
        perdues: p.perdues,
        xutsFallats: p.xutsFallats
    });
    return { ...p, valor };
}).sort((a, b) => b.valor - a.valor);

    cachedPlayersData = players;
    currentSortColumn = 'valor';
    currentSortOrder = 'desc';

    renderComparisonTable(players);

    const topScorers = Object.values(playerStats)
        .filter(p => p.gols > 0)
        .sort((a, b) => b.gols - a.gols)
        .slice(0, 10);

    document.getElementById('allTimeScorers').innerHTML = topScorers.map((p, i) => {
        let rankClass = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
        return `
            <div class="top-scorer-item">
                <div class="player-info">
                    <div class="rank ${rankClass}">${i + 1}</div>
                    <div class="player-num">${p.num}</div>
                    <div class="player-name">${p.name}</div>
                </div>
                <div style="font-size: 24px; font-weight: bold; color: #fde047;">
                    ${p.gols} 🥅🏐
                </div>
            </div>
        `;
    }).join('');

    renderResultsEvolution();
    renderQuarterDifference();
    renderBestWorstMatches();
    renderRivalsHistory();

    // ============ RANKING MVP GLOBAL ============
    const playersWithAvgValue = Object.values(playerStats).map(p => {
        const valor = calculatePlayerValue({
            gols: p.gols,
            goalTypes: p.goalTypes,
            assistencies: p.assistencies,
			infraccions2m: p.infraccions2m || 0,
			contrafaltes: p.contrafaltes || 0,
            robatoris: p.robatoris,
            blocatges: p.blocks || 0,
            parades: p.parades,
            faltesRebudes: p.faltesRebudes || 0,
            exclusions: p.exclusions,
            exclusionTypes: p.exclusionTypes || { normal: 0, penalty: 0 },
            penaltyMissed: p.penaltyMissed,
            perdues: p.perdues,
            xutsFallats: p.xutsFallats
        });
        const avgValor = p.partidos > 0 ? valor / p.partidos : 0;
        return { ...p, valorTotal: valor, valorMitja: avgValor };
    }).sort((a, b) => b.valorTotal - a.valorTotal);

    const mvpContainer = document.createElement('div');
    mvpContainer.className = 'card';
    mvpContainer.innerHTML = `
        <h2 class="section-title">🏆 Ràn­­quing MVP de la Temporada</h2>
        <p style="font-size: 12px; color: #bae6fd; margin-bottom: 15px;">
            Top 10 jugadors amb millor valoració total acumulada
        </p>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
            ${playersWithAvgValue.slice(0, 10).map((player, index) => {
                const medals = ['🥇', '🥈', '🥉'];
                const colors = ['#fbbf24', '#d1d5db', '#d97706'];
                const borderColors = ['#f59e0b', '#9ca3af', '#ea580c'];
                const bgColors = [
                    'linear-gradient(135deg, rgba(251, 191, 36, 0.3), rgba(245, 158, 11, 0.1))',
                    'linear-gradient(135deg, rgba(209, 213, 219, 0.3), rgba(156, 163, 175, 0.1))',
                    'linear-gradient(135deg, rgba(217, 119, 6, 0.3), rgba(234, 88, 12, 0.1))'
                ];
                
                return `
                    <div style="background: ${index < 3 ? bgColors[index] : 'rgba(0,0,0,0.2)'}; 
                                padding: 15px; border-radius: 8px; 
                                border: ${index < 3 ? '3px' : '2px'} solid ${index < 3 ? borderColors[index] : 'rgba(255,255,255,0.2)'}; 
                                position: relative;">
                        <div style="position: absolute; top: 10px; right: 10px; font-size: ${index < 3 ? '36px' : '24px'};">
                            ${index < 3 ? medals[index] : `#${index + 1}`}
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                            <div class="player-num" style="width: ${index < 3 ? '45px' : '40px'}; height: ${index < 3 ? '45px' : '40px'}; font-size: ${index < 3 ? '20px' : '16px'};">${player.num}</div>
                            <div>
                                <div style="font-weight: bold; font-size: ${index < 3 ? '18px' : '16px'}; color: ${index < 3 ? colors[index] : '#fff'};">${player.name}</div>
                                <div style="font-size: 11px; color: #bae6fd;">
                                    Valor/Partit: <strong style="color: ${index < 3 ? colors[index] : '#22d3ee'};">${player.valorMitja.toFixed(1)}</strong>
                                </div>
                                <div style="font-size: 10px; color: #94a3b8;">
                                    ${player.partidos} partits • Total: ${player.valorTotal.toFixed(0)}
                                </div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(65px, 1fr)); gap: 6px;">
                            ${player.gols > 0 ? `
                                <div style="background: rgba(253, 224, 71, 0.2); padding: 4px; border-radius: 4px; text-align: center;">
                                    <div style="color: #bae6fd; font-size: 9px;">Gols</div>
                                    <div style="color: #fde047; font-weight: bold; font-size: 13px;">${player.gols}</div>
                                </div>
                            ` : ''}
                            ${(player.assistencies || 0) > 0 ? `
                                <div style="background: rgba(6, 182, 212, 0.2); padding: 4px; border-radius: 4px; text-align: center;">
                                    <div style="color: #bae6fd; font-size: 9px;">Assists</div>
                                    <div style="color: #06b6d4; font-weight: bold; font-size: 13px;">${player.assistencies}</div>
                                </div>
                            ` : ''}
                            ${(player.robatoris || 0) > 0 ? `
                                <div style="background: rgba(59, 130, 246, 0.2); padding: 4px; border-radius: 4px; text-align: center;">
                                    <div style="color: #bae6fd; font-size: 9px;">Rob</div>
                                    <div style="color: #3b82f6; font-weight: bold; font-size: 13px;">${player.robatoris}</div>
                                </div>
                            ` : ''}
                            ${(player.parades || 0) > 0 ? `
                                <div style="background: rgba(139, 92, 246, 0.2); padding: 4px; border-radius: 4px; text-align: center;">
                                    <div style="color: #bae6fd; font-size: 9px;">Parades</div>
                                    <div style="color: #8b5cf6; font-weight: bold; font-size: 13px;">${player.parades}</div>
                                </div>
                            ` : ''}
                            ${(player.faltesRebudes || 0) > 0 ? `
                                <div style="background: rgba(251, 191, 36, 0.2); padding: 4px; border-radius: 4px; text-align: center;">
                                    <div style="color: #bae6fd; font-size: 9px;">FR</div>
                                    <div style="color: #fbbf24; font-weight: bold; font-size: 13px;">${player.faltesRebudes}</div>
                                </div>
                            ` : ''}
							${(player.infraccions2m || 0) > 0 ? `
    <div style="background: rgba(251, 146, 60, 0.2); padding: 4px; border-radius: 4px; text-align: center;">
        <div style="color: #bae6fd; font-size: 9px;">2m</div>
        <div style="color: #fb923c; font-weight: bold; font-size: 13px;">${player.infraccions2m}</div>
    </div>
` : ''}
                            ${player.exclusions > 0 ? `
                                <div style="background: rgba(239, 68, 68, 0.2); padding: 4px; border-radius: 4px; text-align: center;">
                                    <div style="color: #bae6fd; font-size: 9px;">Exc</div>
                                    <div style="color: #ef4444; font-weight: bold; font-size: 13px;">${player.exclusions}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('')}
        </div>
    `;

    const comparisonTable = document.querySelector('#comparisonView');
    const tableCard = comparisonTable.querySelector('.card:has(#comparisonTable)');
    
    // ✅ ELIMINAR TOTS ELS MVP CONTAINERS ANTICS
    document.querySelectorAll('.card').forEach(card => {
        const title = card.querySelector('h2.section-title');
        if (title && title.textContent.includes('MVP de la Temporada')) {
            card.remove();
        }
    });
    
    if (tableCard) {
        tableCard.parentNode.insertBefore(mvpContainer, tableCard);
    }

    renderGoalsDistributionChart(playerStats);

    // ✅ ZONES DE GOL DELS JUGADORS
    renderGoalZoneStats();

    // ✅ ZONES DE GOLS REBUTS PELS PORTERS
    const goalkeeperZones = renderGoalkeeperZoneStats();

    const goalkeeperZonesHTML = `
        <div class="card" id="goalkeeperZonesCard">
            <h2 class="section-title">🧤 Anàlisi de Gols Rebuts pels Porters</h2>
            <p style="font-size: 12px; color: #bae6fd; margin-bottom: 15px;">
                On reben més gols els nostres porters
            </p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                ${[1, 13].map(gkNum => {
                    const gk = goalkeeperZones[gkNum];
                    if (gk.totalGolsRebuts === 0) return '';
                    
                    const zoneOrder = [
                        'top-left', 'top-center', 'top-right',
                        'mid-left', 'mid-center', 'mid-right',
                        'bottom-left', 'bottom-center', 'bottom-right'
                    ];
                    
                    const zoneLabels = {
                        'top-left': '⬆️ Esq',
                        'top-center': '⬆️ Centre',
                        'top-right': '⬆️ Dret',
                        'mid-left': '➡️ Esq',
                        'mid-center': '🎯 Centre',
                        'mid-right': '⬅️ Dret',
                        'bottom-left': '⬇️ Esq',
                        'bottom-center': '⬇️ Baix',
                        'bottom-right': '⬇️ Dret'
                    };
                    
                    const maxCount = Math.max(...zoneOrder.map(z => gk.zones[z] || 0));
                    
                    return `
                        <div style="background: rgba(0, 0, 0, 0.2); padding: 15px; border-radius: 8px;">
                            <div style="text-align: center; margin-bottom: 12px;">
                                <div style="font-size: 14px; font-weight: bold; color: #22d3ee;">
                                    ${gk.num}. ${gk.name.split(' ')[0]}
                                </div>
                                <div style="font-size: 12px; color: #bae6fd; margin-top: 4px;">
                                    Total gols rebuts: ${gk.totalGolsRebuts}
                                </div>
                            </div>
                            
                            <div class="goal-zone-heatmap">
                                ${zoneOrder.map(zone => {
                                    const count = gk.zones[zone] || 0;
                                    const percentage = gk.totalGolsRebuts > 0 ? 
                                        ((count / gk.totalGolsRebuts) * 100).toFixed(1) : 0;
                                    const intensity = maxCount > 0 ? count / maxCount : 0;
                                    const bgColor = getHeatmapColor(intensity);
                                    
                                    return `
                                        <div class="goal-zone-cell" style="background: ${bgColor};">
                                            <div class="zone-label">${zoneLabels[zone]}</div>
                                            <div class="zone-count">${count}</div>
                                            <div style="font-size: 9px; color: rgba(255,255,255,0.7);">
                                                ${percentage}%
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            
                            ${gk.zones.unknown > 0 ? `
                                <div style="text-align: center; margin-top: 10px; font-size: 11px; color: #bae6fd;">
                                    ❓ Gols sense zona: ${gk.zones.unknown}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
    `;

    // Inserir el HTML dels porters ABANS de la taula de comparació
    const comparisonTableCard = document.querySelector('#comparisonView .card:has(#comparisonTable)');
    if (comparisonTableCard) {
        const existingGKCard = document.getElementById('goalkeeperZonesCard');
        if (existingGKCard) {
            existingGKCard.remove();
        }
        comparisonTableCard.insertAdjacentHTML('beforebegin', goalkeeperZonesHTML);
    }

    // ✅ SWIM RACES I GOALKEEPER SAVES AL FINAL
    document.getElementById('swimRacesStatsContainer').innerHTML = renderSwimRacesStats();
    renderGoalkeeperSavesChart();
}
	

        function renderGoalsDistributionChart(playerStats) {
            const ctx = document.getElementById('goalsDistributionChart');
            
			if (!ctx) return;
            
            if (window.goalsDistributionChartInstance) {
                window.goalsDistributionChartInstance.destroy();
            }
            
            const topPlayers = Object.values(playerStats)
                .filter(p => p.gols > 0)
                .sort((a, b) => b.gols - a.gols)
                .slice(0, 8);
            
            const labels = topPlayers.map(p => `${p.num}. ${p.name.split(' ')[0]}`);
            const data = topPlayers.map(p => p.gols);
            
            const colors = [
                '#22d3ee', '#06b6d4', '#0891b2', '#0e7490',
                '#fde047', '#fbbf24', '#f59e0b', '#d97706'
            ];
            
            window.goalsDistributionChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#1e3a8a'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { 
                            display: true,
                            position: 'right',
                            labels: { 
                                color: 'white', 
                                font: { size: 12 },
                                padding: 10
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value} goles (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
function renderResultsEvolution() {
    const ctx = document.getElementById('resultsEvolutionChart');
    if (!ctx) return;
    
    if (window.resultsEvolutionChartInstance) {
        window.resultsEvolutionChartInstance.destroy();
    }
    
    if (allMatches.length === 0) return;
    
    // Ordenar partidos cronológicamente
    const sortedMatches = [...allMatches].sort((a, b) => new Date(a.data) - new Date(b.data));
    
    const labels = sortedMatches.map((m, i) => {
        const date = new Date(m.data);
        const rival = m.rivalTeam || 'Rival';
        return `${date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' })} vs ${rival.substring(0, 15)}`;
    });
    
    const goalDifferences = sortedMatches.map(m => m.scoreCNT - m.scoreRival);
    const colors = goalDifferences.map(diff => {
        if (diff > 0) return '#22c55e'; // Victoria
        if (diff < 0) return '#ef4444'; // Derrota
        return '#fbbf24'; // Empate
    });
    
    // Calcular racha actual
    let currentStreak = 0;
    let streakType = '';
    if (sortedMatches.length > 0) {
        const lastResult = sortedMatches[sortedMatches.length - 1].scoreCNT > sortedMatches[sortedMatches.length - 1].scoreRival ? 'win' : 
                          sortedMatches[sortedMatches.length - 1].scoreCNT < sortedMatches[sortedMatches.length - 1].scoreRival ? 'loss' : 'draw';
        
        for (let i = sortedMatches.length - 1; i >= 0; i--) {
            const result = sortedMatches[i].scoreCNT > sortedMatches[i].scoreRival ? 'win' : 
                          sortedMatches[i].scoreCNT < sortedMatches[i].scoreRival ? 'loss' : 'draw';
            if (result === lastResult) {
                currentStreak++;
            } else {
                break;
            }
        }
        streakType = lastResult === 'win' ? 'victorias' : lastResult === 'loss' ? 'derrotas' : 'empates';
    }
    
    window.resultsEvolutionChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Diferencia de Goles',
                data: goalDifferences,
                backgroundColor: colors,
                borderWidth: 1,
                borderColor: '#1e3a8a'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false },
                title: {
                    display: true,
                    text: `Racha actual: ${currentStreak} ${streakType}`,
                    color: 'white',
                    font: { size: 14, weight: 'bold' }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const diff = context.parsed.y;
                            const result = diff > 0 ? '✅ Victoria' : diff < 0 ? '❌ Derrota' : '🤝 Empate';
                            return `${result} (${diff > 0 ? '+' : ''}${diff})`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    title: {
                        display: true,
                        text: 'Diferencia de Goles',
                        color: 'white'
                    }
                },
                x: {
                    ticks: { 
                        color: 'white',
                        font: { size: 9 },
                        maxRotation: 45,
                        minRotation: 45
                    },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            }
        }
    });
}

// NUEVA: Diferencia de Goles por Cuarto
function renderQuarterDifference() {
    const ctx = document.getElementById('quarterDifferenceChart');
    if (!ctx) return;
    
    if (window.quarterDifferenceChartInstance) {
        window.quarterDifferenceChartInstance.destroy();
    }
    
    if (allMatches.length === 0) return;
    
    const quarterStats = {
        q1: { cnt: 0, rival: 0 },
        q2: { cnt: 0, rival: 0 },
        q3: { cnt: 0, rival: 0 },
        q4: { cnt: 0, rival: 0 }
    };
    
    allMatches.forEach(match => {
        ['q1', 'q2', 'q3', 'q4'].forEach(q => {
            quarterStats[q].cnt += match.periodScores[q].cnt;
            quarterStats[q].rival += match.periodScores[q].rival;
        });
    });
    
    const labels = ['1º Cuarto', '2º Cuarto', '3º Cuarto', '4º Cuarto'];
    const differences = ['q1', 'q2', 'q3', 'q4'].map(q => {
        const diff = quarterStats[q].cnt - quarterStats[q].rival;
        return (diff / allMatches.length).toFixed(2);
    });
    
    const colors = differences.map(diff => parseFloat(diff) >= 0 ? '#22c55e' : '#ef4444');
    
    window.quarterDifferenceChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Diferencia Promedio',
                data: differences,
                backgroundColor: colors,
                borderWidth: 1,
                borderColor: '#1e3a8a'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const q = ['q1', 'q2', 'q3', 'q4'][context.dataIndex];
                            const totalCNT = quarterStats[q].cnt;
                            const totalRival = quarterStats[q].rival;
                            return [
                                `Diferencia: ${context.parsed.y > 0 ? '+' : ''}${context.parsed.y}`,
                                `Total a favor: ${totalCNT}`,
                                `Total en contra: ${totalRival}`
                            ];
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    title: {
                        display: true,
                        text: 'Diferencia Promedio de Goles',
                        color: 'white'
                    }
                },
                x: {
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            }
        }
    });
}

// NUEVA: Mejores y Peores Partidos
function renderBestWorstMatches() {
    const container = document.getElementById('bestWorstGrid');
    if (!container) return;
    
    if (allMatches.length === 0) return;
    
    // Encontrar mejor victoria
    const bestWin = allMatches
        .filter(m => m.scoreCNT > m.scoreRival)
        .sort((a, b) => (b.scoreCNT - b.scoreRival) - (a.scoreCNT - a.scoreRival))[0];
    
    // Encontrar peor derrota
    const worstLoss = allMatches
        .filter(m => m.scoreCNT < m.scoreRival)
        .sort((a, b) => (a.scoreCNT - a.scoreRival) - (b.scoreCNT - b.scoreRival))[0];
    
    // Partido con más goles anotados
    const mostGoals = allMatches.sort((a, b) => b.scoreCNT - a.scoreCNT)[0];
    
    // Partido con menos goles recibidos (solo victorias)
    const bestDefense = allMatches
        .filter(m => m.scoreCNT > m.scoreRival)
        .sort((a, b) => a.scoreRival - b.scoreRival)[0];
    
    let html = '';
    
    if (bestWin) {
        const date = new Date(bestWin.data).toLocaleDateString('es-ES');
        html += `
            <div class="info-item">
                <div class="info-label">🏆 Mejor Victoria</div>
                <div class="info-value" style="color: #22c55e;">${bestWin.scoreCNT} - ${bestWin.scoreRival}</div>
                <div style="font-size: 10px; color: #bae6fd; margin-top: 4px;">
                    vs ${bestWin.rivalTeam || 'Rival'}<br>${date}
                </div>
            </div>
        `;
    }
    
    if (worstLoss) {
        const date = new Date(worstLoss.data).toLocaleDateString('es-ES');
        html += `
            <div class="info-item">
                <div class="info-label">😞 Peor Derrota</div>
                <div class="info-value" style="color: #ef4444;">${worstLoss.scoreCNT} - ${worstLoss.scoreRival}</div>
                <div style="font-size: 10px; color: #bae6fd; margin-top: 4px;">
                    vs ${worstLoss.rivalTeam || 'Rival'}<br>${date}
                </div>
            </div>
        `;
    }
    
    if (mostGoals) {
        const date = new Date(mostGoals.data).toLocaleDateString('es-ES');
        const result = mostGoals.scoreCNT > mostGoals.scoreRival ? 'win' : mostGoals.scoreCNT < mostGoals.scoreRival ? 'loss' : 'draw';
        html += `
            <div class="info-item">
                <div class="info-label">⚽ Más Goles Anotados</div>
                <div class="info-value ${result}">${mostGoals.scoreCNT} goles</div>
                <div style="font-size: 10px; color: #bae6fd; margin-top: 4px;">
                    vs ${mostGoals.rivalTeam || 'Rival'} (${mostGoals.scoreCNT}-${mostGoals.scoreRival})<br>${date}
                </div>
            </div>
        `;
    }
    
    if (bestDefense) {
        const date = new Date(bestDefense.data).toLocaleDateString('es-ES');
        html += `
            <div class="info-item">
                <div class="info-label">🛡️ Mejor Defensa</div>
                <div class="info-value" style="color: #22d3ee;">${bestDefense.scoreRival} goles</div>
                <div style="font-size: 10px; color: #bae6fd; margin-top: 4px;">
                    vs ${bestDefense.rivalTeam || 'Rival'} (${bestDefense.scoreCNT}-${bestDefense.scoreRival})<br>${date}
                </div>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

// NUEVA: Historial contra Rivales
function renderRivalsHistory() {
    const table = document.getElementById('rivalsHistoryTable');
    if (!table) return;
    
    if (allMatches.length === 0) return;
    
    const rivalsStats = {};
    
    allMatches.forEach(match => {
        const rival = match.rivalTeam || 'Rival Desconocido';
        
        if (!rivalsStats[rival]) {
            rivalsStats[rival] = {
                name: rival,
                played: 0,
                wins: 0,
                losses: 0,
                draws: 0,
                goalsFor: 0,
                goalsAgainst: 0,
                matches: []
            };
        }
        
        rivalsStats[rival].played++;
        rivalsStats[rival].goalsFor += match.scoreCNT;
        rivalsStats[rival].goalsAgainst += match.scoreRival;
        
        if (match.scoreCNT > match.scoreRival) {
            rivalsStats[rival].wins++;
        } else if (match.scoreCNT < match.scoreRival) {
            rivalsStats[rival].losses++;
        } else {
            rivalsStats[rival].draws++;
        }
        
        rivalsStats[rival].matches.push({
            date: match.data,
            score: `${match.scoreCNT}-${match.scoreRival}`,
            result: match.scoreCNT > match.scoreRival ? 'win' : match.scoreCNT < match.scoreRival ? 'loss' : 'draw'
        });
    });
    
    const rivals = Object.values(rivalsStats).sort((a, b) => b.played - a.played);
    
    table.innerHTML = `
        <thead>
            <tr>
                <th>Rival</th>
                <th>PJ</th>
                <th>V</th>
                <th>D</th>
                <th>E</th>
                <th>GF</th>
                <th>GC</th>
                <th>Dif</th>
                <th>%V</th>
                <th>Último Resultado</th>
            </tr>
        </thead>
        <tbody>
            ${rivals.map(r => {
                const diff = r.goalsFor - r.goalsAgainst;
                const winPercentage = r.played > 0 ? ((r.wins / r.played) * 100).toFixed(0) : 0;
                const lastMatch = r.matches.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                const lastDate = new Date(lastMatch.date).toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });
                
                return `
                    <tr>
                        <td><strong>${r.name}</strong></td>
                        <td>${r.played}</td>
                        <td class="win">${r.wins}</td>
                        <td class="loss">${r.losses}</td>
                        <td class="draw">${r.draws}</td>
                        <td>${r.goalsFor}</td>
                        <td>${r.goalsAgainst}</td>
                        <td style="color: ${diff > 0 ? '#22c55e' : diff < 0 ? '#ef4444' : '#fbbf24'}; font-weight: bold;">
                            ${diff > 0 ? '+' : ''}${diff}
                        </td>
                        <td>${winPercentage}%</td>
                        <td>
                            <span class="${lastMatch.result}">${lastMatch.score}</span>
                            <span style="font-size: 10px; color: #bae6fd; margin-left: 4px;">(${lastDate})</span>
                        </td>
                    </tr>
                `;
            }).join('')}
        </tbody>
    `;
}
        function renderTitularityHeatmapChart() {
            const ctx = document.getElementById('titularityHeatmapChart');
            if (!ctx) {
                console.log('Canvas no encontrado');
                return;
            }
            
            if (window.titularityHeatmapChartInstance) {
                window.titularityHeatmapChartInstance.destroy();
            }
            
            if (allMatches.length === 0) {
                console.log('No hay partidos cargados');
                return;
            }
            
            const titularStats = {};
            
            allMatches.forEach(match => {
                const quarters = ['q1', 'q2', 'q3', 'q4'];
                quarters.forEach(q => {
                    const lineup = match.lineups[q] || [];
                    lineup.forEach(playerNum => {
                        const player = match.jugadors.find(j => j.numero === playerNum);
                        if (player) {
                            const playerName = player.nom.trim();
                            if (!titularStats[playerName]) {
                                titularStats[playerName] = { num: player.numero, q1: 0, q2: 0, q3: 0, q4: 0 };
                            }
                            titularStats[playerName].num = player.numero;
                            titularStats[playerName][q]++;
                        }
                    });
                });
            });
            
            const players = Object.keys(titularStats)
                .sort((a, b) => {
                    const totalA = titularStats[a].q1 + titularStats[a].q2 + titularStats[a].q3 + titularStats[a].q4;
                    const totalB = titularStats[b].q1 + titularStats[b].q2 + titularStats[b].q3 + titularStats[b].q4;
                    return totalB - totalA;
                });
            
            if (players.length === 0) {
                console.log('No hay jugadores con titularidades');
                return;
            }
            
            console.log('Jugadores encontrados:', players.length);
            
            const quarters = ['1Q', '2Q', '3Q', '4Q'];
            const datasets = quarters.map((q, qIndex) => {
                const quarterKey = `q${qIndex + 1}`;
                return {
                    label: q,
                    data: players.map(p => titularStats[p][quarterKey]),
                    backgroundColor: ['#22d3ee', '#06b6d4', '#0891b2', '#0e7490'][qIndex]
                };
            });
            
           window.titularityHeatmapChartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
        labels: players.map(p => `${titularStats[p].num}. ${p.split(' ')[0]}`),
        datasets: datasets
    },
    options: {
        responsive: true,
        maintainAspectRatio: false, // ⬅️ CAMBIADO
        indexAxis: 'y',
        plugins: {
            legend: { 
                display: true,
                labels: { 
                    color: 'white', 
                    font: { size: window.innerWidth < 768 ? 10 : 14 } // ⬅️ AÑADIDO
                }
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return `${context.dataset.label}: ${context.parsed.x} veces titular`;
                    }
                }
            }
        },
        scales: {
            x: { 
                stacked: true,
                beginAtZero: true,
                ticks: { 
                    color: 'white', 
                    stepSize: 1,
                    font: { size: window.innerWidth < 768 ? 10 : 12 } // ⬅️ AÑADIDO
                },
                grid: { color: 'rgba(255,255,255,0.1)' },
                title: {
                    display: true,
                    text: 'Veces como Titular',
                    color: 'white',
                    font: { size: window.innerWidth < 768 ? 11 : 14 } // ⬅️ AÑADIDO
                }
            },
            y: { 
                stacked: true,
                ticks: { 
                    color: 'white', 
                    font: { size: window.innerWidth < 768 ? 9 : 11 }, // ⬅️ MODIFICADO
                    autoSkip: false // ⬅️ AÑADIDO - Muestra todas las etiquetas
                },
                grid: { color: 'rgba(255,255,255,0.1)' }
            }
        }
    }
});
        }

        function displayTitularStats() {
    const container = document.getElementById('titularView');
    
    if (allMatches.length === 0) {
        container.innerHTML = '<div class="no-data">No hay partidos cargados</div>';
        return;
    }

    const titularStats = {};
    
    allMatches.forEach(match => {
        const quarters = ['q1', 'q2', 'q3', 'q4'];
        quarters.forEach(q => {
            const lineup = match.lineups[q] || [];
            lineup.forEach(playerNum => {
                const player = match.jugadors.find(j => j.numero === playerNum);
                if (player) {
                    const playerName = player.nom.trim();
                    
                    if (!titularStats[playerName]) {
                        titularStats[playerName] = {
                            num: player.numero,
                            name: playerName,
                            q1: 0, q2: 0, q3: 0, q4: 0, total: 0
                        };
                    }
                    
                    titularStats[playerName].num = player.numero;
                    titularStats[playerName][q]++;
                    titularStats[playerName].total++;
                }
            });
        });
    });

    const players = Object.values(titularStats).sort((a, b) => b.total - a.total);

    container.innerHTML = `
        <h2 class="section-title">Veces como Titular por Cuarto</h2>
        <p style="margin-bottom: 15px; color: #bae6fd; font-size: 14px;">
            Basado en ${allMatches.length} partido${allMatches.length !== 1 ? 's' : ''}
        </p>
        <div class="titular-stats">
            ${players.map(p => `
                <div class="titular-item">
                    <div class="titular-header">
                        <div class="player-num">${p.num}</div>
                        <div style="flex: 1;">
                            <div class="player-name">${p.name}</div>
                            <div style="font-size: 12px; color: #bae6fd; margin-top: 4px;">
                                Total: <span class="total-badge">${p.total}</span>
                            </div>
                        </div>
                    </div>
                    <div class="titular-quarters">
                        <div class="quarter-badge">1Q: ${p.q1}</div>
                        <div class="quarter-badge">2Q: ${p.q2}</div>
                        <div class="quarter-badge">3Q: ${p.q3}</div>
                        <div class="quarter-badge">4Q: ${p.q4}</div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
    
    // Renderizar nuevos gráficos
    renderConsistencyChart();
    renderQuarterPatterns();
    renderPerformanceTable();
}

// NUEVA FUNCIÓN: Gráfico de Consistencia
function renderConsistencyChart() {
    const ctx = document.getElementById('consistencyChart');
    if (!ctx) return;
    
    if (window.consistencyChartInstance) {
        window.consistencyChartInstance.destroy();
    }
    
    if (allMatches.length === 0) return;
    
    const playerConsistency = {};
    const maxPossibleTitular = allMatches.length * 4; // 4 cuartos por partido
    
    allMatches.forEach(match => {
        match.jugadors.forEach(player => {
            const playerName = player.nom.trim();
            if (!playerConsistency[playerName]) {
                playerConsistency[playerName] = {
                    num: player.numero,
                    name: playerName,
                    titular: 0,
                    total: 0
                };
            }
            playerConsistency[playerName].total += 4; // 4 cuartos posibles
        });
        
        ['q1', 'q2', 'q3', 'q4'].forEach(q => {
            const lineup = match.lineups[q] || [];
            lineup.forEach(playerNum => {
                const player = match.jugadors.find(j => j.numero === playerNum);
                if (player) {
                    const playerName = player.nom.trim();
                    if (playerConsistency[playerName]) {
                        playerConsistency[playerName].titular++;
                    }
                }
            });
        });
    });
    
    const players = Object.values(playerConsistency)
        .map(p => ({
            ...p,
            percentage: p.total > 0 ? (p.titular / p.total * 100).toFixed(1) : 0
        }))
        .sort((a, b) => b.percentage - a.percentage);
    
    const labels = players.map(p => `${p.num}. ${p.name.split(' ')[0]}`);
    const data = players.map(p => parseFloat(p.percentage));
    
    // Colores según porcentaje
    const backgroundColors = data.map(percentage => {
        if (percentage >= 75) return '#22c55e'; // Verde - Titular habitual
        if (percentage >= 50) return '#fbbf24'; // Amarillo - Mixto
        if (percentage >= 25) return '#f97316'; // Naranja - Suplente habitual
        return '#ef4444'; // Rojo - Rara vez titular
    });
    
    window.consistencyChartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
        labels: labels,
        datasets: [{
            label: '% de Titularidad',
            data: data,
            backgroundColor: backgroundColors,
            borderWidth: 1,
            borderColor: '#1e3a8a'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false, // ⬅️ CAMBIADO
        indexAxis: 'y',
        plugins: {
            legend: { 
                display: false 
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        const player = players[context.dataIndex];
                        return [
                            `Titularidad: ${context.parsed.x}%`,
                            `Titular: ${player.titular}/${player.total} cuartos`
                        ];
                    }
                }
            }
        },
        scales: {
            x: {
                beginAtZero: true,
                max: 100,
                ticks: { 
                    color: 'white',
                    font: { size: window.innerWidth < 768 ? 10 : 12 }, // ⬅️ AÑADIDO
                    callback: function(value) {
                        return value + '%';
                    }
                },
                grid: { color: 'rgba(255,255,255,0.1)' },
                title: {
                    display: true,
                    text: 'Porcentaje de Titularidad',
                    color: 'white',
                    font: { size: window.innerWidth < 768 ? 11 : 14 } // ⬅️ AÑADIDO
                }
            },
            y: {
                ticks: { 
                    color: 'white', 
                    font: { size: window.innerWidth < 768 ? 9 : 11 }, // ⬅️ MODIFICADO
                    autoSkip: false // ⬅️ AÑADIDO - Muestra todas las etiquetas
                },
                grid: { color: 'rgba(255,255,255,0.1)' }
            }
        }
    }
});
}

// NUEVA FUNCIÓN: Titulars més habituals en forma de piscina
function renderQuarterPatterns() {
    const container = document.getElementById('quarterPatternsGrid');
    if (!container) return;
    
    if (allMatches.length === 0) return;
    
    const playerStarts = {};
    
    // Comptar quantes vegades cada jugador ha estat titular
    allMatches.forEach(match => {
        ['q1', 'q2', 'q3', 'q4'].forEach(q => {
            const lineup = match.lineups[q] || [];
            lineup.forEach(playerNum => {
                const player = match.jugadors.find(j => j.numero === playerNum);
                if (player) {
                    const playerName = player.nom.trim();
                    if (!playerStarts[playerName]) {
                        playerStarts[playerName] = {
                            num: player.numero,
                            name: playerName,
                            starts: 0
                        };
                    }
                    playerStarts[playerName].starts++;
                }
            });
        });
    });
    
    // Ordenar per vegades titular
    const sortedPlayers = Object.values(playerStarts)
        .sort((a, b) => b.starts - a.starts);
    
    // Agafar els 7 més habituals (1 porter + 6 jugadors)
    const goalkeeper = sortedPlayers.find(p => p.num === 1 || p.num === 13) || sortedPlayers[0];
    const fieldPlayers = sortedPlayers
        .filter(p => p.num !== goalkeeper.num)
        .slice(0, 6);
    
    const totalQuarters = allMatches.length * 4;
    
    // Calcular percentatges
    const goalkeeperPercent = ((goalkeeper.starts / totalQuarters) * 100).toFixed(0);
    
    container.innerHTML = `
        <div class="pool-container">
            <div class="pool-goal">
                <div style="font-size: 12px; color: #fca5a5; font-weight: bold;">PORTERIA</div>
            </div>
            
            <div class="pool-players">
                <!-- Porter -->
                <div class="pool-goalkeeper">
                    <div class="pool-player">
                        <div class="pool-player-num" style="background: #8b5cf6;">${goalkeeper.num}</div>
                        <div class="pool-player-name">${goalkeeper.name.split(' ')[0]}</div>
                        <div class="pool-player-stat">${goalkeeper.starts} titularitats (${goalkeeperPercent}%)</div>
                    </div>
                </div>
                
                <div class="pool-midfield">⚡ LÍNEA MITJA ⚡</div>
                
                <!-- Jugadors de camp (3+3) -->
                <div class="pool-field-players">
                    ${fieldPlayers.map(p => {
                        const percent = ((p.starts / totalQuarters) * 100).toFixed(0);
                        return `
                            <div class="pool-player">
                                <div class="pool-player-num">${p.num}</div>
                                <div class="pool-player-name">${p.name.split(' ')[0]}</div>
                                <div class="pool-player-stat">${p.starts} (${percent}%)</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 20px; padding-top: 15px; border-top: 2px dashed rgba(255, 255, 255, 0.3);">
                <div style="font-size: 11px; color: #bae6fd;">
                    💡 Basado en ${allMatches.length} partido${allMatches.length !== 1 ? 's' : ''} 
                    (${totalQuarters} cuartos totales)
                </div>
            </div>
        </div>
    `;
}

// NUEVA FUNCIÓN: Tabla de Rendimiento - CORREGIDA
function renderPerformanceTable() {
    const table = document.getElementById('performanceTable');
    if (!table) return;
    
    if (allMatches.length === 0) return;
    console.log('🎯 renderPerformanceTable - allMatches:', allMatches.length);
    const playerPerformance = {};
    
    allMatches.forEach(match => {
        match.jugadors.forEach(player => {
            const playerName = player.nom.trim();
            if (!playerPerformance[playerName]) {
                playerPerformance[playerName] = {
                    num: player.numero,
                    name: playerName,
                    titular: { teamGoalsFor: 0, teamGoalsAgainst: 0, quarters: 0 },
                    suplente: { teamGoalsFor: 0, teamGoalsAgainst: 0, quarters: 0 }
                };
            }
            
            // Analizar cuarto por cuarto
['q1', 'q2', 'q3', 'q4'].forEach(q => {
    // Validar que periodScores existeix i té les dades del quart
    if (!match.periodScores || !match.periodScores[q]) return;
    
    const isInLineup = match.lineups[q] && match.lineups[q].includes(player.numero);
    const quarterGoalsFor = match.periodScores[q].cnt || 0;
    const quarterGoalsAgainst = match.periodScores[q].rival || 0;
                
                if (isInLineup) {
                    // Es titular en este cuarto - contamos goles del EQUIPO
                    playerPerformance[playerName].titular.quarters++;
                    playerPerformance[playerName].titular.teamGoalsFor += quarterGoalsFor;
                    playerPerformance[playerName].titular.teamGoalsAgainst += quarterGoalsAgainst;
                } else {
                    // Es suplente en este cuarto - contamos goles del EQUIPO
                    playerPerformance[playerName].suplente.quarters++;
                    playerPerformance[playerName].suplente.teamGoalsFor += quarterGoalsFor;
                    playerPerformance[playerName].suplente.teamGoalsAgainst += quarterGoalsAgainst;
                }
            });
        });
    });
    console.log('🎯 playerPerformance object:', playerPerformance);
console.log('🎯 players array length:', Object.keys(playerPerformance).length);
    const players = Object.values(playerPerformance)
        .filter(p => p.titular.quarters > 0 || p.suplente.quarters > 0)
        .sort((a, b) => {
            const avgA = a.titular.quarters > 0 ? (a.titular.teamGoalsFor / a.titular.quarters) : 0;
            const avgB = b.titular.quarters > 0 ? (b.titular.teamGoalsFor / b.titular.quarters) : 0;
            return avgB - avgA;
        });
   console.log('🎯 Filtered players:', players.length);
console.log('🎯 First player example:', players[0]); 
    table.innerHTML = `
        <thead>
            <tr>
                <th rowspan="2">Nº</th>
                <th rowspan="2">Jugador</th>
                <th colspan="3" style="background: rgba(34, 197, 94, 0.3);">Cuando es Titular</th>
                <th colspan="3" style="background: rgba(239, 68, 68, 0.3);">Cuando es Suplente</th>
                <th rowspan="2">Dif GF/Q</th>
                <th rowspan="2">Dif GC/Q</th>
            </tr>
            <tr>
                <th style="background: rgba(34, 197, 94, 0.2);">Cuartos</th>
                <th style="background: rgba(34, 197, 94, 0.2);">GF/Q Equipo</th>
                <th style="background: rgba(34, 197, 94, 0.2);">GC/Q Equipo</th>
                <th style="background: rgba(239, 68, 68, 0.2);">Cuartos</th>
                <th style="background: rgba(239, 68, 68, 0.2);">GF/Q Equipo</th>
                <th style="background: rgba(239, 68, 68, 0.2);">GC/Q Equipo</th>
            </tr>
        </thead>
        <tbody>
            ${players.map(p => {
                const titularAvgGF = p.titular.quarters > 0 ? (p.titular.teamGoalsFor / p.titular.quarters).toFixed(2) : '-';
                const titularAvgGC = p.titular.quarters > 0 ? (p.titular.teamGoalsAgainst / p.titular.quarters).toFixed(2) : '-';
                
                const suplenteAvgGF = p.suplente.quarters > 0 ? (p.suplente.teamGoalsFor / p.suplente.quarters).toFixed(2) : '-';
                const suplenteAvgGC = p.suplente.quarters > 0 ? (p.suplente.teamGoalsAgainst / p.suplente.quarters).toFixed(2) : '-';
                
                // Diferencia de goles A FAVOR (cuando es titular vs suplente)
                // Positivo = metemos MÁS goles cuando es titular (bueno)
                // Negativo = metemos MENOS goles cuando es titular (malo)
                const diffGF = p.titular.quarters > 0 && p.suplente.quarters > 0 
                    ? ((p.titular.teamGoalsFor / p.titular.quarters) - (p.suplente.teamGoalsFor / p.suplente.quarters)).toFixed(2)
                    : '-';
                
                let diffGFColor = 'white';
                if (diffGF !== '-') {
                    // Verde si metemos MÁS goles cuando es titular (positivo)
                    // Rojo si metemos MENOS goles cuando es titular (negativo)
                    diffGFColor = parseFloat(diffGF) > 0 ? '#22c55e' : parseFloat(diffGF) < 0 ? '#ef4444' : '#fbbf24';
                }
                
                // Diferencia de goles EN CONTRA (cuando es titular vs suplente)
                // Positivo = recibimos MÁS goles cuando es titular (malo)
                // Negativo = recibimos MENOS goles cuando es titular (bueno)
                const diffGC = p.titular.quarters > 0 && p.suplente.quarters > 0 
                    ? ((p.titular.teamGoalsAgainst / p.titular.quarters) - (p.suplente.teamGoalsAgainst / p.suplente.quarters)).toFixed(2)
                    : '-';
                
                let diffGCColor = 'white';
                if (diffGC !== '-') {
                    // Verde si recibimos MENOS goles cuando es titular (negativo)
                    // Rojo si recibimos MÁS goles cuando es titular (positivo)
                    diffGCColor = parseFloat(diffGC) < 0 ? '#22c55e' : parseFloat(diffGC) > 0 ? '#ef4444' : '#fbbf24';
                }
                
                return `
                    <tr>
                        <td><div class="player-num" style="width: 30px; height: 30px; font-size: 12px;">${p.num}</div></td>
                        <td><strong>${p.name}</strong></td>
                        <td>${p.titular.quarters}</td>
                        <td><strong style="color: #fde047;">${titularAvgGF}</strong></td>
                        <td><strong style="color: #ef4444;">${titularAvgGC}</strong></td>
                        <td>${p.suplente.quarters}</td>
                        <td><strong style="color: #fde047;">${suplenteAvgGF}</strong></td>
                        <td><strong style="color: #ef4444;">${suplenteAvgGC}</strong></td>
                        <td style="color: ${diffGFColor}; font-weight: bold;">
                            ${diffGF !== '-' ? (diffGF > 0 ? '+' : '') + diffGF : '-'}
                        </td>
                        <td style="color: ${diffGCColor}; font-weight: bold;">
                            ${diffGC !== '-' ? (diffGC > 0 ? '+' : '') + diffGC : '-'}
                        </td>
                    </tr>
                `;
            }).join('')}
        </tbody>
    `;
}


function filterByPlayer() {
    const playerName = document.getElementById('filterPlayer').value;
    
    if (!playerName) {
        document.getElementById('playerStatsCard').classList.add('hidden');
        return;
    }
    
    const playerData = {
        name: playerName,
        num: 0,
        partidos: 0,
        gols: [],
        exclusions: [],
        dates: [],
        totalGols: 0,
        totalExclusions: 0,
        goalTypes: { 'h+': 0, penalty: 0, contra: 0, boya: 0, normal: 0 },
        penaltyMissed: 0,
        titular: { q1: 0, q2: 0, q3: 0, q4: 0 },
        totalParades: 0,
        bestParades: 0,
        paradeTypes: { corner: 0, rebuig: 0, atrapa: 0, penal: 0 },
        totalAssistencies: 0,
        totalRobatoris: 0,
        totalPerdues: 0,
        totalXutsFallats: 0,
        totalBlocks: 0,
        totalFaltesRebudes: 0,
        swimRacesWon: 0,
        swimRacesLost: 0,
        swimRacesTotal: 0
    };
    
    allMatches.forEach(match => {
        const player = match.jugadors.find(j => j.nom.trim() === playerName);
        
        if (player) {
            playerData.num = player.numero;
            playerData.partidos++;
            playerData.gols.push(player.estadistiques.gols);
            playerData.exclusions.push(player.estadistiques.exclusions);
            playerData.dates.push(new Date(match.data).toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' }));
            playerData.totalGols += player.estadistiques.gols;
            playerData.totalExclusions += player.estadistiques.exclusions;
            playerData.penaltyMissed += player.estadistiques.penaltyMissed || 0;
            playerData.totalParades += (player.estadistiques.parades || 0);
            playerData.totalAssistencies += (player.estadistiques.assistencies || 0);
            playerData.totalRobatoris += (player.estadistiques.robatoris || 0);
            playerData.totalPerdues += (player.estadistiques.perdues || 0);
            playerData.totalXutsFallats += (player.estadistiques.xutsFallats || 0);
            playerData.totalBlocks += (player.estadistiques.blocks || 0);
            playerData.totalFaltesRebudes += (player.estadistiques.faltesRebudes || 0);

            if (player.estadistiques.parades && player.estadistiques.parades > playerData.bestParades) {
                playerData.bestParades = player.estadistiques.parades;
            }

            if (player.estadistiques.paradeTypes) {
                Object.keys(playerData.paradeTypes).forEach(type => {
                    playerData.paradeTypes[type] += (player.estadistiques.paradeTypes[type] || 0);
                });
            }
            
            if (player.estadistiques.goalTypes) {
                Object.keys(playerData.goalTypes).forEach(type => {
                    playerData.goalTypes[type] += (player.estadistiques.goalTypes[type] || 0);
                });
            }
            
            ['q1', 'q2', 'q3', 'q4'].forEach(q => {
                if (match.lineups[q] && match.lineups[q].includes(player.numero)) {
                    playerData.titular[q]++;
                }
            });
        }
        
        // ✅ Comptar curses guanyades/perdudes (FORA del if player)
        if (match.chronologicalActions && playerData.num) {
            match.chronologicalActions.forEach(action => {
                if (action.type === 'swim-race' && action.playerNum === playerData.num) {
                    playerData.swimRacesTotal++;
                    if (action.result === 'win') {
                        playerData.swimRacesWon++;
                    } else {
                        playerData.swimRacesLost++;
                    }
                }
            });
        }
    });
    
    // ✅ Cridar displayPlayerStats amb les dades
    displayPlayerStats(playerData);
}
function renderPlayerGoalZones(data) {
     console.log('🥅 renderGoalkeeperReceivedZones CRIDAT amb:', data.name);   
    const goalsBreakdown = document.getElementById('playerGoalsBreakdown');
    
    if (!goalsBreakdown) return;
    
    let zonesContainer = document.getElementById('playerGoalZonesContainer');
    if (!zonesContainer) {
        zonesContainer = document.createElement('div');
        zonesContainer.id = 'playerGoalZonesContainer';
        zonesContainer.style.marginTop = '30px';
        goalsBreakdown.parentNode.insertBefore(zonesContainer, goalsBreakdown.nextSibling);
    }
    
    // Calcular zones totals del jugador
    const zones = {
        'top-left': 0, 'top-center': 0, 'top-right': 0,
        'mid-left': 0, 'mid-center': 0, 'mid-right': 0,
        'bottom-left': 0, 'bottom-center': 0, 'bottom-right': 0,
        'unknown': 0
    };
    
    allMatches.forEach(match => {
        const player = match.jugadors.find(j => j.nom.trim() === data.name);
        if (player && player.estadistiques.goalZones) {
            Object.keys(player.estadistiques.goalZones).forEach(zone => {
                zones[zone] = (zones[zone] || 0) + (player.estadistiques.goalZones[zone] || 0);
            });
        }
    });
    
    const totalGols = Object.values(zones).reduce((sum, count) => sum + count, 0) - zones.unknown;
    
    if (totalGols === 0) {
        zonesContainer.innerHTML = `
            <h3 class="section-title">🎯 Zones de Porteria</h3>
            <div class="no-data">No hi ha dades de zones disponibles</div>
        `;
        return;
    }
    
    const zoneOrder = [
        'top-left', 'top-center', 'top-right',
        'mid-left', 'mid-center', 'mid-right',
        'bottom-left', 'bottom-center', 'bottom-right'
    ];
    
    const zoneLabels = {
        'top-left': '⬆️ Esq', 'top-center': '⬆️ Centre', 'top-right': '⬆️ Dret',
        'mid-left': '➡️ Esq', 'mid-center': '🎯 Centre', 'mid-right': '⬅️ Dret',
        'bottom-left': '⬇️ Esq', 'bottom-center': '⬇️ Baix', 'bottom-right': '⬇️ Dret'
    };
    
    const maxCount = Math.max(...zoneOrder.map(z => zones[z] || 0));
    const preferredZone = zoneOrder.reduce((max, zone) => 
        (zones[zone] || 0) > (zones[max] || 0) ? zone : max, zoneOrder[0]);
    
    const preferredZoneNames = {
        'top-left': 'Dalt Esquerra', 'top-center': 'Dalt Centre', 'top-right': 'Dalt Dreta',
        'mid-left': 'Centre Esquerra', 'mid-center': 'Centre', 'mid-right': 'Centre Dreta',
        'bottom-left': 'Baix Esquerra', 'bottom-center': 'Baix Centre', 'bottom-right': 'Baix Dreta'
    };
    
    zonesContainer.innerHTML = `
        <h3 class="section-title">🎯 Zones de Porteria</h3>
        <div style="background: rgba(34, 211, 238, 0.1); padding: 12px; border-radius: 8px; margin-bottom: 15px; text-align: center;">
            <div style="font-size: 12px; color: #bae6fd;">Zona preferida</div>
            <div style="font-size: 18px; color: #22d3ee; font-weight: bold; margin-top: 4px;">
                ${preferredZoneNames[preferredZone]} (${zones[preferredZone]} gols)
            </div>
        </div>
        <div class="goal-zone-heatmap">
            ${zoneOrder.map(zone => {
                const count = zones[zone] || 0;
                const percentage = totalGols > 0 ? ((count / totalGols) * 100).toFixed(1) : 0;
                const intensity = maxCount > 0 ? count / maxCount : 0;
                const bgColor = getHeatmapColor(intensity);
                
                return `
                    <div class="goal-zone-cell" style="background: ${bgColor};">
                        <div class="zone-label">${zoneLabels[zone]}</div>
                        <div class="zone-count">${count}</div>
                        <div style="font-size: 9px; color: rgba(255,255,255,0.7);">${percentage}%</div>
                    </div>
                `;
            }).join('')}
        </div>
        ${zones.unknown > 0 ? `
            <div style="text-align: center; margin-top: 10px; font-size: 11px; color: #bae6fd;">
                ❓ Gols sense zona: ${zones.unknown}
            </div>
        ` : ''}
        <div style="text-align: center; margin-top: 10px; font-size: 12px; color: #fde047;">
            Total amb zona: ${totalGols} de ${data.totalGols} gols
        </div>
    `;
}
function renderGoalkeeperReceivedZones(data) {
console.log('🎯 renderPlayerGoalZones CRIDAT amb:', data.name);    
    
    const goalsBreakdown = document.getElementById('playerGoalsBreakdown');

    if (!goalsBreakdown) return;
    
    let zonesContainer = document.getElementById('goalkeeperReceivedZonesContainer');
    if (!zonesContainer) {
        zonesContainer = document.createElement('div');
        zonesContainer.id = 'goalkeeperReceivedZonesContainer';
        zonesContainer.style.marginTop = '30px';
        goalsBreakdown.parentNode.insertBefore(zonesContainer, goalsBreakdown.nextSibling);
    }
    
    // Calcular zones de gols rebuts
    const zones = {
        'top-left': 0, 'top-center': 0, 'top-right': 0,
        'mid-left': 0, 'mid-center': 0, 'mid-right': 0,
        'bottom-left': 0, 'bottom-center': 0, 'bottom-right': 0,
        'unknown': 0
    };
    
    let totalGolsRebuts = 0;
    
    allMatches.forEach(match => {
        const player = match.jugadors.find(j => j.numero === data.num);
        if (player && player.estadistiques.golsRebutsZones) {
            Object.keys(player.estadistiques.golsRebutsZones).forEach(zone => {
                const count = player.estadistiques.golsRebutsZones[zone] || 0;
                zones[zone] = (zones[zone] || 0) + count;
                totalGolsRebuts += count;
            });
        }
    });
    
    if (totalGolsRebuts === 0) {
        zonesContainer.innerHTML = `
            <h3 class="section-title">🥅 Zones de Gols Rebuts</h3>
            <div class="no-data">No hi ha dades de zones de gols rebuts</div>
        `;
        return;
    }
    
    const zoneOrder = [
        'top-left', 'top-center', 'top-right',
        'mid-left', 'mid-center', 'mid-right',
        'bottom-left', 'bottom-center', 'bottom-right'
    ];
    
    const zoneLabels = {
        'top-left': '⬆️E', 'top-center': '⬆️C', 'top-right': '⬆️D',
        'mid-left': '➡️E', 'mid-center': '🎯', 'mid-right': '⬅️D',
        'bottom-left': '⬇️E', 'bottom-center': '⬇️B', 'bottom-right': '⬇️D'
    };
    
    const maxCount = Math.max(...zoneOrder.map(z => zones[z] || 0));
    const weakestZone = zoneOrder.reduce((max, zone) => 
        (zones[zone] || 0) > (zones[max] || 0) ? zone : max, zoneOrder[0]);
    
    const weakestZoneNames = {
        'top-left': 'Dalt Esquerra', 'top-center': 'Dalt Centre', 'top-right': 'Dalt Dreta',
        'mid-left': 'Centre Esquerra', 'mid-center': 'Centre', 'mid-right': 'Centre Dreta',
        'bottom-left': 'Baix Esquerra', 'bottom-center': 'Baix Centre', 'bottom-right': 'Baix Dreta'
    };
    
    zonesContainer.innerHTML = `
        <h3 class="section-title">🥅 Zones de Gols Rebuts</h3>
        <div style="background: rgba(239, 68, 68, 0.1); padding: 12px; border-radius: 8px; margin-bottom: 15px; text-align: center;">
            <div style="font-size: 12px; color: #fca5a5;">Zona més feble</div>
            <div style="font-size: 18px; color: #ef4444; font-weight: bold; margin-top: 4px;">
                ${weakestZoneNames[weakestZone]} (${zones[weakestZone]} gols)
            </div>
        </div>
        <div class="goal-zone-heatmap">
            ${zoneOrder.map(zone => {
                const count = zones[zone] || 0;
                const percentage = totalGolsRebuts > 0 ? ((count / totalGolsRebuts) * 100).toFixed(1) : 0;
                const intensity = maxCount > 0 ? count / maxCount : 0;
                const bgColor = getHeatmapColor(intensity);
                
                return `
                    <div class="goal-zone-cell" style="background: ${bgColor};">
                        <div class="zone-label">${zoneLabels[zone]}</div>
                        <div class="zone-count">${count}</div>
                        <div style="font-size: 9px; color: rgba(255,255,255,0.7);">${percentage}%</div>
                    </div>
                `;
            }).join('')}
        </div>
        <div style="text-align: center; margin-top: 10px; font-size: 12px; color: #fca5a5;">
            Total de gols rebuts amb zona: ${totalGolsRebuts}
        </div>
    `;
}
function displayPlayerStats(data) {

	document.getElementById('playerStatsCard').classList.remove('hidden');
    document.getElementById('selectedPlayerName').textContent = `${data.num}. ${data.name}`;
    // ✅ NETEJA els contenidors de zones anteriors
    const oldGoalZones = document.getElementById('playerGoalZonesContainer');
    if (oldGoalZones) oldGoalZones.remove();
    
    const oldGkZones = document.getElementById('goalkeeperReceivedZonesContainer');
    if (oldGkZones) oldGkZones.remove();
    
    const avgGols = data.partidos > 0 ? (data.totalGols / data.partidos).toFixed(2) : 0;
    const avgExc = data.partidos > 0 ? (data.totalExclusions / data.partidos).toFixed(2) : 0;
    const totalTitular = data.titular.q1 + data.titular.q2 + data.titular.q3 + data.titular.q4;
    const maxPossibleTitular = data.partidos * 4;
    const titularPercentage = maxPossibleTitular > 0 ? ((totalTitular / maxPossibleTitular) * 100).toFixed(1) : 0;
    
    const bestMatch = Math.max(...data.gols);
    const bestMatchIndex = data.gols.indexOf(bestMatch);
    
    const isGoalkeeper = data.num === 1 || data.num === 13;

document.getElementById('playerSummaryGrid').innerHTML = `
    <div class="info-item">
        <div class="info-label">Partidos Jugados</div>
        <div class="info-value">${data.partidos}</div>
    </div>
    ${isGoalkeeper ? `
    <div class="info-item">
        <div class="info-label">🧤 Total Parades</div>
        <div class="info-value" style="color: #8b5cf6;">${data.totalParades || 0}</div>
    </div>
    <div class="info-item">
        <div class="info-label">Media Parades/Partido</div>
        <div class="info-value">${data.partidos > 0 ? (data.totalParades / data.partidos).toFixed(1) : '0.0'}</div>
    </div>
    ` : `
    <div class="info-item">
        <div class="info-label">Total Goles</div>
        <div class="info-value" style="color: #fde047;">${data.totalGols}</div>
    </div>
    <div class="info-item">
        <div class="info-label">Media Goles/Partido</div>
        <div class="info-value">${avgGols}</div>
    </div>
    `}
    ${!isGoalkeeper ? `
    <div class="info-item">
        <div class="info-label">🎯 Eficiència de Tir</div>
        <div class="info-value" style="color: ${(() => {
            const totalXuts = data.totalGols + (data.totalXutsFallats || 0);
            const efic = totalXuts > 0 ? (data.totalGols / totalXuts * 100) : 0;
            return efic >= 50 ? '#22c55e' : efic >= 30 ? '#fbbf24' : '#ef4444';
        })()};">
            ${(() => {
                const totalXuts = data.totalGols + (data.totalXutsFallats || 0);
                const efic = totalXuts > 0 ? (data.totalGols / totalXuts * 100).toFixed(1) : '0.0';
                return totalXuts > 0 ? `${data.totalGols}/${totalXuts} (${efic}%)` : '-';
            })()}
        </div>
    </div>
    ` : ''}
    <div class="info-item">
        <div class="info-label">Mejor Partido</div>
        <div class="info-value" style="color: #22c55e;">${isGoalkeeper ? (data.bestParades || 0) + ' parades' : bestMatch + ' goles'}</div>
    </div>
    <div class="info-item">
        <div class="info-label">Total Exclusiones</div>
        <div class="info-value" style="color: #f97316;">${data.totalExclusions}</div>
    </div>
    <div class="info-item">
        <div class="info-label">Media Exclusiones/Partido</div>
        <div class="info-value">${avgExc}</div>
    </div>
    <div class="info-item">
        <div class="info-label">🎯 Assistències</div>
        <div class="info-value" style="color: #22c55e;">${data.totalAssistencies || 0}</div>
    </div>
    <div class="info-item">
        <div class="info-label">🛡️ Robatoris</div>
        <div class="info-value" style="color: #06b6d4;">${data.totalRobatoris || 0}</div>
    </div>
    <div class="info-item">
        <div class="info-label">❌ Pèrdues</div>
        <div class="info-value" style="color: #ef4444;">${data.totalPerdues || 0}</div>
    </div>
    <div class="info-item">
        <div class="info-label">🎯❌ Xuts Fallats</div>
        <div class="info-value" style="color: #f97316;">${data.totalXutsFallats || 0}</div>
    </div>
    <div class="info-item">
        <div class="info-label">Penaltis Fallados</div>
        <div class="info-value" style="color: ${data.penaltyMissed === 0 ? '#22c55e' : '#ef4444'};">${data.penaltyMissed}</div>
    </div>
    <div class="info-item">
        <div class="info-label">Titularidad</div>
        <div class="info-value">${totalTitular}/${maxPossibleTitular} <span style="font-size: 14px;">(${titularPercentage}%)</span></div>
    </div>
    ${data.swimRacesTotal > 0 ? `
    <div class="info-item">
        <div class="info-label">🏊 Curses Guanyades</div>
        <div class="info-value" style="color: #22c55e;">${data.swimRacesWon}/${data.swimRacesTotal}</div>
    </div>
    <div class="info-item">
        <div class="info-label">% Curses</div>
        <div class="info-value" style="color: ${data.swimRacesTotal > 0 && (data.swimRacesWon / data.swimRacesTotal * 100) >= 50 ? '#22c55e' : '#ef4444'};">
            ${data.swimRacesTotal > 0 ? ((data.swimRacesWon / data.swimRacesTotal) * 100).toFixed(1) : '0'}%
        </div>
    </div>
    ` : ''}
`;

// Desglossament de gols o parades segons tipus de jugador
const goalLabels = {
    'h+': 'Superioridad (H+)',
    'penalty': 'Penaltis',
    'contra': 'Contraataques',
    'boya': 'Boya',
    'normal': 'Normales'
};

const paradeLabels = {
    'corner': 'Corner',
    'rebuig': 'Rebuig',
    'atrapa': 'Atrapa',
    'penal': 'Penal'
};
    
    if (isGoalkeeper) {
        // Per porters: mostrar parades
        document.getElementById('playerGoalsBreakdown').innerHTML = Object.keys(data.paradeTypes)
            .filter(type => data.paradeTypes[type] > 0)
            .map(type => `
                <div class="breakdown-item">
                    <div class="breakdown-label">${paradeLabels[type]}</div>
                    <div class="breakdown-value">${data.paradeTypes[type]}</div>
                    <div style="font-size: 11px; color: #bae6fd; margin-top: 4px;">
                        ${data.totalParades > 0 ? ((data.paradeTypes[type] / data.totalParades) * 100).toFixed(1) : 0}%
                    </div>
                </div>
            `).join('') || '<p class="no-data" style="padding: 20px;">No hay datos de tipos de parades</p>';
        
        // Canviar el títol
        const titleElement = document.querySelector('#playerStatsCard h3');
        if (titleElement && titleElement.textContent.includes('Desglose de Goles')) {
            titleElement.textContent = '🧤 Desglose de Parades';
        }
        
        // Zones de gols rebuts pels porters
        renderGoalkeeperReceivedZones(data);
        
    } else {
        // Per jugadors de camp: mostrar gols
        document.getElementById('playerGoalsBreakdown').innerHTML = Object.keys(data.goalTypes)
            .filter(type => data.goalTypes[type] > 0)
            .map(type => `
                <div class="breakdown-item">
                    <div class="breakdown-label">${goalLabels[type]}</div>
                    <div class="breakdown-value">${data.goalTypes[type]}</div>
                    <div style="font-size: 11px; color: #bae6fd; margin-top: 4px;">
                        ${data.totalGols > 0 ? ((data.goalTypes[type] / data.totalGols) * 100).toFixed(1) : 0}%
                    </div>
                </div>
            `).join('') || '<p class="no-data" style="padding: 20px;">No hay datos de tipos de goles</p>';
        
        // Zones de gols per jugadors de camp
        renderPlayerGoalZones(data);
    }
    
    renderPlayerEvolutionChart(data);
    renderPlayerExclusionsChart(data);
    
    document.getElementById('playerStatsCard').scrollIntoView({ behavior: 'smooth' });
}

function renderSwimRacesStats() {
    if (allMatches.length === 0) return;
    
    const swimStats = {};
    
    // Inicialitzar
    players.forEach(p => {
        swimStats[p.name] = { won: 0, lost: 0, total: 0 };
    });
    
    // Comptar curses
    allMatches.forEach(match => {
        if (match.chronologicalActions) {
            match.chronologicalActions.forEach(action => {
                if (action.type === 'swim-race' && action.team === 'cnt') {
                    const playerName = action.playerName;
                    if (swimStats[playerName]) {
                        swimStats[playerName].total++;
                        if (action.result === 'win') {
                            swimStats[playerName].won++;
                        } else {
                            swimStats[playerName].lost++;
                        }
                    }
                }
            });
        }
    });
    
    // Filtrar jugadors amb curses
    const playersWithSwims = Object.entries(swimStats)
        .filter(([name, data]) => data.total > 0)
        .sort((a, b) => b[1].won - a[1].won);
    
    if (playersWithSwims.length === 0) {
        return '<div class="no-data">No hi ha dades de curses</div>';
    }
    
    return `
        <div class="card">
            <h2 class="section-title">🏊 Estadístiques de Curses Inicials</h2>
            <div style="overflow-x: auto;">
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Jugador</th>
                            <th>🏆 Guanyades</th>
                            <th>❌ Perdudes</th>
                            <th>Total</th>
                            <th>% Èxit</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${playersWithSwims.map(([name, data]) => {
                            const percentage = ((data.won / data.total) * 100).toFixed(1);
                            const colorClass = percentage >= 50 ? '#22c55e' : '#ef4444';
                            return `
                                <tr>
                                    <td style="font-weight: bold;">${name.split(' ')[0]}</td>
                                    <td style="color: #22c55e; font-weight: bold;">${data.won}</td>
                                    <td style="color: #ef4444;">${data.lost}</td>
                                    <td>${data.total}</td>
                                    <td style="color: ${colorClass}; font-weight: bold;">${percentage}%</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
            <div style="margin-top: 15px; padding: 12px; background: rgba(34, 211, 238, 0.1); border-radius: 8px; text-align: center;">
                <div style="font-size: 12px; color: #bae6fd;">Millor cursador</div>
                <div style="font-size: 18px; color: #22d3ee; font-weight: bold; margin-top: 4px;">
                    ${playersWithSwims[0][0].split(' ')[0]} (${playersWithSwims[0][1].won}/${playersWithSwims[0][1].total})
                </div>
            </div>
        </div>
    `;
}
function renderPlayerEvolutionChart(data) {
    const ctx = document.getElementById('playerEvolutionChart');
    if (!ctx) return;
    
    if (window.playerEvolutionChartInstance) {
        window.playerEvolutionChartInstance.destroy();
    }
    
    window.playerEvolutionChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.dates,
            datasets: [{
                label: 'Goles por Partido',
                data: data.gols,
                borderColor: '#fde047',
                backgroundColor: 'rgba(253, 224, 71, 0.1)',
                tension: 0.3,
                fill: true,
                pointRadius: 5,
                pointHoverRadius: 7,
                pointBackgroundColor: '#fde047'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { 
                    display: true,
                    labels: { color: 'white', font: { size: 14 } }
                }
            },
            scales: {
                y: { 
                    beginAtZero: true,
                    ticks: { color: 'white', stepSize: 1 },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                },
                x: { 
                    ticks: { color: 'white', font: { size: 11 } },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            }
        }
    });
}

function renderPlayerExclusionsChart(data) {
    const ctx = document.getElementById('playerExclusionsChart');
    if (!ctx) return;
    
    if (window.playerExclusionsChartInstance) {
        window.playerExclusionsChartInstance.destroy();
    }
    
    window.playerExclusionsChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.dates,
            datasets: [{
                label: 'Exclusiones por Partido',
                data: data.exclusions,
                backgroundColor: '#f97316',
                borderColor: '#ea580c',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { 
                    display: true,
                    labels: { color: 'white', font: { size: 14 } }
                }
            },
            scales: {
                y: { 
                    beginAtZero: true,
                    ticks: { color: 'white', stepSize: 1 },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                },
                x: { 
                    ticks: { color: 'white', font: { size: 11 } },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            }
        }
    });
}

function clearPlayerFilter() {
    document.getElementById('filterPlayer').value = '';
    document.getElementById('playerStatsCard').classList.add('hidden');
}
function renderMatchTimeline() {
    const container = document.getElementById('matchTimeline');
    const swimRacesContainer = document.getElementById('matchSwimRacesContainer');
    const swimRacesCard = document.getElementById('swimRacesCard');
    
    if (!container || !currentMatch) return;
    
    // Verificar si hay acciones cronológicas guardadas
    if (!currentMatch.chronologicalActions || currentMatch.chronologicalActions.length === 0) {
        container.innerHTML = '<div class="no-timeline">⚠️ Este partido no tiene registro cronológico de acciones.<br><small style="margin-top: 8px; display: block;">Los partidos nuevos registrados con la app actualizada mostrarán las acciones en orden.</small></div>';
        
        if (swimRacesCard) swimRacesCard.style.display = 'none';
        return;
    }
    
    // ========== CÀLCUL DE TEMPS DE JOC PER QUART ==========
    // Funció per calcular temps de joc proporcional i temps real del quart
    function calculateTimes(action, quarterStats) {
        const quarter = action.quarter;
        const stats = quarterStats[quarter];
        
        if (!stats) return { gameMinutes: 0, gameSeconds: 0, realMinutes: 0, realSeconds: 0 };
        
        // Temps transcorregut des de l'inici del quart (en ms)
        const elapsedRealTime = action.timestamp - stats.firstTimestamp;
        
        // Durada real total del quart (en ms)
        const totalRealTime = stats.lastTimestamp - stats.firstTimestamp;
        
        // TEMPS DE JOC: proporció a 8 minuts
        const GAME_TIME_PER_QUARTER = 8 * 60 * 1000; // 8 minuts en ms
        const gameTime = (elapsedRealTime / totalRealTime) * GAME_TIME_PER_QUARTER;
        
        const gameMinutes = Math.floor(gameTime / 60000);
        const gameSeconds = Math.floor((gameTime % 60000) / 1000);
        
        // TEMPS REAL: temps transcorregut des de l'inici del quart
        const realMinutes = Math.floor(elapsedRealTime / 60000);
        const realSeconds = Math.floor((elapsedRealTime % 60000) / 1000);
        
        return { gameMinutes, gameSeconds, realMinutes, realSeconds };
    }
    
    // Calcular estadístiques de cada quart (primera i última acció)
    const quarterStats = {};
    const sortedActions = [...currentMatch.chronologicalActions]
        .sort((a, b) => a.timestamp - b.timestamp);
    
    sortedActions.forEach(action => {
        const quarter = action.quarter;
        if (!quarterStats[quarter]) {
            quarterStats[quarter] = {
                firstTimestamp: action.timestamp,
                lastTimestamp: action.timestamp
            };
        } else {
            quarterStats[quarter].lastTimestamp = action.timestamp;
        }
    });
    
    // ========== RENDERITZAR CURSES INICIALS ==========
    const swimRaces = currentMatch.chronologicalActions?.filter(a => a.type === 'swim-race') || [];

    if (swimRaces.length > 0 && swimRacesContainer && swimRacesCard) {
        const swimHTML = `
            ${swimRaces.map(race => {
                const icon = race.result === 'win' ? '✅' : '❌';
                const color = race.result === 'win' ? '#22c55e' : '#ef4444';
                const quarter = race.quarter.toUpperCase();
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; margin-bottom: 6px; background: rgba(0,0,0,0.2); border-radius: 6px; border-left: 3px solid ${color};">
                        <span style="color: #bae6fd; font-weight: 600; min-width: 80px;">${quarter}</span>
                        <span style="color: white; flex: 1; text-align: center;">${race.playerName.split(' ')[0]}</span>
                        <span style="color: ${color}; font-weight: bold; min-width: 100px; text-align: right;">${icon} ${race.result === 'win' ? 'Guanyada' : 'Perduda'}</span>
                    </div>
                `;
            }).join('')}
        `;
        
        swimRacesContainer.innerHTML = swimHTML;
        swimRacesCard.style.display = 'block';
    } else {
        if (swimRacesCard) swimRacesCard.style.display = 'none';
    }
 
    // ========== RENDERITZAR CRONOLOGIA DEL PARTIT ==========
    const goalTypeLabels = {
        'h+': 'Superioridad (H+)',
        'penalty': 'Penalty',
        'contra': 'Contraataque',
        'boya': 'Boya',
        'normal': 'Normal'
    };
    
    const quarterLabels = {
        'q1': '1º Cuarto',
        'q2': '2º Cuarto',
        'q3': '3º Cuarto',
        'q4': '4º Cuarto'
    };
    
    container.innerHTML = `
        <div class="timeline">
            ${sortedActions.map(action => {
                let detailText = '';
                let icon = '';
                let cssClass = '';
                const isRival = action.team === 'rival';
                const playerClass = isRival ? 'timeline-rival' : 'timeline-player';
                const teamName = isRival ? (currentMatch.rivalTeam || 'Rival') : 'CN Terrassa';
                
                // Calcular temps de joc i temps real del quart
                const { gameMinutes, gameSeconds, realMinutes, realSeconds } = calculateTimes(action, quarterStats);
                
                // Format de temps millorat amb etiquetes més clares
                const timeDisplay = `
                    <div style="font-size: 11px; margin-top: 6px; display: flex; gap: 12px;">
                        <span style="color: #22c55e; font-weight: 600;">
                            ⏱️ ${gameMinutes}:${gameSeconds.toString().padStart(2, '0')}
                            <span style="font-weight: 400; opacity: 0.7; font-size: 10px;"> temps joc</span>
                        </span>
                        <span style="color: #94a3b8;">
                            🕐 ${realMinutes}:${realSeconds.toString().padStart(2, '0')}
                            <span style="opacity: 0.7; font-size: 10px;"> temps real</span>
                        </span>
                    </div>
                `;
                
                // TIPUS D'ACCIONS
                if (action.type === 'action') {
                    if (action.actionType === 'robatori') {
                        icon = '🤚';
                        cssClass = 'goal';
                        detailText = 'Robatori';
                    } else if (action.actionType === 'perdua') {
                        icon = '🔄';
                        cssClass = 'exclusion';
                        detailText = 'Pèrdua de pilota';
                    } else if (action.actionType === 'assistencia') {
                        icon = '🎯';
                        cssClass = 'goal';
                        detailText = 'Assistència';
                    } else if (action.actionType === 'xut') {
                        icon = '🥅❌';
                        cssClass = 'exclusion';
                        detailText = 'Xut fallat';
                    } else if (action.actionType === 'block') {
                        icon = '🚫';
                        cssClass = 'goal';
                        detailText = 'Blocatge';
                    } else if (action.actionType === '2metres') {  // ✅ AFEGEIX AQUEST BLOC
						icon = '📏';
						cssClass = 'exclusion';
						detailText = 'Infracció 2 metres';
					}
                } else if (action.type === 'save') {
                    icon = '🧤';
                    cssClass = 'goal';
                    detailText = action.saveType === 'atrapa' ? 'Aturada - Atrapa' : 'Aturada - Desvia';
                } else if (action.type === 'goal') {
                    icon = '🥅🏐';
                    cssClass = 'goal';
                    detailText = `Gol ${goalTypeLabels[action.goalType]}`;
                } else if (action.type === 'exclusion') {
                    if (action.exclusionType === 'penalty') {
                        icon = '🔴🏐';
                        detailText = 'Penalty cometido';
                    } else {
                        icon = '🔴⏱️';
                        detailText = 'Exclusión 20 seg.';
                    }
                    cssClass = 'exclusion';
                    
                    if (isRival && action.faltaSobreJugador) {
                        const jugadorCNT = currentMatch.jugadors.find(j => j.numero == action.faltaSobreJugador);
                        if (jugadorCNT) {
                            detailText += ` <span style="font-size: 11px; opacity: 0.7;">(falta sobre ${jugadorCNT.numero}. ${jugadorCNT.nom.split(' ')[0]})</span>`;
                        }
                    }
                } else if (action.type === 'water-change') {
                    icon = action.action === 'in' ? '🏊🟢' : '🏊🔴';
                    cssClass = 'water-change';
                    detailText = action.action === 'in' ? 'Entra al agua' : 'Sale del agua';
                } else if (action.type === 'swim-race') {
                    icon = action.result === 'win' ? '🏊✅' : '🏊❌';
                    cssClass = action.result === 'win' ? 'goal' : 'exclusion';
                    detailText = `Cursa inici quart - ${action.result === 'win' ? 'Guanyada' : 'Perduda'}`;
                }
                
                return `
                    <div class="timeline-item ${cssClass}">
                        <div class="timeline-icon">${icon}</div>
                        <div class="timeline-content">
                            <div class="${playerClass}">
                                ${action.playerNum}. ${action.playerName}
                                <span style="font-size: 11px; opacity: 0.8;">(${teamName})</span>
                            </div>
                            <div class="timeline-detail">${detailText}</div>
                            ${timeDisplay}
                        </div>
                        <div class="timeline-quarter">${quarterLabels[action.quarter] || action.quarter}</div>
                    </div>
                `;
            }).join('')}
        </div>
    `;
}

function renderPlayingTimes() {
    const container = document.getElementById('playingTimesContainer');
    
    if (!container || !currentMatch) return;
    
    if (!currentMatch.playerWaterChanges || currentMatch.playerWaterChanges.length === 0 || !currentMatch.quarterStartTimes) {
        container.innerHTML = '<div class="no-data">⚠️ Aquest partit no té registre de temps de joc.</div>';
        return;
    }
    
    // Utilitzar la funció centralitzada
    const playerTimes = calculateMatchPlayingTimes(currentMatch);
    const players = Object.values(playerTimes).sort((a, b) => b.totalTime - a.totalTime);
    
    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }
    
    const maxTime = 32 * 60; // 32 minuts màxim
    
    // Els 7 amb més minuts
    const topPlayers = players.slice(0, 7);
    const goalkeeper = topPlayers.find(p => p.num === 1 || p.num === 13) || topPlayers[0];
    const fieldPlayers = topPlayers
        .filter(p => p.num !== goalkeeper.num)
        .slice(0, 6);
    
    container.innerHTML = `
        <div class="pool-container">
            <div class="pool-goal">
                <div style="font-size: 12px; color: #fca5a5; font-weight: bold;">PORTERIA</div>
            </div>
            
            <div class="pool-players">
                <!-- Porter -->
                <div class="pool-goalkeeper">
                    <div class="pool-player">
                        <div class="pool-player-num" style="background: #8b5cf6;">${goalkeeper.num}</div>
                        <div class="pool-player-name">${goalkeeper.name.split(' ')[0]}</div>
                        <div class="pool-player-stat">
                            ${formatTime(goalkeeper.totalTime)}
                        </div>
                        <div class="pool-player-stat" style="color: #fde047; font-weight: bold;">
                            ${((goalkeeper.totalTime / maxTime) * 100).toFixed(0)}%
                        </div>
                    </div>
                </div>
                
                <!-- Jugadors de camp -->
                <div class="pool-field-players">
                    ${fieldPlayers.map(p => {
                        const percentage = ((p.totalTime / maxTime) * 100).toFixed(0);
                        const opacity = 0.5 + (parseFloat(percentage) / 200);
                        return `
                            <div class="pool-player" style="opacity: ${opacity};">
                                <div class="pool-player-num">${p.num}</div>
                                <div class="pool-player-name">${p.name.split(' ')[0]}</div>
                                <div class="pool-player-stat">
                                    ${formatTime(p.totalTime)}
                                </div>
                                <div class="pool-player-stat" style="color: #fde047; font-weight: bold;">
                                    ${percentage}%
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
            
            <div class="pool-midfield">
                ━━━━━━━━━ MIG CAMP ━━━━━━━━━
            </div>
        </div>
        
        <p style="font-size: 12px; color: #bae6fd; margin-top: 15px; text-align: center;">
            🏊‍♂️ Els 7 jugadors amb més temps de joc en aquest partit<br>
            ⏱️ Temps màxim: 32 minuts (4 quarts × 8 minuts)
        </p>
        
        <details style="margin-top: 20px;">
            <summary style="cursor: pointer; color: #22d3ee; font-weight: bold; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                📊 Veure taula completa de temps
            </summary>
            <table class="stats-table" style="margin-top: 15px;">
                <thead>
                    <tr>
                        <th>Nº</th>
                        <th>Jugador</th>
                        <th>1Q</th>
                        <th>2Q</th>
                        <th>3Q</th>
                        <th>4Q</th>
                        <th>TOTAL</th>
                        <th>%</th>
                    </tr>
                </thead>
                <tbody>
                    ${players.map(p => {
                        const percentage = ((p.totalTime / maxTime) * 100).toFixed(1);
                        const color = percentage >= 75 ? '#22c55e' : percentage >= 50 ? '#fbbf24' : '#f97316';
                        
                        return `
                            <tr>
                                <td><div class="player-num" style="width: 30px; height: 30px; font-size: 12px;">${p.num}</div></td>
                                <td><strong>${p.name}</strong></td>
                                <td>${formatTime(p.q1)}</td>
                                <td>${formatTime(p.q2)}</td>
                                <td>${formatTime(p.q3)}</td>
                                <td>${formatTime(p.q4)}</td>
                                <td><strong style="color: #fde047;">${formatTime(p.totalTime)}</strong></td>
                                <td><strong style="color: ${color};">${percentage}%</strong></td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </details>
    `;
}
// ============================================
// FUNCIONES PARA ESTADÍSTICAS DE TIEMPO
// ============================================

function displayTimeStats() {
    console.log('=== displayTimeStats called ===');
    console.log('Total matches:', allMatches.length);
    console.log('allMatches:', allMatches);
    
    // Filtrar partidos con datos de tiempo
    matchesWithTime = allMatches.filter(m => {
        console.log('Checking match:', m.rivalTeam);
        console.log('- Has playerWaterChanges:', !!m.playerWaterChanges);
        console.log('- playerWaterChanges length:', m.playerWaterChanges ? m.playerWaterChanges.length : 0);
        console.log('- Has quarterStartTimes:', !!m.quarterStartTimes);
        
        // Excluir partidos sin datos de tiempo completos
        const hasTimeData = m.playerWaterChanges && 
                            m.playerWaterChanges.length > 0 && 
                            m.quarterStartTimes;
        
        if (!hasTimeData) {
            console.warn('Partido sin datos de tiempo completos:', m.rivalTeam);
        }
        
        return hasTimeData;
    });
    
    console.log('Matches with time data:', matchesWithTime.length);
    console.log('matchesWithTime:', matchesWithTime);
    
    if (matchesWithTime.length === 0) {
        document.getElementById('tiempoTab').innerHTML = `
            <div class="card">
                <div class="no-data">
                    <p style="color: #fbbf24; font-size: 18px; margin-bottom: 10px;">⚠️ No hay datos de tiempo disponibles</p>
                    <p style="font-size: 14px; color: #bae6fd;">
                        Los partidos deben tener registrados los cambios de agua (playerWaterChanges) y tiempos de cuarto (quarterStartTimes) para mostrar estas estadísticas.
                    </p>
                    <p style="font-size: 12px; color: #bae6fd; margin-top: 10px;">
                        Partidos cargados: ${allMatches.length}<br>
                        Partidos con datos de tiempo: 0
                    </p>
                </div>
            </div>
        `;
        return;
    }
    
    console.log('Calling populatePlayerTimeFilter...');
    populatePlayerTimeFilter();
    
    console.log('Calling renderTotalTimeChart...');
    renderTotalTimeChart();
    console.log('Calling renderGlobalTimePool...');
	renderGlobalTimePool();  // ← AFEGEIX AQUESTA LÍNIA
    console.log('Calling renderTimeHeatmapTable...');
    renderTimeHeatmapTable();
   
    console.log('Calling other render functions...');
    renderEfficiencyPerMinuteChart();
    renderMinutesDistributionChart();
    renderPlusMinusChart();
    renderLoadBalanceStats();
    renderQuarterAnalysisTable();
    renderPerformanceVsTimeChart();
    renderFatigueAnalysisTable();
    renderRotationStats();
    
    console.log('=== displayTimeStats finished ===');
}
function renderGlobalTimePool() {
    const container = document.getElementById('globalTimePoolContainer');
    if (!container || matchesWithTime.length === 0) return;
    
    // Calcular temps total per jugador
    const playerTotalTimes = {};
    
    matchesWithTime.forEach(match => {
        const playerTimes = calculateMatchPlayingTimes(match);
        Object.values(playerTimes).forEach(pt => {
            const key = `${pt.num}|${pt.name}`;
            if (!playerTotalTimes[key]) {
                playerTotalTimes[key] = {
                    num: pt.num,
                    name: pt.name,
                    totalTime: 0,
                    matches: 0
                };
            }
            playerTotalTimes[key].totalTime += pt.totalTime;
            playerTotalTimes[key].matches++;
        });
    });
    
    // Ordenar per temps total
    const sortedPlayers = Object.values(playerTotalTimes)
        .sort((a, b) => b.totalTime - a.totalTime);
    
    // Els 7 amb més minuts
    const topPlayers = sortedPlayers.slice(0, 7);
    const goalkeeper = topPlayers.find(p => p.num === 1 || p.num === 13) || topPlayers[0];
    const fieldPlayers = topPlayers
        .filter(p => p.num !== goalkeeper.num)
        .slice(0, 6);
    
    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }
    
    const maxPossibleTime = matchesWithTime.length * 32 * 60; // Tots els partits × 32 min
    
    container.innerHTML = `
        <div class="pool-container">
            <div class="pool-goal">
                <div style="font-size: 12px; color: #fca5a5; font-weight: bold;">PORTERIA</div>
            </div>
            
            <div class="pool-players">
                <!-- Porter -->
                <div class="pool-goalkeeper">
                    <div class="pool-player">
                        <div class="pool-player-num" style="background: #8b5cf6;">${goalkeeper.num}</div>
                        <div class="pool-player-name">${goalkeeper.name.split(' ')[0]}</div>
                        <div class="pool-player-stat">
                            ${formatTime(goalkeeper.totalTime)}
                        </div>
                        <div class="pool-player-stat" style="color: #fde047; font-weight: bold;">
                            ${goalkeeper.matches} partits
                        </div>
                        <div class="pool-player-stat" style="color: #bae6fd; font-size: 9px;">
                            ${formatTime(Math.round(goalkeeper.totalTime / goalkeeper.matches))}/partit
                        </div>
                    </div>
                </div>
                
                <!-- Jugadors de camp -->
                <div class="pool-field-players">
                    ${fieldPlayers.map(p => {
                        const avgTimePerMatch = p.totalTime / p.matches;
                        const percentage = ((avgTimePerMatch / (32 * 60)) * 100).toFixed(0);
                        const opacity = 0.5 + (parseFloat(percentage) / 200);
                        return `
                            <div class="pool-player" style="opacity: ${opacity};">
                                <div class="pool-player-num">${p.num}</div>
                                <div class="pool-player-name">${p.name.split(' ')[0]}</div>
                                <div class="pool-player-stat">
                                    ${formatTime(p.totalTime)}
                                </div>
                                <div class="pool-player-stat" style="color: #fde047; font-weight: bold;">
                                    ${p.matches} partits
                                </div>
                                <div class="pool-player-stat" style="color: #bae6fd; font-size: 9px;">
                                    ${formatTime(Math.round(avgTimePerMatch))}/partit
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
            
            <div class="pool-midfield">
                ━━━━━━━━━ MIG CAMP ━━━━━━━━━
            </div>
        </div>
        
        <p style="font-size: 12px; color: #bae6fd; margin-top: 15px; text-align: center;">
            🏊‍♂️ Els 7 jugadors amb més temps acumulat<br>
            📊 Partits analitzats: ${matchesWithTime.length}
        </p>
    `;
}
function populatePlayerTimeFilter() {
    const select = document.getElementById('filterPlayerTime');
    
    if (matchesWithTime.length === 0) return;
    
    const playerSet = new Set();
    
    matchesWithTime.forEach(match => {
        match.jugadors.forEach(j => {
            playerSet.add(JSON.stringify({ num: j.numero, name: j.nom.trim() }));
        });
    });
    
    const players = Array.from(playerSet)
        .map(p => JSON.parse(p))
        .sort((a, b) => a.num - b.num);
    
    select.innerHTML = '<option value="">Todos los jugadores</option>' +
    players.map(p => `<option value="${p.num}|${p.name}">${p.num}. ${p.name}</option>`).join('');
}

function filterByPlayerTime() {
    const playerValue = document.getElementById('filterPlayerTime').value;
    
    if (!playerValue) {
        document.getElementById('playerTimeStatsCard').classList.add('hidden');
        return;
    }
    
    // Parsejar el valor: "numero|nom"
    const [numero, ...nameParts] = playerValue.split('|');
    const nom = nameParts.join('|'); // Per si el nom conté "|"
    
    const player = {
        numero: parseInt(numero),
        nom: nom
    };
    
    const playerTimeData = calculatePlayerTimeData(player);
    displayPlayerTimeStats(playerTimeData);
}

function clearPlayerTimeFilter() {
    document.getElementById('filterPlayerTime').value = '';
    document.getElementById('playerTimeStatsCard').classList.add('hidden');
}

function calculatePlayerTimeData(player) {
    const data = {
        num: player.numero,
        name: player.nom,
        partidos: 0,
        totalTime: 0,
        timeByQuarter: { q1: 0, q2: 0, q3: 0, q4: 0 },
        timeByMatch: [],
        dates: [],
        gols: 0,
        exclusions: 0,
        titularTime: 0,
        suplenteTime: 0,
        titularGols: 0,
        suplenteGols: 0,
        titularExclusions: 0,
        suplenteExclusions: 0
    };
    
    matchesWithTime.forEach(match => {
        const matchPlayer = match.jugadors.find(j => j.numero === player.numero);
        if (!matchPlayer) return;
        
        data.partidos++;
        data.dates.push(match.data ? new Date(match.data).toLocaleDateString('ca-ES') : 'N/A');
        data.gols += matchPlayer.estadistiques?.gols || 0;
        data.exclusions += matchPlayer.estadistiques?.exclusions || 0;
        
        // Utilitzar la funció amb ponderació
        const matchTimes = calculateMatchPlayingTimes(match);
        const playerTime = matchTimes[player.numero];
        
        if (playerTime) {
            let matchTime = 0;
            
            ['q1', 'q2', 'q3', 'q4'].forEach(quarter => {
                const isTitular = match.lineups?.[quarter]?.includes(player.numero);
                const quarterTime = playerTime[quarter];
                
                data.timeByQuarter[quarter] += quarterTime;
                matchTime += quarterTime;
                
                if (isTitular) {
                    data.titularTime += quarterTime;
                } else {
                    data.suplenteTime += quarterTime;
                }
            });
            
            data.timeByMatch.push(matchTime);
            data.totalTime += matchTime;
        }
    });
    
    // Calcular proporció de gols/exclusions segons temps de titular/suplent
    if (data.totalTime > 0) {
        const titularRatio = data.titularTime / data.totalTime;
        data.titularGols = Math.round(data.gols * titularRatio);
        data.suplenteGols = data.gols - data.titularGols;
        data.titularExclusions = Math.round(data.exclusions * titularRatio);
        data.suplenteExclusions = data.exclusions - data.titularExclusions;
    }
    
    data.timeByMatch.reverse();
    data.dates.reverse();
    
    return data;
}
function displayPlayerTimeStats(data) {
    document.getElementById('playerTimeStatsCard').classList.remove('hidden');
    document.getElementById('selectedPlayerTimeName').textContent = `${data.num}. ${data.name}`;
    
    const avgTime = data.partidos > 0 ? (data.totalTime / data.partidos / 60).toFixed(1) : 0;
    const maxPossibleTime = data.partidos * 32;
    const timePercentage = maxPossibleTime > 0 ? ((data.totalTime / 60 / maxPossibleTime) * 100).toFixed(1) : 0;
    const goalsPerMinute = data.totalTime > 0 ? ((data.gols / (data.totalTime / 60))).toFixed(2) : 0;
    const exclusionsPerMinute = data.totalTime > 0 ? ((data.exclusions / (data.totalTime / 60))).toFixed(2) : 0;
    
  
    
    document.getElementById('playerTimeSummaryGrid').innerHTML = `
        <div class="info-item">
            <div class="info-label">Partidos con Datos</div>
            <div class="info-value">${data.partidos}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Tiempo Total Jugado</div>
            <div class="info-value" style="color: #fde047;">${formatTime(data.totalTime)}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Tiempo Promedio/Partido</div>
            <div class="info-value">${avgTime} min</div>
        </div>
        <div class="info-item">
            <div class="info-label">% del Tiempo Máximo</div>
            <div class="info-value" style="color: ${timePercentage >= 75 ? '#22c55e' : timePercentage >= 50 ? '#fbbf24' : '#f97316'};">${timePercentage}%</div>
        </div>
        <div class="info-item">
            <div class="info-label">Total Goles</div>
            <div class="info-value" style="color: #22c55e;">${data.gols}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Goles por Minuto</div>
            <div class="info-value">${goalsPerMinute}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Total Exclusiones</div>
            <div class="info-value" style="color: #f97316;">${data.exclusions}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Exclusiones por Minuto</div>
            <div class="info-value">${exclusionsPerMinute}</div>
        </div>
    `;
    
    // Eficiencia breakdown
    document.getElementById('playerEfficiencyBreakdown').innerHTML = `
        <div class="breakdown-item">
            <div class="breakdown-label">Goles / Minuto</div>
            <div class="breakdown-value" style="color: #22c55e;">${goalsPerMinute}</div>
        </div>
        <div class="breakdown-item">
            <div class="breakdown-label">Exclusiones / Minuto</div>
            <div class="breakdown-value" style="color: #f97316;">${exclusionsPerMinute}</div>
        </div>
        <div class="breakdown-item">
            <div class="breakdown-label">Ratio Gol/Exclusión</div>
            <div class="breakdown-value">${data.exclusions > 0 ? (data.gols / data.exclusions).toFixed(2) : data.gols}</div>
        </div>
    `;
    
    // Titular vs Suplente
    const titularMinutes = (data.titularTime / 60).toFixed(1);
    const suplenteMinutes = (data.suplenteTime / 60).toFixed(1);
    const titularGoalsPerMin = data.titularTime > 0 ? (data.titularGols / (data.titularTime / 60)).toFixed(2) : 0;
    const suplenteGoalsPerMin = data.suplenteTime > 0 ? (data.suplenteGols / (data.suplenteTime / 60)).toFixed(2) : 0;
    
    document.getElementById('playerTitularVsSuplenteGrid').innerHTML = `
        <div class="info-item">
            <div class="info-label">⚪ Tiempo como Titular</div>
            <div class="info-value" style="color: #22c55e;">${titularMinutes} min</div>
            <div style="font-size: 11px; color: #bae6fd; margin-top: 4px;">
                ${data.titularGols} goles (${titularGoalsPerMin}/min)
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">🔴 Tiempo como Suplente</div>
            <div class="info-value" style="color: #fbbf24;">${suplenteMinutes} min</div>
            <div style="font-size: 11px; color: #bae6fd; margin-top: 4px;">
                ${data.suplenteGols} goles (${suplenteGoalsPerMin}/min)
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">⚡ Diferencia Eficiencia</div>
            <div class="info-value" style="color: ${titularGoalsPerMin > suplenteGoalsPerMin ? '#22c55e' : '#ef4444'};">
                ${titularGoalsPerMin > suplenteGoalsPerMin ? '+ Titular' : '+ Suplente'}
            </div>
        </div>
    `;
    
    renderPlayerTimeEvolutionChart(data);
    renderPlayerTimeByQuarterChart(data);
    
    document.getElementById('playerTimeStatsCard').scrollIntoView({ behavior: 'smooth' });
}

function renderPlayerTimeEvolutionChart(data) {
    const ctx = document.getElementById('playerTimeEvolutionChart');
    if (!ctx) return;
    
    if (window.playerTimeEvolutionChartInstance) {
        window.playerTimeEvolutionChartInstance.destroy();
    }
    
    const timeInMinutes = data.timeByMatch.map(t => (t / 60).toFixed(1));
    
    window.playerTimeEvolutionChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.dates,
            datasets: [{
                label: 'Minutos Jugados',
                data: timeInMinutes,
                borderColor: '#06b6d4',
                backgroundColor: 'rgba(6, 182, 212, 0.1)',
                tension: 0.3,
                fill: true,
                pointRadius: 5,
                pointHoverRadius: 7,
                pointBackgroundColor: '#06b6d4'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { 
                    display: true,
                    labels: { color: 'white', font: { size: 14 } }
                }
            },
            scales: {
                y: { 
                    beginAtZero: true,
                    max: 32,
                    ticks: { color: 'white', stepSize: 4 },
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    title: {
                        display: true,
                        text: 'Minutos',
                        color: 'white'
                    }
                },
                x: { 
                    ticks: { color: 'white', font: { size: 11 } },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            }
        }
    });
}

function renderPlayerTimeByQuarterChart(data) {
    const ctx = document.getElementById('playerTimeByQuarterChart');
    if (!ctx) return;
    
    if (window.playerTimeByQuarterChartInstance) {
        window.playerTimeByQuarterChartInstance.destroy();
    }
    
    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }
    
    const labels = ['1º Cuarto', '2º Cuarto', '3º Cuarto', '4º Cuarto'];
    const timeData = [data.timeByQuarter.q1, data.timeByQuarter.q2, data.timeByQuarter.q3, data.timeByQuarter.q4];
    
    window.playerTimeByQuarterChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Tiempo Jugado (segundos)',
                data: timeData,
                backgroundColor: ['#22d3ee', '#06b6d4', '#0891b2', '#0e7490'],
                borderWidth: 1,
                borderColor: '#1e3a8a'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `Tiempo: ${formatTime(context.parsed.y)}`;
                        }
                    }
                }
            },
            scales: {
                y: { 
                    beginAtZero: true,
                    ticks: { 
                        color: 'white',
                        callback: function(value) {
                            return formatTime(value);
                        }
                    },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                },
                x: { 
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            }
        }
    });
}


// ============================================
// FUNCIONS AUXILIARS NECESSÀRIES (afegir ABANS de renderTotalTimeChart)
// ============================================

function getQuarterEndTimeHelper(quarterStartTimes, quarterRealEndTimes, quarter, quarterDuration) {
    // Prioritzar el temps real de finalització si existeix
    if (quarterRealEndTimes && quarterRealEndTimes[quarter]) {
        return quarterRealEndTimes[quarter];
    }
    
    // Si no existeix, utilitzar l'inici del següent quart
    const quarterOrder = ['q1', 'q2', 'q3', 'q4'];
    const currentIndex = quarterOrder.indexOf(quarter);
    
    if (currentIndex < 3) {
        const nextQuarter = quarterOrder[currentIndex + 1];
        if (quarterStartTimes[nextQuarter]) {
            return quarterStartTimes[nextQuarter];
        }
    }
    
    // Si no hi ha res, afegir 8 minuts a l'inici del quart
    return quarterStartTimes[quarter] + (quarterDuration * 1000);
}

function calculatePlayerWaterPercentage(playerNum, quarter, playerWaterChanges, quarterStartTime, quarterEndTime, lineups) {
    // Verificar si el jugador és titular
    const lineup = lineups ? lineups[quarter] : [];
    const isTitular = lineup && lineup.includes(playerNum);
    
    // Obtenir els canvis del jugador
    const qChanges = playerWaterChanges
        .filter(c => c.playerNum === playerNum && c.quarter === quarter)
        .sort((a, b) => a.timestamp - b.timestamp);
    
    // Si és titular i no té canvis → 100% del temps
    if (isTitular && qChanges.length === 0) {
        return 1.0; // 100%
    }
    
    // Si NO és titular i no té canvis → 0% del temps
    if (!isTitular && qChanges.length === 0) {
        return 0.0; // 0%
    }
    
    const totalQuarterTime = (quarterEndTime - quarterStartTime) / 1000;
    if (totalQuarterTime <= 0) {
        return 0.0;
    }
    
    // Netejar canvis duplicats consecutius
    const cleanChanges = [];
    let lastAction = null;
    qChanges.forEach(change => {
        if (change.action !== lastAction) {
            cleanChanges.push(change);
            lastAction = change.action;
        }
    });
    
    let timeInWater = 0;
    
    if (isTitular) {
        // Titular: comença dins
        let lastInTime = quarterStartTime;
        
        cleanChanges.forEach(change => {
            if (change.action === 'out') {
                timeInWater += (change.timestamp - lastInTime) / 1000;
                lastInTime = null;
            } else if (change.action === 'in') {
                lastInTime = change.timestamp;
            }
        });
        
        if (lastInTime !== null) {
            timeInWater += (quarterEndTime - lastInTime) / 1000;
        }
    } else {
        // Suplent: comença fora
        let lastInTime = null;
        
        cleanChanges.forEach(change => {
            if (change.action === 'in') {
                lastInTime = change.timestamp;
            } else if (change.action === 'out' && lastInTime !== null) {
                timeInWater += (change.timestamp - lastInTime) / 1000;
                lastInTime = null;
            }
        });
        
        if (lastInTime !== null) {
            timeInWater += (quarterEndTime - lastInTime) / 1000;
        }
    }
    
    // Retornar el percentatge (0.0 a 1.0)
    return Math.min(timeInWater / totalQuarterTime, 1.0);
}

/**
 * SUBSTITUIR L'EXISTENT: Calcula el temps real aplicant el percentatge als 8 minuts teòrics
 */
function calculateQuarterTimeForPlayerHelper(playerNum, quarter, playerWaterChanges, quarterStartTime, quarterEndTime, lineups) {
    const QUARTER_DURATION = 480; // 8 minuts = 480 segons
    
    if (!quarterStartTime) {
        return 0;
    }
    
    // Obtenir el percentatge de temps dins de l'aigua
    const percentage = calculatePlayerWaterPercentage(
        playerNum, 
        quarter, 
        playerWaterChanges, 
        quarterStartTime, 
        quarterEndTime, 
        lineups
    );
    
    // Aplicar aquest percentatge als 8 minuts teòrics
    const adjustedTime = QUARTER_DURATION * percentage;
    
    return Math.round(adjustedTime);
}

function calculateMatchPlayingTimes(match) {
    const playerTimes = {};
    const quarterDuration = 480; // 8 minuts en segons
    const totalQuarterTime = 3360; // 7 jugadors x 480 segons = 3360 segons
    
    // Inicialitzar jugadors
    match.jugadors.forEach(player => {
        playerTimes[player.numero] = {
            num: player.numero,
            name: player.nom,
            q1: 0,
            q2: 0,
            q3: 0,
            q4: 0,
            totalTime: 0,
            partidos: 1
        };
    });
    
    const quarters = ['q1', 'q2', 'q3', 'q4'];
    
    quarters.forEach(quarter => {
        const quarterStartTime = match.quarterStartTimes?.[quarter];
        if (!quarterStartTime) return;
        
        // Calcular el temps de finalització del quart
        const quarterOrder = ['q1', 'q2', 'q3', 'q4'];
        const currentIndex = quarterOrder.indexOf(quarter);
        let quarterEndTime;
        
        if (match.quarterRealEndTimes && match.quarterRealEndTimes[quarter]) {
            quarterEndTime = match.quarterRealEndTimes[quarter];
        } else if (currentIndex < 3) {
            const nextQuarter = quarterOrder[currentIndex + 1];
            if (match.quarterStartTimes[nextQuarter]) {
                quarterEndTime = match.quarterStartTimes[nextQuarter];
            } else {
                quarterEndTime = quarterStartTime + (quarterDuration * 1000);
            }
        } else {
            quarterEndTime = quarterStartTime + (quarterDuration * 1000);
        }
        
        const quarterChanges = match.playerWaterChanges
            .filter(c => c.quarter === quarter)
            .sort((a, b) => a.timestamp - b.timestamp);
        
        // Primer pas: calcular temps reals i identificar jugadors que juguen tot el quart
        const rawTimes = {};
        const playersFullQuarter = [];
        let sumRawTimesPartial = 0;
        
        match.jugadors.forEach(player => {
            const playerNum = player.numero;
            const isTitular = match.lineups?.[quarter]?.includes(playerNum);
            
            const playerChanges = quarterChanges.filter(c => c.playerNum === playerNum);
            
            // Eliminar canvis duplicats consecutius
            const cleanChanges = [];
            let lastAction = null;
            playerChanges.forEach(change => {
                if (change.action !== lastAction) {
                    cleanChanges.push(change);
                    lastAction = change.action;
                }
            });
            
            let timeInWater = 0;
            let playsFullQuarter = false;
            
            if (isTitular) {
                let lastInTime = quarterStartTime;
                
                cleanChanges.forEach(change => {
                    if (change.action === 'out' && lastInTime !== null) {
                        timeInWater += (change.timestamp - lastInTime) / 1000;
                        lastInTime = null;
                    } else if (change.action === 'in') {
                        lastInTime = change.timestamp;
                    }
                });
                
                if (lastInTime !== null) {
                    timeInWater += (quarterEndTime - lastInTime) / 1000;
                }
                
                // Si és titular i no té canvis d'out, juga tot el quart
               if (timeInWater > 847) {
    playsFullQuarter = true;
}
                console.log(`Jugador ${playerNum}: ${timeInWater.toFixed(0)}s, Titular: ${isTitular}, Canvis: ${cleanChanges.length}, Juga complet: ${playsFullQuarter}`);
            } else {
                let lastInTime = null;
                
                cleanChanges.forEach(change => {
                    if (change.action === 'in') {
                        lastInTime = change.timestamp;
                    } else if (change.action === 'out' && lastInTime !== null) {
                        timeInWater += (change.timestamp - lastInTime) / 1000;
                        lastInTime = null;
                    }
                });
                
                if (lastInTime !== null) {
                    timeInWater += (quarterEndTime - lastInTime) / 1000;
                }
            }
            console.log(`Jugador ${playerNum}: ${timeInWater.toFixed(0)}s, Titular: ${isTitular}, Canvis: ${cleanChanges.length}, Juga complet: ${playsFullQuarter}`);
            rawTimes[playerNum] = Math.max(0, Math.min(timeInWater, quarterDuration));
            
            if (playsFullQuarter) {
                playersFullQuarter.push(playerNum);
            } else {
                sumRawTimesPartial += rawTimes[playerNum];
            }
        });
        
        // Segon pas: assignar temps
        const timeUsedByFullQuarter = playersFullQuarter.length * quarterDuration;
        const remainingTime = totalQuarterTime - timeUsedByFullQuarter;
        
        match.jugadors.forEach(player => {
            const playerNum = player.numero;
            
            if (playersFullQuarter.includes(playerNum)) {
                // Jugador que juga tot el quart: exactament 480 segons
                playerTimes[playerNum][quarter] = quarterDuration;
            } else {
                // Jugador parcial: ponderar amb el temps restant
                if (sumRawTimesPartial > 0) {
                    const adjustedTime = Math.round((rawTimes[playerNum] / sumRawTimesPartial) * remainingTime);
                    playerTimes[playerNum][quarter] = adjustedTime;
                } else {
                    playerTimes[playerNum][quarter] = 0;
                }
            }
            
            playerTimes[playerNum].totalTime += playerTimes[playerNum][quarter];
        });
    });
    
    return playerTimes;
}

function renderTotalTimeChart() {
    const ctx = document.getElementById('totalTimeChart');
    if (!ctx) return;
    
    if (window.totalTimeChartInstance) {
        window.totalTimeChartInstance.destroy();
    }
    
    const playerTimes = {};
    
    matchesWithTime.forEach(match => {
        // Utilitzar la funció amb ponderació
        const matchTimes = calculateMatchPlayingTimes(match);
        
        Object.values(matchTimes).forEach(playerTime => {
            const playerName = playerTime.name.trim();
            
            if (!playerTimes[playerName]) {
                playerTimes[playerName] = {
                    num: playerTime.num,
                    name: playerName,
                    totalTime: 0,
                    partidos: 0
                };
            }
            
            playerTimes[playerName].totalTime += playerTime.totalTime;
            playerTimes[playerName].partidos += 1;
        });
    });
    
    const players = Object.values(playerTimes)
        .sort((a, b) => b.totalTime - a.totalTime)
        .slice(0, 15);
    
    document.getElementById('timeChartSubtitle').textContent = 
        `Basado en ${matchesWithTime.length} partido(s) con datos de tiempo`;
    
    window.totalTimeChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: players.map(p => `${p.num}. ${p.name}`),
            datasets: [{
                label: 'Tiempo Total (segundos)',
                data: players.map(p => p.totalTime),
                backgroundColor: 'rgba(34, 211, 238, 0.7)',
                borderColor: 'rgba(34, 211, 238, 1)',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const seconds = context.parsed.y;
                            const minutes = Math.floor(seconds / 60);
                            const secs = seconds % 60;
                            return `${minutes}:${secs.toString().padStart(2, '0')} minutos`;
                        }
                    }
                }
            },
            scales: {
                y: { 
                    beginAtZero: true,
                    ticks: { 
                        color: 'white',
                        callback: function(value) {
                            return formatTime(value);
                        }
                    },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                },
                x: { 
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            }
        }
    });
}
function renderTimeHeatmapTable() {
    const table = document.getElementById('timeHeatmapTable');
    if (!table) return;
    
    const playerTimes = {};
    
    matchesWithTime.forEach(match => {
        // Utilitzar la funció amb ponderació
        const matchTimes = calculateMatchPlayingTimes(match);
        
        Object.values(matchTimes).forEach(playerTime => {
            const playerName = playerTime.name.trim();
            
            if (!playerTimes[playerName]) {
                playerTimes[playerName] = {
                    num: playerTime.num,
                    name: playerName,
                    q1: 0, q2: 0, q3: 0, q4: 0, total: 0
                };
            }
            
            playerTimes[playerName].q1 += playerTime.q1;
            playerTimes[playerName].q2 += playerTime.q2;
            playerTimes[playerName].q3 += playerTime.q3;
            playerTimes[playerName].q4 += playerTime.q4;
            playerTimes[playerName].total += playerTime.totalTime;
        });
    });
    
    const players = Object.values(playerTimes).sort((a, b) => b.total - a.total);
    
    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }
    
    function getHeatColor(seconds, maxSeconds) {
        const ratio = seconds / maxSeconds;
        if (ratio >= 0.75) return 'background: rgba(34, 197, 94, 0.3);';
        if (ratio >= 0.5) return 'background: rgba(251, 191, 36, 0.3);';
        if (ratio >= 0.25) return 'background: rgba(249, 115, 22, 0.3);';
        return 'background: rgba(239, 68, 68, 0.3);';
    }
    
    const maxTime = Math.max(...players.map(p => p.total));
    
    const quarterTotals = { q1: 0, q2: 0, q3: 0, q4: 0, total: 0 };
    players.forEach(p => {
        quarterTotals.q1 += p.q1;
        quarterTotals.q2 += p.q2;
        quarterTotals.q3 += p.q3;
        quarterTotals.q4 += p.q4;
        quarterTotals.total += p.total;
    });
    
    table.innerHTML = `
        <thead>
            <tr>
                <th>Nº</th>
                <th>Jugador</th>
                <th>1Q</th>
                <th>2Q</th>
                <th>3Q</th>
                <th>4Q</th>
                <th>TOTAL</th>
            </tr>
        </thead>
        <tbody>
            ${players.map(p => `
                <tr>
                    <td><div class="player-num" style="width: 30px; height: 30px; font-size: 12px;">${p.num}</div></td>
                    <td><strong>${p.name}</strong></td>
                    <td style="${getHeatColor(p.q1, maxTime / 4)}">${formatTime(p.q1)}</td>
                    <td style="${getHeatColor(p.q2, maxTime / 4)}">${formatTime(p.q2)}</td>
                    <td style="${getHeatColor(p.q3, maxTime / 4)}">${formatTime(p.q3)}</td>
                    <td style="${getHeatColor(p.q4, maxTime / 4)}">${formatTime(p.q4)}</td>
                    <td style="background: rgba(34, 211, 238, 0.3);"><strong>${formatTime(p.total)}</strong></td>
                </tr>
            `).join('')}
            <tr style="background: rgba(34, 211, 238, 0.2); font-weight: bold; border-top: 2px solid #22d3ee;">
                <td colspan="2">TOTAL PER QUART</td>
                <td>${formatTime(quarterTotals.q1)}</td>
                <td>${formatTime(quarterTotals.q2)}</td>
                <td>${formatTime(quarterTotals.q3)}</td>
                <td>${formatTime(quarterTotals.q4)}</td>
                <td>${formatTime(quarterTotals.total)}</td>
            </tr>
            <tr style="background: rgba(251, 191, 36, 0.2); font-weight: bold;">
                <td colspan="2">ESPERAT (7 jug × 8 min)</td>
                <td>56:00</td>
                <td>56:00</td>
                <td>56:00</td>
                <td>56:00</td>
                <td>224:00</td>
            </tr>
        </tbody>
    `;
}
  
function renderEfficiencyPerMinuteChart() {
    const ctx = document.getElementById('efficiencyPerMinuteChart');
    if (!ctx) return;
    
    if (window.efficiencyPerMinuteChartInstance) {
        window.efficiencyPerMinuteChartInstance.destroy();
    }
    
    const playerStats = {};
    
    matchesWithTime.forEach(match => {
        // Utilitzar la funció centralitzada
        const playerTimes = calculateMatchPlayingTimes(match);
        
        Object.values(playerTimes).forEach(playerTime => {
            const player = match.jugadors.find(j => j.numero === playerTime.num);
            if (!player) return;
            
            const playerName = playerTime.name;
            
            if (!playerStats[playerName]) {
                playerStats[playerName] = {
                    num: playerTime.num,
                    name: playerName,
                    totalTime: 0,
                    gols: 0,
                    exclusions: 0
                };
            }
            
            playerStats[playerName].totalTime += playerTime.total;
            playerStats[playerName].gols += player.estadistiques.gols;
            playerStats[playerName].exclusions += player.estadistiques.exclusions;
        });
    });
    
    const players = Object.values(playerStats)
        .filter(p => p.totalTime > 0)
        .map(p => ({
            ...p,
            goalsPerMinute: (p.gols / (p.totalTime / 60)).toFixed(2),
            exclusionsPerMinute: (p.exclusions / (p.totalTime / 60)).toFixed(2)
        }))
        .sort((a, b) => b.goalsPerMinute - a.goalsPerMinute);
    
    const labels = players.map(p => `${p.num}. ${p.name.split(' ')[0]}`);
    const goalsData = players.map(p => parseFloat(p.goalsPerMinute));
    const exclusionsData = players.map(p => parseFloat(p.exclusionsPerMinute));
    
    window.efficiencyPerMinuteChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Goles/Minuto',
                    data: goalsData,
                    backgroundColor: '#22c55e',
                    borderWidth: 1,
                    borderColor: '#1e3a8a'
                },
                {
                    label: 'Exclusiones/Minuto',
                    data: exclusionsData,
                    backgroundColor: '#f97316',
                    borderWidth: 1,
                    borderColor: '#1e3a8a'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            indexAxis: 'y',
            plugins: {
                legend: { 
                    display: true,
                    labels: { color: 'white', font: { size: 14 } }
                }
            },
            scales: {
                x: { 
                    beginAtZero: true,
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                },
                y: { 
                    ticks: { color: 'white', font: { size: 11 } },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            }
        }
    });
}
// Función para calcular valoración de jugador
function calculatePlayerValue(stats) {
    // Assegurar que stats existeix
    if (!stats) return 0;
    
    // Obtenir estadístiques amb valors per defecte
    const gols = stats.gols ?? 0;
    const goalTypes = stats.goalTypes || {};
    const exclusionTypes = stats.exclusionTypes || {};
    const paradeTypes = stats.paradeTypes || {};
    
    // Accions positives
    const normalGoals = (goalTypes.normal || 0) + (goalTypes['h+'] || 0) + 
                       (goalTypes.contra || 0) + (goalTypes.boya || 0);
    const penaltyGoals = goalTypes.penalty || 0;
    
    // Altres accions positives
    const assists = stats.assistencies || stats.assists || 0;
    const steals = stats.robatoris || stats.steals || 0;
    const blocks = stats.blocks || stats.blocatges || 0;
    const foulsReceived = stats.faltesRebudes || stats.foulReceived || 0;
    
    // ⚠️ CANVI: Parades ara sumen +1 (abans +2)
    const saves = (paradeTypes.corner || 0) + (paradeTypes.rebuig || 0) + 
                 (paradeTypes.atrapa || 0);
    const penaltySaves = paradeTypes.penal || 0;
    
    // Accions negatives
    const exclusions = stats.exclusions || 0;
    const penaltyMissed = stats.penaltyMissed || 0;
    const turnovers = stats.perdues || stats.turnovers || 0;
    const shotsMissed = stats.xutsFallats || stats.shotsMissed || 0;
    
    // ⚠️ NOU: Gols rebuts pel porter
    const golsRebuts = stats.golsRebuts || 0;
    
    // CÀLCUL DEL VALOR
    let valor = 0;
    
    // Positives
    valor += normalGoals * 2;      // Gols normals: +2
    valor += penaltyGoals * 1;     // Gols penalty: +1
    valor += assists * 1;          // Assistències: +1
    valor += steals * 1;           // Robatoris: +1
    valor += blocks * 1;           // Blocks: +1
    valor += saves * 1;            // ⚠️ CANVI: Parades: +1 (abans +2)
    valor += penaltySaves * 2;     // ⚠️ CANVI: Parades penalty: +2 (abans +3)
    valor += foulsReceived * 1;    // Faltes rebudes: +1
    
    // Negatives
    valor += exclusions * (-1);    // Exclusions: -1
    valor += penaltyMissed * (-2); // Penalty fallat: -2
    valor += turnovers * (-0.5);   // Pèrdues: -0.5
    valor += shotsMissed * (-0.5); // Xuts fallats: -0.5
	valor += (stats.infraccions2m || 0) * (-0.5);
	valor += (stats.contrafaltes || 0) * (-0.75);  // Contrafaltes: -0.75
    valor += golsRebuts * (-0.5);    // ⚠️ NOU: Gols rebuts: -0.5
    return valor;
}
function renderMinutesDistributionChart() {
    const ctx = document.getElementById('minutesDistributionChart');
    if (!ctx) return;
    
    if (window.minutesDistributionChartInstance) {
        window.minutesDistributionChartInstance.destroy();
    }
    
    const playerTimes = {};
    
    matchesWithTime.forEach(match => {
        match.jugadors.forEach(player => {
            const playerName = player.nom.trim();
            
            if (!playerTimes[playerName]) {
                playerTimes[playerName] = {
                    num: player.numero,
                    name: playerName,
                    totalTime: 0
                };
            }
            
            const quarterDuration = 480; // 8 minutos máximo por cuarto
            
            ['q1', 'q2', 'q3', 'q4'].forEach(quarter => {
                const qChanges = match.playerWaterChanges.filter(c => c.playerNum === player.numero && c.quarter === quarter);
                if (qChanges.length === 0) return;
                
                // Eliminar duplicados
                const uniqueChanges = [];
                const seenTimestamps = new Set();
                qChanges.sort((a, b) => a.timestamp - b.timestamp);
                qChanges.forEach(change => {
                    if (!seenTimestamps.has(change.timestamp)) {
                        seenTimestamps.add(change.timestamp);
                        uniqueChanges.push(change);
                    }
                });
                
                let timeInWater = 0;
                let lastInTime = null;
                const quarterStartTime = getQuarterRealStartTime(match, quarter);
                const quarterEndTime = quarterStartTime + quarterDuration * 1000;
                
                if (!quarterStartTime) return;
                
                uniqueChanges.forEach(change => {
                    if (change.timestamp < quarterStartTime || change.timestamp > quarterEndTime) return;
                    
                    if (change.action === 'in' && lastInTime === null) {
                        lastInTime = change.timestamp;
                    } else if (change.action === 'out' && lastInTime !== null) {
                        const duration = (change.timestamp - lastInTime) / 1000;
                        if (duration > 0 && duration <= quarterDuration) {
                            timeInWater += duration;
                        }
                        lastInTime = null;
                    }
                });
                
                // Si todavía está dentro al final del cuarto
                if (lastInTime !== null && lastInTime < quarterEndTime) {
                    const duration = (quarterEndTime - lastInTime) / 1000;
                    if (duration > 0 && duration <= quarterDuration) {
                        timeInWater += duration;
                    }
                }
                
                // ✅ LIMITAR A 8 MINUTOS (480 segundos) POR CUARTO
                const quarterTime = Math.min(Math.max(0, Math.round(timeInWater)), quarterDuration);
                playerTimes[playerName].totalTime += quarterTime;
            });
        });
    });
    
    const players = Object.values(playerTimes)
        .sort((a, b) => b.totalTime - a.totalTime)
        .slice(0, 10);
    
    const labels = players.map(p => `${p.num}. ${p.name.split(' ')[0]}`);
    const timeInMinutes = players.map(p => (p.totalTime / 60).toFixed(1));
    
    const colors = [
        '#22d3ee', '#06b6d4', '#0891b2', '#0e7490',
        '#fde047', '#fbbf24', '#f59e0b', '#d97706',
        '#22c55e', '#16a34a'
    ];
    
    window.minutesDistributionChartInstance = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: timeInMinutes,
                backgroundColor: colors,
                borderWidth: 2,
                borderColor: '#1e3a8a'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { 
                    display: true,
                    position: 'right',
                    labels: { 
                        color: 'white', 
                        font: { size: 12 },
                        padding: 10
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = context.dataset.data.reduce((a, b) => parseFloat(a) + parseFloat(b), 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${label}: ${value} min (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

function renderPlusMinusChart() {
    const ctx = document.getElementById('plusMinusChart');
    if (!ctx) return;
    
    if (window.plusMinusChartInstance) {
        window.plusMinusChartInstance.destroy();
    }
    
    const playerPlusMinus = {};
    
    matchesWithTime.forEach(match => {
        ['q1', 'q2', 'q3', 'q4'].forEach(quarter => {
            const quarterStartTime = match.quarterStartTimes[quarter];
            if (!quarterStartTime) return;
            
            const quarterEndTime = match.quarterRealEndTimes?.[quarter] || (quarterStartTime + 480000);
            
            // Obtenir canvis d'aigua d'aquest quart
            const qChanges = match.playerWaterChanges.filter(c => c.quarter === quarter)
                .sort((a, b) => a.timestamp - b.timestamp);
            
            // Processar cada jugador
            match.jugadors.forEach(jugador => {
                const playerNum = jugador.numero;
                const playerName = jugador.nom.trim();
                
                if (!playerPlusMinus[playerName]) {
                    playerPlusMinus[playerName] = {
                        num: playerNum,
                        name: playerName,
                        plusMinus: 0,
                        intervals: 0,
                        details: []
                    };
                }
                
                // Obtenir intervals d'aquest jugador
                const playerChanges = qChanges.filter(c => c.playerNum === playerNum);
                let lastInTime = null;
                
                playerChanges.forEach(change => {
                    if (change.action === 'in') {
                        lastInTime = change.timestamp;
                    } else if (change.action === 'out' && lastInTime !== null) {
                        const scoreIn = getScoreAtTime(match, lastInTime, quarter);
                        const scoreOut = getScoreAtTime(match, change.timestamp, quarter);
                        const plusMinus = (scoreOut.cnt - scoreIn.cnt) - (scoreOut.rival - scoreIn.rival);
                        
                        playerPlusMinus[playerName].plusMinus += plusMinus;
                        playerPlusMinus[playerName].intervals++;
                        playerPlusMinus[playerName].details.push({
                            match: match.rivalTeam || 'Rival',
                            quarter: quarter,
                            timeIn: lastInTime,
                            timeOut: change.timestamp,
                            scoreIn: scoreIn,
                            scoreOut: scoreOut,
                            plusMinus: plusMinus
                        });
                        
                        lastInTime = null;
                    }
                });
                
                // Si encara està dins al final del quart
                if (lastInTime !== null) {
                    const scoreIn = getScoreAtTime(match, lastInTime, quarter);
                    const scoreOut = getScoreAtTime(match, quarterEndTime, quarter);
                    const plusMinus = (scoreOut.cnt - scoreIn.cnt) - (scoreOut.rival - scoreIn.rival);
                    
                    playerPlusMinus[playerName].plusMinus += plusMinus;
                    playerPlusMinus[playerName].intervals++;
                    playerPlusMinus[playerName].details.push({
                        match: match.rivalTeam || 'Rival',
                        quarter: quarter,
                        timeIn: lastInTime,
                        timeOut: quarterEndTime,
                        scoreIn: scoreIn,
                        scoreOut: scoreOut,
                        plusMinus: plusMinus
                    });
                }
            });
        });
    });
    
    const players = Object.values(playerPlusMinus)
        .filter(p => p.intervals > 0)
        .map(p => ({
            ...p,
            avgPlusMinus: (p.plusMinus / p.intervals).toFixed(2)
        }))
        .sort((a, b) => b.plusMinus - a.plusMinus);
    
    // ✅ GRÀFICA RESUM AMB TOTS ELS JUGADORS
    const labels = players.map(p => `${p.num}. ${p.name.split(' ')[0]}`);
    const data = players.map(p => p.plusMinus);
    const colors = data.map(pm => pm >= 0 ? '#22c55e' : '#ef4444');
    
    window.plusMinusChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Plus/Minus Total',
                data: data,
                backgroundColor: colors,
                borderWidth: 1,
                borderColor: '#1e3a8a'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const idx = context.dataIndex;
                            const player = players[idx];
                            return [
                                `Plus/Minus Total: ${context.parsed.x > 0 ? '+' : ''}${context.parsed.x}`,
                                `Promedio: ${player.avgPlusMinus > 0 ? '+' : ''}${player.avgPlusMinus}`,
                                `Intervals: ${player.intervals}`
                            ];
                        }
                    }
                }
            },
            scales: {
                x: { 
                    ticks: { 
                        color: 'white',
                        font: { size: window.innerWidth < 768 ? 10 : 12 }
                    },
                    grid: { 
                        color: 'rgba(255,255,255,0.1)',
                        drawBorder: false
                    },
                    title: {
                        display: true,
                        text: 'Diferencia de Goles',
                        color: 'white',
                        font: { size: window.innerWidth < 768 ? 11 : 14 }
                    }
                },
                y: { 
                    ticks: { 
                        color: 'white', 
                        font: { size: window.innerWidth < 768 ? 9 : 11 },
                        autoSkip: false
                    },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            }
        }
    });
    
    // ✅ CREAR SELECTOR DE JUGADOR I DETALL
    renderPlusMinusSelector(players);
}

// ✅ NOVA FUNCIÓ: Selector de jugador + detall
function renderPlusMinusSelector(players) {
    const chartSection = document.getElementById('plusMinusChart').parentElement;
    
    // Esborrar selector anterior si existeix
    const oldSelector = document.getElementById('plusMinusSelectorContainer');
    if (oldSelector) oldSelector.remove();
    
    const selectorContainer = document.createElement('div');
    selectorContainer.id = 'plusMinusSelectorContainer';
    selectorContainer.style.marginTop = '30px';
    
    selectorContainer.innerHTML = `
        <h3 class="section-title" style="font-size: 18px; margin-bottom: 15px;">
            🔍 Detall d'Intervals per Jugador
        </h3>
        <div style="margin-bottom: 20px;">
            <label style="font-size: 14px; color: #bae6fd; display: block; margin-bottom: 8px;">
                Selecciona un jugador:
            </label>
            <select id="plusMinusPlayerSelect" style="
    width: 100%;
    padding: 12px;
    background: rgba(30, 58, 138, 0.8);
    border: 2px solid #22d3ee;
    border-radius: 8px;
    color: white;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
" onchange="showPlayerPlusMinusDetail()">
    <option value="" style="background: #1e3a8a; color: white;">-- Selecciona un jugador --</option>
    ${players.map(p => `
        <option value="${p.name}" style="background: #1e3a8a; color: white;">
            ${p.num}. ${p.name} (${p.plusMinus > 0 ? '+' : ''}${p.plusMinus})
        </option>
    `).join('')}
</select>
        </div>
        <div id="plusMinusPlayerDetail"></div>
    `;
    
    chartSection.appendChild(selectorContainer);
    
    // Guardar dades dels jugadors globalment
    window.plusMinusPlayersData = players;
}

// ✅ NOVA FUNCIÓ: Mostrar detall del jugador seleccionat
function showPlayerPlusMinusDetail() {
    const select = document.getElementById('plusMinusPlayerSelect');
    const detailContainer = document.getElementById('plusMinusPlayerDetail');
    const selectedName = select.value;
    
    if (!selectedName) {
        detailContainer.innerHTML = '';
        return;
    }
    
    const player = window.plusMinusPlayersData.find(p => p.name === selectedName);
    if (!player) return;
    
    const plusMinusColor = player.plusMinus >= 0 ? '#22c55e' : '#ef4444';
    const plusMinusSign = player.plusMinus > 0 ? '+' : '';
    
    detailContainer.innerHTML = `
        <div style="
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid ${plusMinusColor};
        ">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <div>
                    <span style="font-weight: bold; font-size: 20px;">${player.num}. ${player.name}</span>
                </div>
                <div style="font-size: 28px; font-weight: bold; color: ${plusMinusColor};">
                    ${plusMinusSign}${player.plusMinus}
                </div>
            </div>
            <div style="font-size: 12px; color: #94a3b8; margin-bottom: 15px;">
                ${player.intervals} intervals • Mitjana: ${player.avgPlusMinus > 0 ? '+' : ''}${player.avgPlusMinus} per interval
            </div>
            <div style="overflow-x: auto;">
                <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
                    <thead>
                        <tr style="background: rgba(255,255,255,0.1);">
                            <th style="padding: 8px; text-align: left;">Partit</th>
                            <th style="padding: 8px; text-align: center;">Q</th>
                            <th style="padding: 8px; text-align: center;">Interval amb temps real</th>
                            <th style="padding: 8px; text-align: center;">Marcador</th>
                            <th style="padding: 8px; text-align: center;">+/-</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${player.details.map(detail => {
                            const qNum = detail.quarter.replace('q', '');
                            const qStart = matchesWithTime.find(m => m.rivalTeam === detail.match)?.quarterStartTimes?.[detail.quarter] || detail.timeIn;
                            const timeInStr = formatTimestamp(detail.timeIn, qStart);
                            const timeOutStr = formatTimestamp(detail.timeOut, qStart);
                            const pmColor = detail.plusMinus >= 0 ? '#22c55e' : '#ef4444';
                            const pmSign = detail.plusMinus > 0 ? '+' : '';
                            
                            return `
                                <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                                    <td style="padding: 8px; font-size: 11px; color: #bae6fd;">${detail.match}</td>
                                    <td style="padding: 8px; text-align: center; font-weight: bold;">Q${qNum}</td>
                                    <td style="padding: 8px; text-align: center; font-size: 11px;">${timeInStr} - ${timeOutStr}</td>
                                    <td style="padding: 8px; text-align: center; font-size: 11px;">${detail.scoreIn.cnt}-${detail.scoreIn.rival} → ${detail.scoreOut.cnt}-${detail.scoreOut.rival}</td>
                                    <td style="padding: 8px; text-align: center; font-weight: bold; color: ${pmColor}; font-size: 14px;">${pmSign}${detail.plusMinus}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

// ✅ Funcions auxiliars (ja les tenies abans)
function getScoreAtTime(match, timestamp, quarter) {
    const goalsUntilNow = (match.chronologicalActions || []).filter(a => 
        a.type === 'goal' && 
        a.quarter === quarter && 
        a.timestamp <= timestamp
    );
    
    const quarters = ['q1', 'q2', 'q3', 'q4'];
    const currentIndex = quarters.indexOf(quarter);
    
    let cntScore = 0;
    let rivalScore = 0;
    
    for (let i = 0; i < currentIndex; i++) {
        cntScore += (match.periodScores[quarters[i]]?.cnt || 0);
        rivalScore += (match.periodScores[quarters[i]]?.rival || 0);
    }
    
    goalsUntilNow.forEach(goal => {
        if (goal.team === 'cnt') {
            cntScore++;
        } else {
            rivalScore++;
        }
    });
    
    return { cnt: cntScore, rival: rivalScore };
}

function formatTimestamp(timestamp, quarterStart) {
    const elapsedSeconds = Math.floor((timestamp - quarterStart) / 1000);
    const minutes = Math.floor(elapsedSeconds / 60);
    const seconds = elapsedSeconds % 60;
    return `${minutes}:${seconds.toString().padStart(2, '0')}`;
}

function renderLoadBalanceStats() {
    const container = document.getElementById('loadBalanceGrid');
    const chartCtx = document.getElementById('loadBalanceChart');
    if (!container || !chartCtx) return;
    
    const playerTimes = {};
    
    matchesWithTime.forEach(match => {
        match.jugadors.forEach(player => {
            const playerName = player.nom.trim();
            
            if (!playerTimes[playerName]) {
                playerTimes[playerName] = {
                    num: player.numero,
                    name: playerName,
                    totalTime: 0
                };
            }
            
            const quarterDuration = 480;
            
            ['q1', 'q2', 'q3', 'q4'].forEach(quarter => {
                const qChanges = match.playerWaterChanges.filter(c => c.playerNum === player.numero && c.quarter === quarter);
                if (qChanges.length === 0) return;
                
                qChanges.sort((a, b) => a.timestamp - b.timestamp);
                
                let timeInWater = 0;
                let lastInTime = null;
                const quarterStartTime = getQuarterRealStartTime(match, quarter);
                
                if (!quarterStartTime) return;
                
                qChanges.forEach(change => {
                    if (change.action === 'in') {
                        lastInTime = change.timestamp;
                    } else if (change.action === 'out' && lastInTime !== null) {
                        timeInWater += (change.timestamp - lastInTime) / 1000;
                        lastInTime = null;
                    }
                });
                
                if (lastInTime !== null) {
                    const quarterEndTime = quarterStartTime + quarterDuration * 1000;
                    timeInWater += (quarterEndTime - lastInTime) / 1000;
                }
                
                playerTimes[playerName].totalTime += Math.round(timeInWater);
            });
        });
    });
    
    const players = Object.values(playerTimes);
    const times = players.map(p => p.totalTime / 60);
    
    const maxTime = Math.max(...times);
    const minTime = Math.min(...times);
    const avgTime = times.reduce((a, b) => a + b, 0) / times.length;
    
    const variance = times.reduce((sum, time) => sum + Math.pow(time - avgTime, 2), 0) / times.length;
    const stdDev = Math.sqrt(variance);
    
    const maxPlayer = players.find(p => (p.totalTime / 60) === maxTime);
    const minPlayer = players.find(p => (p.totalTime / 60) === minTime);
    
    function formatTime(minutes) {
        const mins = Math.floor(minutes);
        const secs = Math.round((minutes - mins) * 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }
    
    let balanceStatus = '';
    let balanceColor = '';
    if (stdDev < 3) {
        balanceStatus = '✅ Excelente equidad';
        balanceColor = '#22c55e';
    } else if (stdDev < 5) {
        balanceStatus = '⚠️ Rotación moderada';
        balanceColor = '#fbbf24';
    } else {
        balanceStatus = '❌ Rotación desigual';
        balanceColor = '#ef4444';
    }
    
    container.innerHTML = `
        <div class="info-item">
            <div class="info-label">Desviación Estándar</div>
            <div class="info-value" style="color: ${balanceColor};">${stdDev.toFixed(1)} min</div>
        </div>
        <div class="info-item">
            <div class="info-label">Tiempo Promedio</div>
            <div class="info-value">${formatTime(avgTime)}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Jugador con Más Minutos</div>
            <div class="info-value">${maxPlayer.num}. ${maxPlayer.name.split(' ')[0]}</div>
            <div style="font-size: 11px; color: #bae6fd; margin-top: 4px;">
                ${formatTime(maxTime)}
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">Jugador con Menos Minutos</div>
            <div class="info-value">${minPlayer.num}. ${minPlayer.name.split(' ')[0]}</div>
            <div style="font-size: 11px; color: #bae6fd; margin-top: 4px;">
                ${formatTime(minTime)}
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">Diferencia Máx-Mín</div>
            <div class="info-value" style="color: ${balanceColor};">${formatTime(maxTime - minTime)}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Estado de Balance</div>
            <div class="info-value" style="color: ${balanceColor}; font-size: 16px;">${balanceStatus}</div>
        </div>
    `;
    
    if (window.loadBalanceChartInstance) {
        window.loadBalanceChartInstance.destroy();
    }
    
    window.loadBalanceChartInstance = new Chart(chartCtx, {
        type: 'bar',
        data: {
            labels: ['< 15min', '15-20min', '20-25min', '25-30min', '> 30min'],
            datasets: [{
                label: 'Número de Jugadores',
                data: [
                    times.filter(t => t < 15).length,
                    times.filter(t => t >= 15 && t < 20).length,
                    times.filter(t => t >= 20 && t < 25).length,
                    times.filter(t => t >= 25 && t < 30).length,
                    times.filter(t => t >= 30).length
                ],
                backgroundColor: ['#ef4444', '#f97316', '#fbbf24', '#22c55e', '#06b6d4'],
                borderWidth: 1,
                borderColor: '#1e3a8a'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { 
                    beginAtZero: true,
                    ticks: { color: 'white', stepSize: 1 },
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    title: {
                        display: true,
                        text: 'Jugadores',
                        color: 'white'
                    }
                },
                x: { 
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            }
        }
    });
}

function renderQuarterAnalysisTable() {
    const table = document.getElementById('quarterAnalysisTable');
    if (!table) return;
    
    const quarterStats = {
        q1: { changes: 0, uniquePlayers: new Set(), totalTime: 0 },
        q2: { changes: 0, uniquePlayers: new Set(), totalTime: 0 },
        q3: { changes: 0, uniquePlayers: new Set(), totalTime: 0 },
        q4: { changes: 0, uniquePlayers: new Set(), totalTime: 0 }
    };
    
    matchesWithTime.forEach(match => {
        ['q1', 'q2', 'q3', 'q4'].forEach(quarter => {
            const qChanges = match.playerWaterChanges.filter(c => c.quarter === quarter);
            const quarterStartTime = getQuarterRealStartTime(match, quarter);
            const lineup = match.lineups[quarter] || [];
            
            // Ordenar cambios por timestamp
            qChanges.sort((a, b) => a.timestamp - b.timestamp);
            
            let realChanges = 0;
            
            // Contar solo entradas que NO sean las iniciales de los titulares
            // Una entrada de un suplente = 1 cambio real
            qChanges.forEach(change => {
                const isTitular = lineup.includes(change.playerNum);
                const isInitialEntry = change.action === 'in' && 
                                      Math.abs(change.timestamp - quarterStartTime) < 5000;
                
                // Contar solo ENTRADAS de jugadores que NO sean titulares iniciales
                // Esto cuenta las rotaciones reales (cuando entra un suplente)
                if (change.action === 'in' && !(isTitular && isInitialEntry)) {
                    realChanges++;
                }
                
                quarterStats[quarter].uniquePlayers.add(change.playerNum);
            });
            
            quarterStats[quarter].changes += realChanges;
            quarterStats[quarter].totalTime += 480;
        });
    });
    
    const quarters = ['q1', 'q2', 'q3', 'q4'];
    const labels = ['1º Cuarto', '2º Cuarto', '3º Cuarto', '4º Cuarto'];
    
    table.innerHTML = `
        <thead>
            <tr>
                <th>Cuarto</th>
                <th>Total Cambios</th>
                <th>Promedio Cambios/Partido</th>
                <th>Jugadores Únicos</th>
                <th>Promedio Jugadores/Partido</th>
            </tr>
        </thead>
        <tbody>
            ${quarters.map((q, i) => {
                const avgChanges = (quarterStats[q].changes / matchesWithTime.length).toFixed(1);
                const avgPlayers = (quarterStats[q].uniquePlayers.size / matchesWithTime.length).toFixed(1);
                
                return `
                    <tr>
                        <td><strong>${labels[i]}</strong></td>
                        <td>${quarterStats[q].changes}</td>
                        <td>${avgChanges}</td>
                        <td>${quarterStats[q].uniquePlayers.size}</td>
                        <td>${avgPlayers}</td>
                    </tr>
                `;
            }).join('')}
        </tbody>
    `;
}


function renderPerformanceVsTimeChart() {
    const ctx = document.getElementById('performanceVsTimeChart');
    if (!ctx) return;
    console.log('🎯 renderPerformanceVsTimeChart called');
    console.log('matchesWithTime length:', matchesWithTime.length);
	 // ⚠️ MISSATGE SI HI HA POCS PARTITS
    if (matchesWithTime.length < 3) {
        const canvas = ctx;
        const context = canvas.getContext('2d');
        
        // Obtenir dimensions del canvas
        const width = canvas.width;
        const height = canvas.height;
        
        // Netejar canvas
        context.clearRect(0, 0, width, height);
        
        // Configurar text
        context.fillStyle = '#bae6fd';
        context.font = '16px Arial';
        context.textAlign = 'center';
        context.textBaseline = 'middle';
        
        // Missatge principal
        context.fillText('⚠️ Necessites almenys 3 partits amb dades de temps', width / 2, height / 2 - 20);
        context.fillStyle = '#94a3b8';
        context.font = '14px Arial';
        context.fillText(`Partits disponibles: ${matchesWithTime.length} / 3`, width / 2, height / 2 + 10);
        context.fillText('Aquesta gràfica mostrarà la correlació quan tinguis més dades', width / 2, height / 2 + 35);
        
        return;
    }
    if (window.performanceVsTimeChartInstance) {
        window.performanceVsTimeChartInstance.destroy();
    }
    
    const playerMatchData = [];
    
    matchesWithTime.forEach(match => {
        const teamResult = match.scoreCNT - match.scoreRival;
        
        // Utilitzar la funció centralitzada
        const playerTimes = calculateMatchPlayingTimes(match);
        
        Object.values(playerTimes).forEach(playerTime => {
            const player = match.jugadors.find(j => j.numero === playerTime.num);
            if (!player) return;
            
            playerMatchData.push({
                player: `${playerTime.num}. ${playerTime.name}`,
                time: playerTime.total / 60, // convertir a minuts
                gols: player.estadistiques.gols,
                result: teamResult
            });
        });
    });
    
    const playerAvgs = {};
    playerMatchData.forEach(data => {
        if (!playerAvgs[data.player]) {
            playerAvgs[data.player] = { times: [], results: [] };
        }
        playerAvgs[data.player].times.push(data.time);
        playerAvgs[data.player].results.push(data.result);
    });
    
    const scatterData = Object.keys(playerAvgs).map(player => {
        const avgTime = playerAvgs[player].times.reduce((a, b) => a + b, 0) / playerAvgs[player].times.length;
        const avgResult = playerAvgs[player].results.reduce((a, b) => a + b, 0) / playerAvgs[player].results.length;
        return {
            x: avgTime,
            y: avgResult,
            label: player
        };
    });
    
    window.performanceVsTimeChartInstance = new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: [{
                label: 'Jugadores',
                data: scatterData,
                backgroundColor: '#22d3ee',
                borderColor: '#06b6d4',
                pointRadius: 8,
                pointHoverRadius: 12
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return [
                                context.raw.label,
                                `Tiempo promedio: ${context.parsed.x.toFixed(1)} min`,
                                `Diferencia promedio: ${context.parsed.y > 0 ? '+' : ''}${context.parsed.y.toFixed(1)} goles`
                            ];
                        }
                    }
                }
            },
            scales: {
                x: { 
                    beginAtZero: true,
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    title: {
                        display: true,
                        text: 'Tiempo Promedio Jugado (minutos)',
                        color: 'white'
                    }
                },
                y: { 
                    ticks: { color: 'white' },
                    grid: { 
                        color: 'rgba(255,255,255,0.1)',
                        drawBorder: false
                    },
                    title: {
                        display: true,
                        text: 'Diferencia de Goles Promedio',
                        color: 'white'
                    }
                }
            }
        }
    });
}

function renderFatigueAnalysisTable() {
    const table = document.getElementById('fatigueAnalysisTable');
    if (!table) return;
    
    const playerFatigue = {};
    
    matchesWithTime.forEach(match => {
        match.jugadors.forEach(player => {
            const playerName = player.nom.trim();
            
            if (!playerFatigue[playerName]) {
                playerFatigue[playerName] = {
                    num: player.numero,
                    name: playerName,
                    q1: { gols: 0, exclusions: 0, matches: 0 },
                    q4: { gols: 0, exclusions: 0, matches: 0 }
                };
            }
            
            const playedQ1 = match.lineups.q1 && match.lineups.q1.includes(player.numero);
            const playedQ4 = match.lineups.q4 && match.lineups.q4.includes(player.numero);
            
            if (playedQ1) {
                playerFatigue[playerName].q1.matches++;
                playerFatigue[playerName].q1.gols += player.estadistiques.gols / 4;
                playerFatigue[playerName].q1.exclusions += player.estadistiques.exclusions / 4;
            }
            
            if (playedQ4) {
                playerFatigue[playerName].q4.matches++;
                playerFatigue[playerName].q4.gols += player.estadistiques.gols / 4;
                playerFatigue[playerName].q4.exclusions += player.estadistiques.exclusions / 4;
            }
        });
    });
    
    const players = Object.values(playerFatigue)
        .filter(p => p.q1.matches > 0 && p.q4.matches > 0)
        .sort((a, b) => a.num - b.num);
    
    table.innerHTML = `
        <thead>
            <tr>
                <th>Nº</th>
                <th>Jugador</th>
                <th colspan="2">1º Cuarto (Inicio)</th>
                <th colspan="2">4º Cuarto (Final)</th>
                <th>Cambio Goles</th>
                <th>Cambio Exc</th>
                <th>Fatiga</th>
            </tr>
            <tr style="font-size: 11px;">
                <th></th>
                <th></th>
                <th>Goles</th>
                <th>Exc</th>
                <th>Goles</th>
                <th>Exc</th>
                <th></th>
                <th></th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            ${players.map(p => {
                const q1GoalsAvg = (p.q1.gols / p.q1.matches).toFixed(2);
                const q4GoalsAvg = (p.q4.gols / p.q4.matches).toFixed(2);
                const q1ExcAvg = (p.q1.exclusions / p.q1.matches).toFixed(2);
                const q4ExcAvg = (p.q4.exclusions / p.q4.matches).toFixed(2);
                
                const goalsDiff = (q4GoalsAvg - q1GoalsAvg).toFixed(2);
                const excDiff = (q4ExcAvg - q1ExcAvg).toFixed(2);
                
                let fatigueIndicator = '';
                let fatigueColor = '';
                
                if (goalsDiff < -0.2 && excDiff > 0.2) {
                    fatigueIndicator = '😓 Alta';
                    fatigueColor = '#ef4444';
                } else if (goalsDiff < -0.1 || excDiff > 0.1) {
                    fatigueIndicator = '⚠️ Media';
                    fatigueColor = '#fbbf24';
                } else if (goalsDiff >= 0) {
                    fatigueIndicator = '✅ Baja';
                    fatigueColor = '#22c55e';
                } else {
                    fatigueIndicator = '➖ Normal';
                    fatigueColor = '#06b6d4';
                }
                
                return `
                    <tr>
                        <td><div class="player-num" style="width: 30px; height: 30px; font-size: 12px;">${p.num}</div></td>
                        <td><strong>${p.name}</strong></td>
                        <td>${q1GoalsAvg}</td>
                        <td>${q1ExcAvg}</td>
                        <td>${q4GoalsAvg}</td>
                        <td>${q4ExcAvg}</td>
                        <td style="color: ${goalsDiff >= 0 ? '#22c55e' : '#ef4444'}; font-weight: bold;">
                            ${goalsDiff > 0 ? '+' : ''}${goalsDiff}
                        </td>
                        <td style="color: ${excDiff <= 0 ? '#22c55e' : '#ef4444'}; font-weight: bold;">
                            ${excDiff > 0 ? '+' : ''}${excDiff}
                        </td>
                        <td style="color: ${fatigueColor}; font-weight: bold;">
                            ${fatigueIndicator}
                        </td>
                    </tr>
                `;
            }).join('')}
        </tbody>
    `;
}

function renderRotationStats() {
    const container = document.getElementById('rotationStatsGrid');
    if (!container) return;
    
    let totalChanges = 0;
    let totalQuarters = 0;
    const playerRotations = {};
    
    matchesWithTime.forEach(match => {
        ['q1', 'q2', 'q3', 'q4'].forEach(quarter => {
            const qChanges = match.playerWaterChanges.filter(c => c.quarter === quarter);
            const quarterStartTime = match.quarterStartTimes[quarter];
            const lineup = match.lineups[quarter] || [];
            
            // Ordenar cambios por timestamp
            qChanges.sort((a, b) => a.timestamp - b.timestamp);
            
            // Contar solo entradas de no-titulares (rotaciones reales)
            qChanges.forEach(change => {
                const isTitular = lineup.includes(change.playerNum);
                const isInitialEntry = change.action === 'in' && 
                                      Math.abs(change.timestamp - quarterStartTime) < 5000;
                
                // Contar solo ENTRADAS que no sean iniciales de titulares
                if (change.action === 'in' && !(isTitular && isInitialEntry)) {
                    totalChanges++;
                    
                    if (!playerRotations[change.playerNum]) {
                        playerRotations[change.playerNum] = 0;
                    }
                    playerRotations[change.playerNum]++;
                }
            });
        });
        
        totalQuarters += 4;
    });
    
    const avgChangesPerMatch = (totalChanges / matchesWithTime.length).toFixed(1);
    const avgChangesPerQuarter = (totalChanges / totalQuarters).toFixed(1);
    
    const rotationCounts = Object.values(playerRotations);
    
    if (rotationCounts.length === 0) {
        container.innerHTML = `
            <div class="info-item">
                <div class="info-label">Total de Cambios</div>
                <div class="info-value">0</div>
            </div>
            <div class="info-item" style="grid-column: 1 / -1;">
                <div style="text-align: center; color: #bae6fd; font-size: 14px;">
                    No hay cambios registrados durante los cuartos
                </div>
            </div>
        `;
        return;
    }
    
    const maxRotations = Math.max(...rotationCounts);
    const minRotations = Math.min(...rotationCounts);
    const avgRotations = (rotationCounts.reduce((a, b) => a + b, 0) / rotationCounts.length).toFixed(1);
    
    const mostRotatedPlayerNum = Object.keys(playerRotations).find(
        num => playerRotations[num] === maxRotations
    );
    const leastRotatedPlayerNum = Object.keys(playerRotations).find(
        num => playerRotations[num] === minRotations
    );
    
    let mostRotatedPlayer = 'N/A';
    let leastRotatedPlayer = 'N/A';
    
    matchesWithTime.forEach(match => {
        const playerMost = match.jugadors.find(j => j.numero === parseInt(mostRotatedPlayerNum));
        const playerLeast = match.jugadors.find(j => j.numero === parseInt(leastRotatedPlayerNum));
        
        if (playerMost) mostRotatedPlayer = `${playerMost.numero}. ${playerMost.nom.split(' ')[0]}`;
        if (playerLeast) leastRotatedPlayer = `${playerLeast.numero}. ${playerLeast.nom.split(' ')[0]}`;
    });
    
    container.innerHTML = `
        <div class="info-item">
            <div class="info-label">Total de Cambios (Rotaciones)</div>
            <div class="info-value">${totalChanges}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Promedio Cambios/Partido</div>
            <div class="info-value">${avgChangesPerMatch}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Promedio Cambios/Cuarto</div>
            <div class="info-value">${avgChangesPerQuarter}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Jugador Más Rotado</div>
            <div class="info-value">${mostRotatedPlayer}</div>
            <div style="font-size: 11px; color: #bae6fd; margin-top: 4px;">
                ${maxRotations} entradas al agua
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">Jugador Menos Rotado</div>
            <div class="info-value">${leastRotatedPlayer}</div>
            <div style="font-size: 11px; color: #bae6fd; margin-top: 4px;">
                ${minRotations} entradas al agua
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">Promedio Rotaciones/Jugador</div>
            <div class="info-value">${avgRotations}</div>
        </div>
    `;
}

// ============================================
// FIN FUNCIONES PARA ESTADÍSTICAS DE TIEMPO
// ============================================
function renderGoalkeeperSavesChart() {
    const ctx = document.getElementById('goalkeeperSavesChart');
    if (!ctx) return;
    
    if (window.goalkeeperSavesChartInstance) {
        window.goalkeeperSavesChartInstance.destroy();
    }
    
    const goalkeeperStats = {};
    
    allMatches.forEach(match => {
        match.jugadors.forEach(j => {
            const isGoalkeeper = j.numero === 1 || j.numero === 13;
            if (!isGoalkeeper) return;
            
            const playerName = j.nom.trim();
            
            if (!goalkeeperStats[playerName]) {
                goalkeeperStats[playerName] = {
                    num: j.numero,
                    name: playerName,
                    parades: 0,
                    paradeTypes: { corner: 0, rebuig: 0, atrapa: 0,penal: 0 }
                };
            }
            
            goalkeeperStats[playerName].parades += (j.estadistiques.parades || 0);
            
            if (j.estadistiques.paradeTypes) {
                goalkeeperStats[playerName].paradeTypes.corner += (j.estadistiques.paradeTypes.corner || 0);
                goalkeeperStats[playerName].paradeTypes.rebuig += (j.estadistiques.paradeTypes.rebuig || 0);
                goalkeeperStats[playerName].paradeTypes.atrapa += (j.estadistiques.paradeTypes.atrapa || 0);
				goalkeeperStats[playerName].paradeTypes.penal += (j.estadistiques.paradeTypes.penal || 0);
            }
        });
    });
    
    const goalkeepers = Object.values(goalkeeperStats);
    
    if (goalkeepers.length === 0) {
        ctx.parentElement.innerHTML = '<div class="no-data">No hay datos de paradas de porteros</div>';
        return;
    }
    
    const labels = goalkeepers.map(gk => `${gk.num}. ${gk.name.split(' ')[0]}`);
    
    window.goalkeeperSavesChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
  {
    label: 'Corner',
    data: goalkeepers.map(gk => (gk.paradeTypes?.corner ?? 0)),
    backgroundColor: '#3b82f6'
  },
  {
    label: 'Rebuig',
    data: goalkeepers.map(gk => (gk.paradeTypes?.rebuig ?? 0)),
    backgroundColor: '#f97316'
  },
  {
    label: 'Atrapa',
    data: goalkeepers.map(gk => (gk.paradeTypes?.atrapa ?? 0)),
    backgroundColor: '#22c55e'
  },
  {
    label: 'Penal',
    data: goalkeepers.map(gk => (gk.paradeTypes?.penal ?? 0)),
    backgroundColor: '#eab308'
  }
]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { 
                    display: true,
                    labels: { color: 'white', font: { size: 14 } }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.dataset.label || '';
                            const value = context.parsed.y || 0;
                            return `${label}: ${value} parades`;
                        }
                    }
                }
            },
            scales: {
                y: { 
                    beginAtZero: true,
                    ticks: { color: 'white', stepSize: 1 },
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    title: {
                        display: true,
                        text: 'Parades',
                        color: 'white'
                    }
                },
                x: { 
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            }
        }
    });
}
// ✅ NUEVO: Variables globals per ordenació
let currentSortColumn = 'gols';
let currentSortOrder = 'desc';
let cachedPlayersData = [];
let singleMatchSortColumn = 'valor';
let singleMatchSortOrder = 'desc';

function sortTable(column, tableId = 'comparisonTable') {
    if (currentSortColumn === column) {
        currentSortOrder = currentSortOrder === 'desc' ? 'asc' : 'desc';
    } else {
        currentSortColumn = column;
        currentSortOrder = 'desc';
    }
    
    let sortedPlayers;
    
    // Determinar quins jugadors ordenar segons la taula
    if (tableId === 'comparisonTableIndividual') {
        sortedPlayers = [...getAllUniquePlayers()];
    } else {
        // Per la taula de comparació, obtenim els jugadors directament de la taula actual
        const tableElement = document.getElementById(tableId);
        if (!tableElement || !tableElement.querySelector('tbody')) {
            console.error('No s\'ha trobat la taula:', tableId);
            return;
        }
        
        // Extreure les dades de la taula actual
        const rows = Array.from(tableElement.querySelectorAll('tbody tr'));
        sortedPlayers = rows.map(row => {
            const cells = row.querySelectorAll('td');
            const numText = cells[0].textContent.trim();
            const num = parseInt(numText);
            const name = cells[1].textContent.trim();
            
            // Trobar el jugador complet a comparisonPlayers o getAllUniquePlayers
            let player = comparisonPlayers?.find(p => p.num === num && p.name === name);
            if (!player) {
                player = getAllUniquePlayers().find(p => p.num === num && p.name === name);
            }
            return player;
        }).filter(p => p); // Eliminar nulls
    }
    
    if (!sortedPlayers || sortedPlayers.length === 0) {
        console.error('No hi ha jugadors per ordenar');
        return;
    }
    
    sortedPlayers.sort((a, b) => {
        let valA, valB;
        
        switch(column) {
            case 'num': valA = a.num; valB = b.num; break;
            case 'name': valA = a.name.toLowerCase(); valB = b.name.toLowerCase(); break;
            case 'partidos': valA = a.partidos; valB = b.partidos; break;
            case 'gols': valA = a.gols; valB = b.gols; break;
            case 'h+': valA = a.goalTypes['h+'] || 0; valB = b.goalTypes['h+'] || 0; break;
            case 'penalty': valA = a.goalTypes.penalty || 0; valB = b.goalTypes.penalty || 0; break;
            case 'contra': valA = a.goalTypes.contra || 0; valB = b.goalTypes.contra || 0; break;
            case 'boya': valA = a.goalTypes.boya || 0; valB = b.goalTypes.boya || 0; break;
            case 'normal': valA = a.goalTypes.normal || 0; valB = b.goalTypes.normal || 0; break;
            case 'parades': valA = a.parades || 0; valB = b.parades || 0; break;
            case 'assistencies': valA = a.assistencies || 0; valB = b.assistencies || 0; break;
            case 'robatoris': valA = a.robatoris || 0; valB = b.robatoris || 0; break;
            case 'blocks': 
                valA = (a.blocks || 0) + (a.blocatges || 0); 
                valB = (b.blocks || 0) + (b.blocatges || 0); 
                break;
            case 'faltesRebudes': valA = a.faltesRebudes || 0; valB = b.faltesRebudes || 0; break;
            case 'exclusions': valA = a.exclusions; valB = b.exclusions; break;
            case 'infraccions2m': valA = a.infraccions2m || 0; valB = b.infraccions2m || 0; break;
            case 'contrafaltes': valA = a.contrafaltes || 0; valB = b.contrafaltes || 0; break;
            case 'perdues': valA = a.perdues || 0; valB = b.perdues || 0; break;
            case 'xutsFallats': valA = a.xutsFallats || 0; valB = b.xutsFallats || 0; break;
            case 'penaltyMissed': valA = a.penaltyMissed || 0; valB = b.penaltyMissed || 0; break;
            case 'eficienciaTir':
                const totalXutsA = a.gols + (a.xutsFallats || 0);
                const totalXutsB = b.gols + (b.xutsFallats || 0);
                valA = totalXutsA > 0 ? (a.gols / totalXutsA * 100) : 0;
                valB = totalXutsB > 0 ? (b.gols / totalXutsB * 100) : 0;
                break;
            case 'mediaGols':
                valA = a.partidos > 0 ? (a.gols / a.partidos) : 0;
                valB = b.partidos > 0 ? (b.gols / b.partidos) : 0;
                break;
            case 'valor':
                valA = calculatePlayerValue(a);
                valB = calculatePlayerValue(b);
                break;
            default: valA = 0; valB = 0;
        }
        
        if (typeof valA === 'string') {
            return currentSortOrder === 'desc' 
                ? valB.localeCompare(valA)
                : valA.localeCompare(valB);
        }
        
        return currentSortOrder === 'desc' ? valB - valA : valA - valB;
    });
    
    // Re-renderitzar la taula corresponent
    renderComparisonTable(sortedPlayers, tableId === 'comparisonTableIndividual', tableId);
    
    // Si és la taula individual, tornar a afegir els event listeners
    if (tableId === 'comparisonTableIndividual') {
        document.querySelectorAll('.player-row-clickable').forEach(row => {
            row.addEventListener('click', function() {
                const playerNum = parseInt(this.dataset.playerNum);
                const playerName = this.dataset.playerName;
                showIndividualPlayerDetails({ num: playerNum, name: playerName });
            });
        });
    }
}

function renderComparisonTable(players, clickable = false, tableId = 'comparisonTable') {
    const getSortIndicator = (column) => {
        if (currentSortColumn !== column) return '';
        return currentSortOrder === 'desc' ? ' ▼' : ' ▲';
    };
    
    document.getElementById(tableId).innerHTML = `
      <thead>
<tr>
        <th rowspan="2" onclick="sortTable('num', '${tableId}')" style="cursor: pointer; vertical-align: middle;">Nº${getSortIndicator('num')}</th>
        <th rowspan="2" onclick="sortTable('name', '${tableId}')" style="cursor: pointer; vertical-align: middle;">Jugador${getSortIndicator('name')}</th>
        <th rowspan="2" onclick="sortTable('partidos', '${tableId}')" style="cursor: pointer; vertical-align: middle;">Partidos${getSortIndicator('partidos')}</th>
        <th rowspan="2" onclick="sortTable('gols', '${tableId}')" style="cursor: pointer; vertical-align: middle;">Goles${getSortIndicator('gols')}</th>
        <th colspan="5" style="background: rgba(34, 211, 238, 0.2); text-align: center;" title="Tipus de Gols">🎯 TIPUS GOLS</th>
        <th colspan="5" style="background: rgba(34, 197, 94, 0.2); text-align: center;" title="Accions Positives">✅ POSITIVES</th>
        <th colspan="6" style="background: rgba(239, 68, 68, 0.2); text-align: center;" title="Accions Negatives">❌ NEGATIVES</th>
        <th rowspan="2" onclick="sortTable('eficienciaTir', '${tableId}')" style="cursor: pointer; vertical-align: middle;">🎯 Efic.${getSortIndicator('eficienciaTir')}</th>
        <th rowspan="2" onclick="sortTable('mediaGols', '${tableId}')" style="cursor: pointer; vertical-align: middle;">Media G/P${getSortIndicator('mediaGols')}</th>
        <th rowspan="2" onclick="sortTable('valor', '${tableId}')" style="cursor: pointer; vertical-align: middle;">⭐ Valor${getSortIndicator('valor')}</th>
    </tr>
    <tr style="font-size: 11px;">
        <!-- Tipus de Gols (5 columnes) -->
        <th onclick="sortTable('h+', '${tableId}')" style="cursor: pointer;">H+${getSortIndicator('h+')}</th>
        <th onclick="sortTable('penalty', '${tableId}')" style="cursor: pointer;">Pen${getSortIndicator('penalty')}</th>
        <th onclick="sortTable('contra', '${tableId}')" style="cursor: pointer;">Con${getSortIndicator('contra')}</th>
        <th onclick="sortTable('boya', '${tableId}')" style="cursor: pointer;">Boy${getSortIndicator('boya')}</th>
        <th onclick="sortTable('normal', '${tableId}')" style="cursor: pointer;">Nor${getSortIndicator('normal')}</th>
        
        <!-- Positives (5 columnes) -->
        <th onclick="sortTable('parades', '${tableId}')" style="cursor: pointer;">🧤 Par${getSortIndicator('parades')}</th>
        <th onclick="sortTable('assistencies', '${tableId}')" style="cursor: pointer;">🎯 Ast${getSortIndicator('assistencies')}</th>
        <th onclick="sortTable('robatoris', '${tableId}')" style="cursor: pointer;">🛡️ Rob${getSortIndicator('robatoris')}</th>
        <th onclick="sortTable('blocks', '${tableId}')" style="cursor: pointer;">🚫 Blk${getSortIndicator('blocks')}</th>
        <th onclick="sortTable('faltesRebudes', '${tableId}')" style="cursor: pointer;">⚠️ FR${getSortIndicator('faltesRebudes')}</th>
        
        <!-- Negatives (6 columnes) -->
        <th onclick="sortTable('exclusions', '${tableId}')" style="cursor: pointer;">Exc${getSortIndicator('exclusions')}</th>
        <th onclick="sortTable('infraccions2m', '${tableId}')" style="cursor: pointer;">📏 2m${getSortIndicator('infraccions2m')}</th>
        <th onclick="sortTable('contrafaltes', '${tableId}')" style="cursor: pointer;">⚠️ CF${getSortIndicator('contrafaltes')}</th>
        <th onclick="sortTable('perdues', '${tableId}')" style="cursor: pointer;">❌ Pèr${getSortIndicator('perdues')}</th>
        <th onclick="sortTable('xutsFallats', '${tableId}')" style="cursor: pointer;">🚫 Xut${getSortIndicator('xutsFallats')}</th>
        <th onclick="sortTable('penaltyMissed', '${tableId}')" style="cursor: pointer;">PenF${getSortIndicator('penaltyMissed')}</th>
    </tr>
</thead>
        <tbody>
            ${players.map(p => {
                const totalBlocks = (p.blocks || 0) + (p.blocatges || 0);
                const totalXuts = p.gols + (p.xutsFallats || 0);
                const efic = totalXuts > 0 ? (p.gols / totalXuts * 100) : 0;
                const eficColor = efic >= 50 ? '#22c55e' : efic >= 30 ? '#fbbf24' : '#ef4444';
                const mediaGols = p.partidos > 0 ? (p.gols / p.partidos) : 0;
                
                const valor = calculatePlayerValue({
                    gols: p.gols,
                    goalTypes: p.goalTypes,
                    assistencies: p.assistencies,
                    infraccions2m: p.infraccions2m || 0,
                    contrafaltes: p.contrafaltes || 0,
                    robatoris: p.robatoris,
                    blocatges: totalBlocks,
                    parades: p.parades,
                    faltesRebudes: p.faltesRebudes || 0,
                    exclusions: p.exclusions,
                    exclusionTypes: p.exclusionTypes || { normal: 0, penalty: 0 },
                    penaltyMissed: p.penaltyMissed,
                    perdues: p.perdues,
                    xutsFallats: p.xutsFallats
                });
                
                const valorColor = valor >= 10 ? '#22c55e' : valor >= 5 ? '#fbbf24' : '#ef4444';
                
                const clickableClass = clickable ? 'player-row-clickable' : '';
                const clickableStyle = clickable ? 'cursor: pointer;' : '';
                const hoverEvents = clickable ? `onmouseover="this.style.background='rgba(34,211,238,0.2)'" onmouseout="this.style.background=''"` : '';
                
                return `
                <tr class="${clickableClass}" 
                    data-player-num="${p.num}" 
                    data-player-name="${p.name}"
                    style="${clickableStyle}"
                    ${hoverEvents}>
    <td><div class="player-num" style="width: 30px; height: 30px; font-size: 12px;">${p.num}</div></td>
    <td><strong>${p.name}</strong></td>
    <td>${p.partidos}</td>
    <td><strong style="color: #fde047;">${p.gols}</strong></td>
    <td>${p.goalTypes['h+'] || 0}</td>
    <td>${p.goalTypes.penalty || 0}</td>
    <td>${p.goalTypes.contra || 0}</td>
    <td>${p.goalTypes.boya || 0}</td>
    <td>${p.goalTypes.normal || 0}</td>
    <td style="color: #8b5cf6; font-weight: bold;">${p.parades || 0}</td>
    <td style="color: #22c55e; font-weight: bold;">${p.assistencies || 0}</td>
    <td style="color: #06b6d4; font-weight: bold;">${p.robatoris || 0}</td>
    <td style="color: #a78bfa; font-weight: bold;">${totalBlocks}</td>
    <td style="color: #fbbf24; font-weight: bold;">${p.faltesRebudes || 0}</td>
    <td style="color: #ef4444; font-weight: bold;">${p.exclusions}</td>
    <td style="color: #fb923c; font-weight: bold;">${p.infraccions2m || 0}</td>
    <td style="color: #fbbf24; font-weight: bold;">${p.contrafaltes || 0}</td>
    <td style="color: #ef4444; font-weight: bold;">${p.perdues || 0}</td>
    <td style="color: #f97316; font-weight: bold;">${p.xutsFallats || 0}</td>
    <td style="color: ${(p.penaltyMissed || 0) > 0 ? '#ef4444' : '#22c55e'}; font-weight: bold;">${p.penaltyMissed || 0}</td>
    <td style="color: ${eficColor}; font-weight: bold;">${efic.toFixed(1)}%</td>
    <td>${mediaGols.toFixed(1)}</td>
    <td style="color: ${valorColor}; font-weight: bold;">${valor.toFixed(1)}</td>
</tr>
                `;
            }).join('')}
        </tbody>
    `;
}

function normalizeAllPlayers(matchData) {
  const norm = (p) => {
    p.estadistiques = p.estadistiques || {};
    p.estadistiques.goalTypes = { normal:0, 'h+':0, penalty:0, contra:0, boya:0, ...(p.estadistiques.goalTypes||{}) };
    p.estadistiques.exclusionTypes = { normal:0, penalty:0, ...(p.estadistiques.exclusionTypes||{}) };
    p.estadistiques.paradeTypes = { corner:0, rebuig:0, atrapa:0, penal:0, ...(p.estadistiques.paradeTypes||{}) };
    p.estadistiques.gols = p.estadistiques.gols ?? (
      (p.estadistiques.goalTypes.normal||0) + (p.estadistiques.goalTypes['h+']||0) +
      (p.estadistiques.goalTypes.penalty||0) + (p.estadistiques.goalTypes.contra||0) +
      (p.estadistiques.goalTypes.boya||0)
    );
    return p;
  };
  if (matchData?.data?.players) matchData.data.players = matchData.data.players.map(norm);
  if (matchData?.data?.rivalPlayers) matchData.data.rivalPlayers = matchData.data.rivalPlayers.map(norm);
}
// ============================================
// FUNCIONS PER ESTADÍSTIQUES DE ZONES
// ============================================

function renderGoalZoneStats() {
    if (allMatches.length === 0) return;
    
    console.log('🎯 renderGoalZoneStats INICIADA');
    
    // Calcular zones globals
    const globalZones = {
        'top-left': 0, 'top-center': 0, 'top-right': 0,
        'mid-left': 0, 'mid-center': 0, 'mid-right': 0,
        'bottom-left': 0, 'bottom-center': 0, 'bottom-right': 0,
        'unknown': 0
    };
    
    const playerZones = {};
    
    allMatches.forEach(match => {
    // NOMÉS jugadors del CN Terrassa (no rivals)
    match.jugadors.forEach(j => {
        // Saltar jugadors que no tenen número (indicaria que són rivals)
        if (!j.numero) return;
        
        const playerName = j.nom.trim();
            
            if (!playerZones[playerName]) {
                playerZones[playerName] = {
                    num: j.numero,
                    name: playerName,
                    totalGols: 0,
                    zones: {
    'top-left': 0, 'top-center': 0, 'top-right': 0,
    'mid-left': 0, 'mid-center': 0, 'mid-right': 0,
    'bottom-left': 0, 'bottom-center': 0, 'bottom-right': 0,
    'unknown': 0
}
                };
            }
            
            playerZones[playerName].totalGols += j.estadistiques.gols || 0;
            
            // Debug: Comprovar si hi ha dades de zones
            if (j.estadistiques.goalZones) {
               console.log(`Jugador ${playerName} (${j.numero}) té zones:`, JSON.stringify(j.estadistiques.goalZones), 'Total gols:', j.estadistiques.gols);
                Object.keys(j.estadistiques.goalZones).forEach(zone => {
                    const count = j.estadistiques.goalZones[zone] || 0;
                    globalZones[zone] = (globalZones[zone] || 0) + count;
                    playerZones[playerName].zones[zone] = (playerZones[playerName].zones[zone] || 0) + count;
                });
            }
        });
    });
    
    const totalGols = Object.values(globalZones).reduce((sum, count) => sum + count, 0) - globalZones.unknown;
    
    console.log('📊 Total gols amb zona:', totalGols);
    console.log('📊 Zones globals:', globalZones);
    
    // Si no hi ha dades de zones, mostrar missatge informatiu
    if (totalGols === 0) {
        console.warn('⚠️ No hi ha dades de zones de porteria');
        
        const noDataHTML = `
            <div class="card" id="goalZonesAnalysisCard">
                <h2 class="section-title">🎯 Anàlisi de Zones de Porteria</h2>
                <div class="no-data" style="padding: 40px; text-align: center;">
                    <p style="font-size: 16px; color: #fbbf24; margin-bottom: 10px;">⚠️ No hi ha dades de zones de porteria</p>
                    <p style="font-size: 14px; color: #bae6fd;">
                        Els partits nous registrats amb l'app actualitzada mostraran les zones on es marquen els gols.
                    </p>
                    <p style="font-size: 12px; color: #bae6fd; margin-top: 10px;">
                        Partits analitzats: ${allMatches.length}
                    </p>
                </div>
            </div>
        `;
        
        const comparisonTable = document.querySelector('#comparisonView .card:has(#comparisonTable)');
        
        if (comparisonTable) {
            const existingCard = document.getElementById('goalZonesAnalysisCard');
            if (existingCard) existingCard.remove();
            
            comparisonTable.insertAdjacentHTML('beforebegin', noDataHTML);
            console.log('✅ Card "no data" inserit');
        }
        
        return;
    }
    
    // Top 6 golejadors
    const topScorers = Object.values(playerZones)
        .filter(p => p.totalGols > 0)
        .sort((a, b) => b.totalGols - a.totalGols)
        .slice(0, 6);
    
    console.log('👤 Top scorers:', topScorers.length);
    
    const zoneOrder = [
        'top-left', 'top-center', 'top-right',
        'mid-left', 'mid-center', 'mid-right',
        'bottom-left', 'bottom-center', 'bottom-right'
    ];
    
    const zoneLabels = {
        'top-left': '⬆️ Esq',
        'top-center': '⬆️ Centre',
        'top-right': '⬆️ Dret',
        'mid-left': '➡️ Esq',
        'mid-center': '🎯 Centre',
        'mid-right': '⬅️ Dret',
        'bottom-left': '⬇️ Esq',
        'bottom-center': '⬇️ Baix',
        'bottom-right': '⬇️ Dret'
    };
    
    const zoneLabelsShort = {
        'top-left': '⬆️E',
        'top-center': '⬆️C',
        'top-right': '⬆️D',
        'mid-left': '➡️E',
        'mid-center': '🎯',
        'mid-right': '⬅️D',
        'bottom-left': '⬇️E',
        'bottom-center': '⬇️B',
        'bottom-right': '⬇️D'
    };
    
    const maxCountGlobal = Math.max(...zoneOrder.map(z => globalZones[z] || 0));
    
    // Crear el HTML complet del card
    const goalZonesHTML = `
        <div class="card" id="goalZonesAnalysisCard">
            <h2 class="section-title">🎯 Anàlisi de Zones de Porteria</h2>
            <p style="font-size: 12px; color: #bae6fd; margin-bottom: 15px;">
                On marquen més gols els jugadors del CN Terrassa  (Els del centre són gols de vaselina)
            </p>
            
            <!-- Heatmap Global -->
            <div style="margin-bottom: 30px;">
                <h3 style="color: #22d3ee; font-size: 14px; margin-bottom: 10px;">📊 Mapa Global d'Equip</h3>
                <div class="goal-zone-heatmap">
                    ${zoneOrder.map(zone => {
                        const count = globalZones[zone] || 0;
                        const percentage = totalGols > 0 ? ((count / totalGols) * 100).toFixed(1) : 0;
                        const intensity = maxCountGlobal > 0 ? count / maxCountGlobal : 0;
                        const bgColor = getHeatmapColor(intensity);
                        
                        return `
                            <div class="goal-zone-cell" style="background: ${bgColor};">
                                <div class="zone-label">${zoneLabels[zone]}</div>
                                <div class="zone-count">${count}</div>
                                <div style="font-size: 9px; color: rgba(255,255,255,0.7);">${percentage}%</div>
                            </div>
                        `;
                    }).join('')}
                </div>
                ${globalZones.unknown > 0 ? `
                    <div style="text-align: center; margin-top: 10px; font-size: 11px; color: #bae6fd;">
                        ❓ Gols sense zona registrada: ${globalZones.unknown}
                    </div>
                ` : ''}
                <div style="text-align: center; margin-top: 10px; font-size: 12px; color: #fde047;">
                    Total de gols amb zona: ${totalGols}
                </div>
            </div>
            
            <!-- Heatmaps Individuals -->
            <div style="margin-top: 20px;">
                <h3 style="color: #22d3ee; font-size: 14px; margin-bottom: 10px;">👤 Mapes Individuals (Top 6 Golejadors)</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    ${topScorers.map(player => {
                        console.log(`🔍 ${player.name} zones individuals:`, JSON.stringify(player.zones));
                        const totalWithZone = Object.values(player.zones).reduce((sum, count) => sum + count, 0) - (player.zones.unknown || 0);
                        const maxCount = Math.max(...zoneOrder.map(z => player.zones[z] || 0));
                        
                        const preferredZone = zoneOrder.reduce((max, zone) => 
                            (player.zones[zone] || 0) > (player.zones[max] || 0) ? zone : max
                        , zoneOrder[0]);
                        
                        const preferredZoneLabel = {
                            'top-left': 'Dalt Esquerra',
                            'top-center': 'Dalt Centre',
                            'top-right': 'Dalt Dreta',
                            'mid-left': 'Centre Esquerra',
                            'mid-center': 'Centre',
                            'mid-right': 'Centre Dreta',
                            'bottom-left': 'Baix Esquerra',
                            'bottom-center': 'Baix Centre',
                            'bottom-right': 'Baix Dreta'
                        }[preferredZone];
                        
                        return `
                            <div style="background: rgba(0, 0, 0, 0.2); padding: 12px; border-radius: 8px;">
                                <div style="text-align: center; margin-bottom: 8px;">
                                    <div style="font-size: 12px; font-weight: bold; color: #22d3ee;">
                                        ${player.num}. ${player.name.split(' ')[0]}
                                    </div>
                                    <div style="font-size: 10px; color: #bae6fd; margin-top: 2px;">
                                        ${player.totalGols} gols (${totalWithZone} amb zona)
                                    </div>
                                </div>
                                
                                <div class="goal-zone-heatmap" style="max-width: 180px; margin: 0 auto;">
                                    ${zoneOrder.map(zone => {
                                        const count = player.zones[zone] || 0;
                                        const intensity = maxCount > 0 ? count / maxCount : 0;
                                        const bgColor = getHeatmapColor(intensity);
                                        
                                        return `
                                            <div class="goal-zone-cell" style="background: ${bgColor};">
                                                <div class="zone-label">${zoneLabelsShort[zone]}</div>
                                                <div class="zone-count">${count}</div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                                
                                ${totalWithZone > 0 && player.zones[preferredZone] > 0 ? `
                                    <div style="font-size: 10px; color: #fde047; text-align: center; margin-top: 8px;">
                                        ⭐ ${preferredZoneLabel} (${player.zones[preferredZone]})
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        </div>
    `;
    
    // Inserir el card abans de la taula de comparació
    const comparisonTable = document.querySelector('#comparisonView .card:has(#comparisonTable)');
    
    if (comparisonTable) {
        // Eliminar card anterior si existeix
        const existingCard = document.getElementById('goalZonesAnalysisCard');
        if (existingCard) {
            existingCard.remove();
        }
        
        comparisonTable.insertAdjacentHTML('beforebegin', goalZonesHTML);
        console.log('✅ Card de zones inserit correctament amb dades');
    } else {
        console.error('❌ No s\'ha trobat #comparisonTable');
    }
}
function renderSwimRacesStats() {
    if (allMatches.length === 0) return '';
    
    const swimStats = {};
    
    // ✅ FIX: Primer obtenim tots els jugadors dels partits
    const allPlayers = new Set();
    allMatches.forEach(match => {
        match.jugadors.forEach(j => {
            allPlayers.add(j.nom.trim());
        });
    });
    
    // Inicialitzar tots els jugadors
    allPlayers.forEach(playerName => {
        swimStats[playerName] = { won: 0, lost: 0, total: 0 };
    });
    
    // Comptar curses
    allMatches.forEach(match => {
        if (match.chronologicalActions) {
            match.chronologicalActions.forEach(action => {
                if (action.type === 'swim-race' && action.team === 'cnt') {
                    const playerName = action.playerName;
                    if (swimStats[playerName]) {
                        swimStats[playerName].total++;
                        if (action.result === 'win') {
                            swimStats[playerName].won++;
                        } else {
                            swimStats[playerName].lost++;
                        }
                    }
                }
            });
        }
    });
    
    // Filtrar jugadors amb curses
    const playersWithSwims = Object.entries(swimStats)
        .filter(([name, data]) => data.total > 0)
        .sort((a, b) => b[1].won - a[1].won);
    
    if (playersWithSwims.length === 0) {
        return '';
    }
    
    return `
        <div class="card">
            <h2 class="section-title">🏊 Estadístiques de Curses Inicials</h2>
            <div style="overflow-x: auto;">
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Jugador</th>
                            <th>🏆 Guanyades</th>
                            <th>❌ Perdudes</th>
                            <th>Total</th>
                            <th>% Èxit</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${playersWithSwims.map(([name, data]) => {
                            const percentage = ((data.won / data.total) * 100).toFixed(1);
                            const colorClass = percentage >= 50 ? '#22c55e' : '#ef4444';
                            return `
                                <tr>
                                    <td style="font-weight: bold;">${name.split(' ')[0]}</td>
                                    <td style="color: #22c55e; font-weight: bold;">${data.won}</td>
                                    <td style="color: #ef4444;">${data.lost}</td>
                                    <td>${data.total}</td>
                                    <td style="color: ${colorClass}; font-weight: bold;">${percentage}%</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
            <div style="margin-top: 15px; padding: 12px; background: rgba(34, 211, 238, 0.1); border-radius: 8px; text-align: center;">
                <div style="font-size: 12px; color: #bae6fd;">Millor cursador</div>
                <div style="font-size: 18px; color: #22d3ee; font-weight: bold; margin-top: 4px;">
                    ${playersWithSwims[0][0].split(' ')[0]} (${playersWithSwims[0][1].won}/${playersWithSwims[0][1].total})
                </div>
            </div>
        </div>
    `;
}
function renderGoalkeeperZoneStats() {
    // Aquesta funció es cridarà al displayMatchData() i displayComparison()
    
    const goalkeeperZones = {
        1: {  // Max Valls
            num: 1,
            name: 'MAX VALLS',
            totalGolsRebuts: 0,
            zones: {
                'top-left': 0, 'top-center': 0, 'top-right': 0,
                'mid-left': 0, 'mid-center': 0, 'mid-right': 0,
                'bottom-left': 0, 'bottom-center': 0, 'bottom-right': 0,
                'unknown': 0
            }
        },
        13: {  // Eric Mora
            num: 13,
            name: 'ERIC MORA',
            totalGolsRebuts: 0,
            zones: {
                'top-left': 0, 'top-center': 0, 'top-right': 0,
                'mid-left': 0, 'mid-center': 0, 'mid-right': 0,
                'bottom-left': 0, 'bottom-center': 0, 'bottom-right': 0,
                'unknown': 0
            }
        }
    };
    
    // Acumular dades de tots els partits
    allMatches.forEach(match => {
        match.jugadors.forEach(j => {
            if ((j.numero === 1 || j.numero === 13) && j.estadistiques.golsRebutsZones) {
                Object.keys(j.estadistiques.golsRebutsZones).forEach(zone => {
                    const count = j.estadistiques.golsRebutsZones[zone] || 0;
                    goalkeeperZones[j.numero].zones[zone] += count;
                    goalkeeperZones[j.numero].totalGolsRebuts += count;
                });
            }
        });
    });
    
    return goalkeeperZones;
}
function renderGlobalZoneHeatmap(zones) {
    const container = document.getElementById('globalGoalZoneHeatmap');
    if (!container) return;
    
    const totalGols = Object.values(zones).reduce((sum, count) => sum + count, 0) - zones.unknown;
    
    if (totalGols === 0) {
        container.innerHTML = '<div class="no-data">No hi ha dades de zones disponibles</div>';
        return;
    }
    
    const zoneOrder = [
        'top-left', 'top-center', 'top-right',
        'mid-left', 'mid-center', 'mid-right',
        'bottom-left', 'bottom-center', 'bottom-right'
    ];
    
    const zoneLabels = {
        'top-left': '⬆️ Esq',
        'top-center': '⬆️ Centre',
        'top-right': '⬆️ Dret',
        'mid-left': '➡️ Esq',
        'mid-center': '🎯 Centre',
        'mid-right': '⬅️ Dret',
        'bottom-left': '⬇️ Esq',
        'bottom-center': '⬇️ Baix',
        'bottom-right': '⬇️ Dret'
    };
    
    const maxCount = Math.max(...zoneOrder.map(z => zones[z] || 0));
    
    container.innerHTML = `
        <div class="goal-zone-heatmap">
            ${zoneOrder.map(zone => {
                const count = zones[zone] || 0;
                const percentage = totalGols > 0 ? ((count / totalGols) * 100).toFixed(1) : 0;
                const intensity = maxCount > 0 ? count / maxCount : 0;
                
                // Color segons intensitat
                const bgColor = getHeatmapColor(intensity);
                
                return `
                    <div class="goal-zone-cell" style="background: ${bgColor};">
                        <div class="zone-label">${zoneLabels[zone]}</div>
                        <div class="zone-count">${count}</div>
                        <div style="font-size: 9px; color: rgba(255,255,255,0.7);">${percentage}%</div>
                    </div>
                `;
            }).join('')}
        </div>
        ${zones.unknown > 0 ? `
            <div style="text-align: center; margin-top: 10px; font-size: 11px; color: #bae6fd;">
                ❓ Gols sense zona registrada: ${zones.unknown}
            </div>
        ` : ''}
        <div style="text-align: center; margin-top: 15px; font-size: 12px; color: #bae6fd;">
            Total de gols amb zona: ${totalGols}
        </div>
    `;
}

function renderIndividualZoneMaps(players) {
    const container = document.getElementById('individualGoalZoneMaps');
    if (!container) return;
    
    if (players.length === 0) {
        container.innerHTML = '<div class="no-data">No hi ha dades disponibles</div>';
        return;
    }
    
    const zoneOrder = [
        'top-left', 'top-center', 'top-right',
        'mid-left', 'mid-center', 'mid-right',
        'bottom-left', 'bottom-center', 'bottom-right'
    ];
    
    const zoneLabels = {
        'top-left': '⬆️E',
        'top-center': '⬆️C',
        'top-right': '⬆️D',
        'mid-left': '➡️E',
        'mid-center': '🎯',
        'mid-right': '⬅️D',
        'bottom-left': '⬇️E',
        'bottom-center': '⬇️B',
        'bottom-right': '⬇️D'
    };
    
    container.innerHTML = players.map(player => {
        const totalWithZone = Object.values(player.zones).reduce((sum, count) => sum + count, 0) - (player.zones.unknown || 0);
        const maxCount = Math.max(...zoneOrder.map(z => player.zones[z] || 0));
        
        // Trobar zona preferida
        const preferredZone = zoneOrder.reduce((max, zone) => 
            (player.zones[zone] || 0) > (player.zones[max] || 0) ? zone : max
        , zoneOrder[0]);
        
        const preferredZoneLabel = {
            'top-left': 'Dalt Esquerra',
            'top-center': 'Dalt Centre',
            'top-right': 'Dalt Dreta',
            'mid-left': 'Centre Esquerra',
            'mid-center': 'Centre',
            'mid-right': 'Centre Dreta',
            'bottom-left': 'Baix Esquerra',
            'bottom-center': 'Baix Centre',
            'bottom-right': 'Baix Dreta'
        }[preferredZone];
        
        return `
            <div class="individual-zone-card">
                <div class="player-name">${player.num}. ${player.name.split(' ')[0]}</div>
                <div style="font-size: 10px; color: #bae6fd; text-align: center; margin-bottom: 8px;">
                    ${player.totalGols} gols (${totalWithZone} amb zona)
                </div>
                <div class="goal-zone-heatmap">
                    ${zoneOrder.map(zone => {
                        const count = player.zones[zone] || 0;
                        const intensity = maxCount > 0 ? count / maxCount : 0;
                        const bgColor = getHeatmapColor(intensity);
                        
                        return `
                            <div class="goal-zone-cell" style="background: ${bgColor};">
                                <div class="zone-label">${zoneLabels[zone]}</div>
                                <div class="zone-count">${count}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
                <div style="font-size: 10px; color: #fde047; text-align: center; margin-top: 8px;">
                    ⭐ Zona preferida: ${preferredZoneLabel}
                </div>
            </div>
        `;
    }).join('');
}

function getHeatmapColor(intensity) {
    if (intensity === 0) return 'rgba(50, 50, 50, 0.3)';
    
    // Gradient de verd (menys) a groc (mitjà) a vermell (més)
    if (intensity < 0.33) {
        const r = Math.round(34 + (251 - 34) * (intensity / 0.33));
        const g = Math.round(197 + (191 - 197) * (intensity / 0.33));
        const b = Math.round(94 + (36 - 94) * (intensity / 0.33));
        return `rgba(${r}, ${g}, ${b}, 0.8)`;
    } else if (intensity < 0.66) {
        const adjusted = (intensity - 0.33) / 0.33;
        const r = Math.round(251 + (249 - 251) * adjusted);
        const g = Math.round(191 + (115 - 191) * adjusted);
        const b = Math.round(36 + (22 - 36) * adjusted);
        return `rgba(${r}, ${g}, ${b}, 0.8)`;
    } else {
        const adjusted = (intensity - 0.66) / 0.34;
        const r = Math.round(249 + (239 - 249) * adjusted);
        const g = Math.round(115 + (68 - 115) * adjusted);
        const b = Math.round(22 + (68 - 22) * adjusted);
        return `rgba(${r}, ${g}, ${b}, 0.9)`;
    }
}
function renderMatchGoalZones() {
    const container = document.getElementById('matchGoalZonesContainer');
    if (!container || !currentMatch) return;
    
    // ✅ Calcular zones NOMÉS d'aquest partit (no acumular de tots)
    const matchZones = {
        'top-left': 0, 'top-center': 0, 'top-right': 0,
        'mid-left': 0, 'mid-center': 0, 'mid-right': 0,
        'bottom-left': 0, 'bottom-center': 0, 'bottom-right': 0,
        'unknown': 0
    };
    
    const playerZones = {};
    
    currentMatch.jugadors.forEach(j => {
        if ((j.estadistiques.gols || 0) === 0) return;
        
        const playerName = j.nom.trim();
        
        playerZones[playerName] = {
            num: j.numero,
            name: playerName,
            totalGols: j.estadistiques.gols || 0,  // ✅ Gols NOMÉS d'aquest partit
            zones: {
                'top-left': 0, 'top-center': 0, 'top-right': 0,
                'mid-left': 0, 'mid-center': 0, 'mid-right': 0,
                'bottom-left': 0, 'bottom-center': 0, 'bottom-right': 0,
                'unknown': 0
            }
        };
        
        // ✅ Només les zones d'aquest partit
        if (j.estadistiques.goalZones) {
            Object.keys(j.estadistiques.goalZones).forEach(zone => {
                const count = j.estadistiques.goalZones[zone] || 0;
                matchZones[zone] = (matchZones[zone] || 0) + count;
                playerZones[playerName].zones[zone] = count;  // ✅ Assignar directament, no sumar
            });
        }
    });
    
    const totalGols = Object.values(matchZones).reduce((sum, count) => sum + count, 0) - matchZones.unknown;
    
    if (totalGols === 0) {
        container.innerHTML = `
            <div class="no-data">
                ⚠️ Aquest partit no té dades de zones de porteria.<br>
                <small style="margin-top: 8px; display: block;">
                    Els partits nous registrats amb l'app actualitzada mostraran les zones.
                </small>
            </div>
        `;
        return;
    }
    
    const zoneOrder = [
        'top-left', 'top-center', 'top-right',
        'mid-left', 'mid-center', 'mid-right',
        'bottom-left', 'bottom-center', 'bottom-right'
    ];
    
    const zoneLabels = {
        'top-left': '⬆️ Esq',
        'top-center': '⬆️ Centre',
        'top-right': '⬆️ Dret',
        'mid-left': '➡️ Esq',
        'mid-center': '🎯 Centre',
        'mid-right': '⬅️ Dret',
        'bottom-left': '⬇️ Esq',
        'bottom-center': '⬇️ Baix',
        'bottom-right': '⬇️ Dret'
    };
    
    const maxCount = Math.max(...zoneOrder.map(z => matchZones[z] || 0));
    
    // Mapa global del partit
    container.innerHTML = `
        <div style="margin-bottom: 25px;">
            <h3 style="color: #22d3ee; font-size: 14px; margin-bottom: 10px; text-align: center;">
                📊 Mapa Global del Partit
            </h3>
            <div class="goal-zone-heatmap">
                ${zoneOrder.map(zone => {
                    const count = matchZones[zone] || 0;
                    const percentage = totalGols > 0 ? ((count / totalGols) * 100).toFixed(1) : 0;
                    const intensity = maxCount > 0 ? count / maxCount : 0;
                    const bgColor = getHeatmapColor(intensity);
                    
                    return `
                        <div class="goal-zone-cell" style="background: ${bgColor};">
                            <div class="zone-label">${zoneLabels[zone]}</div>
                            <div class="zone-count">${count}</div>
                            <div style="font-size: 9px; color: rgba(255,255,255,0.7);">${percentage}%</div>
                        </div>
                    `;
                }).join('')}
            </div>
            ${matchZones.unknown > 0 ? `
                <div style="text-align: center; margin-top: 10px; font-size: 11px; color: #bae6fd;">
                    ❓ Gols sense zona registrada: ${matchZones.unknown}
                </div>
            ` : ''}
            <div style="text-align: center; margin-top: 10px; font-size: 12px; color: #fde047;">
                Total de gols amb zona: ${totalGols}
            </div>
        </div>
        
        <div style="margin-top: 25px;">
            <h3 style="color: #22d3ee; font-size: 14px; margin-bottom: 10px; text-align: center;">
                👤 Zones per Jugador
            </h3>
            <div id="individualGoalZoneMaps" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                ${Object.values(playerZones).map(player => {
                    const totalWithZone = Object.values(player.zones).reduce((sum, count) => sum + count, 0) - (player.zones.unknown || 0);
                    const maxPlayerCount = Math.max(...zoneOrder.map(z => player.zones[z] || 0));
                    
                    // Trobar zona preferida
                    const preferredZone = zoneOrder.reduce((max, zone) => 
                        (player.zones[zone] || 0) > (player.zones[max] || 0) ? zone : max
                    , zoneOrder[0]);
                    
                    const preferredZoneLabel = {
                        'top-left': 'Dalt Esquerra',
                        'top-center': 'Dalt Centre',
                        'top-right': 'Dalt Dreta',
                        'mid-left': 'Centre Esquerra',
                        'mid-center': 'Centre',
                        'mid-right': 'Centre Dreta',
                        'bottom-left': 'Baix Esquerra',
                        'bottom-center': 'Baix Centre',
                        'bottom-right': 'Baix Dreta'
                    }[preferredZone];
                    
                    const zoneLabelsShort = {
                        'top-left': '⬆️E',
                        'top-center': '⬆️C',
                        'top-right': '⬆️D',
                        'mid-left': '➡️E',
                        'mid-center': '🎯',
                        'mid-right': '⬅️D',
                        'bottom-left': '⬇️E',
                        'bottom-center': '⬇️B',
                        'bottom-right': '⬇️D'
                    };
                    
                    return `
                        <div class="individual-zone-card">
                            <div class="player-name">${player.num}. ${player.name.split(' ')[0]}</div>
                            <div style="font-size: 10px; color: #bae6fd; text-align: center; margin-bottom: 8px;">
                                ${player.totalGols} gols (${totalWithZone} amb zona)
                            </div>
                            <div class="goal-zone-heatmap">
                                ${zoneOrder.map(zone => {
                                    const count = player.zones[zone] || 0;
                                    const intensity = maxPlayerCount > 0 ? count / maxPlayerCount : 0;
                                    const bgColor = getHeatmapColor(intensity);
                                    
                                    return `
                                        <div class="goal-zone-cell" style="background: ${bgColor};">
                                            <div class="zone-label">${zoneLabelsShort[zone]}</div>
                                            <div class="zone-count">${count}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            ${totalWithZone > 0 && player.zones[preferredZone] > 0 ? `
                                <div style="font-size: 10px; color: #fde047; text-align: center; margin-top: 8px;">
                                    ⭐ ${preferredZoneLabel} (${player.zones[preferredZone]})
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
    `;
}

/**
 * Obtenir el temps de finalització d'un quart
 */
function getQuarterEndTime(quarterStartTimes, quarterRealEndTimes, quarter) {
    const QUARTER_DURATION = 480;
    
    // Prioritzar el temps real de finalització si existeix
    if (quarterRealEndTimes && quarterRealEndTimes[quarter]) {
        return quarterRealEndTimes[quarter];
    }
    
    // Si no existeix, utilitzar l'inici del següent quart
    const quarterOrder = ['q1', 'q2', 'q3', 'q4'];
    const currentIndex = quarterOrder.indexOf(quarter);
    
    if (currentIndex < 3) {
        const nextQuarter = quarterOrder[currentIndex + 1];
        if (quarterStartTimes[nextQuarter]) {
            return quarterStartTimes[nextQuarter];
        }
    }
    
    // Si no hi ha res, afegir 8 minuts a l'inici del quart
    return quarterStartTimes[quarter] + (QUARTER_DURATION * 1000);
}
// ✅ GESTIÓ DE SELECCIÓ D'EQUIP
let selectedTeam = localStorage.getItem('selectedTeam') || null;

function selectTeam(team) {
    console.log('🔍 Team seleccionat:', team);
    
    selectedTeam = team;
    localStorage.setItem('selectedTeam', team);
    document.getElementById('teamSelectionModal').style.display = 'none';
    
    // ✅ APLICAR TEMA VISUAL SEGONS L'EQUIP
    document.body.className = team === 'cadet' ? 'theme-cadet' : 'theme-juvenil';
    
    // ✅ ACTUALITZAR TÍTOL I SUBTÍTOL
    const teamName = team === 'cadet' ? 'CADET' : 'JUVENIL';
    const emoji = team === 'cadet' ? '⬛' : '🟦';
    const coach = team === 'cadet' ? 'Didac Cobacho' : 'Jordi Busquets';
    document.getElementById('mainTitle').innerHTML = `${emoji} 📊 Estadístiques CN Terrassa - ${teamName} ${emoji}`;
    document.getElementById('coachName').innerHTML = `👨‍🏫 Entrenador: ${coach}`;
    //document.getElementById('mainSubtitle').innerHTML = `Temporada 25/26 • ${allMatches.length} partits`;
    
    // Carregar dades
    loadAllMatches(team);
}

async function changeTeam() {
    // Actualitzar si estem al tab ACTAWP
    if (!document.getElementById('actawpTab').classList.contains('hidden')) {
        await checkLastUpdate();
    }
    
    // Netejar i recarregar
    localStorage.removeItem('selectedTeam');
    location.reload();
}

// ✅ COMPROVAR SI JA HI HA EQUIP SELECCIONAT
window.addEventListener('DOMContentLoaded', () => {
    if (selectedTeam) {
        document.getElementById('teamSelectionModal').style.display = 'none';
        
        // ✅ APLICAR TEMA VISUAL SEGONS L'EQUIP
        document.body.className = selectedTeam === 'cadet' ? 'theme-cadet' : 'theme-juvenil';
        
        // ✅ ACTUALITZAR TÍTOL I SUBTÍTOL
        const teamName = selectedTeam === 'cadet' ? 'CADET' : 'JUVENIL';
        const emoji = selectedTeam === 'cadet' ? '⬛' : '🟦';
        const coach = selectedTeam === 'cadet' ? 'Dídac Cobacho' : 'Jordi Busquets';
        document.getElementById('mainTitle').innerHTML = `${emoji} 📊 Estadístiques CN Terrassa - ${teamName} ${emoji}`;
        document.getElementById('coachName').innerHTML = `👨‍🏫 Entrenador: ${coach}`;
        document.getElementById('mainSubtitle').innerHTML = `Temporada 25/26`;
        
        loadAllMatches(selectedTeam);
    }
});
// ============================================
// FUNCIONS PER ESTADÍSTIQUES INDIVIDUALS
// ============================================

let selectedPlayer = null;
let allPlayersData = {};
let comparisonPlayers = [];

function initializePlayerSelector() {
    const container = document.getElementById('individualTab');
    
    // Crear la taula de tots els jugadors (igual que a comparació)
    container.innerHTML = `
        <div class="card">
            <h2 class="section-title">👤 Selecciona un Jugador</h2>
            <p style="color: #bae6fd; margin-bottom: 20px; font-size: 14px;">
                Fes clic sobre un jugador per veure les seves estadístiques detallades
            </p>
            <div style="overflow-x: auto;">
                <table class="comparison-table" id="comparisonTableIndividual"></table>
            </div>
        </div>
        
        <div id="individualPlayerDetails" class="hidden"></div>
    `;
    
    // Generar la taula amb tots els jugadors
    renderPlayerSelectionTable();
}
function getAllUniquePlayers() {
    const playersMap = new Map();
    
    allMatches.forEach(match => {
        if (!match.jugadors) return;
        
        match.jugadors.forEach(jugador => {
            const key = `${jugador.numero}-${jugador.nom}`;
            
            if (!playersMap.has(key)) {
                playersMap.set(key, {
                    num: jugador.numero,
                    name: jugador.nom,
                    partidos: 0,
                    gols: 0,
                    goalTypes: { 'h+': 0, penalty: 0, contra: 0, boya: 0, normal: 0 },
                    assistencies: 0,
                    robatoris: 0,
                    blocks: 0,
                    blocatges: 0,
                    parades: 0,
                    faltesRebudes: 0,
                    exclusions: 0,
                    exclusionTypes: { normal: 0, penalty: 0 },
                    infraccions2m: 0,
                    contrafaltes: 0,
                    perdues: 0,
                    xutsFallats: 0,
                    penaltyMissed: 0
                });
            }
            
            const player = playersMap.get(key);
            const stats = jugador.estadistiques || {};
            
            player.partidos++;
            player.gols += stats.gols || 0;
            
            // Goal types
            if (stats.goalTypes) {
                Object.keys(stats.goalTypes).forEach(type => {
                    player.goalTypes[type] = (player.goalTypes[type] || 0) + (stats.goalTypes[type] || 0);
                });
            }
            
            player.assistencies += stats.assistencies || 0;
            player.robatoris += stats.robatoris || 0;
            player.blocks += stats.blocks || 0;
            player.blocatges += stats.blocatges || 0;
            player.parades += stats.parades || 0;
            player.faltesRebudes += stats.faltesRebudes || 0;
            player.exclusions += stats.exclusions || 0;
            
            if (stats.exclusionTypes) {
                player.exclusionTypes.normal += stats.exclusionTypes.normal || 0;
                player.exclusionTypes.penalty += stats.exclusionTypes.penalty || 0;
            }
            
            player.infraccions2m += stats.infraccions2m || 0;
            player.contrafaltes += stats.contrafaltes || 0;
            player.perdues += stats.perdues || 0;
            player.xutsFallats += stats.xutsFallats || 0;
            player.penaltyMissed += stats.penaltyMissed || 0;
        });
    });
    
    return Array.from(playersMap.values()).sort((a, b) => a.num - b.num);
}
function renderPlayerSelectionTable() {
    const allPlayers = getAllUniquePlayers();
    renderComparisonTable(allPlayers, true, 'comparisonTableIndividual');
    
    // Afegir event listeners per fer clic als jugadors
    document.querySelectorAll('.player-row-clickable').forEach(row => {
        row.addEventListener('click', function() {
            const playerNum = parseInt(this.dataset.playerNum);
            const playerName = this.dataset.playerName;
            showIndividualPlayerDetails({ num: playerNum, name: playerName });
        });
    });
}

function showIndividualPlayerDetails(player) {
    selectedPlayer = player;
    
    // Amagar la taula de selecció
    document.querySelector('#individualTab .card').classList.add('hidden');
    
    // Mostrar el contenidor de detalls
    const detailsContainer = document.getElementById('individualPlayerDetails');
    detailsContainer.classList.remove('hidden');
    
    // Calcular totes les dades del jugador
    const playerData = calculatePlayerFullStats(selectedPlayer);
    
    // Detectar si és porter
    const isGoalkeeper = selectedPlayer.num === 1 || selectedPlayer.num === 13 || playerData.totalSaves > 0;
    
   if (isGoalkeeper) {
    // Botó tornar + contingut porter
    detailsContainer.innerHTML = `
        <div class="card">
            <button class="btn" onclick="backToPlayerSelection()" style="margin-bottom: 20px; background: #64748b;">
                ← Tornar a la Llista de Jugadors
            </button>
        </div>
        
        <div class="card">
            <h2 class="section-title">📊 Resum Estadístic Porter</h2>
            <div class="info-grid" id="goalkeeperSummaryGrid"></div>
        </div>
        
        <div class="card">
            <h2 class="section-title">📈 Percentatge de Parades</h2>
            <canvas id="goalkeeperSavePercentageChart" style="max-height: 300px;"></canvas>
        </div>
        
        <div class="card">
            <h2 class="section-title">🧤 Tipus de Parades</h2>
            <canvas id="goalkeeperSaveTypeChart" style="max-height: 300px;"></canvas>
        </div>
        
        <div class="card">
            <h2 class="section-title">🎯 Zones de Parades</h2>
            <div id="goalkeeperZonesHeatmap"></div>
        </div>
        
        <div class="card">
            <h2 class="section-title">📊 Rendiment per Rival</h2>
            <div style="overflow-x: auto;">
                <table class="comparison-table" id="goalkeeperByRivalTable"></table>
            </div>
        </div>
        
        <div class="card">
            <h2 class="section-title">📈 Evolució del Percentatge de Parades</h2>
            <canvas id="goalkeeperEvolutionChart" style="max-height: 300px;"></canvas>
        </div>
        
        <div class="card">
            <h2 class="section-title">⚖️ Comparativa amb Altres Porters</h2>
            <canvas id="goalkeeperComparisonChart" style="max-height: 300px;"></canvas>
        </div>
        
        <div class="card">
            <h2 class="section-title">🎯 Estadístiques de Penalties</h2>
            <div class="info-grid" id="goalkeeperPenaltiesGrid"></div>
        </div>
    `;
    
    // Esperar que el DOM es renderitzi abans de cridar les funcions
    setTimeout(() => {
        renderGoalkeeperStats(playerData);
    }, 100);
    
} else {
    // Botó tornar + contingut jugador normal
    detailsContainer.innerHTML = `
        <div class="card">
            <button class="btn" onclick="backToPlayerSelection()" style="margin-bottom: 20px; background: #64748b;">
                ← Tornar a la Llista de Jugadors
            </button>
        </div>
        
        <div class="card">
            <div id="playerHeader" style="text-align: center;"></div>
        </div>
        
        <div class="card">
            <h2 class="section-title">📊 Resum Estadístic</h2>
            <div class="info-grid" id="playerSummaryGrid"></div>
        </div>
        
        <div class="card">
            <h2 class="section-title">📈 Evolució per Partit</h2>
            <canvas id="playerEvolutionChart" style="max-height: 300px;"></canvas>
        </div>
        
        <div class="card">
            <h2 class="section-title">🎯 Zones de Gol</h2>
            <div id="playerGoalZonesHeatmap"></div>
        </div>
        
        <div class="card">
            <h2 class="section-title">⚖️ Rendiment vs Equip</h2>
            <canvas id="playerVsTeamChart" style="max-height: 300px;"></canvas>
        </div>
        
        <div class="card">
            <h2 class="section-title">🏠 Rendiment Local vs Visitant</h2>
            <canvas id="homeAwayChart" style="max-height: 250px;"></canvas>
        </div>
        
        <div class="card">
            <h2 class="section-title">⏱️ Rendiment per Quart</h2>
            <canvas id="quarterPerformanceChart" style="max-height: 250px;"></canvas>
        </div>
        
        <div class="card">
            <h2 class="section-title">📜 Historial de Partits</h2>
            <div style="overflow-x: auto;">
                <table class="comparison-table" id="playerMatchHistoryTable"></table>
            </div>
        </div>
        
        <div class="card">
            <h2 class="section-title">👥 Comparar amb Altres Jugadors</h2>
            <div id="comparePlayersCheckboxes"></div>
            <button class="btn" onclick="compareSelectedPlayers()" style="margin-top: 15px; background: #06b6d4;">
                Comparar Seleccionats
            </button>
        </div>
        
        <div id="multiPlayerComparisonContent" class="hidden">
            <div class="card">
                <h2 class="section-title">📊 Comparativa Multi-Jugador</h2>
                <canvas id="multiPlayerComparisonChart" style="max-height: 400px;"></canvas>
            </div>
        </div>
    `;
    
    // Esperar que el DOM es renderitzi abans de cridar les funcions
    setTimeout(() => {
        renderPlayerHeader(playerData);
        renderPlayerSummary(playerData);
        renderPlayerEvolutionChart(playerData);
        renderPlayerGoalZones(playerData);
        renderPlayerVsTeamChart(playerData);
        renderHomeAwayChart(playerData);
        renderQuarterPerformanceChart(playerData);
        renderPlayerMatchHistory(playerData);
        initializeComparePlayersCheckboxes(selectedPlayer);
    }, 100);
}
}
function backToPlayerSelection() {
    // Mostrar la taula de selecció
    document.querySelector('#individualTab .card').classList.remove('hidden');
    
    // Amagar els detalls
    document.getElementById('individualPlayerDetails').classList.add('hidden');
}

// Mostrar estadístiques del jugador seleccionat
function showPlayerStats() {
    const select = document.getElementById('playerSelector');
    const value = select.value;
    
    if (!value) {
        document.getElementById('playerStatsContent').classList.add('hidden');
        document.getElementById('goalkeeperStatsContent').classList.add('hidden');
        return;
    }
    
    const [num, name] = value.split('|');
    selectedPlayer = { num: parseInt(num), name: name };
    
    // Calcular totes les dades del jugador
    const playerData = calculatePlayerFullStats(selectedPlayer);
    
    // ✅ DETECTAR SI ÉS PORTER (número 1 o 13, o té parades)
    const isGoalkeeper = selectedPlayer.num === 1 || selectedPlayer.num === 13 || playerData.totalSaves > 0;
    
    if (isGoalkeeper) {
        // Mostrar estadístiques de porter
        document.getElementById('playerStatsContent').classList.add('hidden');
        document.getElementById('goalkeeperStatsContent').classList.remove('hidden');
        
        renderGoalkeeperStats(playerData);
    } else {
        // Mostrar estadístiques normals
        document.getElementById('playerStatsContent').classList.remove('hidden');
        document.getElementById('goalkeeperStatsContent').classList.add('hidden');
        
        renderPlayerHeader(playerData);
        renderPlayerSummary(playerData);
        renderPlayerEvolutionChart(playerData);
        renderPlayerGoalZones(playerData);
        renderPlayerVsTeamChart(playerData);
        renderHomeAwayChart(playerData);
        renderQuarterPerformanceChart(playerData);
        renderPlayerMatchHistory(playerData);
        initializeComparePlayersCheckboxes(selectedPlayer);
    }
}

// Calcular estadístiques completes del jugador
function calculatePlayerFullStats(player) {
    const data = {
        num: player.num,
        name: player.name,
        totalMatches: 0,
        totalMinutes: 0,
        totalGoals: 0,
        totalAssists: 0,
        totalExclusions: 0,
        totalSteals: 0,
        totalLosses: 0,
        totalSaves: 0,
        mvpCount: 0,  // ← Comptarem aquí
        matchDetails: [],
        goalsByType: {},
        goalsByZone: {},
        goalsByQuarter: { q1: 0, q2: 0, q3: 0, q4: 0 },
        minutesByQuarter: { q1: 0, q2: 0, q3: 0, q4: 0 },
        homeStats: { matches: 0, goals: 0, minutes: 0 },
        awayStats: { matches: 0, goals: 0, minutes: 0 },
        evolution: []
    };
    
    allMatches.forEach(match => {
        const matchPlayer = match.jugadors?.find(j => 
            j.numero === player.num && j.nom.trim() === player.name
        );
        
        if (!matchPlayer) return;
        
        data.totalMatches++;
        
        const stats = matchPlayer.estadistiques || {};
        
        // ✅ CALCULAR MVP: qui té la millor valoració del partit?
        const playersWithValue = match.jugadors.map(j => {
            const valor = calculatePlayerValue({
                gols: j.estadistiques.gols,
                goalTypes: j.estadistiques.goalTypes,
                assistencies: j.estadistiques.assistencies,
                robatoris: j.estadistiques.robatoris,
                blocatges: j.estadistiques.blocks || 0,
                parades: j.estadistiques.parades,
                faltesRebudes: j.estadistiques.faltesRebudes || 0,
                exclusions: j.estadistiques.exclusions,
                exclusionTypes: j.estadistiques.exclusionTypes || { normal: 0, penalty: 0 },
                penaltyMissed: j.estadistiques.penaltyMissed,
                perdues: j.estadistiques.perdues,
                xutsFallats: j.estadistiques.xutsFallats,
                golsRebuts: j.estadistiques.golsRebuts || 0
            });
            return { numero: j.numero, nom: j.nom.trim(), valor };
        }).sort((a, b) => b.valor - a.valor);
        
        const mvp = playersWithValue[0];
        
        // ✅ Comprovar si aquest jugador és l'MVP del partit
        if (mvp && mvp.numero === player.num && mvp.nom === player.name) {
            data.mvpCount++;
        }
        
        // Calcular minuts
        let minutes = 0;
        let minutesByQ = { q1: 0, q2: 0, q3: 0, q4: 0 };
        
        if (match.playerWaterChanges && match.playerWaterChanges.length > 0 && match.quarterStartTimes) {
            const playerTimes = calculateMatchPlayingTimes(match);
            const playerTimeData = playerTimes[player.num];
            
            if (playerTimeData) {
                minutes = Math.round(playerTimeData.totalTime / 60);
                minutesByQ.q1 = playerTimeData.q1;
                minutesByQ.q2 = playerTimeData.q2;
                minutesByQ.q3 = playerTimeData.q3;
                minutesByQ.q4 = playerTimeData.q4;
            }
        } else {
            minutes = matchPlayer.temps || 0;
        }
        
        data.totalMinutes += minutes;
        data.totalGoals += stats.gols || 0;
        data.totalAssists += stats.assistencies || 0;
        data.totalExclusions += stats.exclusions || 0;
        data.totalSteals += stats.robatoris || 0;
        data.totalLosses += stats.perdues || 0;
        data.totalSaves += stats.parades || 0;
        
        // Goals by type
        if (stats.goalTypes) {
            Object.keys(stats.goalTypes).forEach(type => {
                data.goalsByType[type] = (data.goalsByType[type] || 0) + (stats.goalTypes[type] || 0);
            });
        }
        
        // Goals by zone
        if (stats.goalZones) {
            Object.keys(stats.goalZones).forEach(zone => {
                data.goalsByZone[zone] = (data.goalsByZone[zone] || 0) + (stats.goalZones[zone] || 0);
            });
        }
        
        // Goals by quarter
        if (match.chronologicalActions) {
            match.chronologicalActions
                .filter(a => a.type === 'goal' && a.playerNum === player.num)
                .forEach(a => {
                    if (a.quarter) data.goalsByQuarter[a.quarter]++;
                });
        }
        
        // Minutes by quarter (en segons)
        data.minutesByQuarter.q1 += minutesByQ.q1;
        data.minutesByQuarter.q2 += minutesByQ.q2;
        data.minutesByQuarter.q3 += minutesByQ.q3;
        data.minutesByQuarter.q4 += minutesByQ.q4;
        
        // Home vs Away
        const isHome = match.matchLocation === 'casa';
        if (isHome) {
            data.homeStats.matches++;
            data.homeStats.goals += stats.gols || 0;
            data.homeStats.minutes += minutes;
        } else {
            data.awayStats.matches++;
            data.awayStats.goals += stats.gols || 0;
            data.awayStats.minutes += minutes;
        }
        
        // Evolution (per gràfic temporal)
        data.evolution.push({
            date: match.data || match.rival || `Partit ${data.totalMatches}`,
            rival: match.rivalTeam || match.rival,
            goals: stats.gols || 0,
            minutes: minutes
        });
        
        // Match details (per taula)
        const isMVP = mvp && mvp.numero === player.num && mvp.nom === player.name;
        
        data.matchDetails.push({
            date: match.data || '',
            rival: match.rivalTeam || match.rival || 'Desconocido',
            location: (match.matchLocation === 'home' || match.matchLocation === 'casa' || match.homeAway === 'casa') ? '🏠' : '✈️',
            minutes: minutes,
            goals: stats.gols || 0,
            assists: stats.assistencies || 0,
            exclusions: stats.exclusions || 0,
            steals: stats.robatoris || 0,
            saves: stats.parades || 0,
            blocks: stats.blocks || 0,
            turnovers: stats.perdues || 0,
            shotsMissed: stats.xutsFallats || 0,
            infraccions2m: stats.infraccions2m || 0,
            contrafaltes: stats.contrafaltes || 0,
            foulsReceived: stats.faltesRebudes || 0,
            penaltyMissed: stats.penaltyMissed || 0,
            mvp: isMVP ? '⭐' : ''
        });
    });
    
    // Ordenar evolució per data
    data.evolution.sort((a, b) => {
        const dateA = parseSpanishDate(a.date);
        const dateB = parseSpanishDate(b.date);
        return dateA - dateB;
    });
    
    return data;
}
// Funció auxiliar per formatar segons a format mm:ss
function formatTimeFromSeconds(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}
// Renderitzar capçalera del jugador
function renderPlayerHeader(data) {
    const header = document.getElementById('playerHeader');
    header.innerHTML = `
        <div class="player-number-big">${data.num}</div>
        <h3 style="font-size: 24px; margin-bottom: 10px;">${data.name}</h3>
        <p style="font-size: 16px; color: #bae6fd; margin-top: 10px;">
            ${data.totalMatches} partits jugats | ${data.totalMinutes} minuts totals
        </p>
    `;
}

// Renderitzar resum estadístic
function renderPlayerSummary(data) {
    const grid = document.getElementById('playerSummaryGrid');
    
    const avgGoals = (data.totalGoals / data.totalMatches).toFixed(2);
    const avgMinutes = (data.totalMinutes / data.totalMatches).toFixed(1);
    const avgAssists = (data.totalAssists / data.totalMatches).toFixed(2);
    const avgExclusions = (data.totalExclusions / data.totalMatches).toFixed(2);
    
    grid.innerHTML = `
        <div class="stat-card">
            <div class="stat-value">${data.totalGoals}</div>
            <div class="stat-label">Gols Totals</div>
            <div class="stat-sublabel">${avgGoals} per partit</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${data.totalMinutes}'</div>
            <div class="stat-label">Minuts Totals</div>
            <div class="stat-sublabel">${avgMinutes}' per partit</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${avgGoals}</div>
            <div class="stat-label">Mitjana Gols</div>
            <div class="stat-sublabel">per partit</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${data.totalAssists}</div>
            <div class="stat-label">Assistències</div>
            <div class="stat-sublabel">${avgAssists} per partit</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${data.totalExclusions}</div>
            <div class="stat-label">Exclusions</div>
            <div class="stat-sublabel">${avgExclusions} per partit</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${data.totalSteals}</div>
            <div class="stat-label">Robatoris</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${data.mvpCount}</div>
            <div class="stat-label">MVP</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${data.totalSaves}</div>
            <div class="stat-label">Parades</div>
        </div>
    `;
}

// Gràfic d'evolució temporal
function renderPlayerEvolutionChart(data) {
    const ctx = document.getElementById('playerEvolutionChart');
    
    if (window.playerEvolutionChartInstance) {
        window.playerEvolutionChartInstance.destroy();
    }
    
    window.playerEvolutionChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.evolution.map(e => e.date),
            datasets: [
                {
                    label: 'Gols',
                    data: data.evolution.map(e => e.goals),
                    borderColor: '#22d3ee',
                    backgroundColor: 'rgba(34, 211, 238, 0.1)',
                    tension: 0.3,
                    yAxisID: 'y'
                },
                {
                    label: 'Minuts',
                    data: data.evolution.map(e => e.minutes),
                    borderColor: '#fbbf24',
                    backgroundColor: 'rgba(251, 191, 36, 0.1)',
                    tension: 0.3,
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: { labels: { color: 'white' } },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return data.evolution[context[0].dataIndex].rival;
                        }
                    }
                }
            },
            scales: {
                x: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                y: {
                    type: 'linear',
                    position: 'left',
                    title: { display: true, text: 'Gols', color: 'white' },
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                },
                y1: {
                    type: 'linear',
                    position: 'right',
                    title: { display: true, text: 'Minuts', color: 'white' },
                    ticks: { color: 'white' },
                    grid: { display: false }
                }
            }
        }
    });
}

// Mapa de zones de gol
function renderPlayerGoalZones(data) {
    const container = document.getElementById('playerGoalZonesHeatmap');
    
    const zones = [
        ['top-left', 'top-center', 'top-right'],
        ['mid-left', 'mid-center', 'mid-right'],
        ['bottom-left', 'bottom-center', 'bottom-right']
    ];
    
    const zoneLabels = {
        'top-left': 'Superior Esq.',
        'top-center': 'Superior Centre',
        'top-right': 'Superior Dret',
        'mid-left': 'Mig Esq.',
        'mid-center': 'Mig Centre',
        'mid-right': 'Mig Dret',
        'bottom-left': 'Inferior Esq.',
        'bottom-center': 'Inferior Centre',
        'bottom-right': 'Inferior Dret'
    };
    
    const maxGoals = Math.max(...Object.values(data.goalsByZone), 1);
    
    let html = '<div class="zone-heatmap-container">';
    
    zones.forEach(row => {
        row.forEach(zone => {
            const count = data.goalsByZone[zone] || 0;
            const intensity = count / maxGoals;
            const bgColor = `rgba(34, 197, 94, ${intensity})`;
            
            html += `
                <div class="zone-cell" style="background: ${bgColor};">
                    <div class="zone-label">${zoneLabels[zone]}</div>
                    <div class="zone-count">${count}</div>
                </div>
            `;
        });
    });
    
    html += '</div>';
    container.innerHTML = html;
}

// Comparativa jugador vs mitjana equip
function renderPlayerVsTeamChart(data) {
    const ctx = document.getElementById('playerVsTeamChart');
    
    // Calcular mitjanes de l'equip
    const teamAvg = calculateTeamAverages();
    
    const playerAvg = {
        goalsPerMatch: data.totalGoals / data.totalMatches,
        assistsPerMatch: data.totalAssists / data.totalMatches,
        exclusionsPerMatch: data.totalExclusions / data.totalMatches,
        minutesPerMatch: data.totalMinutes / data.totalMatches
    };
    
    if (window.playerVsTeamChartInstance) {
        window.playerVsTeamChartInstance.destroy();
    }
    
    window.playerVsTeamChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Gols/Partit', 'Assist./Partit', 'Excl./Partit', 'Min/Partit'],
            datasets: [
                {
                    label: data.name,
                    data: [
                        playerAvg.goalsPerMatch,
                        playerAvg.assistsPerMatch,
                        playerAvg.exclusionsPerMatch,
                        playerAvg.minutesPerMatch
                    ],
                    backgroundColor: '#22d3ee'
                },
                {
                    label: 'Mitjana Equip',
                    data: [
                        teamAvg.goalsPerMatch,
                        teamAvg.assistsPerMatch,
                        teamAvg.exclusionsPerMatch,
                        teamAvg.minutesPerMatch
                    ],
                    backgroundColor: '#fbbf24'
                }
            ]
        },
        options: {
            responsive: true,
            plugins: { legend: { labels: { color: 'white' } } },
            scales: {
                x: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                y: { 
                    ticks: { color: 'white' }, 
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    title: { display: true, text: 'Mitjana', color: 'white' }
                }
            }
        }
    });
}

// Calcular mitjanes de tot l'equip
function calculateTeamAverages() {
    let totalGoals = 0, totalAssists = 0, totalExclusions = 0, totalMinutes = 0, totalPlayers = 0;
    
    allMatches.forEach(match => {
        match.jugadors?.forEach(j => {
            if (!j.numero) return;
            const stats = j.estadistiques || {};
            totalGoals += stats.gols || 0;
            totalAssists += stats.assistencies || 0;
            totalExclusions += stats.exclusions || 0;
            totalMinutes += j.temps || 0;
            totalPlayers++;
        });
    });
    
    return {
        goalsPerMatch: totalGoals / totalPlayers,
        assistsPerMatch: totalAssists / totalPlayers,
        exclusionsPerMatch: totalExclusions / totalPlayers,
        minutesPerMatch: totalMinutes / totalPlayers
    };
}

// Rendiment casa vs fora
function renderHomeAwayChart(data) {
    const ctx = document.getElementById('homeAwayChart');
    
    const homeAvg = data.homeStats.matches > 0 ? data.homeStats.goals / data.homeStats.matches : 0;
    const awayAvg = data.awayStats.matches > 0 ? data.awayStats.goals / data.awayStats.matches : 0;
    const homeMinAvg = data.homeStats.matches > 0 ? data.homeStats.minutes / data.homeStats.matches : 0;
    const awayMinAvg = data.awayStats.matches > 0 ? data.awayStats.minutes / data.awayStats.matches : 0;
    
    if (window.homeAwayChartInstance) {
        window.homeAwayChartInstance.destroy();
    }
    
    window.homeAwayChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Partits', 'Gols/Partit', 'Minuts/Partit'],
            datasets: [
                {
                    label: '🏠 Casa',
                    data: [data.homeStats.matches, homeAvg, homeMinAvg],
                    backgroundColor: '#22c55e'
                },
                {
                    label: '✈️ Fora',
                    data: [data.awayStats.matches, awayAvg, awayMinAvg],
                    backgroundColor: '#3b82f6'
                }
            ]
        },
        options: {
            responsive: true,
            plugins: { legend: { labels: { color: 'white' } } },
            scales: {
                x: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                y: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } }
            }
        }
    });
}

// Rendiment per quarter
function renderQuarterPerformanceChart(data) {
    const ctx = document.getElementById('quarterPerformanceChart');
    
    // Convertir segons a minuts per mostrar
    const minutesPerQuarter = {
        q1: (data.minutesByQuarter.q1 / 60).toFixed(1),
        q2: (data.minutesByQuarter.q2 / 60).toFixed(1),
        q3: (data.minutesByQuarter.q3 / 60).toFixed(1),
        q4: (data.minutesByQuarter.q4 / 60).toFixed(1)
    };
    
    const avgGoals = ['q1', 'q2', 'q3', 'q4'].map(q => {
        const mins = data.minutesByQuarter[q] / 60;
        const goals = data.goalsByQuarter[q];
        return mins > 0 ? (goals / mins * 60).toFixed(2) : 0;
    });
    
    if (window.quarterPerformanceChartInstance) {
        window.quarterPerformanceChartInstance.destroy();
    }
    
    window.quarterPerformanceChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['1r Quarter', '2n Quarter', '3r Quarter', '4t Quarter'],
            datasets: [
                {
                    label: 'Minuts Jugats',
                    data: [minutesPerQuarter.q1, minutesPerQuarter.q2, minutesPerQuarter.q3, minutesPerQuarter.q4],
                    backgroundColor: '#8b5cf6',
                    yAxisID: 'y'
                },
                {
                    label: 'Gols',
                    data: [data.goalsByQuarter.q1, data.goalsByQuarter.q2, data.goalsByQuarter.q3, data.goalsByQuarter.q4],
                    backgroundColor: '#22d3ee',
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            plugins: { legend: { labels: { color: 'white' } } },
            scales: {
                x: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                y: {
                    type: 'linear',
                    position: 'left',
                    title: { display: true, text: 'Minuts', color: 'white' },
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                },
                y1: {
                    type: 'linear',
                    position: 'right',
                    title: { display: true, text: 'Gols', color: 'white' },
                    ticks: { color: 'white' },
                    grid: { display: false }
                }
            }
        }
    });
}

// Taula històric de partits
function renderPlayerMatchHistory(data) {
    const table = document.getElementById('playerMatchHistoryTable');
    
    // Ordenar per data (més recent primer)
    const sortedMatches = [...data.matchDetails].sort((a, b) => {
        const dateA = parseSpanishDate(a.date);
        const dateB = parseSpanishDate(b.date);
        return dateB - dateA;
    });
    
    // Calcular totals
    const totals = {
        goals: 0,
        assists: 0,
        exclusions: 0,
        steals: 0,
        saves: 0,
        blocks: 0,
        turnovers: 0,
        shotsMissed: 0,
        infraccions2m: 0,
        contrafaltes: 0,
        foulsReceived: 0,
        penaltyMissed: 0,
        mvpCount: 0
    };
    
    sortedMatches.forEach(m => {
        totals.goals += m.goals;
        totals.assists += m.assists;
        totals.exclusions += m.exclusions;
        totals.steals += m.steals;
        totals.saves += m.saves;
        totals.blocks += m.blocks;
        totals.turnovers += m.turnovers;
        totals.shotsMissed += m.shotsMissed;
        totals.infraccions2m += m.infraccions2m;
        totals.contrafaltes += m.contrafaltes;
        totals.foulsReceived += m.foulsReceived;
        totals.penaltyMissed += m.penaltyMissed;
        if (m.mvp === '⭐') totals.mvpCount++;
    });
    
    table.innerHTML = `
        <thead>
            <tr>
                <th>Data</th>
                <th>Rival</th>
                <th>Lloc</th>
                <th>Min</th>
                <th style="background: rgba(34, 197, 94, 0.2);" title="Accions Positives" colspan="6">✅ POSITIVES</th>
                <th style="background: rgba(239, 68, 68, 0.2);" title="Accions Negatives" colspan="6">❌ NEGATIVES</th>
                <th>MVP</th>
            </tr>
            <tr style="font-size: 11px;">
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th title="Gols">⚽ G</th>
                <th title="Assistències">🎯 A</th>
                <th title="Robatoris">🛡️ R</th>
                <th title="Parades">🧤 P</th>
                <th title="Blocks">🚫 B</th>
                <th title="Faltes Rebudes">⚠️ FR</th>
                <th title="Exclusions">🟥 E</th>
                <th title="Pèrdues">❌ Pèr</th>
                <th title="Xuts Fallats">🎯❌ XF</th>
                <th title="Infraccions 2m">📏 2m</th>
                <th title="Contrafaltes">⚠️ CF</th>
                <th title="Penalties Fallats">PenF</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            ${sortedMatches.map(m => `
                <tr>
                    <td>${m.date}</td>
                    <td>${m.rival}</td>
                    <td style="text-align: center;">${m.location}</td>
                    <td>${m.minutes}'</td>
                    <td style="font-weight: bold; color: #22d3ee;">${m.goals}</td>
                    <td style="color: #22c55e;">${m.assists}</td>
                    <td style="color: #06b6d4;">${m.steals}</td>
                    <td style="color: #8b5cf6;">${m.saves}</td>
                    <td style="color: #a78bfa;">${m.blocks}</td>
                    <td style="color: #fbbf24;">${m.foulsReceived}</td>
                    <td style="color: #ef4444;">${m.exclusions}</td>
                    <td style="color: #fca5a5;">${m.turnovers}</td>
                    <td style="color: #f97316;">${m.shotsMissed}</td>
                    <td style="color: #fb923c;">${m.infraccions2m}</td>
                    <td style="color: #fbbf24;">${m.contrafaltes}</td>
                    <td style="color: ${m.penaltyMissed > 0 ? '#ef4444' : '#22c55e'};">${m.penaltyMissed}</td>
                    <td style="text-align: center;">${m.mvp}</td>
                </tr>
            `).join('')}
        </tbody>
        <tfoot>
            <tr style="font-weight: bold; background: rgba(34, 211, 238, 0.2);">
                <td colspan="3">TOTALS</td>
                <td>${data.totalMinutes}'</td>
                <td style="color: #22d3ee;">${totals.goals}</td>
                <td style="color: #22c55e;">${totals.assists}</td>
                <td style="color: #06b6d4;">${totals.steals}</td>
                <td style="color: #8b5cf6;">${totals.saves}</td>
                <td style="color: #a78bfa;">${totals.blocks}</td>
                <td style="color: #fbbf24;">${totals.foulsReceived}</td>
                <td style="color: #ef4444;">${totals.exclusions}</td>
                <td style="color: #fca5a5;">${totals.turnovers}</td>
                <td style="color: #f97316;">${totals.shotsMissed}</td>
                <td style="color: #fb923c;">${totals.infraccions2m}</td>
                <td style="color: #fbbf24;">${totals.contrafaltes}</td>
                <td style="color: ${totals.penaltyMissed > 0 ? '#ef4444' : '#22c55e'};">${totals.penaltyMissed}</td>
                <td style="text-align: center;">${totals.mvpCount} ⭐</td>
            </tr>
        </tfoot>
    `;
}

// Inicialitzar checkboxes per comparar jugadors
function initializeComparePlayersCheckboxes(currentPlayer) {
    const container = document.getElementById('comparePlayersCheckboxes');
    const playerSet = new Set();
    
    allMatches.forEach(match => {
        match.jugadors?.forEach(j => {
            if (j.numero && !(j.numero === currentPlayer.num && j.nom.trim() === currentPlayer.name)) {
                playerSet.add(JSON.stringify({ num: j.numero, name: j.nom.trim() }));
            }
        });
    });
    
    const players = Array.from(playerSet)
        .map(p => JSON.parse(p))
        .sort((a, b) => a.num - b.num);
    
    container.innerHTML = players.map(p => `
        <label>
            <input type="checkbox" value="${p.num}|${p.name}" class="compare-player-checkbox">
            ${p.num}. ${p.name}
        </label>
    `).join('');
}

// Comparar jugadors seleccionats
function compareSelectedPlayers() {
    const checkboxes = document.querySelectorAll('.compare-player-checkbox:checked');
    
    if (checkboxes.length === 0) {
        alert('Selecciona almenys un jugador per comparar');
        return;
    }
    
    if (checkboxes.length > 4) {
        alert('Màxim 4 jugadors per comparar (a més del jugador principal)');
        return;
    }
    
    const playersToCompare = [selectedPlayer];
    
    checkboxes.forEach(cb => {
        const [num, name] = cb.value.split('|');
        playersToCompare.push({ num: parseInt(num), name: name });
    });
    
    renderMultiPlayerComparison(playersToCompare);
    document.getElementById('multiPlayerComparisonContent').classList.remove('hidden');
}

// Gràfic comparatiu multi-jugador
function renderMultiPlayerComparison(players) {
    const ctx = document.getElementById('multiPlayerComparisonChart');
    
    const datasets = players.map((player, idx) => {
        const data = calculatePlayerFullStats(player);
        const colors = ['#22d3ee', '#fbbf24', '#22c55e', '#8b5cf6', '#ef4444'];
        
        return {
            label: `${player.num}. ${player.name}`,
            data: [
                (data.totalGoals / data.totalMatches).toFixed(2),
                (data.totalAssists / data.totalMatches).toFixed(2),
                (data.totalMinutes / data.totalMatches).toFixed(1),
                (data.totalExclusions / data.totalMatches).toFixed(2)
            ],
            backgroundColor: colors[idx % colors.length]
        };
    });
    
    if (window.multiPlayerComparisonChartInstance) {
        window.multiPlayerComparisonChartInstance.destroy();
    }
    
    window.multiPlayerComparisonChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Gols/Partit', 'Assist./Partit', 'Min/Partit', 'Excl./Partit'],
            datasets: datasets
        },
        options: {
            responsive: true,
            plugins: { legend: { labels: { color: 'white' } } },
            scales: {
                x: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                y: { 
                    ticks: { color: 'white' }, 
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    title: { display: true, text: 'Mitjana per Partit', color: 'white' }
                }
            }
        }
    });
}
// ============================================
// FUNCIONS ESPECÍFIQUES PER PORTERS
// ============================================

function calculateGoalkeeperStats(player) {
    const data = {
        num: player.num,
        name: player.name,
        totalMatches: 0,
        totalMinutes: 0,
        totalSaves: 0,
        totalGoalsAgainst: 0,
        savesByType: { corner: 0, rebuig: 0, atrapa: 0, penal: 0 },
        savesByZone: {},
        goalZonesAgainst: {},  // ✅ ZONES DELS GOLS REBUTS
        savesByRival: {},
        evolution: [],
        penalties: { faced: 0, saved: 0 }
    };
    
    allMatches.forEach(match => {
        const matchPlayer = match.jugadors?.find(j => 
            j.numero === player.num && j.nom.trim() === player.name
        );
        
        if (!matchPlayer) return;
        
        data.totalMatches++;
        
        const stats = matchPlayer.estadistiques || {};
        
        // Calcular minuts
        let minutes = 0;
        if (match.playerWaterChanges && match.playerWaterChanges.length > 0 && match.quarterStartTimes) {
            const playerTimes = calculateMatchPlayingTimes(match);
            const playerTimeData = playerTimes[player.num];
            if (playerTimeData) {
                minutes = Math.round(playerTimeData.totalTime / 60);
            }
        } else {
            minutes = matchPlayer.temps || 0;
        }
        
        data.totalMinutes += minutes;
        data.totalSaves += stats.parades || 0;
        
        // ✅ ZONES DELS GOLS REBUTS (des de golsRebutsZones)
        if (stats.golsRebutsZones) {
            Object.keys(stats.golsRebutsZones).forEach(zone => {
                data.goalZonesAgainst[zone] = (data.goalZonesAgainst[zone] || 0) + (stats.golsRebutsZones[zone] || 0);
            });
        }
        
        // Gols encaixats
        const golsRebuts = stats.golsRebuts || 0;
        data.totalGoalsAgainst += golsRebuts;
        
        // Parades per tipus
        if (stats.paradeTypes) {
            Object.keys(stats.paradeTypes).forEach(type => {
                data.savesByType[type] = (data.savesByType[type] || 0) + (stats.paradeTypes[type] || 0);
            });
        }
        
        // Penalties
        data.penalties.saved += data.savesByType.penal || 0;
        
        // Calcular penalties afrontats des de chronologicalActions
        if (match.chronologicalActions) {
            const penaltiesAgainst = match.chronologicalActions.filter(a => 
                a.type === 'goal' && 
                a.team === 'rival' && 
                a.goalType === 'penalty' &&
                a.goalkeeperNum === player.num
            ).length;
            data.penalties.faced += penaltiesAgainst;
        }
        
        // Per rival
        const rivalName = match.rivalTeam || match.rival || 'Desconocido';
        if (!data.savesByRival[rivalName]) {
            data.savesByRival[rivalName] = { 
                matches: 0, 
                saves: 0, 
                goalsAgainst: 0,
                minutes: 0
            };
        }
        data.savesByRival[rivalName].matches++;
        data.savesByRival[rivalName].saves += stats.parades || 0;
        data.savesByRival[rivalName].goalsAgainst += golsRebuts;
        data.savesByRival[rivalName].minutes += minutes;
        
        // Evolució temporal
        const totalShots = (stats.parades || 0) + golsRebuts;
        const savePercentage = totalShots > 0 ? ((stats.parades || 0) / totalShots * 100).toFixed(1) : 0;
        
        data.evolution.push({
            date: match.data || match.rival || `Partit ${data.totalMatches}`,
            rival: rivalName,
            saves: stats.parades || 0,
            goalsAgainst: golsRebuts,
            savePercentage: savePercentage,
            minutes: minutes
        });
    });
    
    // Ordenar evolució per data
    data.evolution.sort((a, b) => {
        const dateA = parseSpanishDate(a.date);
        const dateB = parseSpanishDate(b.date);
        return dateA - dateB;
    });
    
    return data;
}
function renderGoalkeeperStats(playerData) {
    const gkData = calculateGoalkeeperStats(selectedPlayer);
    
    renderGoalkeeperSummary(gkData);
    renderGoalkeeperSavePercentageChart(gkData);
    renderGoalkeeperSaveTypeChart(gkData);
    renderGoalkeeperZonesHeatmap(gkData);
    renderGoalkeeperByRivalTable(gkData);
    renderGoalkeeperEvolutionChart(gkData);
    renderGoalkeeperComparisonChart(gkData);
    renderGoalkeeperPenalties(gkData);
}

function renderGoalkeeperSummary(data) {
    const grid = document.getElementById('goalkeeperSummaryGrid');
    
    const totalShots = data.totalSaves + data.totalGoalsAgainst;
    const savePercentage = totalShots > 0 ? ((data.totalSaves / totalShots) * 100).toFixed(1) : 0;
    const savesPerMatch = (data.totalSaves / data.totalMatches).toFixed(1);
    const goalsPerMatch = (data.totalGoalsAgainst / data.totalMatches).toFixed(1);
    const avgMinutes = (data.totalMinutes / data.totalMatches).toFixed(1);
    
    grid.innerHTML = `
        <div class="stat-card">
            <div class="stat-value" style="color: #22c55e;">${savePercentage}%</div>
            <div class="stat-label">% Parades</div>
            <div class="stat-sublabel">${data.totalSaves}/${totalShots} tirs</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${data.totalSaves}</div>
            <div class="stat-label">Parades Totals</div>
            <div class="stat-sublabel">${savesPerMatch} per partit</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${data.totalGoalsAgainst}</div>
            <div class="stat-label">Gols Encaixats</div>
            <div class="stat-sublabel">${goalsPerMatch} per partit</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${data.totalMatches}</div>
            <div class="stat-label">Partits Jugats</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${avgMinutes}'</div>
            <div class="stat-label">Min/Partit</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${data.totalMinutes}'</div>
            <div class="stat-label">Minuts Totals</div>
        </div>
    `;
}

function renderGoalkeeperSavePercentageChart(data) {
    const ctx = document.getElementById('goalkeeperSavePercentageChart');
    
    const totalShots = data.totalSaves + data.totalGoalsAgainst;
    const savePercentage = totalShots > 0 ? ((data.totalSaves / totalShots) * 100).toFixed(1) : 0;
    const goalPercentage = (100 - savePercentage).toFixed(1);
    
    if (window.goalkeeperSavePercentageChartInstance) {
        window.goalkeeperSavePercentageChartInstance.destroy();
    }
    
    window.goalkeeperSavePercentageChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Parades', 'Gols Encaixats'],
            datasets: [{
                data: [data.totalSaves, data.totalGoalsAgainst],
                backgroundColor: ['#22c55e', '#ef4444']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,  // ✅ AFEGIR AQUESTA LÍNIA
            aspectRatio: 2,  // ✅ AFEGIR: controla la relació ample/alt (2 = més ample que alt)
            plugins: {
                legend: { 
                    labels: { color: 'white', font: { size: 14 } },
                    position: 'bottom'  // ✅ Posar llegenda a baix
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed;
                            const total = data.totalSaves + data.totalGoalsAgainst;
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

function renderGoalkeeperSaveTypeChart(data) {
    const ctx = document.getElementById('goalkeeperSaveTypeChart');
    
    const types = Object.keys(data.savesByType);
    const values = Object.values(data.savesByType);
    
    const labels = {
        corner: '🎯 Córner',
        rebuig: '👊 Rebuig',
        atrapa: '🤲 Atrapa',
        penal: '🎯 Penalty'
    };
    
    if (window.goalkeeperSaveTypeChartInstance) {
        window.goalkeeperSaveTypeChartInstance.destroy();
    }
    
    window.goalkeeperSaveTypeChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: types.map(t => labels[t] || t),
            datasets: [{
                label: 'Parades',
                data: values,
                backgroundColor: ['#3b82f6', '#8b5cf6', '#22c55e', '#fbbf24']
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                x: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                y: { 
                    ticks: { color: 'white', stepSize: 1 }, 
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    beginAtZero: true
                }
            }
        }
    });
}

function renderGoalkeeperZonesHeatmap(data) {
    const container = document.getElementById('goalkeeperZonesHeatmap');
    
    // Si no hi ha dades de zones, mostrar missatge
    if (Object.keys(data.goalZonesAgainst).length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #bae6fd;">
                <p style="font-size: 16px; margin-bottom: 10px;">ℹ️ No hi ha dades de zones de gols rebuts</p>
                <p style="font-size: 12px;">Aquesta funcionalitat registra les zones on el porter ha encaixat gols</p>
            </div>
        `;
        return;
    }
    
    const zones = [
        ['top-left', 'top-center', 'top-right'],
        ['mid-left', 'mid-center', 'mid-right'],
        ['bottom-left', 'bottom-center', 'bottom-right']
    ];
    
    const zoneLabels = {
        'top-left': 'Sup. Esq.',
        'top-center': 'Sup. Centre',
        'top-right': 'Sup. Dret',
        'mid-left': 'Mig Esq.',
        'mid-center': 'Mig Centre',
        'mid-right': 'Mig Dret',
        'bottom-left': 'Inf. Esq.',
        'bottom-center': 'Inf. Centre',
        'bottom-right': 'Inf. Dret'
    };
    
    const maxGoals = Math.max(...Object.values(data.goalZonesAgainst), 1);
    
    let html = '<div class="zone-heatmap-container">';
    
    zones.forEach(row => {
        row.forEach(zone => {
            const count = data.goalZonesAgainst[zone] || 0;
            const intensity = count / maxGoals;
            // ✅ Vermell per gols rebuts (més intens = més gols)
            const bgColor = `rgba(239, 68, 68, ${intensity})`;
            
            html += `
                <div class="zone-cell" style="background: ${bgColor};">
                    <div class="zone-label">${zoneLabels[zone]}</div>
                    <div class="zone-count">${count}</div>
                </div>
            `;
        });
    });
    
    html += '</div>';
    
    // ✅ Afegir llegenda
    html += `
        <div style="margin-top: 20px; text-align: center;">
            <p style="font-size: 14px; color: #bae6fd; margin-bottom: 10px;">
                🎯 Mapa de Calor: Zones on ha encaixat més gols
            </p>
            <div style="display: flex; justify-content: center; gap: 20px; font-size: 12px;">
                <div><span style="color: rgba(239, 68, 68, 0.3);">⬤</span> Pocs gols</div>
                <div><span style="color: rgba(239, 68, 68, 1);">⬤</span> Molts gols</div>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
}
function renderGoalkeeperByRivalTable(data) {
    const table = document.getElementById('goalkeeperByRivalTable');
    
    const rivals = Object.entries(data.savesByRival)
        .map(([name, stats]) => {
            const totalShots = stats.saves + stats.goalsAgainst;
            const savePercentage = totalShots > 0 ? ((stats.saves / totalShots) * 100).toFixed(1) : 0;
            return { name, ...stats, savePercentage };
        })
        .sort((a, b) => b.savePercentage - a.savePercentage);
    
    table.innerHTML = `
        <thead>
            <tr>
                <th>Rival</th>
                <th>Partits</th>
                <th>Parades</th>
                <th>Gols Enc.</th>
                <th>% Parades</th>
                <th>Min</th>
            </tr>
        </thead>
        <tbody>
            ${rivals.map(r => {
                const color = r.savePercentage >= 50 ? '#22c55e' : r.savePercentage >= 30 ? '#fbbf24' : '#ef4444';
                return `
                    <tr>
                        <td><strong>${r.name}</strong></td>
                        <td>${r.matches}</td>
                        <td>${r.saves}</td>
                        <td>${r.goalsAgainst}</td>
                        <td style="font-weight: bold; color: ${color};">${r.savePercentage}%</td>
                        <td>${r.minutes}'</td>
                    </tr>
                `;
            }).join('')}
        </tbody>
    `;
}

function renderGoalkeeperEvolutionChart(data) {
    const ctx = document.getElementById('goalkeeperEvolutionChart');
    
    if (window.goalkeeperEvolutionChartInstance) {
        window.goalkeeperEvolutionChartInstance.destroy();
    }
    
    window.goalkeeperEvolutionChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.evolution.map(e => e.date),
            datasets: [
                {
                    label: '% Parades',
                    data: data.evolution.map(e => e.savePercentage),
                    borderColor: '#22c55e',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    tension: 0.3,
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { labels: { color: 'white' } },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            const idx = context[0].dataIndex;
                            return data.evolution[idx].rival;
                        },
                        afterLabel: function(context) {
                            const idx = context.dataIndex;
                            const ev = data.evolution[idx];
                            return `Parades: ${ev.saves} | Gols: ${ev.goalsAgainst}`;
                        }
                    }
                }
            },
            scales: {
                x: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                y: { 
                    ticks: { 
                        color: 'white',
                        callback: function(value) {
                            return value + '%';
                        }
                    }, 
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    min: 0,
                    max: 100
                }
            }
        }
    });
}

function renderGoalkeeperComparisonChart(gkData) {
    const ctx = document.getElementById('goalkeeperComparisonChart');
    
    // Trobar tots els porters
    const allGoalkeepers = [];
    const goalkeeperStats = {};
    
    allMatches.forEach(match => {
        match.jugadors?.forEach(j => {
            if ((j.numero === 1 || j.numero === 13) && j.estadistiques?.parades > 0) {
                const key = `${j.numero}|${j.nom.trim()}`;
                if (!goalkeeperStats[key]) {
                    goalkeeperStats[key] = {
                        num: j.numero,
                        name: j.nom.trim(),
                        totalSaves: 0,
                        totalGoalsAgainst: 0,
                        matches: 0
                    };
                }
                goalkeeperStats[key].totalSaves += j.estadistiques.parades || 0;
                
                const rivalScore = match.periodScores ? 
                    (match.periodScores.q1?.rival || 0) + 
                    (match.periodScores.q2?.rival || 0) + 
                    (match.periodScores.q3?.rival || 0) + 
                    (match.periodScores.q4?.rival || 0) : 0;
                
                goalkeeperStats[key].totalGoalsAgainst += rivalScore;
                goalkeeperStats[key].matches++;
            }
        });
    });
    
    const goalkeepers = Object.values(goalkeeperStats);
    
    if (goalkeepers.length <= 1) {
        ctx.parentElement.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #bae6fd;">
                <p>ℹ️ No hi ha altres porters per comparar</p>
            </div>
        `;
        return;
    }
    
    if (window.goalkeeperComparisonChartInstance) {
        window.goalkeeperComparisonChartInstance.destroy();
    }
    
    const datasets = goalkeepers.map((gk, idx) => {
        const totalShots = gk.totalSaves + gk.totalGoalsAgainst;
        const savePercentage = totalShots > 0 ? ((gk.totalSaves / totalShots) * 100).toFixed(1) : 0;
        const savesPerMatch = (gk.totalSaves / gk.matches).toFixed(1);
        
        const colors = ['#22d3ee', '#fbbf24', '#22c55e', '#8b5cf6'];
        const isCurrentPlayer = gk.num === selectedPlayer.num && gk.name === selectedPlayer.name;
        
        return {
            label: `${gk.num}. ${gk.name}`,
            data: [parseFloat(savePercentage), parseFloat(savesPerMatch), gk.matches],
            backgroundColor: isCurrentPlayer ? '#22c55e' : colors[idx % colors.length],
            borderWidth: isCurrentPlayer ? 3 : 0,
            borderColor: isCurrentPlayer ? '#fff' : 'transparent'
        };
    });
    
    window.goalkeeperComparisonChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['% Parades', 'Parades/Partit', 'Partits'],
            datasets: datasets
        },
        options: {
            responsive: true,
            plugins: { legend: { labels: { color: 'white' } } },
            scales: {
                x: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                y: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } }
            }
        }
    });
}

function renderGoalkeeperPenalties(data) {
    const grid = document.getElementById('goalkeeperPenaltiesGrid');
    
    const penaltySavePercentage = data.penalties.faced > 0 ? 
        ((data.penalties.saved / data.penalties.faced) * 100).toFixed(1) : 0;
    
    grid.innerHTML = `
        <div class="stat-card">
            <div class="stat-value">${data.penalties.faced}</div>
            <div class="stat-label">Penalties Afrontats</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" style="color: #22c55e;">${data.penalties.saved}</div>
            <div class="stat-label">Penalties Parats</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" style="color: ${penaltySavePercentage >= 50 ? '#22c55e' : '#fbbf24'};">
                ${penaltySavePercentage}%
            </div>
            <div class="stat-label">% Èxit Penalties</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${data.penalties.faced - data.penalties.saved}</div>
            <div class="stat-label">Penalties Gol</div>
        </div>
    `;
}
// Funció auxiliar per parsejar dates en espanyol
function parseSpanishDate(dateStr) {
    if (!dateStr) return new Date(0);
    
    const parts = dateStr.split('-');
    if (parts.length === 3) {
        return new Date(parts[0], parts[1] - 1, parts[2]);
    }
    
    return new Date(dateStr);
}


// ============================================
// FUNCIONS PER CARREGAR DADES ACTAWP
// ============================================

let actawpData = null;

async function loadActawpData(team = 'juvenil') {
    try {
        console.log('🔄 Carregant dades ACTAWP per:', team);
        
        const repos = {
            cadet: 'joseprico/cnt_cadet_25-26',
            juvenil: 'joseprico/CNT_juvenil_25_26'
        };
        
        const selectedRepo = repos[team];
        
        // Carregar el fitxer ACTAWP des de GitHub (ARREGLA ELS BACKTICKS!)
        const response = await fetch(`https://raw.githubusercontent.com/${selectedRepo}/main/actawp_${team}_data.json`);
        
        if (!response.ok) {
            throw new Error(`Error carregant dades ACTAWP: ${response.status}`);
        }
        
        actawpData = await response.json();
        console.log('✅ Dades ACTAWP carregades:', actawpData);
        
        await checkLastUpdate();
        
        // ⭐ AFEGEIX AIXÒ AL FINAL:
        await loadRankingACTAWP(team);
        
        return actawpData;
        
    } catch (error) {
        console.error('❌ Error carregant dades ACTAWP:', error);
        return null;
    }
}
// Funció per mostrar l'última actualització i detectar canvis recents
async function checkLastUpdate() {
    try {
        // ⭐ ACTUALITZAR AMBDUES UBICACIONS: Tab ACTAWP i Tab Inici
        const timeSpan = document.getElementById('lastUpdateTime');
        const timeSpanHome = document.getElementById('lastUpdateTimeHome');
        const badge = document.getElementById('recentUpdateBadge');
        const badgeHome = document.getElementById('recentUpdateBadgeHome');
        
        if (!timeSpan && !timeSpanHome) {
            console.log('⚠️ Elements lastUpdateTime no trobats');
            return;
        }
        
        // Si ja tenim actawpData carregat, usar-lo directament
        if (actawpData && actawpData.last_update) {
            const updateDate = new Date(actawpData.last_update);
            const now = new Date();
            const hoursDiff = (now - updateDate) / (1000 * 60 * 60);
            
            console.log('✅ Last update trobat:', actawpData.last_update);
            console.log(`⏱️ Hores de diferència: ${hoursDiff.toFixed(1)}h`);
            
            // Mostrar data formatada EN HORA CATALANA
            const options = { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit',
                timeZone: 'Europe/Madrid'
            };
            const formattedDate = updateDate.toLocaleString('ca-ES', options);
            
            // Sistema de colors segons l'antiguitat
            let badgeColor, badgeText, badgeIcon, timeColor;
            
            if (hoursDiff < 2) {
                badgeColor = '#10b981';
                badgeText = 'Actualitzat recentment';
                badgeIcon = '🟢';
                timeColor = '#22d3ee';
            } else if (hoursDiff < 5) {
                badgeColor = '#f59e0b';
                badgeText = 'Dades recents';
                badgeIcon = '🟡';
                timeColor = '#22d3ee';
            } else if (hoursDiff < 12) {
                badgeColor = '#f97316';
                badgeText = 'Pendent actualització';
                badgeIcon = '🟠';
                timeColor = '#fbbf24';
            } else {
                badgeColor = '#ef4444';
                badgeText = 'Dades antigues';
                badgeIcon = '🔴';
                timeColor = '#ef4444';
            }
            
            // ⭐ ACTUALITZAR TAB ACTAWP
            if (timeSpan) {
                timeSpan.textContent = formattedDate;
                timeSpan.style.color = timeColor;
            }
            
            // ⭐ ACTUALITZAR TAB INICI
            if (timeSpanHome) {
                timeSpanHome.textContent = formattedDate;
                timeSpanHome.style.color = timeColor;
            }
            
            // ⭐ ACTUALITZAR BADGES (ambdues ubicacions)
            [badge, badgeHome].forEach(b => {
                if (b) {
                    b.style.display = 'inline-block';
                    b.style.background = badgeColor;
                    b.innerHTML = `${badgeIcon} ${badgeText}`;
                    
                    if (hoursDiff < 2) {
                        setTimeout(() => {
                            b.style.display = 'none';
                        }, 10000);
                    }
                }
            });
        } else {
            console.log('⚠️ actawpData no té last_update');
            if (timeSpan) {
                timeSpan.textContent = 'Actualització automàtica cada 30min';
                timeSpan.style.color = '#93c5fd';
            }
            if (timeSpanHome) {
                timeSpanHome.textContent = 'Actualització automàtica cada 30min';
                timeSpanHome.style.color = '#93c5fd';
            }
        }
    } catch (error) {
        console.error('❌ Error checking last update:', error);
        const timeSpan = document.getElementById('lastUpdateTime');
        const timeSpanHome = document.getElementById('lastUpdateTimeHome');
        
        if (timeSpan) {
            timeSpan.textContent = 'Error carregant data';
            timeSpan.style.color = '#ef4444';
        }
        if (timeSpanHome) {
            timeSpanHome.textContent = 'Error carregant data';
            timeSpanHome.style.color = '#ef4444';
        }
    }
}

function displayUpcomingMatches() {
    const matches = actawpData.upcoming_matches || [];
    const container = document.getElementById('actawp-upcoming-matches');
    
    if (matches.length === 0) {
        container.innerHTML = '<p style="color: #bae6fd;">No hi ha pròxims partits programats</p>';
        return;
    }
    
    let html = '<div style="display: flex; flex-direction: column; gap: 15px;">';
    
    matches.forEach((match, index) => {
        const date = match.date || match.date_time || 'Data desconeguda';
        const time = match.time || '';
        const homeTeam = match.home_team || match.team1 || '?';
        const awayTeam = match.away_team || match.team2 || '?';
        const venue = match.venue || '';
        const url = match.url || '#';
        
        // LOGOS
        const homeLogo = match.home_team_logo || match.team1_logo || null;
        const awayLogo = match.away_team_logo || match.team2_logo || null;
        
        // Debug
        if (index === 0) {
            console.log('DEBUG Propers partits - Logos:', { homeLogo, awayLogo, match });
        }
        
        const homeLogoHtml = homeLogo 
            ? `<img src="${homeLogo}" style="width: 28px; height: 28px; object-fit: contain; background: white; border-radius: 4px; padding: 2px; margin-right: 8px;" alt="${homeTeam}" onerror="console.error('Error logo home:', this.src); this.style.display='none';">` 
            : '';
        
        const awayLogoHtml = awayLogo 
            ? `<img src="${awayLogo}" style="width: 28px; height: 28px; object-fit: contain; background: white; border-radius: 4px; padding: 2px; margin-left: 8px;" alt="${awayTeam}" onerror="console.error('Error logo away:', this.src); this.style.display='none';">` 
            : '';
        
        // Determinar si CN Terrassa juga a casa o fora
        const isHome = homeTeam.toUpperCase().includes('TERRASSA');
        const locationIcon = isHome ? '🏠' : '✈️';
        const locationText = isHome ? 'Local' : 'Visitant';
        
        html += `
            <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; border-left: 4px solid #22d3ee;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                    <div>
                        <div style="font-size: 14px; color: #bae6fd; margin-bottom: 5px;">
                            📅 ${date} ${time ? `• ⏰ ${time}` : ''}
                        </div>
                        <div style="font-size: 18px; font-weight: bold; display: flex; align-items: center; gap: 8px;">
                            ${homeLogoHtml}
                            <span>${homeTeam}</span>
                            <span style="color: #67e8f9;">vs</span>
                            <span>${awayTeam}</span>
                            ${awayLogoHtml}
                            <span style="font-size: 32px; line-height: 1;">${locationIcon}</span>
                        </div>
                        <div style="font-size: 13px; color: #94a3b8; margin-top: 5px;">
                            ${locationIcon} ${locationText}
                        </div>
                        ${venue ? `<div style="font-size: 12px; color: #94a3b8; margin-top: 3px;">📍 ${venue}</div>` : ''}
                    </div>
                    <a href="${url}" target="_blank" rel="noopener noreferrer" style="background: #06b6d4; color: white; padding: 8px 16px; border-radius: 6px; text-decoration: none; font-size: 14px;">
                        Veure més →
                    </a>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

function displayLastResults() {
    const results = actawpData.last_results || [];
    const container = document.getElementById('actawp-last-results');
    
    if (results.length === 0) {
        container.innerHTML = '<p style="color: #bae6fd;">No hi ha resultats recents</p>';
        return;
    }
    
    let html = '<div style="display: flex; flex-direction: column; gap: 15px;">';
    
    results.forEach((result, index) => {
        const homeTeam = result.home_team || result.team1 || '?';
        const awayTeam = result.away_team || result.team2 || '?';
        const homeScore = result.home_score || result.score_team1 || 0;
        const awayScore = result.away_score || result.score_team2 || 0;
        const url = result.url || '#';
        
        // LOGOS
        const homeLogo = result.home_team_logo || result.team1_logo || null;
        const awayLogo = result.away_team_logo || result.team2_logo || null;
        
        // Debug
        if (index === 0) {
            console.log('DEBUG Ultims resultats - Logos:', { homeLogo, awayLogo, result });
        }
        
        const homeLogoHtml = homeLogo 
            ? `<img src="${homeLogo}" style="width: 28px; height: 28px; object-fit: contain; background: white; border-radius: 4px; padding: 2px; margin-right: 8px;" alt="${homeTeam}" onerror="console.error('Error logo home:', this.src); this.style.display='none';">` 
            : '';
        
        const awayLogoHtml = awayLogo 
            ? `<img src="${awayLogo}" style="width: 28px; height: 28px; object-fit: contain; background: white; border-radius: 4px; padding: 2px; margin-left: 8px;" alt="${awayTeam}" onerror="console.error('Error logo away:', this.src); this.style.display='none';">` 
            : '';
        
        // Determinar resultat
        const homeWon = homeScore > awayScore;
        const awayWon = awayScore > homeScore;
        const draw = homeScore === awayScore;
        
        // Determinar si CN Terrassa va guanyar, empatar o perdre
        const isHomeTerrassa = homeTeam.toUpperCase().includes('TERRASSA');
        const isAwayTerrassa = awayTeam.toUpperCase().includes('TERRASSA');
        
        let resultIcon = '';
        let resultText = '';
        let borderColor = '';
        
        if (draw) {
            resultIcon = '🟡';
            resultText = 'Empat';
            borderColor = '#fbbf24';
        } else if ((isHomeTerrassa && homeWon) || (isAwayTerrassa && awayWon)) {
            resultIcon = '🟢';
            resultText = 'Victòria';
            borderColor = '#4ade80';
        } else {
            resultIcon = '🔴';
            resultText = 'Derrota';
            borderColor = '#ef4444';
        }
        
        // Colors dels equips segons el resultat
        const homeColor = homeWon ? '#4ade80' : (draw ? '#fbbf24' : '#e0f2fe');
        const awayColor = awayWon ? '#4ade80' : (draw ? '#fbbf24' : '#e0f2fe');
        const homeWeight = homeWon ? '600' : '500';
        const awayWeight = awayWon ? '600' : '500';
        
        html += `
            <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; border-left: 4px solid ${borderColor};">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                    <div style="flex: 1; min-width: 200px;">
                        <div style="font-size: 12px; color: #bae6fd; margin-bottom: 8px;">
                            ${resultIcon} ${resultText}
                        </div>
                        <div style="font-size: 16px; display: flex; align-items: center; justify-content: space-between; gap: 12px;">
                            <div style="display: flex; align-items: center; color: ${homeColor}; font-weight: ${homeWeight};">
                                ${homeLogoHtml}
                                <span>${homeTeam}</span>
                            </div>
                            <div style="background: rgba(34, 211, 238, 0.2); padding: 8px 16px; border-radius: 6px; font-weight: bold; font-size: 20px; color: #22d3ee; min-width: 80px; text-align: center;">
                                ${homeScore} - ${awayScore}
                            </div>
                            <div style="display: flex; align-items: center; color: ${awayColor}; font-weight: ${awayWeight};">
                                <span>${awayTeam}</span>
                                ${awayLogoHtml}
                            </div>
                        </div>
                    </div>
                    <a href="${url}" target="_blank" rel="noopener noreferrer" style="background: #06b6d4; color: white; padding: 8px 16px; border-radius: 6px; text-decoration: none; font-size: 14px;">
                        Detalls →
                    </a>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}
function displayActawpData() {
    if (!actawpData) {
        document.getElementById('actawpLoading').innerHTML = `
            <div style="text-align: center; padding: 40px;">
                <div style="font-size: 48px;">⚠️</div>
                <p style="color: #fbbf24;">No s'han pogut carregar les dades d'ACTAWP</p>
                <p style="color: #bae6fd; font-size: 14px; margin-top: 10px;">
                    Assegura't que el fitxer actawp_data.json existeix al repositori de GitHub
                </p>
            </div>
        `;
        return;
    }
    
    // Amagar loading i mostrar contingut
    document.getElementById('actawpLoading').style.display = 'none';
    document.getElementById('actawpContent').style.display = 'block';
    
    // Mostrar estadístiques de l'equip
    const stats = actawpData.team_stats || {};
    
    // Mapper de noms d'estadístiques (català/castellà)
    const statNames = {
        points: ['Puntos', 'Punts'],
        matchesPlayed: ['Partidos jugados', 'Partits jugats'],
        wins: ['Partidos ganados', 'Partits guanyats'],
        draws: ['Partidos empatados', 'Partits empatats'],
        losses: ['Partidos perdidos', 'Partits perduts'],
        goalsFor: ['A favor', 'A favor', 'Goles a favor', 'Gols a favor'],
        goalsAgainst: ['En contra', 'Gols en contra', 'Goles en contra']
    };
    
    function getStatValue(possibleNames) {
        for (const name of possibleNames) {
            if (stats[name] !== undefined) {
                return stats[name];
            }
        }
        return 0;
    }
    
    const points = getStatValue(statNames.points);
    const matchesPlayed = getStatValue(statNames.matchesPlayed);
    const wins = getStatValue(statNames.wins);
    const draws = getStatValue(statNames.draws);
    const losses = getStatValue(statNames.losses);
    const goalsFor = getStatValue(statNames.goalsFor);
    const goalsAgainst = getStatValue(statNames.goalsAgainst);
    const goalDiff = goalsFor - goalsAgainst;
    
    document.getElementById('actawp-points').textContent = points;
    document.getElementById('actawp-matches-played').textContent = matchesPlayed;
    document.getElementById('actawp-wins').textContent = wins;
    document.getElementById('actawp-draws').textContent = draws;
    document.getElementById('actawp-losses').textContent = losses;
    document.getElementById('actawp-goals-for').textContent = goalsFor;
    document.getElementById('actawp-goals-against').textContent = goalsAgainst;
    document.getElementById('actawp-goal-diff').textContent = goalDiff >= 0 ? `+${goalDiff}` : goalDiff;
    document.getElementById('actawp-goal-diff').style.color = goalDiff >= 0 ? '#4ade80' : '#ef4444';
    
    // Mostrar pròxims partits
    displayUpcomingMatches();
    
    // Mostrar últims resultats
    displayLastResults();
    
    // Mostrar comparativa de jugadors
    displayPlayerComparison();
	if (typeof displayActawpMatches === 'function') {
       displayActawpMatches();
   }
}



function displayPlayerComparison() {
    console.log('\n🔍 displayPlayerComparison() executant...');
    
    function cleanNameForDisplay(name) {
        if (!name) return '';
        let cleaned = name.replace(/^Veure/i, '').replace(/^Ver/i, '').trim();
        return cleaned
            .split(' ')
            .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
            .join(' ');
    }
    
    if (!actawpData) {
        console.error('❌ actawpData null!');
        const container = document.getElementById('actawp-comparison-table');
        if (container) {
            container.innerHTML = '<p style="color: #fbbf24;">⏳ Carregant dades ACTAWP...</p>';
        }
        return;
    }
    
    const actawpPlayers = actawpData.players || [];
    const container = document.getElementById('actawp-comparison-table');
    
    if (!container) {
        console.error('❌ Container no trobat');
        return;
    }
    
    if (actawpPlayers.length === 0) {
        container.innerHTML = '<p style="color: #bae6fd;">No hi ha dades</p>';
        return;
    }
    
    console.log('📊 ACTAWP:', actawpPlayers.length, 'jugadors');
    
    const localPlayers = getAllUniquePlayers();
    console.log('📊 Locals:', localPlayers.length, 'jugadors');
    
    // Crear mapa
    const localPlayersMap = new Map();
    localPlayers.forEach(p => {
        const normalized = normalizeName(p.name);
        localPlayersMap.set(normalized, p);
    });
    
    // Taula HTML
    let html = `
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                <thead>
                    <tr style="background: rgba(255,255,255,0.05);">
                        <th style="padding: 10px; text-align: left; border-bottom: 2px solid #334155; min-width: 150px;">Jugador</th>
                        <th style="padding: 10px; text-align: left; border-bottom: 2px solid #334155;">Font</th>
                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #334155;" title="Partits Jugats">PJ</th>
                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #334155;" title="Gols Totals">Gols</th>
                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #334155;" title="Gols de Penal">G.Pen</th>
                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #334155;" title="Exclusions 20seg">Excl</th>
                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #334155;" title="Penals Fallats">P.Fall</th>
                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #334155; background: rgba(100,116,139,0.1);" title="Només ACTAWP">TA</th>
                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #334155; background: rgba(100,116,139,0.1);" title="Només ACTAWP">TR</th>
                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #334155; background: rgba(100,116,139,0.1);" title="Només ACTAWP">MVP</th>
                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #334155;">Estat</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    let matchedCount = 0;
    let unmatchedCount = 0;
    
    actawpPlayers.forEach(actawpPlayer => {
        const actawpName = actawpPlayer['Nombre'] || '';
        const cleanedActawpName = cleanNameForDisplay(actawpName);
        
        console.log(`\n🔎 Buscant: "${actawpName}"`);
        
        // Buscar coincidència
        let localPlayer = null;
        for (const [localNormalized, player] of localPlayersMap.entries()) {
            if (nameMatches(actawpName, player.name)) {
                localPlayer = player;
                console.log(`  ✅ MATCH amb "${player.name}"`);
                break;
            }
        }
        
        // Dades ACTAWP
        const actawpPJ = actawpPlayer['PJ'] || 0;
        const actawpGols = actawpPlayer['GT'] || 0;
        const actawpGP = actawpPlayer['GP'] || 0;
        const actawpExcl = actawpPlayer['EX'] || 0;
        const actawpPF = actawpPlayer['PF'] || 0;
        const actawpTA = actawpPlayer['TA'] || 0;
        const actawpTR = actawpPlayer['TR'] || 0;
        const actawpMVP = actawpPlayer['MVP'] || 0;
        
        if (localPlayer) {
            matchedCount++;
            
            // Dades locals
            const localPJ = localPlayer.partidos || 0;
            const localGols = localPlayer.gols || 0;
            const localGP = localPlayer.goalTypes?.penalty || 0;
            const localExcl = localPlayer.exclusions || 0;
            const localPF = localPlayer.penaltyMissed || 0;
            
            console.log(`  📊 ACTAWP: PJ=${actawpPJ} G=${actawpGols} GP=${actawpGP} EX=${actawpExcl} PF=${actawpPF}`);
            console.log(`  📊 Local:  PJ=${localPJ} G=${localGols} GP=${localGP} EX=${localExcl} PF=${localPF}`);
            
            // Diferències (només camps comparables)
            const diffPJ = actawpPJ - localPJ;
            const diffGols = actawpGols - localGols;
            const diffGP = actawpGP - localGP;
            const diffExcl = actawpExcl - localExcl;
            const diffPF = actawpPF - localPF;
            
            const hasDiff = diffPJ !== 0 || diffGols !== 0 || diffGP !== 0 || diffExcl !== 0 || diffPF !== 0;
            
            html += `
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <td rowspan="2" style="padding: 10px; font-weight: bold; vertical-align: middle;">${cleanedActawpName}</td>
                    <td style="padding: 10px; color: #22d3ee;">ACTAWP</td>
                    <td style="padding: 10px; text-align: center;">${actawpPJ}</td>
                    <td style="padding: 10px; text-align: center;">${actawpGols}</td>
                    <td style="padding: 10px; text-align: center;">${actawpGP}</td>
                    <td style="padding: 10px; text-align: center;">${actawpExcl}</td>
                    <td style="padding: 10px; text-align: center;">${actawpPF}</td>
                    <td style="padding: 10px; text-align: center; background: rgba(100,116,139,0.05);">${actawpTA > 0 ? `<span style="color: #fbbf24;">${actawpTA}</span>` : '-'}</td>
                    <td style="padding: 10px; text-align: center; background: rgba(100,116,139,0.05);">${actawpTR > 0 ? `<span style="color: #ef4444;">${actawpTR}</span>` : '-'}</td>
                    <td style="padding: 10px; text-align: center; background: rgba(100,116,139,0.05);">${actawpMVP > 0 ? '<span style="color: #fbbf24; font-size: 16px;">⭐</span>' : '-'}</td>
                    <td rowspan="2" style="padding: 10px; text-align: center; vertical-align: middle;">
                        ${hasDiff ? '<span style="color: #fbbf24; font-size: 20px;">⚠️</span>' : '<span style="color: #4ade80; font-size: 20px;">✓</span>'}
                    </td>
                </tr>
                <tr style="border-bottom: 2px solid rgba(255,255,255,0.1);">
                    <td style="padding: 10px; color: #a78bfa;">Local</td>
                    <td style="padding: 10px; text-align: center;">
                        ${localPJ}
                        ${diffPJ !== 0 ? `<span style="color: ${diffPJ > 0 ? '#ef4444' : '#4ade80'}; font-size: 10px; margin-left: 2px;">(${diffPJ > 0 ? '+' : ''}${diffPJ})</span>` : ''}
                    </td>
                    <td style="padding: 10px; text-align: center;">
                        ${localGols}
                        ${diffGols !== 0 ? `<span style="color: ${diffGols > 0 ? '#ef4444' : '#4ade80'}; font-size: 10px; margin-left: 2px;">(${diffGols > 0 ? '+' : ''}${diffGols})</span>` : ''}
                    </td>
                    <td style="padding: 10px; text-align: center;">
                        ${localGP}
                        ${diffGP !== 0 ? `<span style="color: ${diffGP > 0 ? '#ef4444' : '#4ade80'}; font-size: 10px; margin-left: 2px;">(${diffGP > 0 ? '+' : ''}${diffGP})</span>` : ''}
                    </td>
                    <td style="padding: 10px; text-align: center;">
                        ${localExcl}
                        ${diffExcl !== 0 ? `<span style="color: ${diffExcl > 0 ? '#ef4444' : '#4ade80'}; font-size: 10px; margin-left: 2px;">(${diffExcl > 0 ? '+' : ''}${diffExcl})</span>` : ''}
                    </td>
                    <td style="padding: 10px; text-align: center;">
                        ${localPF}
                        ${diffPF !== 0 ? `<span style="color: ${diffPF > 0 ? '#ef4444' : '#4ade80'}; font-size: 10px; margin-left: 2px;">(${diffPF > 0 ? '+' : ''}${diffPF})</span>` : ''}
                    </td>
                    <td colspan="3" style="padding: 10px; text-align: center; color: #64748b; font-size: 11px; background: rgba(100,116,139,0.05);">Només ACTAWP</td>
                </tr>
            `;
        } else {
            unmatchedCount++;
            console.log(`  ❌ NO TROBAT`);
            
            html += `
                <tr style="background: rgba(239, 68, 68, 0.05); border-bottom: 2px solid rgba(255,255,255,0.1);">
                    <td style="padding: 10px; font-weight: bold;">${cleanedActawpName}</td>
                    <td style="padding: 10px; color: #22d3ee;">ACTAWP</td>
                    <td style="padding: 10px; text-align: center;">${actawpPJ}</td>
                    <td style="padding: 10px; text-align: center;">${actawpGols}</td>
                    <td style="padding: 10px; text-align: center;">${actawpGP}</td>
                    <td style="padding: 10px; text-align: center;">${actawpExcl}</td>
                    <td style="padding: 10px; text-align: center;">${actawpPF}</td>
                    <td style="padding: 10px; text-align: center; background: rgba(100,116,139,0.05);">${actawpTA > 0 ? `<span style="color: #fbbf24;">${actawpTA}</span>` : '-'}</td>
                    <td style="padding: 10px; text-align: center; background: rgba(100,116,139,0.05);">${actawpTR > 0 ? `<span style="color: #ef4444;">${actawpTR}</span>` : '-'}</td>
                    <td style="padding: 10px; text-align: center; background: rgba(100,116,139,0.05);">${actawpMVP > 0 ? '<span style="color: #fbbf24; font-size: 16px;">⭐</span>' : '-'}</td>
                    <td style="padding: 10px; color: #ef4444; text-align: center; font-size: 11px;">❌ No local</td>
                </tr>
            `;
        }
    });
    
    html += `
                </tbody>
            </table>
        </div>
        <div style="margin-top: 15px; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px;">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                <div style="color: #bae6fd; font-size: 14px;">
                    📊 <strong>Resum:</strong> ${matchedCount} jugadors coincidents, ${unmatchedCount} només a ACTAWP
                </div>
                <div style="color: #94a3b8; font-size: 12px;">
                    ✓ Comparables: PJ, Gols, G.Penal, Exclusions, P.Fallats
                    <br>
                    ℹ️ Només info ACTAWP: Targetes, MVP
                </div>
            </div>
            ${matchedCount > 0 ? `<div style="color: #4ade80; margin-top: 10px; font-size: 14px;">✅ Comparativa funcionant correctament!</div>` : ''}
        </div>
    `;
    
    container.innerHTML = html;
    
    console.log('\n📊 RESUM:');
    console.log('  ✅ Coincidents:', matchedCount);
    console.log('  ❌ No trobats:', unmatchedCount);
}

// ============================================
// EXEMPLE D'ÚS (per testejar)
// ============================================

// Pots descomentar això per testejar:

console.log('🧪 TEST DE COMPARACIÓ DE NOMS:');
console.log('Test 1:', nameMatches('VerMARC MORENO FOLCH', 'Marc Moreno'));
console.log('Test 2:', nameMatches('VeureLLATZER PEREZ BARADAD', 'Llatzer Perez'));
console.log('Test 3:', nameMatches('VerBIEL GARCIA ARJONA', 'Biel Garcia'));
console.log('Test 4:', nameMatches('VerARNAU MERCADE SEGURA', 'Arnau Mercade'));


function normalizeName(name) {
    if (!name) return '';
    
    let normalized = name
        .toLowerCase()
        .trim();
    
    // Eliminar "veure" i "ver" del principi
    normalized = normalized.replace(/^veure/i, '');
    normalized = normalized.replace(/^ver/i, '');
    
    // Eliminar accents i diacrítics (ñ→n, ç→c, à→a, etc.)
    normalized = normalized
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/ñ/g, 'n')  // ñ específica
        .replace(/ç/g, 'c')  // ç específica
        .replace(/·/g, ' ')  // punt volat
        .replace(/[.,'''`\-]/g, '')  // puntuació
        .replace(/\s+/g, ' ')  // múltiples espais
        .trim();
    
    return normalized;
}

function nameMatches(name1, name2) {
    const n1 = normalizeName(name1);
    const n2 = normalizeName(name2);
    
    console.log(`  🔎 Comparant: "${n1}" vs "${n2}"`);
    
    // Coincidència exacta
    if (n1 === n2) {
        console.log(`    ✅ EXACTE!`);
        return true;
    }
    
    // Separar en paraules
    const words1 = n1.split(' ').filter(w => w.length > 1);  // Filtrar paraules molt curtes
    const words2 = n2.split(' ').filter(w => w.length > 1);
    
    console.log(`    Paraules 1: [${words1.join(', ')}]`);
    console.log(`    Paraules 2: [${words2.join(', ')}]`);
    
    // Si alguna llista està buida, no podem comparar
    if (words1.length === 0 || words2.length === 0) {
        console.log(`    ❌ Llistes buides`);
        return false;
    }
    
    // Cas especial: només 1 paraula a cada llista
    if (words1.length === 1 && words2.length === 1) {
        const match = words1[0] === words2[0];
        console.log(`    ${match ? '✅' : '❌'} Una paraula cada: ${match}`);
        return match;
    }
    
    // Extreure primer nom
    const firstName1 = words1[0];
    const firstName2 = words2[0];
    
    console.log(`    Noms: "${firstName1}" vs "${firstName2}"`);
    
    // El nom ha de coincidir sempre
    if (firstName1 !== firstName2) {
        console.log(`    ❌ Noms diferents`);
        return false;
    }
    
    console.log(`    ✅ Mateix nom!`);
    
    // Si ambdós només tenen nom (sense cognoms), ja hem validat
    if (words1.length === 1 && words2.length === 1) {
        console.log(`    ✅ Només nom, i coincideix`);
        return true;
    }
    
    // Obtenir cognoms (tot excepte la primera paraula)
    const lastNames1 = words1.slice(1);
    const lastNames2 = words2.slice(1);
    
    console.log(`    Cognoms 1: [${lastNames1.join(', ')}]`);
    console.log(`    Cognoms 2: [${lastNames2.join(', ')}]`);
    
    // Si un té cognoms i l'altre no, coincidència pel nom
    if (lastNames1.length === 0 || lastNames2.length === 0) {
        console.log(`    ⚠️ Un sense cognoms, coincidència pel nom`);
        return true;
    }
    
    // Comprovar si algun cognom coincideix
    for (let ln1 of lastNames1) {
        for (let ln2 of lastNames2) {
            if (ln1 === ln2) {
                console.log(`    ✅ Cognom comú: "${ln1}"`);
                return true;
            }
        }
    }
    
    console.log(`    ❌ Cap cognom coincideix`);
    return false;
}








// ============================================
// SECCIÓ DE PARTITS ACTAWP
// Afegir després de displayPlayerComparison()
// ============================================

function displayActawpMatches() {
    console.log('\n🏐 displayActawpMatches() executant...');
    
    if (!actawpData) {
        console.error('❌ actawpData null!');
        return;
    }
    
    const lastResults = actawpData.last_results || [];
    const upcomingMatches = actawpData.upcoming_matches || [];
    
    console.log('📊 Últims resultats:', lastResults.length);
    console.log('📅 Pròxims partits:', upcomingMatches.length);
    
    // Funció MILLORADA per detectar si som Terrassa
    function isOurTeam(teamName) {
        if (!teamName) return false;
        const normalized = teamName.toUpperCase().replace(/\s+/g, ' ').trim();
        
        // Buscar "C.N. TERRASSA" seguit de " A" o final de línia
        // Això detecta: "C.N. TERRASSA A", "C.N. TERRASSA" (exacte)
        // Però NO: "C.N. MONTJUIC" o altres equips
        
        return normalized === 'C.N. TERRASSA' || 
               normalized === 'CN TERRASSA' ||
               normalized === 'C.N. TERRASSA A' ||
               normalized === 'C.N.TERRASSA' ||
               normalized.match(/^C\.?N\.?\s*TERRASSA\s*A?$/);
    }
    
    // ==========================================
    // PRÒXIMS PARTITS
    // ==========================================
    const upcomingContainer = document.getElementById('actawp-upcoming-matches');
    if (upcomingContainer && upcomingMatches.length > 0) {
        let html = '<div style="display: grid; gap: 15px;">';
        
        upcomingMatches.forEach(match => {
            console.log('\n📅 Processant pròxim:', match);
            
            const team1 = match.team1 || '';
            const team2 = match.team2 || '';
            
            console.log(`  Team1: "${team1}"`);
            console.log(`  Team2: "${team2}"`);
            console.log(`  isOurTeam(team1): ${isOurTeam(team1)}`);
            console.log(`  isOurTeam(team2): ${isOurTeam(team2)}`);
            
            // SEGONS L'ESTRUCTURA D'ACTAWP:
            // - team1 = SEMPRE local (columna esquerra)
            // - team2 = SEMPRE visitant (columna dreta)
            
            let isHome, rival;
            if (isOurTeam(team1)) {
                // Som a l'esquerra → Som locals
                isHome = true;
                rival = team2;
            } else if (isOurTeam(team2)) {
                // Som a la dreta → Som visitants
                isHome = false;
                rival = team1;
            } else {
                // Error: no ens trobem
                console.warn('⚠️ No trobem el nostre equip!', {team1, team2});
                isHome = false;
                rival = team2 || team1 || 'Rival desconegut';
            }
            
            console.log(`  → isHome: ${isHome}, rival: "${rival}"`);
            
            const date = match.date || '';
            const time = match.time || '';
            const venue = match.venue || '';
            // Logos
const logo1 = match.team1_logo || '';
const logo2 = match.team2_logo || '';
const ourLogo = isHome ? logo1 : logo2;
const rivalLogo = isHome ? logo2 : logo1;

const ourLogoHtml = ourLogo ? `<img src="${ourLogo}" style="width: 24px; height: 24px; object-fit: contain; background: white; border-radius: 4px; padding: 2px; margin-right: 8px; vertical-align: middle;" onerror="this.style.display='none';">` : '';
const rivalLogoHtml = rivalLogo ? `<img src="${rivalLogo}" style="width: 24px; height: 24px; object-fit: contain; background: white; border-radius: 4px; padding: 2px; margin-right: 8px; vertical-align: middle;" onerror="this.style.display='none';">` : '';
            html += `
                <div style="background: rgba(34, 211, 238, 0.1); border-left: 4px solid #22d3ee; border-radius: 8px; padding: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <div style="flex: 1; min-width: 200px;">
                            <div style="font-size: 12px; color: #94a3b8; margin-bottom: 5px;">
                                📅 ${date} ${time ? '• ' + time : ''}
                            </div>
                            
							${isHome ? `
    <div style="font-size: 16px; font-weight: bold; color: #bae6fd; display: flex; align-items: center;">
        ${ourLogoHtml}
        <span>CN Terrassa</span>
    </div>
    <div style="font-size: 14px; color: #94a3b8; margin-top: 2px; display: flex; align-items: center;">
        <span style="margin-right: 8px;">vs</span>
        ${rivalLogoHtml}
        <span>${rival}</span>
    </div>
` : `
    <div style="font-size: 16px; font-weight: bold; color: #bae6fd; display: flex; align-items: center;">
        ${rivalLogoHtml}
        <span>${rival}</span>
    </div>
    <div style="font-size: 14px; color: #94a3b8; margin-top: 2px; display: flex; align-items: center;">
        <span style="margin-right: 8px;">vs</span>
        ${ourLogoHtml}
        <span>CN Terrassa</span>
    </div>
`}
                            
							${venue ? `<div style="font-size: 12px; color: #64748b; margin-top: 5px;">📍 ${venue}</div>` : ''}
                        </div>
                        <div style="text-align: center; min-width: 100px;">
    <div style="font-size: 32px; color: #22d3ee;">
        ${isHome ? '🏠' : '✈️'}
    </div>
    <div style="font-size: 12px; color: #94a3b8; margin-top: 5px;">
        ${isHome ? 'Local' : 'Visitant'}
    </div>
</div>
                        <div style="min-width: 100px; text-align: right;">
                            <a href="${match.url || '#'}" target="_blank" style="display: inline-block; padding: 8px 16px; background: rgba(34, 211, 238, 0.2); color: #22d3ee; border-radius: 6px; text-decoration: none; font-size: 13px;">
                                ℹ️ Detalls
                            </a>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        upcomingContainer.innerHTML = html;
    } else if (upcomingContainer) {
        upcomingContainer.innerHTML = '<p style="color: #94a3b8; text-align: center; padding: 20px;">No hi ha pròxims partits programats</p>';
    }
    
    // ==========================================
    // ÚLTIMS RESULTATS
    // ==========================================
    const resultsContainer = document.getElementById('actawp-last-results');
    if (resultsContainer && lastResults.length > 0) {
        let html = '<div style="display: grid; gap: 15px;">';
        
        lastResults.forEach(match => {
            console.log('\n📊 Processant resultat:', match);
            
            const team1 = match.team1 || '';
            const team2 = match.team2 || '';
            
            console.log(`  Team1: "${team1}"`);
            console.log(`  Team2: "${team2}"`);
            
            // SEGONS L'ESTRUCTURA D'ACTAWP:
            // - team1 = Equip esquerra
            // - team2 = Equip dreta
            // - score_team1 = Gols de team1
            // - score_team2 = Gols de team2
            
            let isHome, rival, ourScore, theirScore;
            if (isOurTeam(team1)) {
                // Som team1
                isHome = true;
                rival = team2;
                ourScore = match.score_team1;
                theirScore = match.score_team2;
            } else if (isOurTeam(team2)) {
                // Som team2
                isHome = false;
                rival = team1;
                ourScore = match.score_team2;
                theirScore = match.score_team1;
            } else {
                console.warn('⚠️ No trobem el nostre equip!', {team1, team2});
                isHome = false;
                rival = team2 || team1 || 'Rival desconegut';
                ourScore = match.score_team1;
                theirScore = match.score_team2;
            }
            
            console.log(`  → isHome: ${isHome}, rival: "${rival}"`);
            console.log(`  → Marcador: ${ourScore} - ${theirScore}`);
            
            const date = match.date || '';
            const venue = match.venue || '';
            
            const hasScore = ourScore !== undefined && theirScore !== undefined;
            
            if (hasScore) {
                // AMB MARCADOR
                let resultClass, resultIcon;
                if (ourScore > theirScore) {
                    resultClass = 'win';
                    resultIcon = '✅';
                } else if (ourScore < theirScore) {
                    resultClass = 'loss';
                    resultIcon = '❌';
                } else {
                    resultClass = 'draw';
                    resultIcon = '➖';
                }
                
                const bgColor = resultClass === 'win' ? 'rgba(74, 222, 128, 0.1)' : 
                               resultClass === 'loss' ? 'rgba(239, 68, 68, 0.1)' : 
                               'rgba(148, 163, 184, 0.1)';
                
                const borderColor = resultClass === 'win' ? '#4ade80' : 
                                   resultClass === 'loss' ? '#ef4444' : 
                                   '#94a3b8';
				// Logos
const logo1_res = match.team1_logo || '';
const logo2_res = match.team2_logo || '';
const ourLogo_res = isHome ? logo1_res : logo2_res;
const rivalLogo_res = isHome ? logo2_res : logo1_res;

const ourLogoHtml_res = ourLogo_res ? `<img src="${ourLogo_res}" style="width: 24px; height: 24px; object-fit: contain; background: white; border-radius: 4px; padding: 2px; margin-right: 8px; vertical-align: middle;" onerror="this.style.display='none';">` : '';
const rivalLogoHtml_res = rivalLogo_res ? `<img src="${rivalLogo_res}" style="width: 24px; height: 24px; object-fit: contain; background: white; border-radius: 4px; padding: 2px; margin-right: 8px; vertical-align: middle;" onerror="this.style.display='none';">` : '';
                
                html += `
                    <div style="background: ${bgColor}; border-left: 4px solid ${borderColor}; border-radius: 8px; padding: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                            <div style="flex: 1; min-width: 200px;">
                                <div style="font-size: 12px; color: #94a3b8; margin-bottom: 5px;">
                                    ${date} ${venue ? '• ' + venue : ''}
                                </div>
                                
								${isHome ? `
    <div style="font-size: 16px; font-weight: bold; color: #bae6fd; display: flex; align-items: center;">
        ${ourLogoHtml_res}
        <span>CN Terrassa</span>
    </div>
    <div style="font-size: 14px; color: #94a3b8; margin-top: 2px; display: flex; align-items: center;">
        <span style="margin-right: 8px;">vs</span>
        ${rivalLogoHtml_res}
        <span>${rival}</span>
    </div>
` : `
    <div style="font-size: 16px; font-weight: bold; color: #bae6fd; display: flex; align-items: center;">
        ${rivalLogoHtml_res}
        <span>${rival}</span>
    </div>
    <div style="font-size: 14px; color: #94a3b8; margin-top: 2px; display: flex; align-items: center;">
        <span style="margin-right: 8px;">vs</span>
        ${ourLogoHtml_res}
        <span>CN Terrassa</span>
    </div>
`}
                                
								<div style="font-size: 12px; color: #64748b; margin-top: 5px;">
                                    ${isHome ? '🏠 Local' : '✈️ Visitant'}
                                </div>
                            </div>
                            <div style="text-align: center; min-width: 120px;">
                                <div style="font-size: 28px; font-weight: bold; color: #bae6fd;">
    ${isHome ? `${ourScore} - ${theirScore}` : `${theirScore} - ${ourScore}`}
</div>

                                <div style="font-size: 18px; margin-top: 5px;">
                                    ${resultIcon}
                                </div>
                            </div>
                            <div style="min-width: 100px; text-align: right;">
                                <a href="${match.url || '#'}" target="_blank" style="display: inline-block; padding: 8px 16px; background: rgba(34, 211, 238, 0.2); color: #22d3ee; border-radius: 6px; text-decoration: none; font-size: 13px;">
                                    📊 Acta
                                </a>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // SENSE MARCADOR
                html += `
                    <div style="background: rgba(148, 163, 184, 0.1); border-left: 4px solid #94a3b8; border-radius: 8px; padding: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                            <div style="flex: 1; min-width: 200px;">
                                <div style="font-size: 12px; color: #94a3b8; margin-bottom: 5px;">
                                    ${date} ${venue ? '• ' + venue : ''}
                                </div>
                                <div style="font-size: 16px; font-weight: bold; color: #bae6fd;">
                                    CN Terrassa
                                </div>
                                <div style="font-size: 14px; color: #94a3b8; margin-top: 2px;">
                                    vs ${rival}
                                </div>
                                <div style="font-size: 12px; color: #64748b; margin-top: 5px;">
                                    ${isHome ? '🏠 Local' : '✈️ Visitant'}
                                </div>
                            </div>
                            <div style="text-align: center; min-width: 120px;">
                                <div style="font-size: 16px; color: #94a3b8;">
                                    Partit finalitzat
                                </div>
                                <div style="font-size: 12px; color: #64748b; margin-top: 5px;">
                                    Marcador pendent
                                </div>
                            </div>
                            <div style="min-width: 100px; text-align: right;">
                                <a href="${match.url || '#'}" target="_blank" style="display: inline-block; padding: 8px 16px; background: rgba(34, 211, 238, 0.2); color: #22d3ee; border-radius: 6px; text-decoration: none; font-size: 13px;">
                                    📊 Acta
                                </a>
                            </div>
                        </div>
                    </div>
                `;
            }
        });
        
        html += '</div>';
        resultsContainer.innerHTML = html;
    } else if (resultsContainer) {
        resultsContainer.innerHTML = '<p style="color: #94a3b8; text-align: center; padding: 20px;">No hi ha resultats disponibles</p>';
    }
    
    console.log('✅ Partits mostrats!');
}
// Funció per carregar la classificació
function loadRankingACTAWP() {
    console.log('🏆 Carregant classificació ACTAWP...');
    
    const teamKey = localStorage.getItem('selectedTeam') || 'juvenil';
    const container = document.getElementById('actawp-ranking-container');
    
    if (!container) {
        console.error('❌ No es troba el contenidor actawp-ranking-container');
        return;
    }
    
    // Definir les URLs dels JSON per cada equip
const jsonUrls = {
    'juvenil': 'https://joseprico.github.io/CNT_juvenil_25_26/actawp_juvenil_data.json',
    'cadet': 'https://joseprico.github.io/cnt_cadet_25-26/actawp_cadet_data.json'
};

fetch(jsonUrls[teamKey])
        .then(response => {
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return response.json();
        })
        .then(data => {
            console.log('✅ Dades carregades:', data);
            
            if (!data.ranking || data.ranking.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #bae6fd;">No hi ha classificació disponible</p>';
                return;
            }
            
            console.log(`📊 ${data.ranking.length} equips a la classificació`);
            mostrarClassificacio(data.ranking);
        })
        .catch(error => {
            console.error('❌ Error carregant classificació:', error);
            container.innerHTML = '<p style="text-align: center; color: #ef4444;">Error al carregar la classificació</p>';
        });
}

function mostrarClassificacio(ranking) {
    const container = document.getElementById('actawp-ranking-container');
    
    let html = `
        <table class="ranking-table">
            <thead>
                <tr>
                    <th style="width: 60px;">Pos</th>
                    <th style="text-align: left; padding-left: 15px;">Equip</th>
                    <th>PJ</th>
                    <th>G</th>
                    <th>E</th>
                    <th>P</th>
                    <th>GF</th>
                    <th>GC</th>
                    <th>Pts</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    ranking.forEach(team => {
        const isOurTeam = team.equip.toUpperCase().includes('TERRASSA');
        const rowClass = isOurTeam ? 'highlight-team' : '';
        
        // Badge per les primeres 3 posicions
        let posDisplay = team.posicio;
        if (team.posicio === '1') {
            posDisplay = `<span class="position-badge gold">${team.posicio}</span>`;
        } else if (team.posicio === '2') {
            posDisplay = `<span class="position-badge silver">${team.posicio}</span>`;
        } else if (team.posicio === '3') {
            posDisplay = `<span class="position-badge bronze">${team.posicio}</span>`;
        }
        
        // Logo
        const logoHtml = team.logo 
            ? `<img src="${team.logo}" class="team-logo" alt="${team.equip}" onerror="this.style.display='none'">` 
            : '<div style="width: 30px;"></div>';
        
        html += `
            <tr class="${rowClass}">
                <td style="font-weight: bold; color: #22d3ee;">${posDisplay}</td>
                <td>
                    <div class="team-cell">
                        ${logoHtml}
                        <span style="color: #e0f2fe; font-weight: 500;">${team.equip}</span>
                    </div>
                </td>
                <td>${team.partits || 0}</td>
                <td class="stat-wins">${team.guanyats || 0}</td>
                <td class="stat-draws">${team.empatats || 0}</td>
                <td class="stat-losses">${team.perduts || 0}</td>
                <td>${team.gols_favor || 0}</td>
                <td>${team.gols_contra || 0}</td>
                <td class="stat-points">${team.punts || 0}</td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
    console.log('✅ Classificació mostrada correctament');
}

// Carregar quan es mostra el tab ACTAWP
console.log('🔧 Script de classificació carregat');

// Opció 1: Si ja tens una funció loadACTAWPData, afegim-hi la classificació
if (typeof loadACTAWPData === 'function') {
    const originalFunction = loadACTAWPData;
    loadACTAWPData = function() {
        originalFunction();
        setTimeout(loadRankingACTAWP, 500);
    };
    console.log('✅ Classificació integrada amb loadACTAWPData');
}

// Opció 2: Carregar quan es clica el tab ACTAWP
document.addEventListener('DOMContentLoaded', function() {
    const actawpButton = document.querySelector('button[onclick*="actawpTab"]');
    if (actawpButton) {
        actawpButton.addEventListener('click', function() {
            setTimeout(loadRankingACTAWP, 500);
        });
        console.log('✅ Event afegit al botó ACTAWP');
    }
    
    // Si ja estem al tab ACTAWP, carregar directament
    const actawpTab = document.getElementById('actawpTab');
    if (actawpTab && !actawpTab.classList.contains('hidden')) {
        loadRankingACTAWP();
    }
});


console.log('✅ Funcions de visualització amb logos carregades');
function loadNextMatchPill() {
    const container = document.getElementById('next-match-pill');
    
    if (!container) {
        console.error('❌ Container next-match-pill no trobat');
        return;
    }
    
    console.log('📍 Carregant pròxim partit...');
    
    if (!actawpData || !actawpData.upcoming_matches || actawpData.upcoming_matches.length === 0) {
        container.innerHTML = '<div style="color: #bfdbfe; font-size: 11px;">No hi ha pròxims partits</div>';
        return;
    }
    
    const match = actawpData.upcoming_matches[0];
    const date = match.date || '';
    const time = match.time || '';
    const homeTeam = match.team1 || '?';
    const awayTeam = match.team2 || '?';
    const homeLogo = match.team1_logo || '';
    const awayLogo = match.team2_logo || '';
    const isHome = homeTeam.toUpperCase().includes('TERRASSA');
    
    console.log('✅ Pròxim partit:', homeTeam, 'vs', awayTeam);
    
    // Calcular compte enrere
    let countdownHtml = '';
    if (match.date_time) {
        try {
            // Parsejar la data: "Dom 09/11/2025 12:55"
            const dateStr = match.date_time.replace(/^\w+,?\s+/, ''); // Treure "Dom, "
            const [datePart, timePart] = dateStr.split(' ');
            const [day, month, year] = datePart.split('/');
            const [hours, minutes] = timePart.split(':');
            
            const matchDate = new Date(year, month - 1, day, hours, minutes);
            const now = new Date();
            const diff = matchDate - now;
            
            if (diff > 0) {
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((diff % (1000 * 60)) / 1000);
    
    // Si falten més d'1 dia
    if (days > 0) {
        countdownHtml = `
            <div style="margin-top: 10px; padding: 8px 15px; background: rgba(255,255,255,0.15); border-radius: 20px; display: inline-block;">
                <span style="font-size: 12px;">⏱️ Falten <strong>${days}d ${hours}h ${minutes}m</strong></span>
            </div>
        `;
    }
    // Si falta menys d'1 dia però més d'1 hora
    else if (hours > 0) {
        countdownHtml = `
            <div style="margin-top: 10px; padding: 8px 15px; background: rgba(251, 191, 36, 0.3); border-radius: 20px; display: inline-block;">
                <span style="font-size: 12px;">⏱️ Falten <strong>${hours}h ${minutes}m ${seconds}s</strong></span>
            </div>
        `;
    }
    // Si falta menys d'1 hora
    else if (minutes > 0) {
        countdownHtml = `
            <div style="margin-top: 10px; padding: 8px 15px; background: rgba(239, 68, 68, 0.4); border-radius: 20px; display: inline-block; animation: pulse 2s infinite;">
                <span style="font-size: 12px;">🔥 Comença en <strong>${minutes}m ${seconds}s</strong>!</span>
            </div>
        `;
    }
    // Si falten menys d'1 minut
    else {
        countdownHtml = `
            <div style="margin-top: 10px; padding: 8px 15px; background: rgba(239, 68, 68, 0.5); border-radius: 20px; display: inline-block; animation: pulse 1s infinite;">
                <span style="font-size: 13px; font-weight: bold;">🚨 COMENÇA EN ${seconds}s! 🚨</span>
            </div>
        `;
    }
}
        } catch (e) {
            console.log('⚠️ Error calculant compte enrere:', e);
        }
    }
    
    // HTML dels logos
    const homeLogoHtml = homeLogo 
        ? `<img src="${homeLogo}" style="width: 40px; height: 40px; object-fit: contain; background: white; border-radius: 50%; padding: 4px;" alt="${homeTeam}" onerror="this.style.display='none';">` 
        : '';
    
    const awayLogoHtml = awayLogo 
        ? `<img src="${awayLogo}" style="width: 40px; height: 40px; object-fit: contain; background: white; border-radius: 50%; padding: 4px;" alt="${awayTeam}" onerror="this.style.display='none';">` 
        : '';
    
    container.innerHTML = `
        <div style="font-size: 12px; margin-bottom: 12px; color: #bfdbfe;">
            ${date} ${time ? '• ' + time : ''}
        </div>
        
        <!-- Equips amb logos -->
        <div style="display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 12px;">
            <!-- Equip Local -->
            <div style="display: flex; flex-direction: column; align-items: center; gap: 8px; flex: 1;">
                ${homeLogoHtml}
                <div style="font-size: 14px; font-weight: bold; text-align: center; line-height: 1.2;">
                    ${homeTeam}
                </div>
            </div>
            
            <!-- VS -->
            <div style="opacity: 0.6; font-size: 16px; font-weight: bold;">VS</div>
            
            <!-- Equip Visitant -->
            <div style="display: flex; flex-direction: column; align-items: center; gap: 8px; flex: 1;">
                ${awayLogoHtml}
                <div style="font-size: 14px; font-weight: bold; text-align: center; line-height: 1.2;">
                    ${awayTeam}
                </div>
            </div>
        </div>
        
        <!-- Compte enrere -->
        ${countdownHtml}
        
        <div style="margin-top: 10px;">
            <span style="background: rgba(255,255,255,0.2); padding: 3px 10px; border-radius: 12px; font-size: 11px;">
                ${isHome ? '🏠 Casa' : '✈️ Fora'}
            </span>
        </div>
    `;
}
function loadLastResultsMini() {
    const container = document.getElementById('last-results-mini');
    
    if (!container) {
        console.error('❌ Container last-results-mini no trobat');
        return;
    }
    
    console.log('📍 Carregant últims resultats...');
    
    if (!actawpData || !actawpData.last_results || actawpData.last_results.length === 0) {
        container.style.display = 'none';
        return;
    }
    
    // Agafar els últims 3 resultats
    const lastResults = actawpData.last_results.slice(0, 3);
    
    console.log('✅ Últims resultats:', lastResults);
    
    let html = '<div style="display: flex; align-items: center; justify-content: center; gap: 15px; flex-wrap: wrap; font-size: 12px;">';
    html += '<span style="font-weight: bold; color: #22d3ee;">📊 Últims resultats:</span>';
    
    lastResults.forEach(result => {
        const team1 = result.team1 || '?';
        const team2 = result.team2 || '?';
        const score1 = result.score_team1 || 0;
        const score2 = result.score_team2 || 0;
        
        // Determinar si CN Terrassa va guanyar
        const isCNTTeam1 = team1.toUpperCase().includes('TERRASSA');
        const isCNTTeam2 = team2.toUpperCase().includes('TERRASSA');
        
        let won = false;
        let rival = '';
        let scoreCNT = 0;
        let scoreRival = 0;
        
        if (isCNTTeam1) {
            won = score1 > score2;
            rival = team2;
            scoreCNT = score1;
            scoreRival = score2;
        } else if (isCNTTeam2) {
            won = score2 > score1;
            rival = team1;
            scoreCNT = score2;
            scoreRival = score1;
        }
        
        const resultIcon = won ? '✅' : '❌';
        const resultColor = won ? '#10b981' : '#ef4444';
        
        html += `
            <div style="display: flex; align-items: center; gap: 6px;">
                <span style="font-size: 14px;">${resultIcon}</span>
                <span style="font-weight: bold; color: ${resultColor};">${scoreCNT}-${scoreRival}</span>
                <span style="color: #64748b;">vs ${rival.length > 15 ? rival.substring(0, 15) + '...' : rival}</span>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}
function loadRankingPill() {
    const container = document.getElementById('ranking-pill');
    
    if (!container) {
        console.error('❌ Container ranking-pill no trobat');
        return;
    }
    
    console.log('📍 Carregant classificació...');
    
    if (!actawpData || !actawpData.ranking || actawpData.ranking.length === 0) {
        container.innerHTML = '<div style="color: #64748b; text-align: center; font-size: 11px;">No hi ha classificació</div>';
        return;
    }
    
    const top5 = actawpData.ranking.slice(0, 5);
    
    console.log('✅ Classificació top 5:', top5);
    
    let html = '<div style="display: flex; flex-direction: column; gap: 6px;">';
    
    top5.forEach(team => {
    const isOurTeam = team.equip.toUpperCase().includes('TERRASSA');
    const bgColor = isOurTeam ? 'rgba(59, 130, 246, 0.1)' : 'transparent';
    const borderLeft = isOurTeam ? '3px solid #3b82f6' : '3px solid transparent';
    
    // Logo de l'equip
    const logoHtml = team.logo 
        ? `<img src="${team.logo}" style="width: 20px; height: 20px; object-fit: contain; background: white; border-radius: 3px; padding: 2px;" alt="${team.equip}" onerror="this.style.display='none';">` 
        : '';
    
    html += `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 8px; background: ${bgColor}; border-radius: 4px; border-left: ${borderLeft}; font-size: 11px; gap: 8px;">
            <!-- Posició + Logo + Nom -->
            <div style="display: flex; align-items: center; gap: 6px; flex: 1; min-width: 0;">
                <span style="font-weight: bold; width: 15px; font-size: 10px; flex-shrink: 0;">${team.posicio}.</span>
                ${logoHtml}
                <span style="font-weight: ${isOurTeam ? 'bold' : 'normal'}; color: ${isOurTeam ? '#3b82f6' : 'inherit'}; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                    ${team.equip}
                </span>
            </div>
            
            <!-- Estadístiques -->
            <div style="display: flex; align-items: center; gap: 8px; flex-shrink: 0;">
                <span style="color: #94a3b8; font-size: 10px;" title="Partits jugats">PJ: ${team.partits || 0}</span>
                <span style="color: #10b981; font-size: 10px;" title="Guanyats">V: ${team.guanyats || 0}</span>
                <span style="color: #ef4444; font-size: 10px;" title="Perduts">D: ${team.perduts || 0}</span>
                <span style="font-weight: bold; color: ${isOurTeam ? '#3b82f6' : 'inherit'}; font-size: 11px;">${team.punts} pts</span>
            </div>
        </div>
    `;
});
    
    html += '</div>';
    container.innerHTML = html;
}


function loadTeamSpirit() {
    const container = document.getElementById('team-spirit-content');
    
    if (!container) {
        console.error('❌ Container team-spirit-content no trobat');
        return;
    }
    
    console.log('📍 Carregant esperit d\'equip...');
    
    if (!allMatches || allMatches.length === 0) {
        document.getElementById('team-spirit').style.display = 'none';
        return;
    }
    
    // Calcular estadístiques d'equip
    let totalGoals = 0;
    let totalGoalsAgainst = 0;
    let wins = 0;
    let draws = 0;
    let losses = 0;
    let consecutiveWins = 0;
    let currentStreak = 0;
    let homeWins = 0;
    let homeMatches = 0;
    let awayWins = 0;
    let awayMatches = 0;
    let biggestWin = { margin: 0, rival: '', score: '' };
    let cleanSheets = 0; // Partits sense encaixar gols
    let comebacks = 0; // Remuntades (si tenim dades per quarters)
    
    // Iterar pels partits (ja estan ordenats per data desc)
    allMatches.forEach((match, index) => {
        const scoreCNT = match.scoreCNT || 0;
        const scoreRival = match.scoreRival || 0;
        const isHome = match.location === 'home';
        const rival = match.rivalTeam || 'Rival';
        
        totalGoals += scoreCNT;
        totalGoalsAgainst += scoreRival;
        
        const won = scoreCNT > scoreRival;
        const draw = scoreCNT === scoreRival;
        
        if (won) {
            wins++;
            const margin = scoreCNT - scoreRival;
            if (margin > biggestWin.margin) {
                biggestWin = {
                    margin: margin,
                    rival: rival,
                    score: `${scoreCNT}-${scoreRival}`
                };
            }
        } else if (draw) {
            draws++;
        } else {
            losses++;
        }
        
        // Clean sheets
        if (scoreRival === 0) cleanSheets++;
        
        if (isHome) {
            homeMatches++;
            if (won) homeWins++;
        } else {
            awayMatches++;
            if (won) awayWins++;
        }
        
        // Calcular ratxa actual (últims partits consecutius)
        if (index === 0 && won) {
            currentStreak = 1;
            for (let i = 1; i < allMatches.length; i++) {
                const prevMatch = allMatches[i];
                if ((prevMatch.scoreCNT || 0) > (prevMatch.scoreRival || 0)) {
                    currentStreak++;
                } else {
                    break;
                }
            }
        }
    });
    
    const totalMatches = allMatches.length;
    const avgGoals = totalMatches > 0 ? (totalGoals / totalMatches).toFixed(1) : 0;
    const avgGoalsAgainst = totalMatches > 0 ? (totalGoalsAgainst / totalMatches).toFixed(1) : 0;
    const winRate = totalMatches > 0 ? Math.round((wins / totalMatches) * 100) : 0;
    const homeWinRate = homeMatches > 0 ? Math.round((homeWins / homeMatches) * 100) : 0;
    const awayWinRate = awayMatches > 0 ? Math.round((awayWins / awayMatches) * 100) : 0;
    const goalDifference = totalGoals - totalGoalsAgainst;
    
    console.log('📊 Estadístiques:', {
        totalMatches,
        wins,
        currentStreak,
        avgGoals,
        winRate,
        goalDifference,
        biggestWin
    });
    
    // Frases motivadoras segons les estadístiques
    const motivationalPhrases = [
        "L'equip és primer, la victòria és de tots! 💙",
        "Junts som més forts! 🤝",
        "Un per tots, tots per un! ⚡",
        "Treballem units, guanyem junts! 🔥",
        "La força està en l'equip! 💪",
        "Cada gol és un triomf col·lectiu! ⚽",
        "Units cap a la victòria! 🏆"
    ];
    
    // Frases especials segons situació
    let phrase = '';
    if (currentStreak >= 5) {
        phrase = `🔥 ${currentStreak} victòries seguides! IMPARABLES!`;
    } else if (currentStreak >= 3) {
        phrase = `🔥 ${currentStreak} victòries consecutives! Seguim així!`;
    } else if (winRate >= 80) {
        phrase = "Temporada espectacular! Continuem forts! 🌟";
    } else if (winRate >= 60) {
        phrase = "Bon ritme d'equip! A per més victòries! 💪";
    } else if (goalDifference > 20) {
        phrase = "Atac imparable! L'equip marca la diferència! ⚡";
    } else {
        // Frase aleatòria motivadora
        phrase = motivationalPhrases[Math.floor(Math.random() * motivationalPhrases.length)];
    }
    
    // HTML amb estadístiques principals
    let html = `
        <div style="font-style: italic; font-size: 13px; margin-bottom: 12px; opacity: 0.95;">
            "${phrase}"
        </div>
        
        <!-- Estadístiques principals (sempre visibles) -->
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px;">
            <div style="background: rgba(255,255,255,0.15); padding: 8px; border-radius: 8px;">
                <div style="font-size: 18px; font-weight: bold;">${wins}</div>
                <div style="font-size: 10px; opacity: 0.9;">Victòries</div>
            </div>
            <div style="background: rgba(255,255,255,0.15); padding: 8px; border-radius: 8px;">
                <div style="font-size: 18px; font-weight: bold;">${avgGoals}</div>
                <div style="font-size: 10px; opacity: 0.9;">Gols/partit</div>
            </div>
            <div style="background: rgba(255,255,255,0.15); padding: 8px; border-radius: 8px;">
                <div style="font-size: 18px; font-weight: bold;">${winRate}%</div>
                <div style="font-size: 10px; opacity: 0.9;">Èxit</div>
            </div>
        </div>
        
        <!-- Més estadístiques destacades -->
        <div style="display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; font-size: 11px; margin-top: 12px;">
    `;
    
    // Diferència de gols (si és positiva)
    if (goalDifference > 0) {
        html += `
            <div style="background: rgba(16, 185, 129, 0.3); padding: 5px 10px; border-radius: 12px;">
                <strong>+${goalDifference}</strong> diferència gols
            </div>
        `;
    }
    
    // Ratxa actual
    if (currentStreak >= 2) {
        html += `
            <div style="background: rgba(239, 68, 68, 0.3); padding: 5px 10px; border-radius: 12px;">
                🔥 <strong>${currentStreak}</strong> seguides
            </div>
        `;
    }
    
    // Victòries a casa (si > 50%)
    if (homeWinRate > 50 && homeMatches > 0) {
        html += `
            <div style="background: rgba(59, 130, 246, 0.3); padding: 5px 10px; border-radius: 12px;">
                🏠 <strong>${homeWinRate}%</strong> a casa
            </div>
        `;
    }
    
    // Victòries fora (si > 50%)
    if (awayWinRate > 50 && awayMatches > 0) {
        html += `
            <div style="background: rgba(168, 85, 247, 0.3); padding: 5px 10px; border-radius: 12px;">
                ✈️ <strong>${awayWinRate}%</strong> fora
            </div>
        `;
    }
    
    // Clean sheets
    if (cleanSheets > 0) {
        html += `
            <div style="background: rgba(34, 211, 238, 0.3); padding: 5px 10px; border-radius: 12px;">
                🛡️ <strong>${cleanSheets}</strong> porteria a zero
            </div>
        `;
    }
    
    // Golejada més gran
    if (biggestWin.margin >= 5) {
        html += `
            <div style="background: rgba(251, 191, 36, 0.3); padding: 5px 10px; border-radius: 12px;">
                ⚡ Millor: <strong>${biggestWin.score}</strong> vs ${biggestWin.rival.length > 12 ? biggestWin.rival.substring(0, 12) + '...' : biggestWin.rival}
            </div>
        `;
    }
    
    // Promig gols en contra (si és baix)
    if (avgGoalsAgainst < 8) {
        html += `
            <div style="background: rgba(16, 185, 129, 0.3); padding: 5px 10px; border-radius: 12px;">
                🛡️ Només <strong>${avgGoalsAgainst}</strong> gols rebuts/partit
            </div>
        `;
    }
    
    // Total gols marcats (si és alt)
    if (totalGoals >= 100) {
        html += `
            <div style="background: rgba(239, 68, 68, 0.3); padding: 5px 10px; border-radius: 12px;">
                🎯 <strong>${totalGoals}</strong> gols totals
            </div>
        `;
    }
    
    html += '</div>';
    
    container.innerHTML = html;
    console.log('✅ Esperit d\'equip carregat amb estadístiques ampliades');
}
// Variable global per guardar l'interval
let countdownInterval = null;

function startCountdownTimer() {
    // Netejar interval anterior si existeix
    if (countdownInterval) {
        clearInterval(countdownInterval);
    }
    
    // Funció per determinar l'interval segons el temps restant
    function getUpdateInterval() {
        if (!actawpData || !actawpData.upcoming_matches || actawpData.upcoming_matches.length === 0) {
            return 60000; // 1 minut per defecte
        }
        
        const match = actawpData.upcoming_matches[0];
        if (!match.date_time) return 60000;
        
        try {
            const dateStr = match.date_time.replace(/^\w+,?\s+/, '');
            const [datePart, timePart] = dateStr.split(' ');
            const [day, month, year] = datePart.split('/');
            const [hours, minutes] = timePart.split(':');
            
            const matchDate = new Date(year, month - 1, day, hours, minutes);
            const now = new Date();
            const diff = matchDate - now;
            
            // Si falta menys d'1 hora: actualitzar cada 10 segons
            if (diff > 0 && diff < 3600000) {
                return 10000;
            }
            // Si falta menys d'1 dia: actualitzar cada 30 segons
            else if (diff > 0 && diff < 86400000) {
                return 30000;
            }
            // Altrament: cada minut
            else {
                return 60000;
            }
        } catch (e) {
            return 60000;
        }
    }
    
    // Actualitzar amb l'interval adequat
    const interval = getUpdateInterval();
    countdownInterval = setInterval(() => {
        console.log('🔄 Actualitzant compte enrere...');
        loadNextMatchPill();
        
        // Reajustar interval si cal
        const newInterval = getUpdateInterval();
        if (newInterval !== interval) {
            startCountdownTimer(); // Reiniciar amb nou interval
        }
    }, interval);
    
    console.log(`⏱️ Compte enrere dinàmic activat (actualització cada ${interval/1000}s)`);
}

function stopCountdownTimer() {
    if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
        console.log('⏹️ Compte enrere dinàmic desactivat');
    }
}
async function loadFrontPagePills() {
    console.log('🎨 Carregant pastilles portada...');
    
    if (!actawpData) {
        console.log('📥 Carregant dades ACTAWP...');
        await loadACTAWPData();
    }
    
    console.log('✅ ACTAWP Data:', actawpData);
    
    loadNextMatchPill();
    loadRankingPill();
    loadLastResultsMini();
    loadTeamSpirit();
    
    // ⭐ Iniciar compte enrere dinàmic
    startCountdownTimer();
}
</script>

  
  </script>
   <script>
    // 🔒 Bloqueo de clic derecho y atajos
    document.addEventListener("contextmenu", event => event.preventDefault());
    document.addEventListener("keydown", event => {
      if ((event.ctrlKey && ["s", "u"].includes(event.key.toLowerCase())) ||
          event.key === "F12") {
        event.preventDefault();
      }
    });
    </script>
</body>
</html>
